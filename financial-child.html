<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Financial Child v4 - Premium</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --green:#22c55e;--green-glow:#4ade80;--red:#ef4444;--red-glow:#f87171;
      --blue:#3b82f6;--purple:#8b5cf6;--gold:#f59e0b;--orange:#f97316;
      --cyan:#06b6d4;--pink:#ec4899;
      --dark:#0a0e1a;--dark2:#131a2e;--dark3:#1c2540;--dark4:#263354;
      --text:#f1f5f9;--text2:#7a8ba8;
      --card:rgba(19,26,46,0.7);--card-border:rgba(31,45,71,0.6);
      --glass:rgba(19,26,46,0.55);--glass-border:rgba(255,255,255,0.08);
      --gold-grad:linear-gradient(135deg,#f59e0b,#fbbf24,#f59e0b);
      --premium-grad:linear-gradient(135deg,#667eea,#764ba2);
    }
    @keyframes bgShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#0a0e1a,#111827,#0f172a,#1a1040,#0a0e1a);background-size:400% 400%;animation:bgShift 20s ease infinite;color:var(--text);min-height:100vh;overflow-x:hidden}

    /* GLASSMORPHISM */
    .glass{background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:20px}
    .glass-sm{background:var(--glass);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid var(--glass-border);border-radius:14px}
    .glass-card{background:rgba(19,26,46,0.5);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:18px;margin-bottom:14px;transition:transform .3s,box-shadow .3s}
    .glass-card:hover{transform:translateY(-1px);box-shadow:0 8px 32px rgba(0,0,0,0.2)}

    /* TRANSITIONS */
    *{transition-property:color,background-color,border-color,opacity,transform,box-shadow;transition-duration:.2s;transition-timing-function:ease}

    /* RIPPLE */
    .ripple{position:relative;overflow:hidden}
    .ripple::after{content:'';position:absolute;width:100%;height:100%;top:0;left:0;background:radial-gradient(circle,rgba(255,255,255,.15) 10%,transparent 10.01%);background-repeat:no-repeat;background-position:50%;transform:scale(10);opacity:0;transition:transform .5s,opacity 1s}
    .ripple:active::after{transform:scale(0);opacity:.3;transition:0s}

    /* PREMIUM GOLD ACCENTS */
    .gold-text{background:var(--gold-grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .gold-border{border:1px solid rgba(245,158,11,0.3)}
    .gold-glow{box-shadow:0 0 20px rgba(245,158,11,0.15)}

    /* LOGIN */
    .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px}
    .login-logo{font-size:2.8rem;font-weight:900;margin-bottom:6px;background:linear-gradient(135deg,var(--gold),#fbbf24,var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:none;letter-spacing:-1px}
    .login-subtitle{color:var(--text2);margin-bottom:40px;font-size:1.05rem;letter-spacing:.5px}
    .login-box{background:var(--glass);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border:1px solid var(--glass-border);border-radius:24px;padding:36px;width:100%;max-width:420px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
    .login-box h2{text-align:center;margin-bottom:20px;font-size:1.3rem}
    .tab-switch{display:flex;margin-bottom:24px;border-radius:14px;overflow:hidden;border:1px solid var(--glass-border);background:rgba(0,0,0,0.2)}
    .tab-btn{flex:1;padding:12px;border:none;background:transparent;color:var(--text2);cursor:pointer;font-size:.9rem;font-weight:700;transition:all .3s}
    .tab-btn.active{background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:6px;color:var(--text2);font-size:.78rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
    .form-group input,.form-group select{width:100%;padding:13px 16px;border:1px solid var(--glass-border);border-radius:12px;background:rgba(0,0,0,0.25);color:var(--text);font-size:.95rem;outline:none;transition:all .3s;backdrop-filter:blur(8px)}
    .form-group input:focus,.form-group select:focus{border-color:var(--gold);box-shadow:0 0 20px rgba(245,158,11,0.1)}
    .btn{width:100%;padding:14px;border:none;border-radius:14px;font-size:1rem;font-weight:800;cursor:pointer;transition:all .3s;margin-top:8px;letter-spacing:.3px}
    .btn-primary{background:linear-gradient(135deg,var(--gold),var(--orange));color:#000;box-shadow:0 4px 20px rgba(245,158,11,0.25)}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(245,158,11,0.35)}
    .btn-primary:active{transform:translateY(0)}
    .error-msg{color:var(--red);font-size:.82rem;text-align:center;margin-top:10px}
    .access-options{display:flex;gap:12px;margin-top:18px}
    .access-btn{flex:1;padding:18px 14px;border:1.5px solid var(--glass-border);border-radius:18px;background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);color:var(--text);cursor:pointer;text-align:center;transition:all .3s}
    .access-btn:hover{border-color:var(--gold);transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,0.3)}
    .access-btn .icon{font-size:2rem;display:block;margin-bottom:8px}
    .access-btn .label{font-weight:800;font-size:.9rem}

    /* PARENT DASHBOARD */
    .dashboard{min-height:100vh;padding:20px;max-width:900px;margin:0 auto}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--glass-border)}
    .header-left h1{font-size:1.5rem;font-weight:900;background:linear-gradient(135deg,var(--gold),#fbbf24);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .header-left small{color:var(--text2);font-size:.85rem}
    .logout-btn{padding:10px 18px;border:1px solid var(--glass-border);border-radius:12px;background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);color:var(--text2);cursor:pointer;font-size:.82rem;font-weight:700;transition:all .3s}
    .logout-btn:hover{border-color:var(--red);color:var(--red);background:rgba(239,68,68,0.1)}
    .card{background:var(--glass);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid var(--glass-border);border-radius:20px;padding:24px;margin-bottom:18px;transition:all .3s}
    .card:hover{box-shadow:0 8px 32px rgba(0,0,0,0.15)}
    .card h3{font-size:1.1rem;margin-bottom:16px;display:flex;align-items:center;gap:10px;font-weight:800}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:18px}
    .stat-card{background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);border:1px solid var(--glass-border);border-radius:16px;padding:18px;text-align:center;transition:all .3s}
    .stat-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.2)}
    .stat-card .stat-value{font-size:1.5rem;font-weight:900;margin-bottom:4px}
    .stat-card .stat-label{color:var(--text2);font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px}
    .stat-green .stat-value{color:var(--green)}.stat-blue .stat-value{color:var(--blue)}.stat-gold .stat-value{color:var(--gold)}.stat-purple .stat-value{color:var(--purple)}
    .config-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn-row{display:flex;gap:10px;margin-top:16px}
    .btn-row .btn{flex:1}
    .btn-sm{padding:11px 16px;font-size:.85rem}
    .btn-outline{background:rgba(0,0,0,0.2);border:1px solid var(--glass-border);color:var(--text)}
    .btn-outline:hover{border-color:var(--gold);color:var(--gold)}
    .tx-list{max-height:300px;overflow-y:auto}
    .tx-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid rgba(255,255,255,0.04)}
    .tx-item:last-child{border-bottom:none}
    .tx-type{font-weight:800;font-size:.78rem;padding:4px 10px;border-radius:8px}
    .tx-buy{background:rgba(34,197,94,.12);color:var(--green)}.tx-sell{background:rgba(239,68,68,.12);color:var(--red)}
    .tx-details{text-align:right}.tx-details .tx-value{font-weight:800;font-size:.9rem}.tx-details .tx-time{color:var(--text2);font-size:.72rem}

    /* TRADING PANEL */
    .trading-panel{min-height:100vh;padding:14px 14px 90px 14px;max-width:520px;margin:0 auto;display:flex;flex-direction:column}
    .trading-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .trading-header h1{font-size:1.2rem;font-weight:900;background:linear-gradient(135deg,var(--gold),#fbbf24);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .balance-display{text-align:right}
    .balance-display .label{font-size:.68rem;color:var(--text2);font-weight:700;text-transform:uppercase;letter-spacing:.5px}
    .balance-display .value{font-size:1.25rem;font-weight:900;color:var(--gold)}
    .market-status{display:flex;align-items:center;gap:6px;font-size:.75rem;color:var(--text2)}
    .live-dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
    .status-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
    .status-dot.paused{background:var(--red);animation:none}

    /* XP BAR IN HEADER */
    .xp-header-bar{display:flex;align-items:center;gap:8px;margin-bottom:12px;padding:8px 14px;background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);border-radius:12px;border:1px solid var(--glass-border)}
    .xp-level-badge{font-size:.8rem;font-weight:900;color:var(--gold);white-space:nowrap}
    .xp-bar-mini{flex:1;height:8px;background:rgba(0,0,0,0.3);border-radius:4px;overflow:hidden}
    .xp-bar-mini-fill{height:100%;background:var(--gold-grad);border-radius:4px;transition:width .5s}
    .xp-text-mini{font-size:.68rem;color:var(--text2);font-weight:700;white-space:nowrap}

    /* WELCOME BANNER */
    .welcome-banner{background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(139,92,246,0.15));backdrop-filter:blur(16px);border:1px solid rgba(245,158,11,0.2);border-radius:18px;padding:18px;margin-bottom:14px;text-align:center;animation:bannerIn .6s ease-out}
    @keyframes bannerIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
    .welcome-banner .wb-greeting{font-size:1.2rem;font-weight:900;margin-bottom:4px}
    .welcome-banner .wb-sub{font-size:.82rem;color:var(--text2)}

    /* CATEGORY TABS */
    .category-tabs{display:flex;gap:4px;margin-bottom:12px;background:rgba(0,0,0,0.2);border-radius:14px;padding:4px;backdrop-filter:blur(8px)}
    .cat-tab{flex:1;padding:10px 6px;border:none;border-radius:10px;background:transparent;color:var(--text2);cursor:pointer;font-size:.75rem;font-weight:800;transition:all .3s;text-align:center}
    .cat-tab.active{background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff;box-shadow:0 4px 15px rgba(59,130,246,0.25)}
    .cat-tab:hover{color:var(--text)}

    /* ASSET CHIPS */
    .asset-scroll{display:flex;gap:8px;margin-bottom:14px;overflow-x:auto;padding-bottom:6px;-webkit-overflow-scrolling:touch}
    .asset-scroll::-webkit-scrollbar{height:3px}
    .asset-scroll::-webkit-scrollbar-thumb{background:var(--dark4);border-radius:3px}
    .asset-chip{flex-shrink:0;padding:10px 14px;border-radius:14px;border:1.5px solid var(--glass-border);background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);cursor:pointer;text-align:center;transition:all .3s;min-width:90px;position:relative}
    .asset-chip:hover{border-color:var(--gold);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.2)}
    .asset-chip.active{border-color:var(--gold);background:rgba(245,158,11,0.08);box-shadow:0 0 20px rgba(245,158,11,0.1)}
    .asset-chip .a-icon{font-size:1.3rem;display:block}
    .asset-chip .a-name{font-size:.7rem;font-weight:900;margin-top:2px;letter-spacing:.5px}
    .asset-chip .a-price{font-size:.65rem;font-weight:600;color:var(--text2);margin-top:2px}
    .asset-chip .a-change{font-size:.6rem;font-weight:800}
    .a-change.up{color:var(--green)}.a-change.down{color:var(--red)}

    /* PRICE SECTION */
    .price-section{background:rgba(0,0,0,0.25);backdrop-filter:blur(16px);border:1px solid var(--glass-border);border-radius:20px;padding:20px;text-align:center;margin-bottom:14px;position:relative;overflow:hidden}
    .price-section::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);animation:scanline 3s linear infinite}
    @keyframes scanline{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
    .price-label{color:var(--text2);font-size:.78rem;font-weight:700;margin-bottom:8px}
    .price-row{display:flex;align-items:center;justify-content:center;gap:10px}
    .price-value{font-size:2.6rem;font-weight:900;transition:color .3s;font-variant-numeric:tabular-nums}
    .price-up{color:var(--green)}.price-down{color:var(--red)}.price-stable{color:var(--text)}
    .price-emoji{font-size:1.8rem;display:inline-block;animation:bounce 1s infinite}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .price-change{font-size:.88rem;font-weight:800;margin-top:4px}
    .price-meta{display:flex;justify-content:center;gap:18px;margin-top:10px;font-size:.72rem;color:var(--text2)}
    .price-meta span{display:flex;align-items:center;gap:4px}

    /* CHART */
    .chart-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:18px;margin-bottom:14px;overflow:hidden}
    .chart-toolbar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px 8px}
    .chart-toolbar .chart-title{font-size:.8rem;font-weight:800;color:var(--text2)}
    .time-tabs{display:flex;gap:3px;background:rgba(0,0,0,0.2);border-radius:10px;padding:3px}
    .time-tab{padding:6px 11px;border:none;border-radius:8px;background:transparent;color:var(--text2);cursor:pointer;font-size:.7rem;font-weight:800;transition:all .2s}
    .time-tab.active{background:var(--gold);color:#000}
    .time-tab:hover{color:var(--text)}
    .chart-wrap{padding:8px 14px 14px;height:200px;position:relative}
    .chart-canvas{width:100%;height:100%}

    /* HOLDINGS */
    .holdings-bar{display:flex;gap:8px;margin-bottom:14px}
    .holding-item{flex:1;background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);border:1px solid var(--glass-border);border-radius:14px;padding:12px;text-align:center;transition:all .3s}
    .holding-item:hover{transform:translateY(-1px)}
    .holding-item .h-label{font-size:.65rem;color:var(--text2);font-weight:700;text-transform:uppercase;letter-spacing:.5px}
    .holding-item .h-value{font-size:1.1rem;font-weight:900;margin-top:3px}

    /* PORTFOLIO */
    .portfolio-section{margin-bottom:14px}
    .portfolio-section h4{font-size:.82rem;color:var(--text2);margin-bottom:10px;font-weight:700}
    .portfolio-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .portfolio-coin{background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);border:1px solid var(--glass-border);border-radius:14px;padding:11px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:all .3s}
    .portfolio-coin:hover{border-color:var(--gold);transform:translateY(-1px)}
    .portfolio-coin .pc-icon{font-size:1.3rem}
    .portfolio-coin .pc-info{flex:1}
    .portfolio-coin .pc-name{font-size:.74rem;font-weight:800}
    .portfolio-coin .pc-qty{font-size:.65rem;color:var(--text2)}
    .portfolio-coin .pc-val{font-size:.85rem;font-weight:900;text-align:right}

    /* TRADE */
    .trade-section{background:rgba(0,0,0,0.25);backdrop-filter:blur(16px);border:1px solid var(--glass-border);border-radius:18px;padding:16px;margin-bottom:14px}
    .trade-section h4{font-size:.82rem;color:var(--text2);margin-bottom:12px;font-weight:700;text-align:center}
    .qty-selector{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:14px}
    .qty-selector label{color:var(--text2);font-size:.82rem;font-weight:700}
    .qty-controls{display:flex;align-items:center;gap:12px}
    .qty-btn{width:38px;height:38px;border-radius:50%;border:1px solid var(--glass-border);background:rgba(0,0,0,0.2);color:var(--text);font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s}
    .qty-btn:hover{border-color:var(--gold);background:rgba(245,158,11,0.1);color:var(--gold)}
    .qty-value{font-size:1.4rem;font-weight:900;min-width:32px;text-align:center}
    .trade-buttons{display:flex;gap:12px}
    .trade-btn{flex:1;padding:18px 12px;border:none;border-radius:16px;font-size:1.1rem;font-weight:900;cursor:pointer;transition:all .3s;text-transform:uppercase;letter-spacing:.5px}
    .buy-btn{background:linear-gradient(135deg,#14532d,var(--green));color:#fff;box-shadow:0 4px 20px rgba(34,197,94,.2)}
    .sell-btn{background:linear-gradient(135deg,#7f1d1d,var(--red));color:#fff;box-shadow:0 4px 20px rgba(239,68,68,.2)}
    .trade-btn:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,0.3)}
    .trade-btn:active{transform:translateY(0)}
    .trade-btn.glow-green{animation:glowG 1.5s ease-in-out infinite}
    .trade-btn.glow-red{animation:glowR 1.5s ease-in-out infinite}
    .trade-btn:disabled{opacity:.3;cursor:not-allowed;transform:none!important;animation:none!important;box-shadow:none!important}
    @keyframes glowG{0%,100%{box-shadow:0 0 20px rgba(34,197,94,.3)}50%{box-shadow:0 0 40px rgba(34,197,94,.6)}}
    @keyframes glowR{0%,100%{box-shadow:0 0 20px rgba(239,68,68,.3)}50%{box-shadow:0 0 40px rgba(239,68,68,.6)}}
    .trade-btn .btn-sub{font-size:.65rem;font-weight:600;opacity:.85;display:block;margin-top:4px;letter-spacing:0;text-transform:none}
    .max-buttons{display:flex;gap:8px;margin-top:10px}
    .max-btn{flex:1;padding:10px;border:1px solid var(--glass-border);border-radius:10px;background:rgba(0,0,0,0.2);color:var(--text2);cursor:pointer;font-size:.72rem;font-weight:800;transition:all .3s;text-align:center}
    .max-btn:hover{border-color:var(--gold);color:var(--gold);background:rgba(245,158,11,0.05)}

    /* PROGRESS */
    .progress-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:16px;padding:14px;margin-bottom:14px}
    .progress-header{display:flex;justify-content:space-between;margin-bottom:8px}
    .progress-label{font-size:.82rem;color:var(--text2);font-weight:700}
    .progress-value{font-size:.82rem;font-weight:800;color:var(--gold)}
    .progress-bar-bg{width:100%;height:20px;background:rgba(0,0,0,0.3);border-radius:10px;overflow:hidden;position:relative}
    .progress-bar-fill{height:100%;border-radius:10px;transition:width .8s ease;background:linear-gradient(90deg,var(--blue),var(--purple));position:relative}
    .progress-bar-fill.near-goal{background:linear-gradient(90deg,var(--gold),#fbbf24);animation:pulseG 1s ease-in-out infinite}
    .progress-bar-fill.goal-reached{background:linear-gradient(90deg,var(--green),var(--green-glow))}
    @keyframes pulseG{0%,100%{opacity:1}50%{opacity:.7}}
    .progress-percent{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:.65rem;font-weight:900;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.4)}

    /* TX FEED */
    .tx-feed{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:16px;padding:14px;margin-bottom:14px}
    .tx-feed h4{font-size:.82rem;color:var(--text2);margin-bottom:10px;font-weight:700}
    .tx-feed-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:.78rem}
    .tx-feed-item:last-child{border-bottom:none}

    /* YIELD */
    .yield-section{background:linear-gradient(135deg,rgba(19,26,46,0.7),rgba(26,39,68,0.7));backdrop-filter:blur(16px);border:1px solid rgba(34,197,94,0.15);border-radius:18px;padding:16px;margin-bottom:14px;position:relative;overflow:hidden}
    .yield-section::after{content:'';position:absolute;top:-50%;right:-50%;width:100%;height:100%;background:radial-gradient(circle,rgba(34,197,94,.06),transparent);pointer-events:none}
    .yield-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .yield-title{font-size:.85rem;font-weight:800;color:var(--green)}
    .yield-rate{font-size:.75rem;font-weight:800;color:var(--gold);background:rgba(245,158,11,.12);padding:4px 10px;border-radius:8px}
    .yield-info{display:flex;gap:10px}
    .yield-card{flex:1;background:rgba(0,0,0,0.2);border-radius:12px;padding:12px;text-align:center}
    .yield-card .y-label{font-size:.65rem;color:var(--text2);font-weight:700;text-transform:uppercase}
    .yield-card .y-value{font-size:1.05rem;font-weight:900;margin-top:3px}
    .yield-card .y-sub{font-size:.6rem;color:var(--green);font-weight:600;margin-top:2px}

    /* RANKING */
    .ranking-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:18px;padding:16px;margin-bottom:14px}
    .ranking-section h4{font-size:.85rem;color:var(--text2);margin-bottom:12px;font-weight:700}
    .rank-list{display:flex;flex-direction:column;gap:8px}
    .rank-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:12px;background:rgba(0,0,0,0.15);transition:all .3s}
    .rank-item:hover{background:rgba(0,0,0,0.25)}
    .rank-item.me{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2)}
    .rank-pos{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:900;flex-shrink:0}
    .rank-1{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#000}
    .rank-2{background:linear-gradient(135deg,#94a3b8,#64748b);color:#000}
    .rank-3{background:linear-gradient(135deg,#cd7f32,#a0522d);color:#fff}
    .rank-other{background:var(--dark3);color:var(--text2)}
    .rank-info{flex:1}.rank-name{font-size:.8rem;font-weight:800}.rank-assets{font-size:.65rem;color:var(--text2)}
    .rank-value{font-size:.88rem;font-weight:900;text-align:right}

    /* NEWS */
    .news-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:16px;padding:14px;margin-bottom:14px}
    .news-header{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    .news-header span{font-size:.8rem;font-weight:800;color:var(--cyan)}
    .news-badge{font-size:.55rem;background:var(--red);color:#fff;padding:3px 8px;border-radius:6px;font-weight:800;animation:pulse 1.5s infinite}
    .news-item{background:rgba(0,0,0,0.15);border-radius:10px;padding:12px;margin-bottom:8px;border-left:3px solid var(--cyan);font-size:.78rem;line-height:1.5;transition:all .3s}
    .news-item:hover{background:rgba(0,0,0,0.25)}
    .news-item:last-child{margin-bottom:0}
    .news-item .news-hint{color:var(--gold);font-weight:800;font-size:.7rem;margin-top:5px;display:block}

    /* CHALLENGES */
    .challenges-section{background:linear-gradient(135deg,rgba(19,26,46,0.6),rgba(26,34,51,0.6));backdrop-filter:blur(16px);border:1px solid rgba(245,158,11,0.1);border-radius:18px;padding:16px;margin-bottom:14px}
    .challenges-section h4{font-size:.85rem;color:var(--gold);margin-bottom:12px;font-weight:800}
    .challenge-item{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(0,0,0,0.15);border-radius:12px;margin-bottom:8px;border:1px solid transparent;transition:all .3s}
    .challenge-item:last-child{margin-bottom:0}
    .challenge-item.completed{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.05)}
    .challenge-item:hover{background:rgba(0,0,0,0.25)}
    .challenge-icon{font-size:1.4rem;flex-shrink:0}
    .challenge-info{flex:1}.challenge-name{font-size:.8rem;font-weight:800}.challenge-desc{font-size:.68rem;color:var(--text2);margin-top:3px}
    .challenge-reward{font-size:.72rem;font-weight:900;color:var(--gold);flex-shrink:0}
    .challenge-check{color:var(--green);font-size:1.1rem;flex-shrink:0}

    /* CONFIRM MODAL */
    .confirm-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:950;animation:fadeIn .2s}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .confirm-box{background:var(--dark2);border:1px solid var(--glass-border);border-radius:22px;padding:28px;width:90%;max-width:380px;animation:scaleIn .3s;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
    @keyframes scaleIn{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
    .confirm-title{font-size:1.15rem;font-weight:900;text-align:center;margin-bottom:6px}
    .confirm-detail{font-size:.85rem;color:var(--text2);text-align:center;margin-bottom:18px}
    .confirm-question{font-size:.82rem;font-weight:800;color:var(--gold);text-align:center;margin-bottom:12px}
    .reason-options{display:flex;flex-direction:column;gap:8px;margin-bottom:18px}
    .reason-btn{padding:12px 16px;border:1px solid var(--glass-border);border-radius:12px;background:rgba(0,0,0,0.2);color:var(--text);cursor:pointer;font-size:.82rem;font-weight:600;text-align:left;transition:all .3s}
    .reason-btn:hover{border-color:var(--gold);background:rgba(245,158,11,0.05)}
    .reason-btn .reason-icon{margin-right:8px}
    .confirm-actions{display:flex;gap:10px}
    .confirm-actions .btn{flex:1;margin-top:0;padding:13px;font-size:.9rem}
    .btn-cancel{background:rgba(255,255,255,0.05);color:var(--text2);border:1px solid var(--glass-border)}
    .btn-cancel:hover{border-color:var(--red);color:var(--red)}

    /* CELEBRATION */
    .celebration-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);backdrop-filter:blur(12px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;animation:fadeIn .5s}
    .celebration-content{text-align:center;animation:scaleIn .5s}
    .celebration-emoji{font-size:5rem;margin-bottom:16px;animation:bounce 1s infinite}
    .celebration-title{font-size:2rem;font-weight:900;background:var(--gold-grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
    .celebration-text{color:var(--text2);font-size:1.05rem;margin-bottom:24px}

    /* PAUSED */
    .paused-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:900}
    .paused-content{text-align:center;color:var(--text2)}
    .paused-content .pause-icon{font-size:4rem;margin-bottom:12px}
    .paused-content .pause-text{font-size:1.3rem;font-weight:800}

    /* TOAST */
    .toast{position:fixed;top:18px;right:18px;padding:12px 20px;border-radius:14px;font-weight:800;font-size:.85rem;z-index:1100;animation:slideIn .3s,slideOut .3s 2.7s;pointer-events:none;backdrop-filter:blur(12px);box-shadow:0 8px 30px rgba(0,0,0,0.3)}
    .toast-success{background:rgba(34,197,94,0.9);color:#fff}.toast-error{background:rgba(239,68,68,0.9);color:#fff}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}

    /* ===== BOTTOM NAV ===== */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(10,14,26,0.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-top:1px solid rgba(255,255,255,0.06);display:flex;justify-content:space-around;padding:6px 0 env(safe-area-inset-bottom,8px);z-index:800;max-width:520px;margin:0 auto}
    .nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 16px;cursor:pointer;transition:all .3s;border-radius:12px;min-width:60px}
    .nav-item:hover{background:rgba(255,255,255,0.04)}
    .nav-item.active{color:var(--gold)}
    .nav-item.active .nav-icon{transform:scale(1.15)}
    .nav-icon{font-size:1.3rem;transition:transform .3s}
    .nav-label{font-size:.62rem;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:inherit}
    .nav-item:not(.active) .nav-label{color:var(--text2)}

    /* TAB CONTENT TRANSITIONS */
    .tab-content{display:none;animation:tabFadeIn .3s ease}
    .tab-content.active{display:block}
    @keyframes tabFadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    /* ===== GAMES TAB ===== */
    .game-card{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:18px;padding:20px;margin-bottom:14px;cursor:pointer;transition:all .3s;position:relative;overflow:hidden}
    .game-card:hover{transform:translateY(-3px);box-shadow:0 12px 40px rgba(0,0,0,0.3);border-color:var(--gold)}
    .game-card::before{content:'';position:absolute;top:0;right:0;width:80px;height:80px;border-radius:50%;opacity:.06;pointer-events:none}
    .game-card .game-emoji{font-size:2.5rem;margin-bottom:10px;display:block}
    .game-card .game-name{font-size:1.05rem;font-weight:900;margin-bottom:4px}
    .game-card .game-desc{font-size:.78rem;color:var(--text2);line-height:1.4}
    .game-card .game-xp{position:absolute;top:14px;right:14px;background:rgba(245,158,11,0.15);color:var(--gold);font-size:.7rem;font-weight:900;padding:4px 10px;border-radius:8px}

    /* GAME OVERLAY */
    .game-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(10,14,26,0.97);backdrop-filter:blur(12px);z-index:850;overflow-y:auto;padding:20px;animation:fadeIn .3s}
    .game-container{max-width:480px;margin:0 auto}
    .game-back{display:inline-flex;align-items:center;gap:6px;padding:10px 16px;border:1px solid var(--glass-border);border-radius:12px;background:rgba(0,0,0,0.2);color:var(--text2);cursor:pointer;font-size:.82rem;font-weight:700;margin-bottom:16px;transition:all .3s}
    .game-back:hover{border-color:var(--gold);color:var(--gold)}
    .game-title-bar{text-align:center;margin-bottom:20px}
    .game-title-bar h2{font-size:1.4rem;font-weight:900;margin-bottom:4px}
    .game-title-bar p{color:var(--text2);font-size:.85rem}

    /* QUIZ */
    .quiz-option{display:block;width:100%;padding:14px 18px;margin-bottom:10px;border:1.5px solid var(--glass-border);border-radius:14px;background:rgba(0,0,0,0.2);color:var(--text);cursor:pointer;font-size:.9rem;font-weight:600;text-align:left;transition:all .3s}
    .quiz-option:hover{border-color:var(--gold);background:rgba(245,158,11,0.05);transform:translateX(4px)}
    .quiz-option.correct{border-color:var(--green);background:rgba(34,197,94,0.15);color:var(--green)}
    .quiz-option.wrong{border-color:var(--red);background:rgba(239,68,68,0.15);color:var(--red)}
    .quiz-progress{display:flex;gap:4px;margin-bottom:20px;justify-content:center}
    .quiz-dot{width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,0.1);transition:all .3s}
    .quiz-dot.done{background:var(--green)}.quiz-dot.current{background:var(--gold);transform:scale(1.3)}.quiz-dot.wrong-dot{background:var(--red)}

    /* LEMONADE GAME */
    .lemon-stat{background:rgba(0,0,0,0.2);border:1px solid var(--glass-border);border-radius:14px;padding:14px;text-align:center;margin-bottom:10px}
    .lemon-stat .ls-val{font-size:1.5rem;font-weight:900;margin-bottom:2px}
    .lemon-stat .ls-label{font-size:.72rem;color:var(--text2);font-weight:700;text-transform:uppercase}
    .lemon-controls{display:grid;gap:10px;margin-bottom:16px}
    .lemon-control{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:rgba(0,0,0,0.15);border-radius:12px;border:1px solid var(--glass-border)}
    .lemon-control label{font-size:.85rem;font-weight:700}
    .lemon-input{display:flex;align-items:center;gap:10px}
    .lemon-input input{width:70px;padding:8px;border-radius:8px;border:1px solid var(--glass-border);background:rgba(0,0,0,0.2);color:var(--text);text-align:center;font-size:1rem;font-weight:800}
    .weather-display{text-align:center;padding:20px;background:rgba(0,0,0,0.15);border-radius:16px;margin-bottom:16px;border:1px solid var(--glass-border)}
    .weather-display .weather-icon{font-size:3rem;margin-bottom:8px;display:block}
    .weather-display .weather-text{font-size:1rem;font-weight:800}

    /* BUDGET GAME */
    .budget-item{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;margin-bottom:8px;background:rgba(0,0,0,0.15);border:1.5px solid var(--glass-border);border-radius:14px;cursor:pointer;transition:all .3s}
    .budget-item:hover{border-color:var(--gold)}
    .budget-item.selected{border-color:var(--green);background:rgba(34,197,94,0.08)}
    .budget-item .bi-info{display:flex;align-items:center;gap:10px}
    .budget-item .bi-icon{font-size:1.4rem}
    .budget-item .bi-name{font-size:.88rem;font-weight:700}
    .budget-item .bi-tag{font-size:.6rem;padding:2px 8px;border-radius:6px;font-weight:800;text-transform:uppercase}
    .bi-tag.need{background:rgba(59,130,246,0.15);color:var(--blue)}
    .bi-tag.want{background:rgba(236,72,153,0.15);color:var(--pink)}
    .bi-tag.save{background:rgba(34,197,94,0.15);color:var(--green)}
    .budget-item .bi-price{font-size:1rem;font-weight:900;color:var(--gold)}
    .budget-remaining{text-align:center;padding:16px;margin-bottom:14px;background:rgba(0,0,0,0.2);border-radius:14px;border:1px solid var(--glass-border)}
    .budget-remaining .br-label{font-size:.75rem;color:var(--text2);font-weight:700;text-transform:uppercase}
    .budget-remaining .br-value{font-size:1.8rem;font-weight:900;color:var(--gold)}

    /* ===== LEARN TAB ===== */
    .lesson-card{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:18px;padding:18px;margin-bottom:12px;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:14px}
    .lesson-card:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,0.2);border-color:var(--gold)}
    .lesson-card.completed-lesson{border-color:rgba(34,197,94,0.3)}
    .lesson-card .lesson-emoji{font-size:2rem;flex-shrink:0}
    .lesson-card .lesson-info{flex:1}
    .lesson-card .lesson-name{font-size:.95rem;font-weight:800;margin-bottom:3px}
    .lesson-card .lesson-desc{font-size:.75rem;color:var(--text2)}
    .lesson-card .lesson-badge{flex-shrink:0;font-size:1rem}
    .lesson-slide{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:20px;padding:28px;text-align:center;margin-bottom:16px;min-height:280px;display:flex;flex-direction:column;justify-content:center;align-items:center}
    .lesson-slide .slide-emoji{font-size:4rem;margin-bottom:16px}
    .lesson-slide .slide-title{font-size:1.2rem;font-weight:900;margin-bottom:10px}
    .lesson-slide .slide-text{font-size:.9rem;color:var(--text2);line-height:1.6;max-width:360px}
    .lesson-dots{display:flex;gap:6px;justify-content:center;margin-bottom:16px}
    .lesson-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.1);transition:all .3s}
    .lesson-dot.active{background:var(--gold);transform:scale(1.3)}

    /* ===== PROFILE TAB ===== */
    .profile-avatar{text-align:center;padding:30px 20px;margin-bottom:16px}
    .profile-avatar .avatar-circle{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--orange));display:flex;align-items:center;justify-content:center;font-size:2.5rem;margin:0 auto 12px;box-shadow:0 8px 30px rgba(245,158,11,0.25);border:3px solid rgba(255,255,255,0.1)}
    .profile-avatar .profile-name{font-size:1.3rem;font-weight:900;margin-bottom:4px}
    .profile-avatar .profile-level{font-size:.9rem;color:var(--gold);font-weight:800}
    .xp-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid rgba(245,158,11,0.15);border-radius:18px;padding:18px;margin-bottom:16px}
    .xp-section .xp-title{font-size:.78rem;color:var(--text2);font-weight:700;margin-bottom:4px;text-transform:uppercase}
    .xp-section .xp-values{display:flex;justify-content:space-between;margin-bottom:8px}
    .xp-section .xp-current{font-size:1.1rem;font-weight:900;color:var(--gold)}
    .xp-section .xp-next{font-size:.8rem;color:var(--text2);font-weight:700}
    .xp-bar-full{width:100%;height:14px;background:rgba(0,0,0,0.3);border-radius:7px;overflow:hidden}
    .xp-bar-fill{height:100%;background:var(--gold-grad);border-radius:7px;transition:width .6s}
    .profile-stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
    .profile-stat{background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);border:1px solid var(--glass-border);border-radius:14px;padding:16px;text-align:center}
    .profile-stat .ps-value{font-size:1.3rem;font-weight:900;margin-bottom:4px}
    .profile-stat .ps-label{font-size:.68rem;color:var(--text2);font-weight:700;text-transform:uppercase}
    .achievements-section{margin-bottom:16px}
    .achievements-section h4{font-size:.85rem;color:var(--text2);font-weight:700;margin-bottom:12px}
    .achievement-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .achievement-badge{background:rgba(0,0,0,0.2);border:1px solid var(--glass-border);border-radius:14px;padding:14px 8px;text-align:center;transition:all .3s}
    .achievement-badge.earned{border-color:rgba(245,158,11,0.3);background:rgba(245,158,11,0.05)}
    .achievement-badge .ab-icon{font-size:1.5rem;margin-bottom:4px;display:block}
    .achievement-badge .ab-name{font-size:.6rem;font-weight:700;color:var(--text2)}
    .achievement-badge.earned .ab-name{color:var(--gold)}

    /* LEVEL UP OVERLAY */
    .levelup-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.92);backdrop-filter:blur(16px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1050;animation:fadeIn .5s}
    .levelup-content{text-align:center;animation:scaleIn .5s}
    .levelup-emoji{font-size:5rem;margin-bottom:10px;animation:bounce 1s infinite}
    .levelup-title{font-size:1.8rem;font-weight:900;color:var(--gold);margin-bottom:6px}
    .levelup-level{font-size:1.3rem;font-weight:800;color:var(--text);margin-bottom:20px}

    .hidden{display:none!important}
    @media(max-width:500px){
      .config-grid{grid-template-columns:1fr}
      .stats-grid{grid-template-columns:1fr 1fr}
      .price-value{font-size:2rem}
      .trade-btn{padding:16px 8px;font-size:.95rem}
      .asset-chip{min-width:78px;padding:8px 10px}
      .portfolio-grid{grid-template-columns:1fr}
      .chart-wrap{height:170px}
      .profile-stats{grid-template-columns:1fr 1fr}
      .achievement-grid{grid-template-columns:repeat(3,1fr)}
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="login-screen">
  <div class="login-logo">Financial Child</div>
  <div class="login-subtitle">Aprenda a investir brincando!</div>
  <div class="login-box">
    <div class="tab-switch"><button class="tab-btn active" onclick="switchTab('login')">Entrar</button><button class="tab-btn" onclick="switchTab('register')">Criar Conta</button></div>
    <div id="loginForm">
      <div class="form-group"><label>Email</label><input type="email" id="loginEmail" placeholder="seu@email.com"></div>
      <div class="form-group"><label>Senha</label><input type="password" id="loginPassword" placeholder="Sua senha"></div>
      <button class="btn btn-primary ripple" onclick="handleLogin()">Entrar</button>
      <div id="loginError" class="error-msg hidden"></div>
      <div class="access-options">
        <button class="access-btn" onclick="enterAsParent()"><span class="icon">üë®‚Äçüë©‚Äçüëß</span><span class="label">Sou Pai/Mae</span></button>
        <button class="access-btn" onclick="showChildAccess()"><span class="icon">üßí</span><span class="label">Sou Crianca</span></button>
      </div>
    </div>
    <div id="registerForm" class="hidden">
      <div class="form-group"><label>Seu Nome</label><input type="text" id="regName" placeholder="Ex: Maria"></div>
      <div class="form-group"><label>Email</label><input type="email" id="regEmail" placeholder="seu@email.com"></div>
      <div class="form-group"><label>Senha</label><input type="password" id="regPassword" placeholder="Crie uma senha"></div>
      <button class="btn btn-primary ripple" onclick="handleRegister()">Criar Conta</button>
      <div id="regError" class="error-msg hidden"></div>
    </div>
  </div>
</div>

<!-- PARENT DASHBOARD -->
<div id="parentDashboard" class="dashboard hidden">
  <div class="header"><div class="header-left"><h1>Financial Child</h1><small>Painel dos Pais</small></div><button class="logout-btn" onclick="logout()">Sair</button></div>
  <div id="setupChild" class="card">
    <h3>üë∂ Configurar Conta do Filho</h3>
    <div class="config-grid">
      <div class="form-group"><label>Nome</label><input type="text" id="childName" placeholder="Ex: Joao"></div>
      <div class="form-group"><label>Idade</label><input type="number" id="childAge" value="10" min="5" max="17"></div>
      <div class="form-group"><label>Saldo Inicial (R$)</label><input type="number" id="childBalance" value="100" min="10" step="10"></div>
      <div class="form-group"><label>Volatilidade</label><select id="childVolatility"><option value="baixa">Baixa</option><option value="media" selected>Media</option><option value="alta">Alta</option></select></div>
      <div class="form-group"><label>Meta (R$)</label><input type="number" id="childGoal" value="200" min="20" step="10"></div>
    </div>
    <button class="btn btn-primary ripple" onclick="createChildAccount()">Criar Conta</button>
  </div>
  <div id="childDashboard" class="hidden">
    <div class="stats-grid">
      <div class="stat-card stat-blue"><div class="stat-value" id="pSaldo">R$ 0</div><div class="stat-label">Saldo</div></div>
      <div class="stat-card stat-green"><div class="stat-value" id="pMoedas">0</div><div class="stat-label">Ativos</div></div>
      <div class="stat-card stat-gold"><div class="stat-value" id="pTotal">R$ 0</div><div class="stat-label">Patrimonio</div></div>
      <div class="stat-card stat-purple"><div class="stat-value" id="pOps">0</div><div class="stat-label">Operacoes</div></div>
    </div>
    <div class="card"><h3>üéØ Meta</h3><div class="progress-header"><span class="progress-label" id="pChildName">Filho</span><span class="progress-value" id="pGoalText">R$0 / R$0</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" id="pProgressBar" style="width:0%"><span class="progress-percent" id="pProgressPct">0%</span></div></div></div>
    <div class="card"><h3>‚öôÔ∏è Config</h3><div class="config-grid"><div class="form-group"><label>Volatilidade</label><select id="editVolatility" onchange="updateConfig()"><option value="baixa">Baixa</option><option value="media">Media</option><option value="alta">Alta</option></select></div><div class="form-group"><label>Meta (R$)</label><input type="number" id="editGoal" min="20" step="10" onchange="updateConfig()"></div></div><div class="btn-row"><button class="btn btn-sm btn-outline ripple" onclick="toggleMarket()" id="toggleBtn">‚è∏ Pausar</button><button class="btn btn-sm btn-outline ripple" onclick="resetChildAccount()" style="border-color:rgba(239,68,68,.3);color:var(--red);">üîÑ Resetar</button></div></div>
    <div class="card"><h3>üîë Codigo da Crianca</h3><div style="background:rgba(0,0,0,0.25);padding:16px;border-radius:14px;text-align:center;"><span id="childCode" style="font-size:1.8rem;font-weight:900;letter-spacing:6px;color:var(--gold);"></span></div></div>
    <div class="card"><h3>üìä Historico</h3><div class="tx-list" id="pTxList"><p style="color:var(--text2);text-align:center;padding:16px;">Nenhuma operacao</p></div></div>
  </div>
</div>

<!-- CHILD ACCESS -->
<div id="childAccessScreen" class="login-screen hidden">
  <div class="login-logo">Financial Child</div>
  <div class="login-subtitle">Area do Investidor üöÄ</div>
  <div class="login-box">
    <h2>Digite seu codigo</h2>
    <div class="form-group"><label>Codigo</label><input type="text" id="childCodeInput" placeholder="ABC123" maxlength="6" style="text-align:center;font-size:1.5rem;letter-spacing:6px;font-weight:900;"></div>
    <button class="btn btn-primary ripple" onclick="childLogin()">Entrar</button>
    <div id="childLoginError" class="error-msg hidden"></div>
    <button class="btn btn-outline" style="margin-top:12px;" onclick="backToLogin()">Voltar</button>
  </div>
</div>

<!-- TRADING PANEL (Child) -->
<div id="tradingPanel" class="trading-panel hidden">
  <div class="trading-header">
    <div><h1>Financial Child</h1><div class="market-status"><div class="status-dot" id="marketDot"></div><span id="marketStatusText">Ao vivo</span></div></div>
    <div class="balance-display"><div class="label">SALDO</div><div class="value" id="cBalance">R$ 0</div></div>
  </div>

  <!-- XP Header Bar -->
  <div class="xp-header-bar" id="xpHeaderBar">
    <span class="xp-level-badge" id="xpLevelBadge">üê£ Lv.1</span>
    <div class="xp-bar-mini"><div class="xp-bar-mini-fill" id="xpBarMiniFill" style="width:0%"></div></div>
    <span class="xp-text-mini" id="xpTextMini">0/50 XP</span>
  </div>

  <!-- Welcome Banner -->
  <div class="welcome-banner" id="welcomeBanner">
    <div class="wb-greeting" id="wbGreeting">Ola, Investidor! üëã</div>
    <div class="wb-sub">Bora fazer boas escolhas hoje?</div>
  </div>

  <!-- TAB: MERCADO -->
  <div id="tabMercado" class="tab-content active">
    <div class="category-tabs" id="catTabs"></div>
    <div class="asset-scroll" id="assetScroll"></div>
    <div class="price-section">
      <div class="price-label"><span class="live-dot"></span> <strong id="cCoinName">EKO</strong> - <span id="cCoinType">Cripto</span></div>
      <div class="price-row"><span class="price-value price-stable" id="cPrice">R$ 10,00</span><span class="price-emoji" id="cEmoji">üìä</span></div>
      <div class="price-change" id="cPriceChange"></div>
      <div class="price-meta">
        <span>üìà Max: <strong id="cHigh">-</strong></span>
        <span>üìâ Min: <strong id="cLow">-</strong></span>
        <span>üìä Base: <strong id="cBase">-</strong></span>
      </div>
    </div>
    <div class="chart-section">
      <div class="chart-toolbar">
        <span class="chart-title" id="chartTitle">Grafico EKO</span>
        <div class="time-tabs" id="timeTabs"></div>
      </div>
      <div class="chart-wrap"><canvas class="chart-canvas" id="priceChart"></canvas></div>
    </div>
    <div class="news-section">
      <div class="news-header"><span>üì∞ Noticias do Mercado</span><span class="news-badge">AO VIVO</span></div>
      <div id="newsContainer"></div>
    </div>
    <div class="holdings-bar">
      <div class="holding-item"><div class="h-label">Quantidade</div><div class="h-value" id="cQty" style="color:var(--blue);">0</div></div>
      <div class="holding-item"><div class="h-label">Valor</div><div class="h-value" id="cVal" style="color:var(--purple);">R$ 0</div></div>
      <div class="holding-item"><div class="h-label">Patrimonio</div><div class="h-value" id="cTotal" style="color:var(--gold);">R$ 0</div></div>
    </div>
    <div class="portfolio-section"><h4>üì¶ Carteira</h4><div class="portfolio-grid" id="portfolioGrid"></div></div>
    <div class="trade-section">
      <h4>Negociar <span id="tradeAssetName">EKO</span></h4>
      <div class="qty-selector"><label>Qtd:</label><div class="qty-controls"><button class="qty-btn ripple" onclick="changeQty(-1)">-</button><span class="qty-value" id="qtyValue">1</span><button class="qty-btn ripple" onclick="changeQty(1)">+</button></div></div>
      <div class="trade-buttons">
        <button class="trade-btn buy-btn ripple" id="buyBtn" onclick="confirmTrade('BUY')">Comprar<span class="btn-sub" id="buyCost"></span></button>
        <button class="trade-btn sell-btn ripple" id="sellBtn" onclick="confirmTrade('SELL')">Vender<span class="btn-sub" id="sellValue"></span></button>
      </div>
      <div class="max-buttons">
        <button class="max-btn ripple" onclick="buyMax()">üí∞ COMPRAR MAX</button>
        <button class="max-btn ripple" onclick="sellMax()">üì§ VENDER TUDO</button>
      </div>
    </div>
    <div class="challenges-section">
      <h4>üéØ Desafios do Investidor</h4>
      <div id="challengesList"></div>
    </div>
    <div class="yield-section">
      <div class="yield-header"><span class="yield-title">üí∞ Rendimento Passivo</span><span class="yield-rate" id="yieldRate">+0.5%/min</span></div>
      <div class="yield-info">
        <div class="yield-card"><div class="y-label">Ganho/min</div><div class="y-value" id="yieldPerMin" style="color:var(--green)">R$ 0,00</div><div class="y-sub">baseado nos seus EKOs</div></div>
        <div class="yield-card"><div class="y-label">Total ganho</div><div class="y-value" id="yieldTotal" style="color:var(--gold)">R$ 0,00</div><div class="y-sub" id="yieldTime">desde o inicio</div></div>
      </div>
    </div>
    <div class="ranking-section">
      <h4>üèÜ Ranking de Investidores</h4>
      <div class="rank-list" id="rankList"></div>
    </div>
    <div class="progress-section"><div class="progress-header"><span class="progress-label">üéØ Meta</span><span class="progress-value" id="cGoalText">R$0 / R$0</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" id="cProgressBar" style="width:0%"><span class="progress-percent" id="cProgressPct">0%</span></div></div></div>
    <div class="tx-feed"><h4>Ultimas Operacoes</h4><div id="cTxList"><p style="color:var(--text2);text-align:center;padding:10px;font-size:.85rem;">Faca sua primeira operacao!</p></div></div>
  </div>

  <!-- TAB: JOGOS -->
  <div id="tabJogos" class="tab-content">
    <h3 style="text-align:center;margin-bottom:18px;font-size:1.2rem;font-weight:900;">üéÆ Mini-Games</h3>
    <div class="game-card" onclick="startQuiz()">
      <span class="game-emoji">üß†</span>
      <div class="game-name">Quiz do Investidor</div>
      <div class="game-desc">Teste seus conhecimentos sobre dinheiro e investimentos!</div>
      <span class="game-xp">+15 XP</span>
    </div>
    <div class="game-card" onclick="startLemonade()">
      <span class="game-emoji">üçã</span>
      <div class="game-name">Fabrica de Limonada</div>
      <div class="game-desc">Monte sua barraca e aprenda sobre custos, precos e lucro!</div>
      <span class="game-xp">+15 XP</span>
    </div>
    <div class="game-card" onclick="startBudget()">
      <span class="game-emoji">üí≥</span>
      <div class="game-name">Desafio do Orcamento</div>
      <div class="game-desc">Receba R$100 e aprenda a gastar com sabedoria!</div>
      <span class="game-xp">+15 XP</span>
    </div>
  </div>

  <!-- TAB: APRENDER -->
  <div id="tabAprender" class="tab-content">
    <h3 style="text-align:center;margin-bottom:18px;font-size:1.2rem;font-weight:900;">üìö Aprender</h3>
    <div id="lessonsList"></div>
  </div>

  <!-- TAB: PERFIL -->
  <div id="tabPerfil" class="tab-content">
    <div class="profile-avatar">
      <div class="avatar-circle" id="profileAvatarIcon">üßí</div>
      <div class="profile-name" id="profileName">Investidor</div>
      <div class="profile-level" id="profileLevel">üê£ Nivel 1 - Iniciante</div>
    </div>
    <div class="xp-section">
      <div class="xp-title">Experiencia</div>
      <div class="xp-values"><span class="xp-current" id="profileXpCurrent">0 XP</span><span class="xp-next" id="profileXpNext">Proximo: 50 XP</span></div>
      <div class="xp-bar-full"><div class="xp-bar-fill" id="profileXpBar" style="width:0%"></div></div>
    </div>
    <div class="profile-stats">
      <div class="profile-stat"><div class="ps-value" id="profPatrimony" style="color:var(--gold)">R$ 0</div><div class="ps-label">Patrimonio</div></div>
      <div class="profile-stat"><div class="ps-value" id="profTrades" style="color:var(--blue)">0</div><div class="ps-label">Operacoes</div></div>
      <div class="profile-stat"><div class="ps-value" id="profDays" style="color:var(--green)">0</div><div class="ps-label">Dias Ativo</div></div>
      <div class="profile-stat"><div class="ps-value" id="profGames" style="color:var(--purple)">0</div><div class="ps-label">Jogos</div></div>
    </div>
    <div class="achievements-section">
      <h4>üèÖ Conquistas</h4>
      <div class="achievement-grid" id="achievementGrid"></div>
    </div>
    <button class="btn btn-outline" style="margin-top:14px;margin-bottom:20px;" onclick="logout()">Sair da Conta</button>
  </div>
</div>

<!-- BOTTOM NAV (child only) -->
<div id="bottomNav" class="bottom-nav hidden">
  <div class="nav-item active" onclick="switchChildTab('Mercado')" id="navMercado">
    <span class="nav-icon">üìà</span><span class="nav-label">Mercado</span>
  </div>
  <div class="nav-item" onclick="switchChildTab('Jogos')" id="navJogos">
    <span class="nav-icon">üéÆ</span><span class="nav-label">Jogos</span>
  </div>
  <div class="nav-item" onclick="switchChildTab('Aprender')" id="navAprender">
    <span class="nav-icon">üìö</span><span class="nav-label">Aprender</span>
  </div>
  <div class="nav-item" onclick="switchChildTab('Perfil')" id="navPerfil">
    <span class="nav-icon">üë§</span><span class="nav-label">Perfil</span>
  </div>
</div>

<!-- OVERLAYS -->
<div id="celebrationOverlay" class="celebration-overlay hidden"><div class="celebration-content"><div class="celebration-emoji">üèÜüéâüöÄ</div><div class="celebration-title">META ATINGIDA!</div><div class="celebration-text" id="celebrationText"></div><button class="btn btn-primary ripple" style="max-width:200px;margin:0 auto;" onclick="closeCelebration()">Valeu! üéä</button></div></div>

<div id="confirmOverlay" class="confirm-overlay hidden">
  <div class="confirm-box">
    <div class="confirm-title" id="confirmTitle">Comprar EKO?</div>
    <div class="confirm-detail" id="confirmDetail">2 EKO por R$ 20,00</div>
    <div class="confirm-question">üß† Por que voce quer fazer isso?</div>
    <div class="reason-options" id="reasonOptions"></div>
    <div class="confirm-actions">
      <button class="btn btn-cancel ripple" onclick="cancelTrade()">Cancelar</button>
      <button class="btn btn-primary ripple" id="confirmBtn" onclick="executeTrade()" disabled>Confirmar</button>
    </div>
  </div>
</div>

<div id="pausedOverlay" class="paused-overlay hidden"><div class="paused-content"><div class="pause-icon">‚è∏Ô∏è</div><div class="pause-text">Mercado Pausado</div></div></div>

<div id="levelUpOverlay" class="levelup-overlay hidden">
  <div class="levelup-content">
    <div class="levelup-emoji" id="levelUpEmoji">üéâ</div>
    <div class="levelup-title">LEVEL UP!</div>
    <div class="levelup-level" id="levelUpText">Nivel 2 - Aprendiz</div>
    <button class="btn btn-primary ripple" style="max-width:200px;margin:0 auto;" onclick="closeLevelUp()">Incrivel! ‚ú®</button>
  </div>
</div>

<!-- GAME OVERLAY -->
<div id="gameOverlay" class="game-overlay hidden">
  <div class="game-container" id="gameContainer"></div>
</div>

<!-- LESSON OVERLAY -->
<div id="lessonOverlay" class="game-overlay hidden">
  <div class="game-container" id="lessonContainer"></div>
</div>

<script>
// ============================================================
// FINANCIAL CHILD v4 - PREMIUM EDITION
// ============================================================

const CATEGORIES = [
  { id: 'cripto', name: 'Cripto', icon: 'ü™ô' },
  { id: 'acoes',  name: 'Acoes',  icon: 'üìä' },
  { id: 'commodities', name: 'Commodities', icon: 'üí∞' },
];

const ASSETS = [
  { id:'EKO',  name:'EKO',  icon:'üíé', color:'#3b82f6', basePrice:10,  cat:'cripto', vol:1.0 },
  { id:'LUNA', name:'LUNA', icon:'üåô', color:'#8b5cf6', basePrice:25,  cat:'cripto', vol:1.2 },
  { id:'FIRE', name:'FIRE', icon:'üî•', color:'#ef4444', basePrice:15,  cat:'cripto', vol:1.5 },
  { id:'STAR', name:'STAR', icon:'‚≠ê', color:'#f59e0b', basePrice:5,   cat:'cripto', vol:0.8 },
  { id:'TOYS', name:'TOYS', icon:'üß∏', color:'#ec4899', basePrice:30,  cat:'acoes', vol:0.6 },
  { id:'GAME', name:'GAME', icon:'üéÆ', color:'#06b6d4', basePrice:45,  cat:'acoes', vol:0.7 },
  { id:'FOOD', name:'FOOD', icon:'üçî', color:'#f97316', basePrice:20,  cat:'acoes', vol:0.4 },
  { id:'PETS', name:'PETS', icon:'üê∂', color:'#a3e635', basePrice:18,  cat:'acoes', vol:0.5 },
  { id:'GOLD', name:'GOLD', icon:'ü•á', color:'#fbbf24', basePrice:80,  cat:'commodities', vol:0.3 },
  { id:'DIAM', name:'DIAM', icon:'üí†', color:'#67e8f9', basePrice:120, cat:'commodities', vol:0.35 },
  { id:'SILV', name:'SILV', icon:'ü•à', color:'#94a3b8', basePrice:40,  cat:'commodities', vol:0.25 },
];

const TIME_PERIODS = [
  { id:'1m', label:'1m', seconds:60 },
  { id:'5m', label:'5m', seconds:300 },
  { id:'15m',label:'15m',seconds:900 },
  { id:'1h', label:'1h', seconds:3600 },
  { id:'all',label:'Tudo',seconds:Infinity },
];

// ============ XP / LEVEL SYSTEM ============
const LEVELS = [
  { level:1, xp:0,   title:'Iniciante', emoji:'üê£' },
  { level:2, xp:50,  title:'Aprendiz',  emoji:'üê•' },
  { level:3, xp:150, title:'Esperto',   emoji:'ü¶ä' },
  { level:4, xp:300, title:'Investidor', emoji:'ü¶Å' },
  { level:5, xp:500, title:'Mestre',    emoji:'üêâ' },
  { level:6, xp:800, title:'Lenda',     emoji:'üëë' },
];

function getLevel(xp) {
  let lv = LEVELS[0];
  for (let i = LEVELS.length - 1; i >= 0; i--) {
    if (xp >= LEVELS[i].xp) { lv = LEVELS[i]; break; }
  }
  return lv;
}

function getNextLevel(xp) {
  for (let i = 0; i < LEVELS.length; i++) {
    if (xp < LEVELS[i].xp) return LEVELS[i];
  }
  return null;
}

function addXP(amount, reason) {
  if (!currentChild) return;
  const ch = load('children') || {};
  const child = ch[currentChild.id];
  if (!child) return;
  const oldXP = child.xp || 0;
  const oldLevel = getLevel(oldXP);
  child.xp = (child.xp || 0) + amount;
  const newLevel = getLevel(child.xp);
  ch[child.id] = child;
  save('children', ch);
  currentChild = child;
  showToast(`+${amount} XP! ${reason}`, 'success');
  if (newLevel.level > oldLevel.level) {
    setTimeout(() => showLevelUp(newLevel), 500);
  }
  updateXPUI();
}

function showLevelUp(level) {
  document.getElementById('levelUpEmoji').textContent = level.emoji;
  document.getElementById('levelUpText').textContent = `Nivel ${level.level} - ${level.title}`;
  document.getElementById('levelUpOverlay').classList.remove('hidden');
  createConfetti();
}

function closeLevelUp() {
  document.getElementById('levelUpOverlay').classList.add('hidden');
}

function updateXPUI() {
  if (!currentChild) return;
  const xp = currentChild.xp || 0;
  const lv = getLevel(xp);
  const next = getNextLevel(xp);
  const badge = `${lv.emoji} Lv.${lv.level}`;
  let pct = 100;
  let xpText = `${xp} XP (MAX)`;
  if (next) {
    const progress = xp - lv.xp;
    const needed = next.xp - lv.xp;
    pct = Math.min(100, (progress / needed) * 100);
    xpText = `${xp}/${next.xp} XP`;
  }
  const hBadge = document.getElementById('xpLevelBadge');
  const hFill = document.getElementById('xpBarMiniFill');
  const hText = document.getElementById('xpTextMini');
  if (hBadge) hBadge.textContent = badge;
  if (hFill) hFill.style.width = pct + '%';
  if (hText) hText.textContent = xpText;

  // Profile tab XP
  const pName = document.getElementById('profileName');
  const pLevel = document.getElementById('profileLevel');
  const pXpCur = document.getElementById('profileXpCurrent');
  const pXpNext = document.getElementById('profileXpNext');
  const pXpBar = document.getElementById('profileXpBar');
  if (pName) pName.textContent = currentChild.name || 'Investidor';
  if (pLevel) pLevel.textContent = `${lv.emoji} Nivel ${lv.level} - ${lv.title}`;
  if (pXpCur) pXpCur.textContent = xp + ' XP';
  if (pXpNext) pXpNext.textContent = next ? `Proximo: ${next.xp} XP` : 'Nivel Maximo!';
  if (pXpBar) pXpBar.style.width = pct + '%';
}

// ============ STORAGE ============
function save(k, d) { localStorage.setItem('fc4_' + k, JSON.stringify(d)); }
function load(k) { const d = localStorage.getItem('fc4_' + k); return d ? JSON.parse(d) : null; }
function genCode() { const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let r = ''; for (let i = 0; i < 6; i++) r += c[~~(Math.random() * c.length)]; return r; }

// ============ STATE ============
let currentParent = null, currentChild = null, currentView = 'login';
let marketInterval = null, tradeQty = 1;
let selectedAsset = 'EKO', selectedCat = 'cripto', selectedTime = '5m';
let priceHistories = {}, trendData = {}, celebrationShown = false;
let tickCount = 0, totalYieldEarned = 0, yieldInterval = null;
let currentChildTab = 'Mercado';

function init() {
  const s = load('session');
  if (s) {
    if (s.type === 'parent') { currentParent = s.data; showParentDashboard(); }
    else if (s.type === 'child') { currentChild = s.data; showTradingPanel(); }
  }
}

// ============ AUTH ============
function switchTab(t) {
  document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', (t === 'login' && i === 0) || (t === 'register' && i === 1)));
  document.getElementById('loginForm').classList.toggle('hidden', t !== 'login');
  document.getElementById('registerForm').classList.toggle('hidden', t !== 'register');
}

function handleRegister() {
  const n = document.getElementById('regName').value.trim(), e = document.getElementById('regEmail').value.trim(), p = document.getElementById('regPassword').value.trim();
  if (!n || !e || !p) { showError('regError', 'Preencha todos os campos'); return; }
  const ex = load('parents') || {};
  if (ex[e]) { showError('regError', 'Email ja cadastrado'); return; }
  const par = { id: Date.now().toString(), name: n, email: e, password: p };
  ex[e] = par; save('parents', ex);
  currentParent = par; save('session', { type: 'parent', data: par }); showParentDashboard();
}

function handleLogin() {
  const e = document.getElementById('loginEmail').value.trim(), p = document.getElementById('loginPassword').value.trim();
  const pars = load('parents') || {}; const par = pars[e];
  if (!par || par.password !== p) { showError('loginError', 'Email ou senha incorretos'); return; }
  currentParent = par; save('session', { type: 'parent', data: par }); showParentDashboard();
}

function enterAsParent() { switchTab('register'); }
function showChildAccess() { showScreen('childAccess'); }
function backToLogin() { showScreen('login'); }

function childLogin() {
  const code = document.getElementById('childCodeInput').value.trim().toUpperCase();
  const ch = load('children') || {}; const child = Object.values(ch).find(c => c.code === code);
  if (!child) { showError('childLoginError', 'Codigo invalido'); return; }
  currentChild = child; save('session', { type: 'child', data: child });
  // Daily login XP
  const today = new Date().toDateString();
  const lastLogin = child.lastLogin || '';
  if (lastLogin !== today) {
    child.lastLogin = today;
    child.daysActive = (child.daysActive || 0) + 1;
    ch[child.id] = child; save('children', ch); currentChild = child;
    setTimeout(() => addXP(10, 'Login diario!'), 1000);
  }
  showTradingPanel();
}

function logout() {
  stopMarket(); currentParent = null; currentChild = null;
  localStorage.removeItem('fc4_session'); celebrationShown = false;
  document.getElementById('bottomNav').classList.add('hidden');
  showScreen('login');
}

function showError(id, msg) {
  const el = document.getElementById(id); el.textContent = msg; el.classList.remove('hidden');
  setTimeout(() => el.classList.add('hidden'), 3000);
}

function showScreen(s) {
  currentView = s;
  const map = { login: 'loginScreen', parent: 'parentDashboard', childAccess: 'childAccessScreen', trading: 'tradingPanel' };
  ['loginScreen', 'parentDashboard', 'childAccessScreen', 'tradingPanel'].forEach(id => {
    document.getElementById(id).classList.toggle('hidden', id !== map[s]);
  });
  document.getElementById('bottomNav').classList.toggle('hidden', s !== 'trading');
}

// ============ BOTTOM NAV / TABS ============
function switchChildTab(tab) {
  currentChildTab = tab;
  ['Mercado', 'Jogos', 'Aprender', 'Perfil'].forEach(t => {
    const el = document.getElementById('tab' + t);
    const nav = document.getElementById('nav' + t);
    if (el) { el.classList.toggle('active', t === tab); }
    if (nav) { nav.classList.toggle('active', t === tab); }
  });
  if (tab === 'Perfil') updateProfileTab();
  if (tab === 'Aprender') renderLessons();
}

// ============ PARENT DASHBOARD ============
function showParentDashboard() { showScreen('parent'); refreshParent(); }

function refreshParent() {
  const ch = load('children') || {};
  const list = Object.values(ch).filter(c => c.parent_id === currentParent.id);
  if (!list.length) {
    document.getElementById('setupChild').classList.remove('hidden');
    document.getElementById('childDashboard').classList.add('hidden'); return;
  }
  document.getElementById('setupChild').classList.add('hidden');
  document.getElementById('childDashboard').classList.remove('hidden');
  const child = list[0]; currentChild = child;
  const tv = calcTotal(child);
  const txs = (load('transactions') || {})[child.id] || [];
  const totalAssets = ASSETS.reduce((s, a) => s + (child.assets?.[a.id]?.qty || 0), 0);
  document.getElementById('pSaldo').textContent = fmt(child.balance);
  document.getElementById('pMoedas').textContent = totalAssets;
  document.getElementById('pTotal').textContent = fmt(tv);
  document.getElementById('pOps').textContent = txs.length;
  const pct = Math.min(100, (tv / child.goal_amount) * 100);
  document.getElementById('pChildName').textContent = child.name;
  document.getElementById('pGoalText').textContent = `${fmt(tv)} / ${fmt(child.goal_amount)}`;
  document.getElementById('pProgressBar').style.width = pct + '%';
  document.getElementById('pProgressPct').textContent = Math.round(pct) + '%';
  document.getElementById('editVolatility').value = child.volatility;
  document.getElementById('editGoal').value = child.goal_amount;
  document.getElementById('toggleBtn').textContent = child.is_active ? '‚è∏ Pausar' : '‚ñ∂Ô∏è Retomar';
  document.getElementById('childCode').textContent = child.code;
  renderParentTx(child.id);
}

function createChildAccount() {
  const name = document.getElementById('childName').value.trim();
  if (!name) { showToast('Digite o nome', 'error'); return; }
  const age = +document.getElementById('childAge').value, bal = +document.getElementById('childBalance').value;
  const vol = document.getElementById('childVolatility').value, goal = +document.getElementById('childGoal').value;
  const code = genCode(); const assets = {};
  ASSETS.forEach(a => { assets[a.id] = { qty: 0, price: a.basePrice }; });
  const child = { id: Date.now().toString(), parent_id: currentParent.id, name, age, balance: bal, initial_balance: bal, assets, volatility: vol, goal_amount: goal, is_active: 1, code, created_at: new Date().toISOString(), xp: 0, daysActive: 0, gamesPlayed: 0, lastLogin: '' };
  const ch = load('children') || {}; ch[child.id] = child; save('children', ch);
  const ph = load('priceH') || {};
  ASSETS.forEach(a => { ph[child.id + '_' + a.id] = [{ p: a.basePrice, t: Date.now() }]; });
  save('priceH', ph);
  const tx = load('transactions') || {}; tx[child.id] = []; save('transactions', tx);
  showToast(`${name} criado! Codigo: ${code}`, 'success'); refreshParent();
}

function updateConfig() {
  if (!currentChild) return; const ch = load('children') || {}; const c = ch[currentChild.id]; if (!c) return;
  c.volatility = document.getElementById('editVolatility').value;
  c.goal_amount = +document.getElementById('editGoal').value;
  ch[c.id] = c; save('children', ch); currentChild = c; refreshParent();
}

function toggleMarket() {
  if (!currentChild) return; const ch = load('children') || {}; const c = ch[currentChild.id];
  c.is_active = c.is_active ? 0 : 1; ch[c.id] = c; save('children', ch); currentChild = c; refreshParent();
}

function resetChildAccount() {
  if (!currentChild || !confirm('Resetar todo o progresso?')) return;
  const bal = +(prompt('Saldo (R$):', currentChild.initial_balance) || currentChild.initial_balance);
  const goal = +(prompt('Meta (R$):', currentChild.goal_amount) || currentChild.goal_amount);
  const ch = load('children') || {}; const c = ch[currentChild.id];
  c.balance = bal; c.initial_balance = bal; c.goal_amount = goal; c.xp = 0; c.gamesPlayed = 0;
  const assets = {}; ASSETS.forEach(a => { assets[a.id] = { qty: 0, price: a.basePrice }; }); c.assets = assets;
  ch[c.id] = c; save('children', ch);
  const ph = load('priceH') || {};
  ASSETS.forEach(a => { ph[c.id + '_' + a.id] = [{ p: a.basePrice, t: Date.now() }]; });
  save('priceH', ph);
  const tx = load('transactions') || {}; tx[c.id] = []; save('transactions', tx);
  save('challenges_' + c.id, {});
  save('lessons_' + c.id, {});
  currentChild = c; showToast('Resetado!', 'success'); refreshParent();
}

function renderParentTx(cid) {
  const txs = (load('transactions') || {})[cid] || [];
  const el = document.getElementById('pTxList');
  if (!txs.length) { el.innerHTML = '<p style="color:var(--text2);text-align:center;padding:16px;">Nenhuma operacao</p>'; return; }
  el.innerHTML = txs.slice(-20).reverse().map(tx => {
    const a = ASSETS.find(x => x.id === tx.asset) || ASSETS[0];
    return `<div class="tx-item"><div><span class="tx-type ${tx.type === 'BUY' ? 'tx-buy' : 'tx-sell'}">${tx.type === 'BUY' ? 'üü¢ COMPROU' : 'üî¥ VENDEU'}</span><span style="margin-left:6px;color:var(--text2);font-size:.82rem;">${tx.qty} ${a.icon}${a.name} a ${fmt(tx.price)}</span></div><div class="tx-details"><div class="tx-value">${fmt(tx.total)}</div><div class="tx-time">${new Date(tx.time).toLocaleTimeString('pt-BR')}</div></div></div>`;
  }).join('');
}

// ============ TRADING ============
function showTradingPanel() {
  showScreen('trading');
  const ch = load('children') || {}; currentChild = ch[currentChild.id] || currentChild;
  if (!currentChild.assets) {
    const assets = {}; ASSETS.forEach(a => { assets[a.id] = { qty: 0, price: a.basePrice }; });
    currentChild.assets = assets; ch[currentChild.id] = currentChild; save('children', ch);
  }
  loadHistories(); selectedAsset = 'EKO'; selectedCat = 'cripto'; selectedTime = '5m';
  celebrationShown = false; tickCount = 0; totalYieldEarned = currentChild.totalYield || 0;
  currentChildTab = 'Mercado';
  // Set welcome name
  const wbg = document.getElementById('wbGreeting');
  if (wbg) wbg.textContent = `Ola, ${currentChild.name}! üëã`;
  renderCatTabs(); renderAssets(); renderTimeTabs(); updateUI(); startMarket(); startYield();
  updateXPUI(); renderLessons();
  switchChildTab('Mercado');
  // Hide welcome after 5s
  setTimeout(() => {
    const wb = document.getElementById('welcomeBanner');
    if (wb) { wb.style.opacity = '0'; wb.style.transform = 'translateY(-10px)'; setTimeout(() => { wb.style.display = 'none'; }, 300); }
  }, 5000);
}

function loadHistories() {
  const ph = load('priceH') || {}; priceHistories = {};
  ASSETS.forEach(a => { priceHistories[a.id] = ph[currentChild.id + '_' + a.id] || [{ p: a.basePrice, t: Date.now() }]; });
}

function renderCatTabs() {
  document.getElementById('catTabs').innerHTML = CATEGORIES.map(c =>
    `<button class="cat-tab ${selectedCat === c.id ? 'active' : ''}" onclick="selectCat('${c.id}')">${c.icon} ${c.name}</button>`
  ).join('');
}

function selectCat(catId) {
  selectedCat = catId; const first = ASSETS.find(a => a.cat === catId);
  if (first) selectedAsset = first.id; renderCatTabs(); renderAssets(); updateUI();
}

function renderAssets() {
  const filtered = ASSETS.filter(a => a.cat === selectedCat);
  document.getElementById('assetScroll').innerHTML = filtered.map(a => {
    const ad = currentChild.assets?.[a.id]; const price = ad?.price || a.basePrice;
    const h = priceHistories[a.id] || []; const prev = h.length >= 2 ? h[h.length - 2].p : price;
    const chg = prev > 0 ? ((price - prev) / prev * 100).toFixed(1) : '0.0'; const up = price >= prev;
    return `<div class="asset-chip ${selectedAsset === a.id ? 'active' : ''}" onclick="selectAsset('${a.id}')"><span class="a-icon">${a.icon}</span><span class="a-name">${a.name}</span><span class="a-price">${fmt(price)}</span><span class="a-change ${up ? 'up' : 'down'}">${up ? '+' : ''}${chg}%</span></div>`;
  }).join('');
}

function selectAsset(id) {
  selectedAsset = id; tradeQty = 1; document.getElementById('qtyValue').textContent = 1;
  renderAssets(); updateUI();
}

function renderTimeTabs() {
  document.getElementById('timeTabs').innerHTML = TIME_PERIODS.map(t =>
    `<button class="time-tab ${selectedTime === t.id ? 'active' : ''}" onclick="selectTime('${t.id}')">${t.label}</button>`
  ).join('');
}
function selectTime(id) { selectedTime = id; renderTimeTabs(); drawChart(); }

function startMarket() {
  stopMarket();
  ASSETS.forEach(a => { if (!trendData[a.id]) trendData[a.id] = { dir: Math.random() > .4 ? 1 : -1, ticks: ~~(Math.random() * 20) + 8 }; });
  marketInterval = setInterval(tickMarket, 3000);
}
function stopMarket() {
  if (marketInterval) clearInterval(marketInterval); marketInterval = null;
  if (yieldInterval) clearInterval(yieldInterval); yieldInterval = null;
}

// ============ YIELD ============
function getYieldRate(child) {
  const ekoState = child.assets?.['EKO'];
  if (!ekoState || ekoState.qty <= 0) return { rate: 0, perMin: 0 };
  const ekoValue = ekoState.qty * ekoState.price;
  const rate = 0.005;
  const perMin = ekoValue * rate;
  return { rate, perMin, ekoValue, ekoQty: ekoState.qty };
}

function startYield() {
  if (yieldInterval) clearInterval(yieldInterval);
  yieldInterval = setInterval(() => {
    const ch = load('children') || {}; const child = ch[currentChild.id];
    if (!child || !child.is_active) return;
    const y = getYieldRate(child); if (y.perMin <= 0) return;
    const earning = Math.round((y.perMin / 6) * 100) / 100;
    child.balance = Math.round((child.balance + earning) * 100) / 100;
    totalYieldEarned = Math.round((totalYieldEarned + earning) * 100) / 100;
    child.totalYield = totalYieldEarned;
    ch[child.id] = child; save('children', ch); currentChild = child;
    updateYieldUI(child);
  }, 10000);
}

function updateYieldUI(child) {
  const y = getYieldRate(child);
  document.getElementById('yieldRate').textContent = y.perMin > 0 ? `+${(y.rate * 100).toFixed(1)}%/min` : 'Compre EKOs!';
  document.getElementById('yieldPerMin').textContent = y.perMin > 0 ? fmt(y.perMin) : 'R$ 0,00';
  document.getElementById('yieldTotal').textContent = fmt(totalYieldEarned);
  document.getElementById('yieldTime').textContent = y.ekoQty ? `${y.ekoQty} EKOs gerando renda` : 'compre EKOs para ganhar';
}

function tickMarket() {
  const ch = load('children') || {}; const child = ch[currentChild.id];
  if (!child || !child.is_active) return;
  const ph = load('priceH') || {}; tickCount++;
  ASSETS.forEach(asset => {
    const state = child.assets[asset.id]; if (!state) return;
    const np = calcPrice(asset, state.price, child.volatility);
    state.price = np;
    const key = child.id + '_' + asset.id;
    if (!ph[key]) ph[key] = [];
    ph[key].push({ p: np, t: Date.now() });
    if (ph[key].length > 2000) ph[key] = ph[key].slice(-2000);
  });
  ch[child.id] = child; save('children', ch); save('priceH', ph); currentChild = child;
  ASSETS.forEach(a => { priceHistories[a.id] = ph[child.id + '_' + a.id] || []; });
  if (tickCount % 3 === 0) renderAssets();
  if (tickCount % 10 === 0) checkChallenges();
  updateUI();
}

function calcPrice(asset, cur, volatility) {
  let base = { baixa: .012, media: .025, alta: .05 }[volatility] || .025;
  base *= asset.vol;
  let td = trendData[asset.id]; if (!td) { td = { dir: 1, ticks: 10 }; trendData[asset.id] = td; }
  td.ticks--; if (td.ticks <= 0) { td.dir = Math.random() > .4 ? 1 : -1; td.ticks = ~~(Math.random() * 20) + 8; }
  let v = Math.random() * (base * 2) - base;
  v += td.dir * (Math.random() * .008 + .003);
  v -= ((cur - asset.basePrice) / asset.basePrice) * .02;
  let np = cur * (1 + v);
  np = Math.max(asset.basePrice * .08, Math.min(asset.basePrice * 5, np));
  return Math.round(np * 100) / 100;
}

function calcTotal(child) {
  let t = child.balance;
  ASSETS.forEach(a => { const d = child.assets?.[a.id]; if (d) t += d.qty * d.price; });
  return t;
}

function updateUI() {
  const child = currentChild; if (!child) return;
  const ch = load('children') || {}; const fresh = ch[child.id];
  if (fresh) {
    currentChild = fresh;
    document.getElementById('pausedOverlay').classList.toggle('hidden', fresh.is_active === 1);
    document.getElementById('marketDot').classList.toggle('paused', !fresh.is_active);
    document.getElementById('marketStatusText').textContent = fresh.is_active ? 'Ao vivo' : 'Pausado';
  }
  const asset = ASSETS.find(a => a.id === selectedAsset);
  const state = child.assets?.[selectedAsset]; if (!asset || !state) return;
  const price = state.price; const bp = asset.basePrice; const tv = calcTotal(child);

  document.getElementById('cBalance').textContent = fmt(child.balance);
  document.getElementById('cCoinName').textContent = asset.icon + ' ' + asset.name;
  document.getElementById('cCoinType').textContent = CATEGORIES.find(c => c.id === asset.cat)?.name || '';
  document.getElementById('tradeAssetName').textContent = asset.icon + ' ' + asset.name;

  const priceEl = document.getElementById('cPrice'); priceEl.textContent = fmt(price);
  const h = priceHistories[selectedAsset] || []; let prev = bp;
  if (h.length >= 2) prev = h[h.length - 2].p;
  const diff = price - prev; const pct = prev > 0 ? ((diff / prev) * 100).toFixed(1) : '0.0';
  priceEl.className = 'price-value ' + (diff > 0 ? 'price-up' : diff < 0 ? 'price-down' : 'price-stable');
  document.getElementById('cEmoji').textContent = diff > 0 ? 'üöÄ' : diff < 0 ? 'ü™Ç' : 'üìä';
  const chgEl = document.getElementById('cPriceChange');
  chgEl.textContent = `${diff >= 0 ? '+' : ''}${fmt(diff)} (${pct}%)`;
  chgEl.style.color = diff > 0 ? 'var(--green)' : diff < 0 ? 'var(--red)' : 'var(--text2)';

  const prices = h.map(x => x.p);
  document.getElementById('cHigh').textContent = prices.length ? fmt(Math.max(...prices.slice(-100))) : '-';
  document.getElementById('cLow').textContent = prices.length ? fmt(Math.min(...prices.slice(-100))) : '-';
  document.getElementById('cBase').textContent = fmt(bp);
  document.getElementById('chartTitle').textContent = `${asset.icon} ${asset.name}`;

  document.getElementById('cQty').textContent = state.qty;
  document.getElementById('cVal').textContent = fmt(state.qty * price);
  document.getElementById('cTotal').textContent = fmt(tv);

  const cost = price * tradeQty;
  document.getElementById('buyCost').textContent = `${tradeQty} x ${fmt(price)} = ${fmt(cost)}`;
  document.getElementById('sellValue').textContent = `${tradeQty} x ${fmt(price)} = ${fmt(cost)}`;
  const buyBtn = document.getElementById('buyBtn'), sellBtn = document.getElementById('sellBtn');
  buyBtn.disabled = child.balance < cost; sellBtn.disabled = state.qty < tradeQty;
  buyBtn.classList.toggle('glow-green', price < bp * .85 && child.balance >= cost);
  sellBtn.classList.toggle('glow-red', price > bp * 1.25 && state.qty >= tradeQty);

  renderPortfolio(child);

  const ppct = Math.min(100, (tv / child.goal_amount) * 100);
  document.getElementById('cGoalText').textContent = `${fmt(tv)} / ${fmt(child.goal_amount)}`;
  const bar = document.getElementById('cProgressBar'); bar.style.width = ppct + '%';
  document.getElementById('cProgressPct').textContent = Math.round(ppct) + '%';
  bar.classList.remove('near-goal', 'goal-reached');
  if (ppct >= 100) bar.classList.add('goal-reached'); else if (ppct >= 90) bar.classList.add('near-goal');
  if (ppct >= 100 && !celebrationShown) { celebrationShown = true; showCelebration(tv, child.goal_amount); }

  updateYieldUI(child); renderRanking(child); renderNews(); renderChallenges(); drawChart(); renderChildTx();
  updateXPUI();
}

// ============ RANKING ============
function renderRanking(child) {
  const el = document.getElementById('rankList');
  const allChildren = Object.values(load('children') || {});
  const players = allChildren.map(c => {
    const tv = calcTotal(c);
    const numAssets = ASSETS.filter(a => (c.assets?.[a.id]?.qty || 0) > 0).length;
    return { name: c.name, value: tv, numAssets, me: c.id === child.id };
  });
  players.sort((a, b) => b.value - a.value);
  if (!players.length) { el.innerHTML = '<p style="color:var(--text2);text-align:center;font-size:.8rem;">Nenhum investidor</p>'; return; }
  el.innerHTML = players.map((p, i) => {
    const posClass = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other';
    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
    return `<div class="rank-item ${p.me ? 'me' : ''}"><div class="rank-pos ${posClass}">${medal || i + 1}</div><div class="rank-info"><div class="rank-name">${p.me ? '‚≠ê ' : ''}${p.name}${p.me ? ' (Voce)' : ''}</div><div class="rank-assets">${p.numAssets} ativo${p.numAssets !== 1 ? 's' : ''}</div></div><div class="rank-value" style="color:${p.me ? 'var(--gold)' : 'var(--text)'}">${fmt(p.value)}</div></div>`;
  }).join('');
}

function renderPortfolio(child) {
  const grid = document.getElementById('portfolioGrid');
  const owned = ASSETS.filter(a => (child.assets?.[a.id]?.qty || 0) > 0);
  if (!owned.length) { grid.innerHTML = '<p style="color:var(--text2);font-size:.75rem;grid-column:1/-1;text-align:center;">Carteira vazia</p>'; return; }
  grid.innerHTML = owned.map(a => {
    const d = child.assets[a.id];
    return `<div class="portfolio-coin" onclick="selectAsset('${a.id}');selectCat('${a.cat}')" style="${selectedAsset === a.id ? 'border-color:' + a.color : ''}"><span class="pc-icon">${a.icon}</span><div class="pc-info"><div class="pc-name">${a.name}</div><div class="pc-qty">${d.qty} unid.</div></div><div class="pc-val" style="color:${a.color}">${fmt(d.qty * d.price)}</div></div>`;
  }).join('');
}

// ============ TRADE CONFIRMATION ============
let pendingTrade = null, selectedReason = '';

const BUY_REASONS = [
  { icon: 'üìâ', text: 'O preco caiu e esta barato (comprar na baixa)' },
  { icon: 'üìä', text: 'Acredito que vai subir em breve' },
  { icon: 'üíé', text: 'Quero ter mais dessa moeda para o rendimento' },
  { icon: 'üéØ', text: 'Faz parte da minha estrategia para a meta' },
];
const SELL_REASONS = [
  { icon: 'üìà', text: 'O preco subiu bastante (vender na alta)' },
  { icon: 'üí∞', text: 'Quero garantir meu lucro agora' },
  { icon: 'üîÑ', text: 'Quero trocar por outro ativo melhor' },
  { icon: 'üéØ', text: 'Preciso de saldo para outra oportunidade' },
];

function confirmTrade(type) {
  const asset = ASSETS.find(a => a.id === selectedAsset);
  const state = currentChild.assets?.[selectedAsset]; if (!asset || !state) return;
  const total = state.price * tradeQty;
  if (type === 'BUY' && currentChild.balance < total) { showToast('Saldo insuficiente!', 'error'); return; }
  if (type === 'SELL' && state.qty < tradeQty) { showToast('Quantidade insuficiente!', 'error'); return; }
  pendingTrade = { type, asset: selectedAsset, qty: tradeQty, price: state.price, total };
  selectedReason = '';
  document.getElementById('confirmTitle').textContent = `${type === 'BUY' ? 'Comprar' : 'Vender'} ${asset.icon} ${asset.name}?`;
  document.getElementById('confirmDetail').textContent = `${tradeQty} unid. por ${fmt(total)}`;
  document.getElementById('confirmBtn').disabled = true;
  const reasons = type === 'BUY' ? BUY_REASONS : SELL_REASONS;
  document.getElementById('reasonOptions').innerHTML = reasons.map((r, i) =>
    `<button class="reason-btn" onclick="pickReason(${i})" id="reason${i}"><span class="reason-icon">${r.icon}</span>${r.text}</button>`
  ).join('');
  document.getElementById('confirmOverlay').classList.remove('hidden');
}

function pickReason(i) {
  selectedReason = i;
  document.querySelectorAll('.reason-btn').forEach((b, j) => {
    b.style.borderColor = j === i ? 'var(--gold)' : 'var(--glass-border)';
    b.style.background = j === i ? 'rgba(245,158,11,0.08)' : 'rgba(0,0,0,0.2)';
  });
  document.getElementById('confirmBtn').disabled = false;
}

function cancelTrade() { pendingTrade = null; document.getElementById('confirmOverlay').classList.add('hidden'); }

function executeTrade() {
  if (!pendingTrade) return;
  document.getElementById('confirmOverlay').classList.add('hidden');
  if (pendingTrade.type === 'BUY') execBuy(pendingTrade.qty);
  else execSell(pendingTrade.qty);
  checkChallenges();
  addXP(5, 'Operacao realizada!');
  pendingTrade = null;
}

function execBuy(qty) {
  const ch = load('children') || {}; const child = ch[currentChild.id]; if (!child || !child.is_active) return;
  const asset = ASSETS.find(a => a.id === selectedAsset); const state = child.assets[selectedAsset];
  const cost = state.price * qty; if (child.balance < cost) return;
  child.balance = Math.round((child.balance - cost) * 100) / 100; state.qty += qty;
  ch[child.id] = child; save('children', ch); currentChild = child;
  const tx = load('transactions') || {}; if (!tx[child.id]) tx[child.id] = [];
  tx[child.id].push({ type: 'BUY', asset: selectedAsset, qty, price: state.price, total: cost, time: Date.now() });
  save('transactions', tx); showToast(`Comprou ${qty} ${asset.icon}${asset.name}!`, 'success'); updateUI();
}

function execSell(qty) {
  const ch = load('children') || {}; const child = ch[currentChild.id]; if (!child || !child.is_active) return;
  const asset = ASSETS.find(a => a.id === selectedAsset); const state = child.assets[selectedAsset];
  if (state.qty < qty) return;
  const val = state.price * qty; child.balance = Math.round((child.balance + val) * 100) / 100; state.qty -= qty;
  ch[child.id] = child; save('children', ch); currentChild = child;
  const tx = load('transactions') || {}; if (!tx[child.id]) tx[child.id] = [];
  tx[child.id].push({ type: 'SELL', asset: selectedAsset, qty, price: state.price, total: val, time: Date.now() });
  save('transactions', tx); showToast(`Vendeu ${qty} ${asset.icon}${asset.name}!`, 'success'); updateUI();
}

function buyMax() {
  const state = currentChild.assets?.[selectedAsset]; if (!state) return;
  const maxQty = Math.floor(currentChild.balance / state.price);
  if (maxQty <= 0) { showToast('Saldo insuficiente!', 'error'); return; }
  tradeQty = maxQty; document.getElementById('qtyValue').textContent = tradeQty; confirmTrade('BUY');
}

function sellMax() {
  const state = currentChild.assets?.[selectedAsset]; if (!state || state.qty <= 0) { showToast('Voce nao tem esse ativo!', 'error'); return; }
  tradeQty = state.qty; document.getElementById('qtyValue').textContent = tradeQty; confirmTrade('SELL');
}

function changeQty(d) { tradeQty = Math.max(1, tradeQty + d); document.getElementById('qtyValue').textContent = tradeQty; updateUI(); }

// ============ NEWS ============
const NEWS_TEMPLATES = [
  { text: 'üè≠ Fabrica de {asset} aumentou producao! Especialistas dizem que o preco pode {dir}.', hint: 'Pense: mais oferta = preco tende a cair?', forUp: false },
  { text: 'üåç Muitas pessoas querem comprar {asset}! A demanda esta altissima.', hint: 'Dica: quando todos querem, o preco geralmente sobe!', forUp: true },
  { text: 'üì± Uma nova tecnologia usa {asset}. Investidores estao animados!', hint: 'Novidades boas costumam fazer o preco subir.', forUp: true },
  { text: '‚ö†Ô∏è Especialistas dizem que {asset} esta caro demais agora.', hint: 'Quando esta caro, pode ser hora de vender e esperar cair.', forUp: false },
  { text: 'üéâ {asset} bateu recorde de vendas essa semana!', hint: 'Recordes podem significar que o preco ainda vai subir.', forUp: true },
  { text: 'üò∞ Investidores estao com medo e vendendo {asset}.', hint: 'Quando todos vendem, o preco cai. Pode ser hora de comprar barato!', forUp: false },
  { text: 'üè¶ O Banco Central disse que {asset} e um bom investimento.', hint: 'Noticias positivas de autoridades fazem o preco subir.', forUp: true },
  { text: 'üåßÔ∏è Problemas de transporte afetaram a entrega de {asset}.', hint: 'Problemas = menos oferta. O que acontece com o preco?', forUp: true },
];

let currentNews = [];
function generateNews() {
  currentNews = [];
  const shuffled = [...NEWS_TEMPLATES].sort(() => Math.random() - .5);
  for (let i = 0; i < 2; i++) {
    const template = shuffled[i];
    const asset = ASSETS[~~(Math.random() * ASSETS.length)];
    currentNews.push({
      text: template.text.replace('{asset}', asset.icon + ' ' + asset.name).replace('{dir}', template.forUp ? 'subir' : 'cair'),
      hint: template.hint, asset: asset.id, forUp: template.forUp
    });
  }
}

function renderNews() {
  const el = document.getElementById('newsContainer');
  if (!currentNews.length) generateNews();
  el.innerHTML = currentNews.map(n => `<div class="news-item">${n.text}<span class="news-hint">üí° ${n.hint}</span></div>`).join('');
}

setInterval(() => { generateNews(); renderNews(); }, 45000);

// ============ CHALLENGES ============
const CHALLENGE_DEFS = [
  { id: 'buy_low', icon: 'üìâ', name: 'Comprar na Baixa', desc: 'Compre qualquer ativo quando estiver abaixo do preco base', reward: '+R$ 5', check: c => { const txs = (load('transactions') || {})[c.id] || []; return txs.some(t => { if (t.type !== 'BUY') return false; const a = ASSETS.find(x => x.id === t.asset); return a && t.price < a.basePrice; }); } },
  { id: 'sell_high', icon: 'üìà', name: 'Vender na Alta', desc: 'Venda qualquer ativo quando estiver acima de 120% do base', reward: '+R$ 5', check: c => { const txs = (load('transactions') || {})[c.id] || []; return txs.some(t => { if (t.type !== 'SELL') return false; const a = ASSETS.find(x => x.id === t.asset); return a && t.price > a.basePrice * 1.2; }); } },
  { id: 'diversify', icon: 'üåà', name: 'Diversificar', desc: 'Tenha pelo menos 3 ativos diferentes na carteira', reward: '+R$ 10', check: c => ASSETS.filter(a => (c.assets?.[a.id]?.qty || 0) > 0).length >= 3 },
  { id: 'patience', icon: 'üßò', name: 'Paciencia', desc: 'Acumule mais de R$ 20 em rendimento passivo (EKOs)', reward: '+R$ 8', check: c => (c.totalYield || 0) >= 20 },
  { id: 'profit', icon: 'üí∞', name: 'Lucro Real', desc: 'Tenha patrimonio 30% acima do saldo inicial', reward: '+R$ 15', check: c => calcTotal(c) >= c.initial_balance * 1.3 },
  { id: 'trader', icon: '‚ö°', name: 'Trader Ativo', desc: 'Faca 10 operacoes no total', reward: '+R$ 5', check: c => { const txs = (load('transactions') || {})[c.id] || []; return txs.length >= 10; } },
];

function renderChallenges() {
  const el = document.getElementById('challengesList'); const child = currentChild;
  const completed = load('challenges_' + child.id) || {};
  el.innerHTML = CHALLENGE_DEFS.map(ch => {
    const done = completed[ch.id] || false;
    return `<div class="challenge-item ${done ? 'completed' : ''}"><span class="challenge-icon">${ch.icon}</span><div class="challenge-info"><div class="challenge-name">${ch.name}</div><div class="challenge-desc">${ch.desc}</div></div>${done ? '<span class="challenge-check">‚úÖ</span>' : `<span class="challenge-reward">${ch.reward}</span>`}</div>`;
  }).join('');
}

function checkChallenges() {
  const ch = load('children') || {}; const child = ch[currentChild.id]; if (!child) return;
  const completed = load('challenges_' + child.id) || {};
  let earned = false;
  CHALLENGE_DEFS.forEach(chal => {
    if (completed[chal.id]) return;
    if (chal.check(child)) {
      completed[chal.id] = true;
      const reward = parseFloat(chal.reward.replace(/[^0-9.]/g, '')) || 0;
      child.balance = Math.round((child.balance + reward) * 100) / 100;
      earned = true;
      showToast(`üéØ Desafio "${chal.name}" completo! ${chal.reward}`, 'success');
      setTimeout(() => addXP(20, 'Desafio completo!'), 500);
    }
  });
  if (earned) { ch[child.id] = child; save('children', ch); currentChild = child; save('challenges_' + child.id, completed); }
  renderChallenges();
}

function renderChildTx() {
  const txs = ((load('transactions') || {})[currentChild.id] || []);
  const el = document.getElementById('cTxList');
  if (!txs.length) { el.innerHTML = '<p style="color:var(--text2);text-align:center;padding:10px;font-size:.85rem;">Faca sua primeira operacao!</p>'; return; }
  el.innerHTML = txs.slice(-10).reverse().map(tx => {
    const a = ASSETS.find(x => x.id === tx.asset) || ASSETS[0];
    return `<div class="tx-feed-item"><span>${tx.type === 'BUY' ? 'üü¢' : 'üî¥'} ${tx.type === 'BUY' ? 'Comprou' : 'Vendeu'} ${tx.qty} ${a.icon}${a.name} a ${fmt(tx.price)}</span><span style="font-weight:800;color:${tx.type === 'BUY' ? 'var(--red)' : 'var(--green)'}">${tx.type === 'BUY' ? '-' : '+'}${fmt(tx.total)}</span></div>`;
  }).join('');
}

// ============ CHART ============
function drawChart() {
  const canvas = document.getElementById('priceChart'); if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width; canvas.height = rect.height;
  const asset = ASSETS.find(a => a.id === selectedAsset);
  let allData = priceHistories[selectedAsset] || [];
  const period = TIME_PERIODS.find(t => t.id === selectedTime);
  if (period && period.seconds !== Infinity) {
    const cutoff = Date.now() - period.seconds * 1000;
    allData = allData.filter(d => d.t >= cutoff);
  }
  if (allData.length < 2) { ctx.fillStyle = '#7a8ba8'; ctx.font = '13px sans-serif'; ctx.textAlign = 'center'; ctx.fillText('Coletando dados...', canvas.width / 2, canvas.height / 2); return; }
  let data = allData; const maxPts = 150;
  if (data.length > maxPts) { const step = Math.ceil(data.length / maxPts); data = data.filter((_, i) => i % step === 0); if (data[data.length - 1] !== allData[allData.length - 1]) data.push(allData[allData.length - 1]); }
  const prices = data.map(d => d.p);
  const min = Math.min(...prices) * .97; const max = Math.max(...prices) * 1.03;
  const range = max - min || 1;
  const w = canvas.width, h = canvas.height, pad = 8;
  const stepX = w / (prices.length - 1);

  ctx.strokeStyle = '#1f2d4722'; ctx.lineWidth = .5;
  for (let i = 0; i <= 5; i++) { const y = pad + ((h - pad * 2) / 5) * i; ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke(); }
  ctx.fillStyle = '#4a5568'; ctx.font = '9px sans-serif'; ctx.textAlign = 'right';
  for (let i = 0; i <= 4; i++) { const y = pad + ((h - pad * 2) / 4) * i; const val = max - (range / 4) * i; ctx.fillText(`${val.toFixed(val >= 100 ? 0 : 1)}`, w - 4, y + 3); }

  const baseY = h - pad - ((asset.basePrice - min) / range) * (h - pad * 2);
  ctx.strokeStyle = '#f59e0b33'; ctx.lineWidth = 1; ctx.setLineDash([4, 4]);
  ctx.beginPath(); ctx.moveTo(0, baseY); ctx.lineTo(w, baseY); ctx.stroke(); ctx.setLineDash([]);

  const pts = prices.map((p, i) => ({ x: i * stepX, y: h - pad - ((p - min) / range) * (h - pad * 2) }));
  const lastP = prices[prices.length - 1]; const lineColor = asset.color;

  ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
  for (let i = 1; i < pts.length; i++) {
    const prev2 = pts[i - 1], cur = pts[i];
    const cpx = (prev2.x + cur.x) / 2;
    ctx.bezierCurveTo(cpx, prev2.y, cpx, cur.y, cur.x, cur.y);
  }
  ctx.strokeStyle = lineColor; ctx.lineWidth = 2.5; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.stroke();
  ctx.shadowColor = lineColor; ctx.shadowBlur = 8; ctx.stroke(); ctx.shadowBlur = 0;

  const lastPt = pts[pts.length - 1];
  ctx.lineTo(lastPt.x, h); ctx.lineTo(pts[0].x, h); ctx.closePath();
  const grad = ctx.createLinearGradient(0, 0, 0, h);
  grad.addColorStop(0, lineColor + '30'); grad.addColorStop(.6, lineColor + '08'); grad.addColorStop(1, 'transparent');
  ctx.fillStyle = grad; ctx.fill();

  if (prices.length > 3) {
    const barH = h * .12;
    for (let i = 1; i < prices.length; i++) {
      const change = Math.abs(prices[i] - prices[i - 1]) / prices[i - 1];
      const bh = Math.min(barH, change * barH * 40);
      const x = i * stepX;
      ctx.fillStyle = prices[i] >= prices[i - 1] ? 'rgba(34,197,94,.15)' : 'rgba(239,68,68,.15)';
      ctx.fillRect(x - stepX / 3, h - bh, stepX * .6, bh);
    }
  }

  ctx.beginPath(); ctx.arc(lastPt.x, lastPt.y, 7, 0, Math.PI * 2); ctx.fillStyle = lineColor + '33'; ctx.fill();
  ctx.beginPath(); ctx.arc(lastPt.x, lastPt.y, 4, 0, Math.PI * 2); ctx.fillStyle = lineColor; ctx.fill();
  ctx.strokeStyle = '#fff'; ctx.lineWidth = 1.5; ctx.stroke();
  ctx.fillStyle = lineColor; ctx.font = 'bold 10px sans-serif'; ctx.textAlign = 'right';
  ctx.fillText(fmt(lastP), lastPt.x - 8, lastPt.y - 8);
}

// ============ CELEBRATION ============
function showCelebration(tv, goal) {
  document.getElementById('celebrationText').textContent = `Patrimonio: ${fmt(tv)} - Meta: ${fmt(goal)}`;
  document.getElementById('celebrationOverlay').classList.remove('hidden'); createConfetti();
}
function closeCelebration() { document.getElementById('celebrationOverlay').classList.add('hidden'); }
function createConfetti() {
  const colors = ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
  for (let i = 0; i < 60; i++) {
    const c = document.createElement('div');
    c.style.cssText = `position:fixed;width:${Math.random() * 10 + 5}px;height:${Math.random() * 10 + 5}px;background:${colors[~~(Math.random() * colors.length)]};left:${Math.random() * 100}vw;top:-20px;border-radius:${Math.random() > .5 ? '50%' : '2px'};z-index:1100;pointer-events:none;animation:cFall ${Math.random() * 2 + 2}s ease-in forwards;`;
    document.body.appendChild(c); setTimeout(() => c.remove(), 4000);
  }
  if (!document.getElementById('cStyle')) { const s = document.createElement('style'); s.id = 'cStyle'; s.textContent = '@keyframes cFall{to{transform:translateY(110vh) rotate(720deg);opacity:0}}'; document.head.appendChild(s); }
}

// ============ UTILS ============
function fmt(v) { return 'R$ ' + (v || 0).toFixed(2).replace('.', ','); }
function showToast(m, t) {
  const el = document.createElement('div'); el.className = `toast toast-${t}`; el.textContent = m;
  document.body.appendChild(el); setTimeout(() => el.remove(), 3000);
}

// ============================================================
// MINI-GAMES
// ============================================================

// ====== GAME 1: QUIZ DO INVESTIDOR ======
const QUIZ_QUESTIONS = [
  { q: 'O que acontece quando muita gente quer comprar algo?', opts: ['O preco sobe', 'O preco cai', 'Nada acontece', 'O produto some'], correct: 0 },
  { q: 'O que significa diversificar?', opts: ['Comprar so uma coisa', 'Investir em coisas diferentes', 'Vender tudo', 'Guardar dinheiro em casa'], correct: 1 },
  { q: 'Se voce compra por R$5 e vende por R$8, qual o lucro?', opts: ['R$8', 'R$5', 'R$3', 'R$13'], correct: 2 },
  { q: 'O que e inflacao?', opts: ['Quando as coisas ficam mais baratas', 'Quando as coisas ficam mais caras', 'Quando o dinheiro aumenta', 'Quando o banco fecha'], correct: 1 },
  { q: 'Qual a melhor hora de comprar?', opts: ['Quando o preco esta alto', 'Quando o preco esta baixo', 'Quando todo mundo compra', 'Nunca'], correct: 1 },
  { q: 'O que e um investimento?', opts: ['Gastar dinheiro com doces', 'Colocar dinheiro para ele crescer', 'Emprestar dinheiro', 'Guardar moedas'], correct: 1 },
  { q: 'O que e lucro?', opts: ['O dinheiro que voce gasta', 'O dinheiro que voce ganha alem do que investiu', 'O preco de um produto', 'O salario do mes'], correct: 1 },
  { q: 'Por que poupar dinheiro e importante?', opts: ['Para ter seguranca no futuro', 'Nao e importante', 'Para impressionar amigos', 'Para o dinheiro ficar velho'], correct: 0 },
  { q: 'O que e uma acao?', opts: ['Um pedacinho de uma empresa', 'Um tipo de doce', 'Uma conta bancaria', 'Um emprestimo'], correct: 0 },
  { q: 'Se um produto custa R$10 e tem desconto de 20%, quanto voce paga?', opts: ['R$8', 'R$2', 'R$10', 'R$12'], correct: 0 },
  { q: 'O que e risco no investimento?', opts: ['A chance de perder dinheiro', 'Ganhar muito dinheiro', 'Comprar algo caro', 'Vender algo barato'], correct: 0 },
  { q: 'O que e empreendedor?', opts: ['Alguem que cria um negocio', 'Alguem que gasta muito', 'Alguem que so poupa', 'Alguem que nao trabalha'], correct: 0 },
  { q: 'O que significa "oferta e demanda"?', opts: ['Quantos querem vender vs quantos querem comprar', 'Uma promocao de loja', 'Um tipo de investimento', 'O nome de um banco'], correct: 0 },
  { q: 'Qual a melhor hora de vender um investimento?', opts: ['Quando o preco esta alto', 'Quando o preco esta baixo', 'Nunca', 'No inicio'], correct: 0 },
  { q: 'O que e juros?', opts: ['O dinheiro extra que o banco te paga por guardar', 'Um imposto', 'O preco de algo', 'Um desconto'], correct: 0 },
  { q: 'O que significa "comprar na baixa e vender na alta"?', opts: ['A estrategia basica de ganhar dinheiro investindo', 'Comprar coisas baratas', 'Vender coisas caras', 'Nao investir'], correct: 0 },
];

let quizState = { current: 0, score: 0, questions: [], answered: false };

function startQuiz() {
  quizState = { current: 0, score: 0, questions: shuffle([...QUIZ_QUESTIONS]).slice(0, 8), answered: false };
  document.getElementById('gameOverlay').classList.remove('hidden');
  renderQuiz();
}

function renderQuiz() {
  const gc = document.getElementById('gameContainer');
  const q = quizState.questions[quizState.current];
  const total = quizState.questions.length;
  gc.innerHTML = `
    <button class="game-back" onclick="closeGame()">‚Üê Voltar</button>
    <div class="game-title-bar"><h2>üß† Quiz do Investidor</h2><p>Pergunta ${quizState.current + 1} de ${total}</p></div>
    <div class="quiz-progress">${quizState.questions.map((_, i) => `<div class="quiz-dot ${i < quizState.current ? 'done' : i === quizState.current ? 'current' : ''}"></div>`).join('')}</div>
    <div class="glass-card" style="margin-bottom:16px;"><p style="font-size:1.05rem;font-weight:800;line-height:1.5;text-align:center;">${q.q}</p></div>
    <div>${q.opts.map((o, i) => `<button class="quiz-option" onclick="answerQuiz(${i})" id="qopt${i}">${o}</button>`).join('')}</div>
    <div style="text-align:center;margin-top:12px;"><span style="color:var(--gold);font-weight:800;">Pontos: ${quizState.score}/${total}</span></div>
  `;
}

function answerQuiz(idx) {
  if (quizState.answered) return;
  quizState.answered = true;
  const q = quizState.questions[quizState.current];
  const correct = idx === q.correct;
  if (correct) quizState.score++;
  document.getElementById('qopt' + idx).classList.add(correct ? 'correct' : 'wrong');
  if (!correct) document.getElementById('qopt' + q.correct).classList.add('correct');
  setTimeout(() => {
    quizState.current++;
    quizState.answered = false;
    if (quizState.current >= quizState.questions.length) {
      showQuizResult();
    } else {
      renderQuiz();
    }
  }, 1200);
}

function showQuizResult() {
  const gc = document.getElementById('gameContainer');
  const total = quizState.questions.length;
  const pct = Math.round((quizState.score / total) * 100);
  const xpEarned = Math.round((quizState.score / total) * 15);
  let msg = pct >= 80 ? 'Incrivel! Voce e um genio!' : pct >= 50 ? 'Muito bem! Continue aprendendo!' : 'Continue estudando, voce vai melhorar!';
  let emoji = pct >= 80 ? 'üèÜ' : pct >= 50 ? '‚≠ê' : 'üìö';
  gc.innerHTML = `
    <button class="game-back" onclick="closeGame()">‚Üê Voltar</button>
    <div style="text-align:center;padding:40px 20px;">
      <div style="font-size:4rem;margin-bottom:16px;">${emoji}</div>
      <h2 style="font-size:1.5rem;font-weight:900;margin-bottom:8px;">Quiz Completo!</h2>
      <p style="font-size:1.1rem;color:var(--text2);margin-bottom:6px;">${quizState.score} de ${total} corretas (${pct}%)</p>
      <p style="font-size:1rem;font-weight:700;margin-bottom:20px;">${msg}</p>
      <p style="color:var(--gold);font-weight:900;font-size:1.1rem;margin-bottom:24px;">+${xpEarned} XP</p>
      <button class="btn btn-primary ripple" style="max-width:240px;margin:0 auto 10px;" onclick="startQuiz()">Jogar Novamente üîÑ</button>
      <button class="btn btn-outline" style="max-width:240px;margin:0 auto;" onclick="closeGame()">Voltar aos Jogos</button>
    </div>
  `;
  if (xpEarned > 0) addXP(xpEarned, 'Quiz completo!');
  incrementGamesPlayed();
}

// ====== GAME 2: FABRICA DE LIMONADA ======
let lemonState = {};

function startLemonade() {
  lemonState = { round: 1, totalRounds: 5, money: 20, totalProfit: 0, history: [] };
  document.getElementById('gameOverlay').classList.remove('hidden');
  renderLemonadeRound();
}

function renderLemonadeRound() {
  const gc = document.getElementById('gameContainer');
  const weathers = [
    { name: 'Ensolarado', emoji: '‚òÄÔ∏è', demand: 1.5, desc: 'Dia perfeito para limonada!' },
    { name: 'Nublado', emoji: '‚õÖ', demand: 1.0, desc: 'Um dia normal.' },
    { name: 'Chuvoso', emoji: 'üåßÔ∏è', demand: 0.4, desc: 'Pouca gente na rua...' },
    { name: 'Muito Quente', emoji: 'üî•', demand: 2.0, desc: 'Todo mundo quer algo gelado!' },
  ];
  const weather = weathers[~~(Math.random() * weathers.length)];
  lemonState.currentWeather = weather;

  gc.innerHTML = `
    <button class="game-back" onclick="closeGame()">‚Üê Voltar</button>
    <div class="game-title-bar"><h2>üçã Fabrica de Limonada</h2><p>Rodada ${lemonState.round} de ${lemonState.totalRounds}</p></div>
    <div class="weather-display">
      <span class="weather-icon">${weather.emoji}</span>
      <div class="weather-text">${weather.name}</div>
      <div style="color:var(--text2);font-size:.85rem;margin-top:4px;">${weather.desc}</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
      <div class="lemon-stat"><div class="ls-val" style="color:var(--gold)">${fmt(lemonState.money)}</div><div class="ls-label">Seu Dinheiro</div></div>
      <div class="lemon-stat"><div class="ls-val" style="color:var(--green)">${fmt(lemonState.totalProfit)}</div><div class="ls-label">Lucro Total</div></div>
    </div>
    <div class="glass-card">
      <p style="font-size:.85rem;color:var(--text2);margin-bottom:12px;text-align:center;">Cada copo custa R$ 1,00 para fazer. Decida quantos copos fazer e o preco de venda!</p>
      <div class="lemon-controls">
        <div class="lemon-control"><label>ü•§ Copos para fazer:</label><div class="lemon-input"><input type="number" id="lemonCups" value="10" min="1" max="50"></div></div>
        <div class="lemon-control"><label>üí∞ Preco por copo:</label><div class="lemon-input">R$ <input type="number" id="lemonPrice" value="3" min="1" max="10" step="0.5"></div></div>
      </div>
      <p style="font-size:.78rem;color:var(--text2);text-align:center;" id="lemonCostPreview">Custo: R$ 10,00</p>
    </div>
    <button class="btn btn-primary ripple" style="margin-top:12px;" onclick="playLemonadeRound()">Vender! üçã</button>
  `;

  document.getElementById('lemonCups').addEventListener('input', updateLemonPreview);
  document.getElementById('lemonPrice').addEventListener('input', updateLemonPreview);
}

function updateLemonPreview() {
  const cups = Math.max(1, +document.getElementById('lemonCups').value || 0);
  const cost = cups * 1;
  document.getElementById('lemonCostPreview').textContent = `Custo: ${fmt(cost)}`;
}

function playLemonadeRound() {
  const cups = Math.min(50, Math.max(1, +document.getElementById('lemonCups').value || 10));
  const price = Math.min(10, Math.max(1, +document.getElementById('lemonPrice').value || 3));
  const cost = cups * 1;
  if (cost > lemonState.money) { showToast('Dinheiro insuficiente!', 'error'); return; }

  const weather = lemonState.currentWeather;
  const baseDemand = ~~(Math.random() * 8 + 8);
  const actualDemand = Math.min(cups, ~~(baseDemand * weather.demand * (price < 3 ? 1.3 : price > 5 ? 0.6 : 1)));
  const revenue = actualDemand * price;
  const profit = revenue - cost;

  lemonState.money = Math.round((lemonState.money + profit) * 100) / 100;
  lemonState.totalProfit = Math.round((lemonState.totalProfit + profit) * 100) / 100;
  lemonState.history.push({ round: lemonState.round, cups, price, sold: actualDemand, cost, revenue, profit, weather: weather.name });

  const gc = document.getElementById('gameContainer');
  const profitColor = profit >= 0 ? 'var(--green)' : 'var(--red)';
  gc.innerHTML = `
    <button class="game-back" onclick="closeGame()">‚Üê Voltar</button>
    <div class="game-title-bar"><h2>üçã Resultado da Rodada ${lemonState.round}</h2></div>
    <div class="glass-card" style="text-align:center;">
      <p style="font-size:1.1rem;margin-bottom:12px;">Voce fez <strong>${cups}</strong> copos e vendeu <strong>${actualDemand}</strong>!</p>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;">
        <div><div style="font-size:.7rem;color:var(--text2);text-transform:uppercase;">Custo</div><div style="font-size:1.1rem;font-weight:900;color:var(--red)">${fmt(cost)}</div></div>
        <div><div style="font-size:.7rem;color:var(--text2);text-transform:uppercase;">Receita</div><div style="font-size:1.1rem;font-weight:900;color:var(--blue)">${fmt(revenue)}</div></div>
        <div><div style="font-size:.7rem;color:var(--text2);text-transform:uppercase;">Lucro</div><div style="font-size:1.1rem;font-weight:900;color:${profitColor}">${profit >= 0 ? '+' : ''}${fmt(profit)}</div></div>
      </div>
      ${actualDemand < cups ? `<p style="font-size:.82rem;color:var(--orange);">üí° ${cups - actualDemand} copos sobraram! Tente fazer menos ou abaixar o preco.</p>` : `<p style="font-size:.82rem;color:var(--green);">üéâ Vendeu tudo! Podia ter feito mais copos.</p>`}
    </div>
    <button class="btn btn-primary ripple" style="margin-top:14px;" onclick="nextLemonadeRound()">
      ${lemonState.round < lemonState.totalRounds ? `Proxima Rodada (${lemonState.round + 1}/${lemonState.totalRounds})` : 'Ver Resultado Final'}
    </button>
  `;
}

function nextLemonadeRound() {
  lemonState.round++;
  if (lemonState.round > lemonState.totalRounds) {
    showLemonadeResult();
  } else {
    renderLemonadeRound();
  }
}

function showLemonadeResult() {
  const gc = document.getElementById('gameContainer');
  const profit = lemonState.totalProfit;
  const xpEarned = profit > 10 ? 15 : profit > 0 ? 10 : 5;
  let msg = profit > 10 ? 'Empresario de sucesso!' : profit > 0 ? 'Bom trabalho, deu lucro!' : 'Prejuizo, mas voce aprendeu!';
  let emoji = profit > 10 ? 'üèÜ' : profit > 0 ? 'üëç' : 'üìö';
  gc.innerHTML = `
    <button class="game-back" onclick="closeGame()">‚Üê Voltar</button>
    <div style="text-align:center;padding:30px 20px;">
      <div style="font-size:4rem;margin-bottom:14px;">${emoji}</div>
      <h2 style="font-size:1.5rem;font-weight:900;margin-bottom:8px;">Jogo Completo!</h2>
      <p style="font-size:1.1rem;font-weight:800;color:${profit >= 0 ? 'var(--green)' : 'var(--red)'};margin-bottom:6px;">Lucro total: ${profit >= 0 ? '+' : ''}${fmt(profit)}</p>
      <p style="font-size:1rem;color:var(--text2);margin-bottom:6px;">${msg}</p>
      <p style="color:var(--gold);font-weight:900;font-size:1.1rem;margin-bottom:20px;">+${xpEarned} XP</p>
      <div class="glass-card" style="text-align:left;margin-bottom:16px;">
        <p style="font-size:.82rem;font-weight:800;margin-bottom:8px;">üìä Resumo:</p>
        ${lemonState.history.map(h => `<div style="display:flex;justify-content:space-between;font-size:.78rem;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.04);">
          <span>${h.weather} - ${h.sold}/${h.cups} copos a ${fmt(h.price)}</span>
          <span style="color:${h.profit >= 0 ? 'var(--green)' : 'var(--red)'}; font-weight:800;">${h.profit >= 0 ? '+' : ''}${fmt(h.profit)}</span>
        </div>`).join('')}
      </div>
      <button class="btn btn-primary ripple" style="max-width:240px;margin:0 auto 10px;" onclick="startLemonade()">Jogar Novamente üîÑ</button>
      <button class="btn btn-outline" style="max-width:240px;margin:0 auto;" onclick="closeGame()">Voltar aos Jogos</button>
    </div>
  `;
  addXP(xpEarned, 'Fabrica de Limonada!');
  incrementGamesPlayed();
}

// ====== GAME 3: DESAFIO DO ORCAMENTO ======
const BUDGET_ITEMS = [
  { name: 'Comida da Semana', icon: 'üçé', price: 30, type: 'need', tag: 'Necessidade' },
  { name: 'Brinquedo Legal', icon: 'üß∏', price: 50, type: 'want', tag: 'Desejo' },
  { name: 'Poupanca', icon: 'üè¶', price: 20, type: 'save', tag: 'Poupanca' },
  { name: 'Roupa Nova', icon: 'üëï', price: 25, type: 'need', tag: 'Necessidade' },
  { name: 'Doces', icon: 'üç¨', price: 10, type: 'want', tag: 'Desejo' },
  { name: 'Livro Educativo', icon: 'üìñ', price: 15, type: 'need', tag: 'Necessidade' },
  { name: 'Video Game', icon: 'üéÆ', price: 60, type: 'want', tag: 'Desejo' },
  { name: 'Investimento', icon: 'üìà', price: 25, type: 'save', tag: 'Poupanca' },
  { name: 'Material Escolar', icon: '‚úèÔ∏è', price: 20, type: 'need', tag: 'Necessidade' },
  { name: 'Sorvete', icon: 'üç¶', price: 8, type: 'want', tag: 'Desejo' },
  { name: 'Presente pra Mae', icon: 'üéÅ', price: 15, type: 'need', tag: 'Necessidade' },
  { name: 'Fundo de Emergencia', icon: 'üõü', price: 15, type: 'save', tag: 'Poupanca' },
];

let budgetState = { budget: 100, selected: [], items: [] };

function startBudget() {
  budgetState = { budget: 100, selected: [], items: shuffle([...BUDGET_ITEMS]).slice(0, 8) };
  document.getElementById('gameOverlay').classList.remove('hidden');
  renderBudget();
}

function renderBudget() {
  const gc = document.getElementById('gameContainer');
  const spent = budgetState.selected.reduce((s, i) => s + budgetState.items[i].price, 0);
  const remaining = budgetState.budget - spent;
  gc.innerHTML = `
    <button class="game-back" onclick="closeGame()">‚Üê Voltar</button>
    <div class="game-title-bar"><h2>üí≥ Desafio do Orcamento</h2><p>Escolha com sabedoria!</p></div>
    <div class="budget-remaining">
      <div class="br-label">Orcamento Restante</div>
      <div class="br-value" style="color:${remaining < 0 ? 'var(--red)' : 'var(--gold)'}">${fmt(remaining)}</div>
    </div>
    <div style="margin-bottom:14px;">
      ${budgetState.items.map((item, i) => {
        const sel = budgetState.selected.includes(i);
        const canAfford = !sel && (remaining >= item.price);
        const tagClass = item.type === 'need' ? 'need' : item.type === 'save' ? 'save' : 'want';
        return `<div class="budget-item ${sel ? 'selected' : ''}" onclick="toggleBudgetItem(${i})" style="${!canAfford && !sel ? 'opacity:0.4;' : ''}">
          <div class="bi-info"><span class="bi-icon">${item.icon}</span><span class="bi-name">${item.name}</span><span class="bi-tag ${tagClass}">${item.tag}</span></div>
          <span class="bi-price">${fmt(item.price)}</span>
        </div>`;
      }).join('')}
    </div>
    <button class="btn btn-primary ripple" onclick="finishBudget()" ${budgetState.selected.length === 0 ? 'disabled' : ''}>Confirmar Escolhas ‚úÖ</button>
  `;
}

function toggleBudgetItem(i) {
  const idx = budgetState.selected.indexOf(i);
  if (idx >= 0) {
    budgetState.selected.splice(idx, 1);
  } else {
    const spent = budgetState.selected.reduce((s, j) => s + budgetState.items[j].price, 0);
    if (spent + budgetState.items[i].price <= budgetState.budget) {
      budgetState.selected.push(i);
    } else {
      showToast('Orcamento insuficiente!', 'error'); return;
    }
  }
  renderBudget();
}

function finishBudget() {
  const items = budgetState.selected.map(i => budgetState.items[i]);
  const needScore = items.filter(i => i.type === 'need').length * 15;
  const saveScore = items.filter(i => i.type === 'save').length * 20;
  const wantScore = items.filter(i => i.type === 'want').length * 5;
  const spent = items.reduce((s, i) => s + i.price, 0);
  const leftover = budgetState.budget - spent;
  const leftoverBonus = leftover >= 10 ? 10 : 0;
  const totalScore = Math.min(100, needScore + saveScore + wantScore + leftoverBonus);
  const xpEarned = Math.round(totalScore / 100 * 15);

  let msg, emoji;
  if (totalScore >= 80) { msg = 'Excelente! Voce sabe equilibrar muito bem!'; emoji = 'üèÜ'; }
  else if (totalScore >= 50) { msg = 'Bom trabalho! Tente priorizar mais as necessidades.'; emoji = 'üëç'; }
  else { msg = 'Muitos desejos! Lembre: necessidades primeiro!'; emoji = 'üìö'; }

  const gc = document.getElementById('gameContainer');
  gc.innerHTML = `
    <button class="game-back" onclick="closeGame()">‚Üê Voltar</button>
    <div style="text-align:center;padding:30px 20px;">
      <div style="font-size:4rem;margin-bottom:14px;">${emoji}</div>
      <h2 style="font-size:1.5rem;font-weight:900;margin-bottom:8px;">Orcamento Completo!</h2>
      <p style="font-size:1.2rem;font-weight:800;color:var(--gold);margin-bottom:6px;">Pontuacao: ${totalScore}/100</p>
      <p style="font-size:.95rem;color:var(--text2);margin-bottom:16px;">${msg}</p>
      <div class="glass-card" style="text-align:left;margin-bottom:12px;">
        <p style="font-size:.82rem;font-weight:800;margin-bottom:8px;">Suas escolhas:</p>
        ${items.map(i => {
          const tagClass = i.type === 'need' ? 'need' : i.type === 'save' ? 'save' : 'want';
          return `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.04);">
            <span style="font-size:.82rem;">${i.icon} ${i.name} <span class="bi-tag ${tagClass}" style="font-size:.55rem;">${i.tag}</span></span>
            <span style="font-weight:800;font-size:.82rem;">${fmt(i.price)}</span>
          </div>`;
        }).join('')}
        <div style="display:flex;justify-content:space-between;padding:8px 0;margin-top:6px;">
          <span style="font-size:.85rem;font-weight:800;">Sobrou:</span>
          <span style="font-weight:900;color:var(--gold);">${fmt(leftover)}</span>
        </div>
      </div>
      <p style="color:var(--gold);font-weight:900;font-size:1.1rem;margin-bottom:20px;">+${xpEarned} XP</p>
      <button class="btn btn-primary ripple" style="max-width:240px;margin:0 auto 10px;" onclick="startBudget()">Jogar Novamente üîÑ</button>
      <button class="btn btn-outline" style="max-width:240px;margin:0 auto;" onclick="closeGame()">Voltar aos Jogos</button>
    </div>
  `;
  addXP(xpEarned, 'Desafio do Orcamento!');
  incrementGamesPlayed();
}

function closeGame() {
  document.getElementById('gameOverlay').classList.add('hidden');
}

function incrementGamesPlayed() {
  const ch = load('children') || {}; const child = ch[currentChild.id];
  if (!child) return;
  child.gamesPlayed = (child.gamesPlayed || 0) + 1;
  ch[child.id] = child; save('children', ch); currentChild = child;
}

// ============================================================
// LESSONS
// ============================================================
const LESSONS_DATA = [
  {
    id: 'money', title: 'O que e dinheiro?', emoji: 'üíµ', desc: 'Conceitos basicos sobre dinheiro',
    slides: [
      { emoji: 'üíµ', title: 'O que e Dinheiro?', text: 'Dinheiro e algo que usamos para trocar por coisas que queremos ou precisamos. Antigamente, as pessoas trocavam coisas diretamente - galinha por trigo, por exemplo!' },
      { emoji: 'üè¶', title: 'De onde vem o Dinheiro?', text: 'O dinheiro e criado pelo governo do pais. No Brasil, usamos o Real (R$). Cada pais tem sua moeda: EUA tem o Dolar ($), Europa tem o Euro, etc.' },
      { emoji: 'üí≥', title: 'Tipos de Dinheiro', text: 'Dinheiro pode ser fisico (notas e moedas) ou digital (no banco, no celular). Hoje em dia, a maior parte do dinheiro e digital!' },
      { emoji: 'üéØ', title: 'O Valor do Dinheiro', text: 'Dinheiro tem valor porque todos concordam que ele vale algo. Por isso e importante cuidar bem dele - saber ganhar, guardar e gastar com sabedoria!' },
    ]
  },
  {
    id: 'supply', title: 'Comprar e Vender', emoji: 'üè™', desc: 'Oferta e demanda',
    slides: [
      { emoji: 'üè™', title: 'Oferta e Demanda', text: 'Quando muita gente quer comprar algo (demanda alta) e tem pouco disponivel (oferta baixa), o preco SOBE. E a lei basica do mercado!' },
      { emoji: 'üìà', title: 'Preco Subindo', text: 'Imagine que so existem 10 ingressos para um show incrivel, mas 100 pessoas querem. O preco vai la para cima! Quem chegar primeiro leva.' },
      { emoji: 'üìâ', title: 'Preco Caindo', text: 'Agora imagine que tem 100 sorvetes, mas so 5 pessoas querem. O vendedor vai abaixar o preco para vender. Sobrou = preco cai!' },
      { emoji: 'üß†', title: 'Dica de Investidor', text: 'Compre quando o preco esta baixo (pouca demanda) e venda quando esta alto (muita demanda). Essa e a base de todo investimento!' },
    ]
  },
  {
    id: 'saving', title: 'O poder da poupanca', emoji: 'üê∑', desc: 'Aprendendo a poupar',
    slides: [
      { emoji: 'üê∑', title: 'Por que Poupar?', text: 'Poupar dinheiro significa guardar uma parte do que voce ganha para usar no futuro. E como plantar uma semente que vai virar uma arvore!' },
      { emoji: 'üéØ', title: 'A Regra 50-30-20', text: 'Uma dica famosa: gaste 50% com o que precisa (comida, escola), 30% com o que quer (brinquedos, jogos), e guarde 20% (poupanca)!' },
      { emoji: '‚è∞', title: 'O Poder do Tempo', text: 'Quanto mais cedo voce comecar a poupar, mais dinheiro tera no futuro. R$10 por semana = R$520 em um ano! Imagina em 10 anos?' },
      { emoji: 'üèÜ', title: 'Metas de Poupanca', text: 'Defina uma meta! Quer comprar algo especial? Calcule quanto custa e quanto precisa guardar por semana. Ter um objetivo ajuda muito!' },
    ]
  },
  {
    id: 'investing', title: 'O que sao investimentos?', emoji: 'üìä', desc: 'Basico de investimentos',
    slides: [
      { emoji: 'üìä', title: 'O que e Investir?', text: 'Investir e colocar seu dinheiro em algo que pode crescer com o tempo. Em vez de deixar parado, voce faz ele trabalhar para voce!' },
      { emoji: 'üå±', title: 'Tipos de Investimento', text: 'Existem varios tipos: acoes (pedacos de empresas), renda fixa (emprestimos seguros), imoveis, criptomoedas, e muito mais!' },
      { emoji: 'üíé', title: 'Juros Compostos', text: 'Quando voce investe, ganha juros. E esses juros tambem ganham juros! E como uma bola de neve que cresce cada vez mais rapido.' },
      { emoji: 'üéì', title: 'Comece Cedo!', text: 'Quem comeca a investir jovem tem uma vantagem enorme. O tempo e o melhor amigo do investidor. Voce ja esta no caminho certo!' },
    ]
  },
  {
    id: 'risk', title: 'Risco e Recompensa', emoji: '‚öñÔ∏è', desc: 'Entendendo riscos',
    slides: [
      { emoji: '‚öñÔ∏è', title: 'Risco vs Recompensa', text: 'Todo investimento tem risco - a chance de perder dinheiro. Geralmente, quanto maior o risco, maior a chance de ganhar muito (ou perder muito).' },
      { emoji: 'üé≤', title: 'Baixo Risco', text: 'Investimentos seguros (como poupanca) ganham pouco, mas voce quase nunca perde. E como andar de bicicleta com rodinhas - seguro!' },
      { emoji: 'üöÄ', title: 'Alto Risco', text: 'Investimentos arriscados (como criptomoedas) podem ganhar muito, mas tambem perder. E como andar de skate em uma rampa!' },
      { emoji: 'üåà', title: 'Diversificar', text: 'A melhor estrategia? Nao coloque todos os ovos na mesma cesta! Divida seu dinheiro entre investimentos seguros e arriscados.' },
    ]
  },
  {
    id: 'business', title: 'Seu primeiro negocio', emoji: 'üöÄ', desc: 'Empreendedorismo basico',
    slides: [
      { emoji: 'üöÄ', title: 'Ser Empreendedor', text: 'Um empreendedor e alguem que cria um negocio para resolver um problema ou oferecer algo que as pessoas querem. Voce pode ser um!' },
      { emoji: 'üí°', title: 'Encontre uma Ideia', text: 'Olhe ao redor: o que as pessoas precisam? Pode ser vender limonada, fazer pulseiras, ensinar algo, lavar carros... As opcoes sao infinitas!' },
      { emoji: 'üìù', title: 'Planeje seu Negocio', text: 'Pense: quanto vai custar? Por quanto vou vender? Quem vai comprar? Um bom plano e metade do caminho para o sucesso!' },
      { emoji: 'üåü', title: 'Comece Pequeno', text: 'Todo grande empresario comecou pequeno. O importante e comecar, aprender com os erros, e melhorar sempre. Voce consegue!' },
    ]
  },
];

let lessonState = { id: '', slide: 0 };

function renderLessons() {
  const el = document.getElementById('lessonsList');
  const completedLessons = load('lessons_' + (currentChild?.id || '')) || {};
  el.innerHTML = LESSONS_DATA.map(l => {
    const done = completedLessons[l.id];
    return `<div class="lesson-card ${done ? 'completed-lesson' : ''}" onclick="openLesson('${l.id}')">
      <span class="lesson-emoji">${l.emoji}</span>
      <div class="lesson-info"><div class="lesson-name">${l.title}</div><div class="lesson-desc">${l.desc}</div></div>
      <span class="lesson-badge">${done ? '‚úÖ' : '‚Üí'}</span>
    </div>`;
  }).join('');
}

function openLesson(id) {
  const lesson = LESSONS_DATA.find(l => l.id === id);
  if (!lesson) return;
  lessonState = { id, slide: 0 };
  document.getElementById('lessonOverlay').classList.remove('hidden');
  renderLessonSlide();
}

function renderLessonSlide() {
  const lesson = LESSONS_DATA.find(l => l.id === lessonState.id);
  if (!lesson) return;
  const slide = lesson.slides[lessonState.slide];
  const total = lesson.slides.length;
  const isLast = lessonState.slide === total - 1;
  const lc = document.getElementById('lessonContainer');
  lc.innerHTML = `
    <button class="game-back" onclick="closeLesson()">‚Üê Voltar</button>
    <div class="game-title-bar"><h2>${lesson.emoji} ${lesson.title}</h2><p>Pagina ${lessonState.slide + 1} de ${total}</p></div>
    <div class="lesson-dots">${lesson.slides.map((_, i) => `<div class="lesson-dot ${i === lessonState.slide ? 'active' : i < lessonState.slide ? 'active' : ''}"></div>`).join('')}</div>
    <div class="lesson-slide">
      <div class="slide-emoji">${slide.emoji}</div>
      <div class="slide-title">${slide.title}</div>
      <div class="slide-text">${slide.text}</div>
    </div>
    <div style="display:flex;gap:10px;">
      ${lessonState.slide > 0 ? '<button class="btn btn-outline" style="flex:1;" onclick="prevSlide()">‚Üê Anterior</button>' : ''}
      <button class="btn btn-primary ripple" style="flex:1;" onclick="${isLast ? 'completeLesson()' : 'nextSlide()'}">${isLast ? 'Concluir ‚úÖ' : 'Proximo ‚Üí'}</button>
    </div>
  `;
}

function nextSlide() { lessonState.slide++; renderLessonSlide(); }
function prevSlide() { if (lessonState.slide > 0) { lessonState.slide--; renderLessonSlide(); } }

function completeLesson() {
  const completedLessons = load('lessons_' + currentChild.id) || {};
  if (!completedLessons[lessonState.id]) {
    completedLessons[lessonState.id] = true;
    save('lessons_' + currentChild.id, completedLessons);
    addXP(15, 'Licao completa!');
  }
  closeLesson();
  renderLessons();
}

function closeLesson() {
  document.getElementById('lessonOverlay').classList.add('hidden');
}

// ============================================================
// PROFILE TAB
// ============================================================
const ACHIEVEMENTS = [
  { id: 'first_trade', icon: 'üéØ', name: 'Primeira Operacao', check: c => { const txs = (load('transactions') || {})[c.id] || []; return txs.length >= 1; } },
  { id: 'ten_trades', icon: '‚ö°', name: '10 Operacoes', check: c => { const txs = (load('transactions') || {})[c.id] || []; return txs.length >= 10; } },
  { id: 'diversifier', icon: 'üåà', name: 'Diversificado', check: c => ASSETS.filter(a => (c.assets?.[a.id]?.qty || 0) > 0).length >= 3 },
  { id: 'saver', icon: 'üê∑', name: 'Poupador', check: c => (c.totalYield || 0) >= 10 },
  { id: 'gamer', icon: 'üéÆ', name: 'Jogador', check: c => (c.gamesPlayed || 0) >= 3 },
  { id: 'learner', icon: 'üìö', name: 'Estudioso', check: c => { const l = load('lessons_' + c.id) || {}; return Object.keys(l).length >= 3; } },
  { id: 'rich', icon: 'üí∞', name: 'Ricao', check: c => calcTotal(c) >= 200 },
  { id: 'level3', icon: 'ü¶ä', name: 'Nivel 3', check: c => (c.xp || 0) >= 150 },
  { id: 'level5', icon: 'üêâ', name: 'Mestre', check: c => (c.xp || 0) >= 500 },
];

function updateProfileTab() {
  if (!currentChild) return;
  const child = currentChild;
  const tv = calcTotal(child);
  const txs = (load('transactions') || {})[child.id] || [];

  document.getElementById('profileAvatarIcon').textContent = getLevel(child.xp || 0).emoji;
  document.getElementById('profPatrimony').textContent = fmt(tv);
  document.getElementById('profTrades').textContent = txs.length;
  document.getElementById('profDays').textContent = child.daysActive || 0;
  document.getElementById('profGames').textContent = child.gamesPlayed || 0;

  updateXPUI();

  // Achievements
  const grid = document.getElementById('achievementGrid');
  grid.innerHTML = ACHIEVEMENTS.map(a => {
    const earned = a.check(child);
    return `<div class="achievement-badge ${earned ? 'earned' : ''}"><span class="ab-icon">${earned ? a.icon : 'üîí'}</span><span class="ab-name">${a.name}</span></div>`;
  }).join('');
}

// ============================================================
// UTILITY
// ============================================================
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = ~~(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// ============ DATA MIGRATION (v3 -> v4) ============
function migrateData() {
  // Check if there's v3 data but no v4 data
  const v3Parents = localStorage.getItem('fc3_parents');
  const v4Parents = localStorage.getItem('fc4_parents');
  if (v3Parents && !v4Parents) {
    // Migrate all fc3_ keys to fc4_
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('fc3_')) {
        const newKey = 'fc4_' + key.substring(4);
        if (!localStorage.getItem(newKey)) {
          localStorage.setItem(newKey, localStorage.getItem(key));
        }
      }
    }
    // Migrate children to add new fields
    const ch = load('children') || {};
    Object.values(ch).forEach(c => {
      if (c.xp === undefined) c.xp = 0;
      if (c.daysActive === undefined) c.daysActive = 0;
      if (c.gamesPlayed === undefined) c.gamesPlayed = 0;
      if (c.lastLogin === undefined) c.lastLogin = '';
      ch[c.id] = c;
    });
    save('children', ch);
    // Migrate session
    const v3Session = localStorage.getItem('fc3_session');
    if (v3Session && !localStorage.getItem('fc4_session')) {
      localStorage.setItem('fc4_session', v3Session);
    }
  }
}

migrateData();
init();
</script>
</body>
</html>
