<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Financial Child v4 - Premium</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --green:#22c55e;--green-glow:#4ade80;--red:#ef4444;--red-glow:#f87171;
      --blue:#3b82f6;--purple:#8b5cf6;--gold:#f59e0b;--orange:#f97316;
      --cyan:#06b6d4;--pink:#ec4899;
      --dark:#0a0e1a;--dark2:#131a2e;--dark3:#1c2540;--dark4:#263354;
      --text:#f1f5f9;--text2:#7a8ba8;
      --card:rgba(19,26,46,0.7);--card-border:rgba(31,45,71,0.6);
      --glass:rgba(19,26,46,0.55);--glass-border:rgba(255,255,255,0.08);
      --gold-grad:linear-gradient(135deg,#f59e0b,#fbbf24,#f59e0b);
      --premium-grad:linear-gradient(135deg,#667eea,#764ba2);
    }
    @keyframes bgShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#0a0e1a,#111827,#0f172a,#1a1040,#0a0e1a);background-size:400% 400%;animation:bgShift 20s ease infinite;color:var(--text);min-height:100vh;overflow-x:hidden}
    .glass{background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:20px}
    .glass-sm{background:var(--glass);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid var(--glass-border);border-radius:14px}
    .glass-card{background:rgba(19,26,46,0.5);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:18px;margin-bottom:14px;transition:transform .3s,box-shadow .3s}
    .glass-card:hover{transform:translateY(-1px);box-shadow:0 8px 32px rgba(0,0,0,0.2)}
    *{transition-property:color,background-color,border-color,opacity,transform,box-shadow;transition-duration:.2s;transition-timing-function:ease}
    .ripple{position:relative;overflow:hidden}
    .ripple::after{content:'';position:absolute;width:100%;height:100%;top:0;left:0;background:radial-gradient(circle,rgba(255,255,255,.15) 10%,transparent 10.01%);background-repeat:no-repeat;background-position:50%;transform:scale(10);opacity:0;transition:transform .5s,opacity 1s}
    .ripple:active::after{transform:scale(0);opacity:.3;transition:0s}
    .gold-text{background:var(--gold-grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .gold-border{border:1px solid rgba(245,158,11,0.3)}
    .gold-glow{box-shadow:0 0 20px rgba(245,158,11,0.15)}
    .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px}
    .login-logo{font-size:2.8rem;font-weight:900;margin-bottom:6px;background:linear-gradient(135deg,var(--gold),#fbbf24,var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:none;letter-spacing:-1px}
    .login-subtitle{color:var(--text2);margin-bottom:40px;font-size:1.05rem;letter-spacing:.5px}
    .login-box{background:var(--glass);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border:1px solid var(--glass-border);border-radius:24px;padding:36px;width:100%;max-width:420px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
    .login-box h2{text-align:center;margin-bottom:20px;font-size:1.3rem}
    .tab-switch{display:flex;margin-bottom:24px;border-radius:14px;overflow:hidden;border:1px solid var(--glass-border);background:rgba(0,0,0,0.2)}
    .tab-btn{flex:1;padding:12px;border:none;background:transparent;color:var(--text2);cursor:pointer;font-size:.9rem;font-weight:700;transition:all .3s}
    .tab-btn.active{background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:6px;color:var(--text2);font-size:.78rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
    .form-group input,.form-group select{width:100%;padding:13px 16px;border:1px solid var(--glass-border);border-radius:12px;background:rgba(0,0,0,0.25);color:var(--text);font-size:.95rem;outline:none;transition:all .3s;backdrop-filter:blur(8px)}
    .form-group input:focus,.form-group select:focus{border-color:var(--gold);box-shadow:0 0 20px rgba(245,158,11,0.1)}
    .btn{width:100%;padding:14px;border:none;border-radius:14px;font-size:1rem;font-weight:800;cursor:pointer;transition:all .3s;margin-top:8px;letter-spacing:.3px}
    .btn-primary{background:linear-gradient(135deg,var(--gold),var(--orange));color:#000;box-shadow:0 4px 20px rgba(245,158,11,0.25)}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(245,158,11,0.35)}
    .btn-primary:active{transform:translateY(0)}
    .error-msg{color:var(--red);font-size:.82rem;text-align:center;margin-top:10px}
    .access-options{display:flex;gap:12px;margin-top:18px}
    .access-btn{flex:1;padding:18px 14px;border:1.5px solid var(--glass-border);border-radius:18px;background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);color:var(--text);cursor:pointer;text-align:center;transition:all .3s}
    .access-btn:hover{border-color:var(--gold);transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,0.3)}
    .access-btn .icon{font-size:2rem;display:block;margin-bottom:8px}
    .access-btn .label{font-weight:800;font-size:.9rem}
    .dashboard{min-height:100vh;padding:20px;max-width:900px;margin:0 auto}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--glass-border)}
    .header-left h1{font-size:1.5rem;font-weight:900;background:linear-gradient(135deg,var(--gold),#fbbf24);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .header-left small{color:var(--text2);font-size:.85rem}
    .logout-btn{padding:10px 18px;border:1px solid var(--glass-border);border-radius:12px;background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);color:var(--text2);cursor:pointer;font-size:.82rem;font-weight:700;transition:all .3s}
    .logout-btn:hover{border-color:var(--red);color:var(--red);background:rgba(239,68,68,0.1)}
    .card{background:var(--glass);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid var(--glass-border);border-radius:20px;padding:24px;margin-bottom:18px;transition:all .3s}
    .card:hover{box-shadow:0 8px 32px rgba(0,0,0,0.15)}
    .card h3{font-size:1.1rem;margin-bottom:16px;display:flex;align-items:center;gap:10px;font-weight:800}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:18px}
    .stat-card{background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);border:1px solid var(--glass-border);border-radius:16px;padding:18px;text-align:center;transition:all .3s}
    .stat-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.2)}
    .stat-card .stat-value{font-size:1.5rem;font-weight:900;margin-bottom:4px}
    .stat-card .stat-label{color:var(--text2);font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px}
    .stat-green .stat-value{color:var(--green)}.stat-blue .stat-value{color:var(--blue)}.stat-gold .stat-value{color:var(--gold)}.stat-purple .stat-value{color:var(--purple)}
    .config-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn-row{display:flex;gap:10px;margin-top:16px}
    .btn-row .btn{flex:1}
    .btn-sm{padding:11px 16px;font-size:.85rem}
    .btn-outline{background:rgba(0,0,0,0.2);border:1px solid var(--glass-border);color:var(--text)}
    .btn-outline:hover{border-color:var(--gold);color:var(--gold)}
    .tx-list{max-height:300px;overflow-y:auto}
    .tx-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid rgba(255,255,255,0.04)}
    .tx-item:last-child{border-bottom:none}
    .tx-type{font-weight:800;font-size:.78rem;padding:4px 10px;border-radius:8px}
    .tx-buy{background:rgba(34,197,94,.12);color:var(--green)}.tx-sell{background:rgba(239,68,68,.12);color:var(--red)}
    .tx-details{text-align:right}.tx-details .tx-value{font-weight:800;font-size:.9rem}.tx-details .tx-time{color:var(--text2);font-size:.72rem}
    .trading-panel{min-height:100vh;padding:14px 14px 140px 14px;max-width:520px;margin:0 auto;display:flex;flex-direction:column}
    .trading-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .trading-header h1{font-size:1.2rem;font-weight:900;background:linear-gradient(135deg,var(--gold),#fbbf24);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .balance-display{text-align:right}
    .balance-display .label{font-size:.68rem;color:var(--text2);font-weight:700;text-transform:uppercase;letter-spacing:.5px}
    .balance-display .value{font-size:1.25rem;font-weight:900;color:var(--gold)}
    .market-status{display:flex;align-items:center;gap:6px;font-size:.75rem;color:var(--text2)}
    .live-dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
    .status-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
    .status-dot.paused{background:var(--red);animation:none}
    .xp-header-bar{display:flex;align-items:center;gap:8px;margin-bottom:12px;padding:8px 14px;background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);border-radius:12px;border:1px solid var(--glass-border)}
    .xp-level-badge{font-size:.8rem;font-weight:900;color:var(--gold);white-space:nowrap}
    .xp-bar-mini{flex:1;height:8px;background:rgba(0,0,0,0.3);border-radius:4px;overflow:hidden}
    .xp-bar-mini-fill{height:100%;background:var(--gold-grad);border-radius:4px;transition:width .5s}
    .xp-text-mini{font-size:.68rem;color:var(--text2);font-weight:700;white-space:nowrap}
    .welcome-banner{background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(139,92,246,0.15));backdrop-filter:blur(16px);border:1px solid rgba(245,158,11,0.2);border-radius:18px;padding:18px;margin-bottom:14px;text-align:center;animation:bannerIn .6s ease-out}
    @keyframes bannerIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
    .welcome-banner .wb-greeting{font-size:1.2rem;font-weight:900;margin-bottom:4px}
    .welcome-banner .wb-sub{font-size:.82rem;color:var(--text2)}
    .category-tabs{display:flex;gap:4px;margin-bottom:12px;background:rgba(0,0,0,0.2);border-radius:14px;padding:4px;backdrop-filter:blur(8px);overflow-x:auto;-webkit-overflow-scrolling:touch}
    .cat-tab{flex-shrink:0;padding:10px 6px;border:none;border-radius:10px;background:transparent;color:var(--text2);cursor:pointer;font-size:.7rem;font-weight:800;transition:all .3s;text-align:center;min-width:64px}
    .cat-tab.active{background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff;box-shadow:0 4px 15px rgba(59,130,246,0.25)}
    .cat-tab:hover{color:var(--text)}
    .asset-scroll{display:flex;gap:8px;margin-bottom:14px;overflow-x:auto;padding-bottom:6px;-webkit-overflow-scrolling:touch}
    .asset-scroll::-webkit-scrollbar{height:3px}
    .asset-scroll::-webkit-scrollbar-thumb{background:var(--dark4);border-radius:3px}
    .asset-chip{flex-shrink:0;padding:10px 14px;border-radius:14px;border:1.5px solid var(--glass-border);background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);cursor:pointer;text-align:center;transition:all .3s;min-width:90px;position:relative}
    .asset-chip:hover{border-color:var(--gold);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.2)}
    .asset-chip.active{border-color:var(--gold);background:rgba(245,158,11,0.08);box-shadow:0 0 20px rgba(245,158,11,0.1)}
    .asset-chip .a-icon{font-size:1.3rem;display:block}
    .asset-chip .a-name{font-size:.7rem;font-weight:900;margin-top:2px;letter-spacing:.5px}
    .asset-chip .a-price{font-size:.65rem;font-weight:600;color:var(--text2);margin-top:2px}
    .asset-chip .a-change{font-size:.6rem;font-weight:800}
    .a-change.up{color:var(--green)}.a-change.down{color:var(--red)}
    .price-section{background:rgba(0,0,0,0.25);backdrop-filter:blur(16px);border:1px solid var(--glass-border);border-radius:20px;padding:20px;text-align:center;margin-bottom:14px;position:relative;overflow:hidden}
    .price-section::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);animation:scanline 3s linear infinite}
    @keyframes scanline{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
    .price-label{color:var(--text2);font-size:.78rem;font-weight:700;margin-bottom:8px}
    .price-row{display:flex;align-items:center;justify-content:center;gap:10px}
    .price-value{font-size:2.6rem;font-weight:900;transition:color .3s;font-variant-numeric:tabular-nums}
    .price-up{color:var(--green)}.price-down{color:var(--red)}.price-stable{color:var(--text)}
    .price-emoji{font-size:1.8rem;display:inline-block;animation:bounce 1s infinite}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .price-change{font-size:.88rem;font-weight:800;margin-top:4px}
    .price-meta{display:flex;justify-content:center;gap:18px;margin-top:10px;font-size:.72rem;color:var(--text2)}
    .price-meta span{display:flex;align-items:center;gap:4px}
    .chart-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:18px;margin-bottom:14px;overflow:hidden}
    .chart-toolbar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px 8px;flex-wrap:wrap;gap:6px}
    .chart-toolbar .chart-title{font-size:.8rem;font-weight:800;color:var(--text2)}
    .chart-toolbar-right{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .time-tabs{display:flex;gap:3px;background:rgba(0,0,0,0.2);border-radius:10px;padding:3px}
    .time-tab{padding:6px 11px;border:none;border-radius:8px;background:transparent;color:var(--text2);cursor:pointer;font-size:.7rem;font-weight:800;transition:all .2s}
    .time-tab.active{background:var(--gold);color:#000}
    .time-tab:hover{color:var(--text)}
    .chart-type-btn{padding:5px 10px;border:1px solid var(--glass-border);border-radius:8px;background:rgba(0,0,0,0.2);color:var(--text2);cursor:pointer;font-size:.65rem;font-weight:800;transition:all .2s}
    .chart-type-btn.active{background:var(--purple);color:#fff;border-color:var(--purple)}
    .indicator-tabs{display:flex;gap:4px;padding:4px 16px 8px}
    .indicator-btn{padding:4px 10px;border:1px solid var(--glass-border);border-radius:7px;background:rgba(0,0,0,0.2);color:var(--text2);cursor:pointer;font-size:.63rem;font-weight:800;transition:all .2s}
    .indicator-btn.active{border-color:var(--cyan);color:var(--cyan);background:rgba(6,182,212,0.08)}
    .chart-wrap{padding:8px 14px 14px;height:200px;position:relative}
    .chart-canvas{width:100%;height:100%}
    .rsi-wrap{padding:0 14px 8px;height:40px;position:relative}
    .holdings-bar{display:flex;gap:8px;margin-bottom:14px}
    .holding-item{flex:1;background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);border:1px solid var(--glass-border);border-radius:14px;padding:12px;text-align:center;transition:all .3s}
    .holding-item:hover{transform:translateY(-1px)}
    .holding-item .h-label{font-size:.65rem;color:var(--text2);font-weight:700;text-transform:uppercase;letter-spacing:.5px}
    .holding-item .h-value{font-size:1.1rem;font-weight:900;margin-top:3px}
    .portfolio-section{margin-bottom:14px}
    .portfolio-section h4{font-size:.82rem;color:var(--text2);margin-bottom:10px;font-weight:700}
    .portfolio-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .portfolio-coin{background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);border:1px solid var(--glass-border);border-radius:14px;padding:11px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:all .3s}
    .portfolio-coin:hover{border-color:var(--gold);transform:translateY(-1px)}
    .portfolio-coin .pc-icon{font-size:1.3rem}
    .portfolio-coin .pc-info{flex:1}
    .portfolio-coin .pc-name{font-size:.74rem;font-weight:800}
    .portfolio-coin .pc-qty{font-size:.65rem;color:var(--text2)}
    .portfolio-coin .pc-val{font-size:.85rem;font-weight:900;text-align:right}
    .trade-section{background:rgba(0,0,0,0.25);backdrop-filter:blur(16px);border:1px solid var(--glass-border);border-radius:18px;padding:16px;margin-bottom:14px}
    .trade-section h4{font-size:.82rem;color:var(--text2);margin-bottom:12px;font-weight:700;text-align:center}
    .qty-selector{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:14px}
    .qty-selector label{color:var(--text2);font-size:.82rem;font-weight:700}
    .qty-controls{display:flex;align-items:center;gap:12px}
    .qty-btn{width:38px;height:38px;border-radius:50%;border:1px solid var(--glass-border);background:rgba(0,0,0,0.2);color:var(--text);font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s}
    .qty-btn:hover{border-color:var(--gold);background:rgba(245,158,11,0.1);color:var(--gold)}
    .qty-value{font-size:1.4rem;font-weight:900;min-width:32px;text-align:center}
    .trade-buttons{display:flex;gap:12px}
    .trade-btn{flex:1;padding:18px 12px;border:none;border-radius:16px;font-size:1.1rem;font-weight:900;cursor:pointer;transition:all .3s;text-transform:uppercase;letter-spacing:.5px}
    .buy-btn{background:linear-gradient(135deg,#14532d,var(--green));color:#fff;box-shadow:0 4px 20px rgba(34,197,94,.2)}
    .sell-btn{background:linear-gradient(135deg,#7f1d1d,var(--red));color:#fff;box-shadow:0 4px 20px rgba(239,68,68,.2)}
    .short-btn{background:linear-gradient(135deg,#4c1d95,var(--purple));color:#fff;box-shadow:0 4px 20px rgba(139,92,246,.2);flex:1;padding:18px 8px;border:none;border-radius:16px;font-size:.85rem;font-weight:900;cursor:pointer;transition:all .3s;text-transform:uppercase;letter-spacing:.3px}
    .cover-btn{background:linear-gradient(135deg,#065f46,var(--cyan));color:#fff;box-shadow:0 4px 20px rgba(6,182,212,.2)}
    .trade-btn:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,0.3)}
    .trade-btn:active{transform:translateY(0)}
    .trade-btn.glow-green{animation:glowG 1.5s ease-in-out infinite}
    .trade-btn.glow-red{animation:glowR 1.5s ease-in-out infinite}
    .trade-btn:disabled{opacity:.3;cursor:not-allowed;transform:none!important;animation:none!important;box-shadow:none!important}
    @keyframes glowG{0%,100%{box-shadow:0 0 20px rgba(34,197,94,.3)}50%{box-shadow:0 0 40px rgba(34,197,94,.6)}}
    @keyframes glowR{0%,100%{box-shadow:0 0 20px rgba(239,68,68,.3)}50%{box-shadow:0 0 40px rgba(239,68,68,.6)}}
    .trade-btn .btn-sub{font-size:.65rem;font-weight:600;opacity:.85;display:block;margin-top:4px;letter-spacing:0;text-transform:none}
    .max-buttons{display:flex;gap:8px;margin-top:10px}
    .max-btn{flex:1;padding:10px;border:1px solid var(--glass-border);border-radius:10px;background:rgba(0,0,0,0.2);color:var(--text2);cursor:pointer;font-size:.72rem;font-weight:800;transition:all .3s;text-align:center}
    .max-btn:hover{border-color:var(--gold);color:var(--gold);background:rgba(245,158,11,0.05)}
    .leverage-row{display:flex;align-items:center;justify-content:space-between;margin-top:10px;padding:10px 12px;background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.2);border-radius:12px}
    .leverage-toggle{padding:6px 14px;border:1px solid var(--purple);border-radius:8px;background:transparent;color:var(--purple);cursor:pointer;font-size:.72rem;font-weight:800;transition:all .2s}
    .leverage-toggle.active{background:var(--purple);color:#fff}
    .progress-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:16px;padding:14px;margin-bottom:14px}
    .progress-header{display:flex;justify-content:space-between;margin-bottom:8px}
    .progress-label{font-size:.82rem;color:var(--text2);font-weight:700}
    .progress-value{font-size:.82rem;font-weight:800;color:var(--gold)}
    .progress-bar-bg{width:100%;height:20px;background:rgba(0,0,0,0.3);border-radius:10px;overflow:hidden;position:relative}
    .progress-bar-fill{height:100%;border-radius:10px;transition:width .8s ease;background:linear-gradient(90deg,var(--blue),var(--purple));position:relative}
    .progress-bar-fill.near-goal{background:linear-gradient(90deg,var(--gold),#fbbf24);animation:pulseG 1s ease-in-out infinite}
    .progress-bar-fill.goal-reached{background:linear-gradient(90deg,var(--green),var(--green-glow))}
    @keyframes pulseG{0%,100%{opacity:1}50%{opacity:.7}}
    .progress-percent{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:.65rem;font-weight:900;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.4)}
    .tx-feed{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:16px;padding:14px;margin-bottom:14px}
    .tx-feed h4{font-size:.82rem;color:var(--text2);margin-bottom:10px;font-weight:700}
    .tx-feed-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:.78rem}
    .tx-feed-item:last-child{border-bottom:none}
    .yield-section{background:linear-gradient(135deg,rgba(19,26,46,0.7),rgba(26,39,68,0.7));backdrop-filter:blur(16px);border:1px solid rgba(34,197,94,0.15);border-radius:18px;padding:16px;margin-bottom:14px;position:relative;overflow:hidden}
    .yield-section::after{content:'';position:absolute;top:-50%;right:-50%;width:100%;height:100%;background:radial-gradient(circle,rgba(34,197,94,.06),transparent);pointer-events:none}
    .yield-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .yield-title{font-size:.85rem;font-weight:800;color:var(--green)}
    .yield-rate{font-size:.75rem;font-weight:800;color:var(--gold);background:rgba(245,158,11,.12);padding:4px 10px;border-radius:8px}
    .yield-info{display:flex;gap:10px}
    .yield-card{flex:1;background:rgba(0,0,0,0.2);border-radius:12px;padding:12px;text-align:center}
    .yield-card .y-label{font-size:.65rem;color:var(--text2);font-weight:700;text-transform:uppercase}
    .yield-card .y-value{font-size:1.05rem;font-weight:900;margin-top:3px}
    .yield-card .y-sub{font-size:.6rem;color:var(--green);font-weight:600;margin-top:2px}
    .ranking-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:18px;padding:16px;margin-bottom:14px}
    .ranking-section h4{font-size:.85rem;color:var(--text2);margin-bottom:12px;font-weight:700}
    .rank-list{display:flex;flex-direction:column;gap:8px}
    .rank-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:12px;background:rgba(0,0,0,0.15);transition:all .3s}
    .rank-item:hover{background:rgba(0,0,0,0.25)}
    .rank-item.me{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2)}
    .rank-pos{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:900;flex-shrink:0}
    .rank-1{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#000}
    .rank-2{background:linear-gradient(135deg,#94a3b8,#64748b);color:#000}
    .rank-3{background:linear-gradient(135deg,#cd7f32,#a0522d);color:#fff}
    .rank-other{background:var(--dark3);color:var(--text2)}
    .rank-info{flex:1}.rank-name{font-size:.8rem;font-weight:800}.rank-assets{font-size:.65rem;color:var(--text2)}
    .rank-value{font-size:.88rem;font-weight:900;text-align:right}
    .news-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:16px;padding:14px;margin-bottom:14px}
    .news-header{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    .news-header span{font-size:.8rem;font-weight:800;color:var(--cyan)}
    .news-badge{font-size:.55rem;background:var(--red);color:#fff;padding:3px 8px;border-radius:6px;font-weight:800;animation:pulse 1.5s infinite}
    .news-item{background:rgba(0,0,0,0.15);border-radius:10px;padding:12px;margin-bottom:8px;border-left:3px solid var(--cyan);font-size:.78rem;line-height:1.5;transition:all .3s}
    .news-item:hover{background:rgba(0,0,0,0.25)}
    .news-item:last-child{margin-bottom:0}
    .news-item .news-hint{color:var(--gold);font-weight:800;font-size:.7rem;margin-top:5px;display:block}
    .challenges-section{background:linear-gradient(135deg,rgba(19,26,46,0.6),rgba(26,34,51,0.6));backdrop-filter:blur(16px);border:1px solid rgba(245,158,11,0.1);border-radius:18px;padding:16px;margin-bottom:14px}
    .challenges-section h4{font-size:.85rem;color:var(--gold);margin-bottom:12px;font-weight:800}
    .challenge-item{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(0,0,0,0.15);border-radius:12px;margin-bottom:8px;border:1px solid transparent;transition:all .3s}
    .challenge-item:last-child{margin-bottom:0}
    .challenge-item.completed{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.05)}
    .challenge-item:hover{background:rgba(0,0,0,0.25)}
    .challenge-icon{font-size:1.4rem;flex-shrink:0}
    .challenge-info{flex:1}.challenge-name{font-size:.8rem;font-weight:800}.challenge-desc{font-size:.68rem;color:var(--text2);margin-top:3px}
    .challenge-reward{font-size:.72rem;font-weight:900;color:var(--gold);flex-shrink:0}
    .challenge-check{color:var(--green);font-size:1.1rem;flex-shrink:0}
    .confirm-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:950;animation:fadeIn .2s}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .confirm-box{background:var(--dark2);border:1px solid var(--glass-border);border-radius:22px;padding:28px;width:90%;max-width:380px;animation:scaleIn .3s;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
    @keyframes scaleIn{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
    .confirm-title{font-size:1.15rem;font-weight:900;text-align:center;margin-bottom:6px}
    .confirm-detail{font-size:.85rem;color:var(--text2);text-align:center;margin-bottom:18px}
    .confirm-question{font-size:.82rem;font-weight:800;color:var(--gold);text-align:center;margin-bottom:12px}
    .reason-options{display:flex;flex-direction:column;gap:8px;margin-bottom:18px}
    .reason-btn{padding:12px 16px;border:1px solid var(--glass-border);border-radius:12px;background:rgba(0,0,0,0.2);color:var(--text);cursor:pointer;font-size:.82rem;font-weight:600;text-align:left;transition:all .3s}
    .reason-btn:hover{border-color:var(--gold);background:rgba(245,158,11,0.05)}
    .reason-btn .reason-icon{margin-right:8px}
    .confirm-actions{display:flex;gap:10px}
    .confirm-actions .btn{flex:1;margin-top:0;padding:13px;font-size:.9rem}
    .btn-cancel{background:rgba(255,255,255,0.05);color:var(--text2);border:1px solid var(--glass-border)}
    .btn-cancel:hover{border-color:var(--red);color:var(--red)}
    .celebration-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);backdrop-filter:blur(12px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;animation:fadeIn .5s}
    .celebration-content{text-align:center;animation:scaleIn .5s}
    .celebration-emoji{font-size:5rem;margin-bottom:16px;animation:bounce 1s infinite}
    .celebration-title{font-size:2rem;font-weight:900;background:var(--gold-grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
    .celebration-text{color:var(--text2);font-size:1.05rem;margin-bottom:24px}
    .paused-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:900}
    .paused-content{text-align:center;color:var(--text2)}
    .paused-content .pause-icon{font-size:4rem;margin-bottom:12px}
    .paused-content .pause-text{font-size:1.3rem;font-weight:800}
    .toast{position:fixed;top:18px;right:18px;padding:12px 20px;border-radius:14px;font-weight:800;font-size:.85rem;z-index:1100;animation:slideIn .3s,slideOut .3s 2.7s;pointer-events:none;backdrop-filter:blur(12px);box-shadow:0 8px 30px rgba(0,0,0,0.3);max-width:300px}
    .toast-success{background:rgba(34,197,94,0.9);color:#fff}.toast-error{background:rgba(239,68,68,0.9);color:#fff}.toast-info{background:rgba(59,130,246,0.9);color:#fff}.toast-warn{background:rgba(245,158,11,0.9);color:#000}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}
    /* FIXED TRADE BAR */
    .fixed-trade-bar{position:fixed;bottom:56px;left:0;right:0;background:rgba(10,14,26,0.95);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-top:1px solid rgba(255,255,255,0.08);padding:8px 12px;z-index:790;max-width:520px;margin:0 auto;display:none;animation:slideUpBar .3s ease}
    @keyframes slideUpBar{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
    .ftb-row{display:flex;align-items:center;gap:8px}
    .ftb-asset{display:flex;align-items:center;gap:6px;flex-shrink:0}
    .ftb-asset .ftb-icon{font-size:1.2rem}
    .ftb-asset .ftb-name{font-size:.72rem;font-weight:900;color:var(--text)}
    .ftb-price-col{flex:1;text-align:center}
    .ftb-price{font-size:1.1rem;font-weight:900;font-variant-numeric:tabular-nums;transition:color .3s}
    .ftb-price.up{color:var(--green)}.ftb-price.down{color:var(--red)}.ftb-price.stable{color:var(--text)}
    .ftb-change{font-size:.6rem;font-weight:800}
    .ftb-change.up{color:var(--green)}.ftb-change.down{color:var(--red)}
    .ftb-btns{display:flex;gap:6px;flex-shrink:0}
    .ftb-buy,.ftb-sell{padding:10px 16px;border:none;border-radius:12px;font-size:.78rem;font-weight:900;cursor:pointer;transition:all .2s;letter-spacing:.3px}
    .ftb-buy{background:linear-gradient(135deg,#14532d,var(--green));color:#fff;box-shadow:0 2px 12px rgba(34,197,94,.2)}
    .ftb-sell{background:linear-gradient(135deg,#7f1d1d,var(--red));color:#fff;box-shadow:0 2px 12px rgba(239,68,68,.2)}
    .ftb-buy:active,.ftb-sell:active{transform:scale(.95)}
    .ftb-buy:disabled,.ftb-sell:disabled{opacity:.3;cursor:not-allowed;transform:none}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(10,14,26,0.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-top:1px solid rgba(255,255,255,0.06);display:flex;justify-content:space-around;padding:6px 0 env(safe-area-inset-bottom,8px);z-index:800;max-width:520px;margin:0 auto}
    .nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 16px;cursor:pointer;transition:all .3s;border-radius:12px;min-width:60px}
    .nav-item:hover{background:rgba(255,255,255,0.04)}
    .nav-item.active{color:var(--gold)}
    .nav-item.active .nav-icon{transform:scale(1.15)}
    .nav-icon{font-size:1.3rem;transition:transform .3s}
    .nav-label{font-size:.62rem;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:inherit}
    .nav-item:not(.active) .nav-label{color:var(--text2)}
    .tab-content{display:none;animation:tabFadeIn .3s ease}
    .tab-content.active{display:block}
    @keyframes tabFadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .game-card{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:18px;padding:20px;margin-bottom:14px;cursor:pointer;transition:all .3s;position:relative;overflow:hidden}
    .game-card:hover{transform:translateY(-3px);box-shadow:0 12px 40px rgba(0,0,0,0.3);border-color:var(--gold)}
    .game-card::before{content:'';position:absolute;top:0;right:0;width:80px;height:80px;border-radius:50%;opacity:.06;pointer-events:none}
    .game-card .game-emoji{font-size:2.5rem;margin-bottom:10px;display:block}
    .game-card .game-name{font-size:1.05rem;font-weight:900;margin-bottom:4px}
    .game-card .game-desc{font-size:.78rem;color:var(--text2);line-height:1.4}
    .game-card .game-xp{position:absolute;top:14px;right:14px;background:rgba(245,158,11,0.15);color:var(--gold);font-size:.7rem;font-weight:900;padding:4px 10px;border-radius:8px}
    .game-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(10,14,26,0.97);backdrop-filter:blur(12px);z-index:850;overflow-y:auto;padding:20px;animation:fadeIn .3s}
    .game-container{max-width:480px;margin:0 auto}
    .game-back{display:inline-flex;align-items:center;gap:6px;padding:10px 16px;border:1px solid var(--glass-border);border-radius:12px;background:rgba(0,0,0,0.2);color:var(--text2);cursor:pointer;font-size:.82rem;font-weight:700;margin-bottom:16px;transition:all .3s}
    .game-back:hover{border-color:var(--gold);color:var(--gold)}
    .game-title-bar{text-align:center;margin-bottom:20px}
    .game-title-bar h2{font-size:1.4rem;font-weight:900;margin-bottom:4px}
    .game-title-bar p{color:var(--text2);font-size:.85rem}
    .quiz-option{display:block;width:100%;padding:14px 18px;margin-bottom:10px;border:1.5px solid var(--glass-border);border-radius:14px;background:rgba(0,0,0,0.2);color:var(--text);cursor:pointer;font-size:.9rem;font-weight:600;text-align:left;transition:all .3s}
    .quiz-option:hover{border-color:var(--gold);background:rgba(245,158,11,0.05);transform:translateX(4px)}
    .quiz-option.correct{border-color:var(--green);background:rgba(34,197,94,0.15);color:var(--green)}
    .quiz-option.wrong{border-color:var(--red);background:rgba(239,68,68,0.15);color:var(--red)}
    .quiz-progress{display:flex;gap:4px;margin-bottom:20px;justify-content:center}
    .quiz-dot{width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,0.1);transition:all .3s}
    .quiz-dot.done{background:var(--green)}.quiz-dot.current{background:var(--gold);transform:scale(1.3)}.quiz-dot.wrong-dot{background:var(--red)}
    .lemon-stat{background:rgba(0,0,0,0.2);border:1px solid var(--glass-border);border-radius:14px;padding:14px;text-align:center;margin-bottom:10px}
    .lemon-stat .ls-val{font-size:1.5rem;font-weight:900;margin-bottom:2px}
    .lemon-stat .ls-label{font-size:.72rem;color:var(--text2);font-weight:700;text-transform:uppercase}
    .lemon-controls{display:grid;gap:10px;margin-bottom:16px}
    .lemon-control{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:rgba(0,0,0,0.15);border-radius:12px;border:1px solid var(--glass-border)}
    .lemon-control label{font-size:.85rem;font-weight:700}
    .lemon-input{display:flex;align-items:center;gap:10px}
    .lemon-input input{width:70px;padding:8px;border-radius:8px;border:1px solid var(--glass-border);background:rgba(0,0,0,0.2);color:var(--text);text-align:center;font-size:1rem;font-weight:800}
    .weather-display{text-align:center;padding:20px;background:rgba(0,0,0,0.15);border-radius:16px;margin-bottom:16px;border:1px solid var(--glass-border)}
    .weather-display .weather-icon{font-size:3rem;margin-bottom:8px;display:block}
    .weather-display .weather-text{font-size:1rem;font-weight:800}
    .budget-item{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;margin-bottom:8px;background:rgba(0,0,0,0.15);border:1.5px solid var(--glass-border);border-radius:14px;cursor:pointer;transition:all .3s}
    .budget-item:hover{border-color:var(--gold)}
    .budget-item.selected{border-color:var(--green);background:rgba(34,197,94,0.08)}
    .budget-item .bi-info{display:flex;align-items:center;gap:10px}
    .budget-item .bi-icon{font-size:1.4rem}
    .budget-item .bi-name{font-size:.88rem;font-weight:700}
    .budget-item .bi-tag{font-size:.6rem;padding:2px 8px;border-radius:6px;font-weight:800;text-transform:uppercase}
    .bi-tag.need{background:rgba(59,130,246,0.15);color:var(--blue)}
    .bi-tag.want{background:rgba(236,72,153,0.15);color:var(--pink)}
    .bi-tag.save{background:rgba(34,197,94,0.15);color:var(--green)}
    .budget-item .bi-price{font-size:1rem;font-weight:900;color:var(--gold)}
    .budget-remaining{text-align:center;padding:16px;margin-bottom:14px;background:rgba(0,0,0,0.2);border-radius:14px;border:1px solid var(--glass-border)}
    .budget-remaining .br-label{font-size:.75rem;color:var(--text2);font-weight:700;text-transform:uppercase}
    .budget-remaining .br-value{font-size:1.8rem;font-weight:900;color:var(--gold)}
    .lesson-card{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:18px;padding:18px;margin-bottom:12px;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:14px}
    .lesson-card:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,0.2);border-color:var(--gold)}
    .lesson-card.completed-lesson{border-color:rgba(34,197,94,0.3)}
    .lesson-card .lesson-emoji{font-size:2rem;flex-shrink:0}
    .lesson-card .lesson-info{flex:1}
    .lesson-card .lesson-name{font-size:.95rem;font-weight:800;margin-bottom:3px}
    .lesson-card .lesson-desc{font-size:.75rem;color:var(--text2)}
    .lesson-card .lesson-badge{flex-shrink:0;font-size:1rem}
    .lesson-slide{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:20px;padding:28px;text-align:center;margin-bottom:16px;min-height:280px;display:flex;flex-direction:column;justify-content:center;align-items:center}
    .lesson-slide .slide-emoji{font-size:4rem;margin-bottom:16px}
    .lesson-slide .slide-title{font-size:1.2rem;font-weight:900;margin-bottom:10px}
    .lesson-slide .slide-text{font-size:.9rem;color:var(--text2);line-height:1.6;max-width:360px}
    .lesson-dots{display:flex;gap:6px;justify-content:center;margin-bottom:16px}
    .lesson-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.1);transition:all .3s}
    .lesson-dot.active{background:var(--gold);transform:scale(1.3)}
    .profile-avatar{text-align:center;padding:30px 20px;margin-bottom:16px}
    .profile-avatar .avatar-circle{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--orange));display:flex;align-items:center;justify-content:center;font-size:2.5rem;margin:0 auto 12px;box-shadow:0 8px 30px rgba(245,158,11,0.25);border:3px solid rgba(255,255,255,0.1)}
    .profile-avatar .profile-name{font-size:1.3rem;font-weight:900;margin-bottom:4px}
    .profile-avatar .profile-level{font-size:.9rem;color:var(--gold);font-weight:800}
    .xp-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid rgba(245,158,11,0.15);border-radius:18px;padding:18px;margin-bottom:16px}
    .xp-section .xp-title{font-size:.78rem;color:var(--text2);font-weight:700;margin-bottom:4px;text-transform:uppercase}
    .xp-section .xp-values{display:flex;justify-content:space-between;margin-bottom:8px}
    .xp-section .xp-current{font-size:1.1rem;font-weight:900;color:var(--gold)}
    .xp-section .xp-next{font-size:.8rem;color:var(--text2);font-weight:700}
    .xp-bar-full{width:100%;height:14px;background:rgba(0,0,0,0.3);border-radius:7px;overflow:hidden}
    .xp-bar-fill{height:100%;background:var(--gold-grad);border-radius:7px;transition:width .6s}
    .profile-stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
    .profile-stat{background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);border:1px solid var(--glass-border);border-radius:14px;padding:16px;text-align:center}
    .profile-stat .ps-value{font-size:1.3rem;font-weight:900;margin-bottom:4px}
    .profile-stat .ps-label{font-size:.68rem;color:var(--text2);font-weight:700;text-transform:uppercase}
    .achievements-section{margin-bottom:16px}
    .achievements-section h4{font-size:.85rem;color:var(--text2);font-weight:700;margin-bottom:12px}
    .achievement-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .achievement-badge{background:rgba(0,0,0,0.2);border:1px solid var(--glass-border);border-radius:14px;padding:14px 8px;text-align:center;transition:all .3s}
    .achievement-badge.earned{border-color:rgba(245,158,11,0.3);background:rgba(245,158,11,0.05)}
    .achievement-badge .ab-icon{font-size:1.5rem;margin-bottom:4px;display:block}
    .achievement-badge .ab-name{font-size:.6rem;font-weight:700;color:var(--text2)}
    .achievement-badge.earned .ab-name{color:var(--gold)}
    .levelup-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.92);backdrop-filter:blur(16px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1050;animation:fadeIn .5s}
    .levelup-content{text-align:center;animation:scaleIn .5s}
    .levelup-emoji{font-size:5rem;margin-bottom:10px;animation:bounce 1s infinite}
    .levelup-title{font-size:1.8rem;font-weight:900;color:var(--gold);margin-bottom:6px}
    .levelup-level{font-size:1.3rem;font-weight:800;color:var(--text);margin-bottom:20px}
    .empresas-portfolio-bar{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
    .empresas-portfolio-card{background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(139,92,246,0.08));backdrop-filter:blur(12px);border:1px solid rgba(245,158,11,0.15);border-radius:16px;padding:14px;text-align:center}
    .empresas-portfolio-card .ep-label{font-size:.65rem;color:var(--text2);font-weight:700;text-transform:uppercase;letter-spacing:.5px}
    .empresas-portfolio-card .ep-value{font-size:1.15rem;font-weight:900;margin-top:3px}
    .criar-empresa-section{background:linear-gradient(135deg,rgba(34,197,94,0.1),rgba(6,182,212,0.1));backdrop-filter:blur(16px);border:1px solid rgba(34,197,94,0.2);border-radius:20px;padding:18px;margin-bottom:16px;position:relative;overflow:hidden}
    .criar-empresa-section::before{content:'';position:absolute;top:-50%;right:-50%;width:100%;height:100%;background:radial-gradient(circle,rgba(34,197,94,.06),transparent);pointer-events:none}
    .criar-empresa-section h4{font-size:.9rem;font-weight:900;color:var(--green);margin-bottom:14px;display:flex;align-items:center;gap:8px}
    .criar-empresa-form{display:grid;gap:10px}
    .criar-empresa-form .form-group{margin-bottom:0}
    .criar-empresa-size-options{display:flex;gap:8px}
    .criar-empresa-size-btn{flex:1;padding:12px 8px;border:1.5px solid var(--glass-border);border-radius:12px;background:rgba(0,0,0,0.2);color:var(--text);cursor:pointer;text-align:center;transition:all .3s;font-size:.78rem;font-weight:700}
    .criar-empresa-size-btn:hover{border-color:var(--gold);transform:translateY(-1px)}
    .criar-empresa-size-btn.selected{border-color:var(--green);background:rgba(34,197,94,0.1);color:var(--green)}
    .criar-empresa-size-btn .size-price{font-size:1rem;font-weight:900;display:block;margin-bottom:2px}
    .criar-empresa-size-btn .size-earn{font-size:.65rem;color:var(--text2)}
    .my-companies-section{margin-bottom:16px}
    .my-companies-section h4{font-size:.85rem;color:var(--text2);font-weight:700;margin-bottom:10px}
    .my-company-card{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid rgba(34,197,94,0.15);border-radius:16px;padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:12px}
    .my-company-card .mc-icon{font-size:1.8rem;flex-shrink:0}
    .my-company-card .mc-info{flex:1}
    .my-company-card .mc-name{font-size:.88rem;font-weight:800}
    .my-company-card .mc-sector{font-size:.65rem;color:var(--text2);font-weight:600}
    .my-company-card .mc-stats{display:flex;gap:12px;margin-top:4px}
    .my-company-card .mc-stat{font-size:.68rem;color:var(--green);font-weight:700}
    .my-company-card .mc-upgrade{padding:8px 14px;border:1px solid rgba(245,158,11,0.3);border-radius:10px;background:rgba(245,158,11,0.08);color:var(--gold);cursor:pointer;font-size:.7rem;font-weight:800;transition:all .3s;flex-shrink:0}
    .my-company-card .mc-upgrade:hover{background:rgba(245,158,11,0.15);transform:translateY(-1px)}
    .company-grid{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:16px}
    .company-card{background:rgba(19,26,46,0.5);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,0.06);border-radius:18px;padding:16px;transition:all .3s;position:relative;overflow:hidden}
    .company-card:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,0.25);border-color:rgba(255,255,255,0.12)}
    .company-card-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .company-card-icon{font-size:1.8rem;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.2);border-radius:12px;flex-shrink:0}
    .company-card-info{flex:1}
    .company-card-name{font-size:.92rem;font-weight:900}
    .company-card-sector{display:inline-block;font-size:.6rem;font-weight:800;padding:3px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:.5px;margin-top:3px}
    .sector-brinquedos{background:rgba(236,72,153,0.15);color:#ec4899}
    .sector-tecnologia{background:rgba(59,130,246,0.15);color:#3b82f6}
    .sector-animais{background:rgba(163,230,53,0.15);color:#a3e635}
    .sector-alimentacao{background:rgba(249,115,22,0.15);color:#f97316}
    .sector-educacao{background:rgba(139,92,246,0.15);color:#8b5cf6}
    .sector-esportes{background:rgba(34,197,94,0.15);color:#22c55e}
    .sector-entretenimento{background:rgba(6,182,212,0.15);color:#06b6d4}
    .sector-sustentabilidade{background:rgba(132,204,22,0.15);color:#84cc16}
    .sector-comida{background:rgba(249,115,22,0.15);color:#f97316}
    .sector-roupas{background:rgba(244,114,182,0.15);color:#f472b6}
    .company-card-price-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .company-card-price{font-size:1.2rem;font-weight:900}
    .company-card-price.up{color:var(--green)}.company-card-price.down{color:var(--red)}.company-card-price.stable{color:var(--text)}
    .company-card-change{font-size:.72rem;font-weight:800;padding:3px 8px;border-radius:6px}
    .company-card-change.up{background:rgba(34,197,94,0.12);color:var(--green)}
    .company-card-change.down{background:rgba(239,68,68,0.12);color:var(--red)}
    .company-dividend-badge{display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(251,191,36,0.15));border:1px solid rgba(245,158,11,0.25);color:var(--gold);font-size:.68rem;font-weight:900;padding:4px 10px;border-radius:8px}
    .company-sparkline{height:30px;margin:6px 0}
    .company-sparkline canvas{width:100%;height:100%;border-radius:6px}
    .company-stars{color:var(--gold);font-size:.75rem;letter-spacing:1px}
    .company-card-footer{display:flex;align-items:center;justify-content:space-between;margin-top:10px;gap:8px}
    .company-owned-badge{font-size:.7rem;color:var(--cyan);font-weight:800;background:rgba(6,182,212,0.1);padding:4px 10px;border-radius:8px}
    .company-invest-btn{padding:10px 20px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff;font-size:.8rem;font-weight:900;cursor:pointer;transition:all .3s;text-transform:uppercase;letter-spacing:.5px}
    .company-invest-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(59,130,246,0.3)}
    .company-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.88);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;z-index:960;animation:fadeIn .2s}
    .company-modal-box{background:var(--dark2);border:1px solid var(--glass-border);border-radius:22px;padding:24px;width:92%;max-width:440px;max-height:88vh;overflow-y:auto;animation:scaleIn .3s;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
    .company-modal-box::-webkit-scrollbar{width:4px}
    .company-modal-box::-webkit-scrollbar-thumb{background:var(--dark4);border-radius:4px}
    .company-modal-header{display:flex;align-items:center;gap:12px;margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--glass-border)}
    .company-modal-header .cm-icon{font-size:2.2rem}
    .company-modal-header .cm-info{flex:1}
    .company-modal-header .cm-name{font-size:1.1rem;font-weight:900}
    .company-modal-header .cm-sector{font-size:.72rem;color:var(--text2)}
    .company-modal-close{width:32px;height:32px;border-radius:50%;border:1px solid var(--glass-border);background:rgba(0,0,0,0.2);color:var(--text2);cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all .3s;flex-shrink:0}
    .company-modal-close:hover{border-color:var(--red);color:var(--red)}
    .company-modal-desc{font-size:.82rem;color:var(--text2);line-height:1.5;margin-bottom:14px;padding:12px;background:rgba(0,0,0,0.15);border-radius:12px}
    .company-report{background:rgba(0,0,0,0.2);border:1px solid var(--glass-border);border-radius:14px;padding:14px;margin-bottom:14px}
    .company-report h5{font-size:.78rem;font-weight:800;color:var(--gold);margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px}
    .company-report-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:.8rem}
    .company-report-row:last-child{border-bottom:none}
    .company-report-label{color:var(--text2);font-weight:600}
    .company-report-value{font-weight:800}
    .company-modal-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px}
    .company-modal-stat{background:rgba(0,0,0,0.15);border-radius:10px;padding:10px;text-align:center}
    .company-modal-stat .cms-val{font-size:1rem;font-weight:900;margin-bottom:2px}
    .company-modal-stat .cms-label{font-size:.6rem;color:var(--text2);font-weight:700;text-transform:uppercase}
    .company-trade-section{background:rgba(0,0,0,0.15);border:1px solid var(--glass-border);border-radius:14px;padding:14px;margin-bottom:10px}
    .company-trade-section h5{font-size:.78rem;font-weight:800;color:var(--text2);margin-bottom:10px;text-align:center}
    .company-qty-row{display:flex;align-items:center;justify-content:center;gap:14px;margin-bottom:10px}
    .company-qty-btn{width:34px;height:34px;border-radius:50%;border:1px solid var(--glass-border);background:rgba(0,0,0,0.2);color:var(--text);font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s}
    .company-qty-btn:hover{border-color:var(--gold);color:var(--gold)}
    .company-qty-val{font-size:1.3rem;font-weight:900;min-width:30px;text-align:center}
    .company-total-cost{text-align:center;font-size:.82rem;color:var(--text2);margin-bottom:12px}
    .company-trade-btns{display:flex;gap:10px}
    .company-trade-btns .btn{flex:1;margin-top:0;padding:12px;font-size:.88rem}
    /* NEW FEATURE STYLES */
    .market-index-bar{background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(139,92,246,0.1));border:1px solid rgba(59,130,246,0.2);border-radius:14px;padding:12px 16px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .mib-left .mib-name{font-size:.72rem;font-weight:800;color:var(--text2)}
    .mib-left .mib-val{font-size:1.2rem;font-weight:900;color:var(--blue)}
    .mib-left .mib-chg{font-size:.72rem;font-weight:800;margin-top:2px}
    .mib-spark{width:80px;height:30px;flex-shrink:0}
    .event-ticker{background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:10px;padding:8px 14px;margin-bottom:14px;font-size:.78rem;overflow:hidden;white-space:nowrap}
    .event-ticker-inner{display:inline-block;animation:tickerScroll 20s linear infinite}
    @keyframes tickerScroll{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}}
    .fear-greed-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:18px;padding:16px;margin-bottom:14px}
    .fear-greed-section h4{font-size:.85rem;color:var(--text2);margin-bottom:12px;font-weight:700;display:flex;align-items:center;justify-content:space-between}
    .fg-gauge-wrap{position:relative;width:180px;height:100px;margin:0 auto 10px}
    .fg-label-row{display:flex;justify-content:space-between;font-size:.6rem;color:var(--text2);font-weight:700;margin-bottom:4px}
    .fg-value-display{text-align:center;font-size:1.4rem;font-weight:900;margin-bottom:4px}
    .fg-sentiment{text-align:center;font-size:.8rem;font-weight:800}
    .fg-tip{font-size:.7rem;color:var(--text2);text-align:center;margin-top:8px;padding:8px;background:rgba(0,0,0,0.15);border-radius:8px;line-height:1.4}
    .order-book-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:18px;padding:14px;margin-bottom:14px}
    .order-book-section h4{font-size:.82rem;color:var(--text2);margin-bottom:10px;font-weight:700}
    .ob-header{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;font-size:.6rem;color:var(--text2);font-weight:800;text-transform:uppercase;margin-bottom:6px;padding:0 4px}
    .ob-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;padding:4px 4px;border-radius:6px;font-size:.72rem;font-weight:700;position:relative;overflow:hidden;margin-bottom:2px}
    .ob-row-bg{position:absolute;top:0;bottom:0;border-radius:6px;opacity:.15;z-index:0}
    .ob-row span{position:relative;z-index:1}
    .ob-sell .ob-row-bg{background:var(--red);right:0}
    .ob-buy .ob-row-bg{background:var(--green);left:0}
    .ob-spread{text-align:center;font-size:.65rem;color:var(--text2);padding:4px;font-weight:800}
    .orders-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid rgba(139,92,246,0.2);border-radius:18px;padding:14px;margin-bottom:14px}
    .orders-section h4{font-size:.82rem;color:var(--purple);margin-bottom:10px;font-weight:700}
    .order-form{display:grid;gap:8px;margin-bottom:12px}
    .order-form-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .order-type-tabs{display:flex;gap:4px;margin-bottom:8px}
    .order-type-tab{flex:1;padding:7px 4px;border:1px solid var(--glass-border);border-radius:8px;background:transparent;color:var(--text2);cursor:pointer;font-size:.65rem;font-weight:800;transition:all .2s;text-align:center}
    .order-type-tab.active{background:var(--purple);color:#fff;border-color:var(--purple)}
    .order-input{flex:1;padding:8px 10px;border:1px solid var(--glass-border);border-radius:10px;background:rgba(0,0,0,0.2);color:var(--text);font-size:.85rem;font-weight:700;min-width:80px}
    .order-submit-btn{padding:8px 14px;border:none;border-radius:10px;background:var(--purple);color:#fff;font-size:.75rem;font-weight:800;cursor:pointer;transition:all .2s;white-space:nowrap}
    .order-submit-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(139,92,246,0.3)}
    .active-orders-list{display:flex;flex-direction:column;gap:6px}
    .active-order-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:10px;border:1px solid var(--glass-border);background:rgba(0,0,0,0.15);font-size:.72rem}
    .active-order-cancel{padding:3px 8px;border:1px solid rgba(239,68,68,0.4);border-radius:6px;background:transparent;color:var(--red);cursor:pointer;font-size:.65rem;font-weight:800;transition:all .2s}
    .active-order-cancel:hover{background:rgba(239,68,68,0.1)}
    .alerts-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid rgba(245,158,11,0.2);border-radius:18px;padding:14px;margin-bottom:14px}
    .alerts-section h4{font-size:.82rem;color:var(--gold);margin-bottom:10px;font-weight:700}
    .alert-form{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
    .alert-input{flex:1;padding:8px 10px;border:1px solid var(--glass-border);border-radius:10px;background:rgba(0,0,0,0.2);color:var(--text);font-size:.85rem;font-weight:700;min-width:80px}
    .alert-direction-btn{padding:6px 10px;border:1px solid var(--glass-border);border-radius:8px;background:transparent;color:var(--text2);cursor:pointer;font-size:.7rem;font-weight:800;transition:all .2s}
    .alert-direction-btn.active{background:var(--gold);color:#000;border-color:var(--gold)}
    .alert-add-btn{padding:7px 12px;border:none;border-radius:9px;background:var(--gold);color:#000;font-size:.72rem;font-weight:800;cursor:pointer;white-space:nowrap}
    .alert-item{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;border-radius:9px;border:1px solid rgba(245,158,11,0.2);background:rgba(245,158,11,0.05);font-size:.72rem;margin-bottom:5px}
    .alert-remove{padding:3px 7px;border:1px solid rgba(239,68,68,0.3);border-radius:6px;background:transparent;color:var(--red);cursor:pointer;font-size:.6rem;font-weight:800}
    .dca-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid rgba(34,197,94,0.2);border-radius:18px;padding:14px;margin-bottom:14px}
    .dca-section h4{font-size:.82rem;color:var(--green);margin-bottom:6px;font-weight:700}
    .dca-section .dca-desc{font-size:.7rem;color:var(--text2);margin-bottom:10px;line-height:1.4}
    .dca-form{display:grid;gap:8px;margin-bottom:10px}
    .dca-form-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .dca-input{flex:1;padding:8px 10px;border:1px solid var(--glass-border);border-radius:10px;background:rgba(0,0,0,0.2);color:var(--text);font-size:.85rem;font-weight:700;min-width:80px}
    .dca-select{flex:1;padding:8px 10px;border:1px solid var(--glass-border);border-radius:10px;background:rgba(0,0,0,0.25);color:var(--text);font-size:.8rem;font-weight:700}
    .dca-add-btn{padding:8px 14px;border:none;border-radius:10px;background:var(--green);color:#fff;font-size:.75rem;font-weight:800;cursor:pointer}
    .dca-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:10px;border:1px solid rgba(34,197,94,0.2);background:rgba(34,197,94,0.05);font-size:.72rem;margin-bottom:5px}
    .dca-item-cancel{padding:3px 8px;border:1px solid rgba(239,68,68,0.3);border-radius:6px;background:transparent;color:var(--red);cursor:pointer;font-size:.65rem;font-weight:800}
    .savings-section{background:linear-gradient(135deg,rgba(6,182,212,0.1),rgba(59,130,246,0.1));backdrop-filter:blur(16px);border:1px solid rgba(6,182,212,0.2);border-radius:18px;padding:16px;margin-bottom:14px}
    .savings-section h4{font-size:.85rem;color:var(--cyan);margin-bottom:12px;font-weight:700}
    .savings-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
    .savings-stat{background:rgba(0,0,0,0.2);border-radius:12px;padding:12px;text-align:center}
    .savings-stat .ss-val{font-size:1.1rem;font-weight:900;margin-bottom:3px}
    .savings-stat .ss-label{font-size:.62rem;color:var(--text2);font-weight:700;text-transform:uppercase}
    .savings-actions{display:flex;gap:8px}
    .savings-btn{flex:1;padding:10px;border:1px solid var(--glass-border);border-radius:10px;background:rgba(0,0,0,0.2);color:var(--text);cursor:pointer;font-size:.75rem;font-weight:800;transition:all .2s;text-align:center}
    .savings-btn.deposit{border-color:rgba(6,182,212,0.4);color:var(--cyan)}
    .savings-btn.withdraw{border-color:rgba(239,68,68,0.3);color:var(--red)}
    .savings-btn:hover{transform:translateY(-1px)}
    .short-positions{background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.2);border-radius:14px;padding:12px;margin-top:10px}
    .short-pos-item{display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:.75rem}
    .short-pos-item:last-child{border-bottom:none}
    .analytics-tab{padding:0}
    .analytics-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:18px;padding:16px;margin-bottom:14px}
    .analytics-section h4{font-size:.85rem;color:var(--text2);margin-bottom:12px;font-weight:700}
    .pnl-grid{display:grid;gap:8px}
    .pnl-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:12px;background:rgba(0,0,0,0.15);border:1px solid var(--glass-border)}
    .pnl-left{display:flex;align-items:center;gap:8px}
    .pnl-icon{font-size:1.2rem}
    .pnl-name{font-size:.8rem;font-weight:800}
    .pnl-qty{font-size:.65rem;color:var(--text2)}
    .pnl-right{text-align:right}
    .pnl-value{font-size:.9rem;font-weight:900}
    .pnl-pct{font-size:.7rem;font-weight:800}
    .analytics-metrics{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
    .analytics-metric{background:rgba(0,0,0,0.2);border:1px solid var(--glass-border);border-radius:14px;padding:14px;text-align:center}
    .analytics-metric .am-val{font-size:1.2rem;font-weight:900;margin-bottom:4px}
    .analytics-metric .am-label{font-size:.65rem;color:var(--text2);font-weight:700;text-transform:uppercase}
    .risk-meter{display:flex;gap:4px;margin-top:8px}
    .risk-bar{flex:1;height:8px;border-radius:4px}
    .tax-section{background:rgba(0,0,0,0.2);backdrop-filter:blur(12px);border:1px solid rgba(245,158,11,0.15);border-radius:18px;padding:16px;margin-bottom:14px}
    .tax-section h4{font-size:.85rem;color:var(--gold);margin-bottom:12px;font-weight:700}
    .tax-rows{display:grid;gap:6px}
    .tax-row{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-radius:10px;background:rgba(0,0,0,0.15);font-size:.8rem}
    .tax-row .tr-label{color:var(--text2);font-weight:600}
    .tax-row .tr-value{font-weight:900}
    .tax-tip{font-size:.72rem;color:var(--text2);margin-top:10px;padding:10px;background:rgba(0,0,0,0.15);border-radius:10px;line-height:1.5}
    .hidden{display:none!important}
    .lang-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px}
    .lang-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px;width:100%;max-width:600px;max-height:60vh;overflow-y:auto;padding:4px}
    .lang-btn{padding:12px 8px;border:1.5px solid var(--glass-border);border-radius:14px;background:rgba(0,0,0,0.2);backdrop-filter:blur(8px);color:var(--text);cursor:pointer;text-align:center;transition:all .3s;font-size:.85rem;font-weight:700}
    .lang-btn:hover{border-color:var(--gold);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.3)}
    .lang-btn .lang-flag{font-size:1.5rem;display:block;margin-bottom:4px}
    .lang-change-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border:1px solid var(--glass-border);border-radius:10px;background:rgba(0,0,0,0.2);color:var(--text2);cursor:pointer;font-size:.78rem;font-weight:700;transition:all .3s;margin-top:12px}
    .lang-change-btn:hover{border-color:var(--gold);color:var(--gold)}
    @media(max-width:500px){
      .config-grid{grid-template-columns:1fr}
      .stats-grid{grid-template-columns:1fr 1fr}
      .price-value{font-size:2rem}
      .trade-btn{padding:16px 8px;font-size:.95rem}
      .asset-chip{min-width:78px;padding:8px 10px}
      .portfolio-grid{grid-template-columns:1fr}
      .chart-wrap{height:170px}
      .profile-stats{grid-template-columns:1fr 1fr}
      .achievement-grid{grid-template-columns:repeat(3,1fr)}
      .empresas-portfolio-bar{grid-template-columns:1fr 1fr}
      .company-modal-stats{grid-template-columns:1fr 1fr 1fr}
    }
  </style>
</head>
<body>
<!-- LANGUAGE SELECTION -->
<div id="langScreen" class="lang-screen">
  <div class="login-logo">Financial Child</div>
  <div class="login-subtitle" style="margin-bottom:20px">Choose your language / Escolha seu idioma</div>
  <div class="lang-grid" id="langGrid"></div>
</div>

<!-- LOGIN -->
<div id="loginScreen" class="login-screen hidden">
  <div class="login-logo">Financial Child</div>
  <div class="login-subtitle">Aprenda a investir brincando!</div>
  <div class="login-box">
    <div class="tab-switch"><button class="tab-btn active" onclick="switchTab('login')">Entrar</button><button class="tab-btn" onclick="switchTab('register')">Criar Conta</button></div>
    <div id="loginForm">
      <div class="form-group"><label id="lbl_email">Email</label><input type="email" id="loginEmail" placeholder="seu@email.com"></div>
      <div class="form-group"><label id="lbl_password">Senha</label><input type="password" id="loginPassword" placeholder="Sua senha"></div>
      <button class="btn btn-primary ripple" id="btn_login" onclick="handleLogin()">Entrar</button>
      <div id="loginError" class="error-msg hidden"></div>
      <div class="access-options">
        <button class="access-btn" onclick="enterAsParent()"><span class="icon"></span><span class="label" id="btn_parent">Sou Pai/Mae</span></button>
        <button class="access-btn" onclick="showChildAccess()"><span class="icon"></span><span class="label" id="btn_child">Sou Crianca</span></button>
      </div>
    </div>
    <div id="registerForm" class="hidden">
      <div class="form-group"><label id="lbl_yourname">Seu Nome</label><input type="text" id="regName" placeholder="Ex: Maria"></div>
      <div class="form-group"><label id="lbl_email2">Email</label><input type="email" id="regEmail" placeholder="seu@email.com"></div>
      <div class="form-group"><label id="lbl_password2">Senha</label><input type="password" id="regPassword" placeholder="Crie uma senha"></div>
      <button class="btn btn-primary ripple" id="btn_register" onclick="handleRegister()">Criar Conta</button>
      <div id="regError" class="error-msg hidden"></div>
    </div>
  </div>
  <button class="lang-change-btn" onclick="showScreen('lang')"> <span id="loginLangBtnText">Mudar Idioma</span></button>
</div>

<!-- PARENT DASHBOARD -->
<div id="parentDashboard" class="dashboard hidden">
  <div class="header"><div class="header-left"><h1>Financial Child</h1><small>Painel dos Pais</small></div><button class="logout-btn" onclick="logout()">Sair</button></div>
  <div id="setupChild" class="card">
    <h3> Configurar Conta do Filho</h3>
    <div class="config-grid">
      <div class="form-group"><label>Nome</label><input type="text" id="childName" placeholder="Ex: Joao"></div>
      <div class="form-group"><label>Idade</label><input type="number" id="childAge" value="10" min="5" max="17"></div>
      <div class="form-group"><label>Saldo Inicial (R$)</label><input type="number" id="childBalance" value="100" min="10" step="10"></div>
      <div class="form-group"><label>Volatilidade</label><select id="childVolatility"><option value="baixa">Baixa</option><option value="media" selected>Media</option><option value="alta">Alta</option></select></div>
      <div class="form-group"><label>Meta (R$)</label><input type="number" id="childGoal" value="200" min="20" step="10"></div>
    </div>
    <button class="btn btn-primary ripple" onclick="createChildAccount()">Criar Conta</button>
  </div>
  <div id="childDashboard" class="hidden">
    <div class="stats-grid">
      <div class="stat-card stat-blue"><div class="stat-value" id="pSaldo">R$ 0</div><div class="stat-label">Saldo</div></div>
      <div class="stat-card stat-green"><div class="stat-value" id="pMoedas">0</div><div class="stat-label">Ativos</div></div>
      <div class="stat-card stat-gold"><div class="stat-value" id="pTotal">R$ 0</div><div class="stat-label">Patrimonio</div></div>
      <div class="stat-card stat-purple"><div class="stat-value" id="pOps">0</div><div class="stat-label">Operacoes</div></div>
    </div>
    <div class="card"><h3> Meta</h3><div class="progress-header"><span class="progress-label" id="pChildName">Filho</span><span class="progress-value" id="pGoalText">R$0 / R$0</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" id="pProgressBar" style="width:0%"><span class="progress-percent" id="pProgressPct">0%</span></div></div></div>
    <div class="card"><h3> Config</h3><div class="config-grid"><div class="form-group"><label>Volatilidade</label><select id="editVolatility" onchange="updateConfig()"><option value="baixa">Baixa</option><option value="media">Media</option><option value="alta">Alta</option></select></div><div class="form-group"><label>Meta (R$)</label><input type="number" id="editGoal" min="20" step="10" onchange="updateConfig()"></div></div><div class="btn-row"><button class="btn btn-sm btn-outline ripple" onclick="toggleMarket()" id="toggleBtn"> Pausar</button><button class="btn btn-sm btn-outline ripple" onclick="resetChildAccount()" style="border-color:rgba(239,68,68,.3);color:var(--red);"> Resetar</button></div></div>
    <div class="card"><h3> Codigo da Crianca</h3><div style="background:rgba(0,0,0,0.25);padding:16px;border-radius:14px;text-align:center;"><span id="childCode" style="font-size:1.8rem;font-weight:900;letter-spacing:6px;color:var(--gold);"></span></div></div>
    <div class="card"><h3> Historico</h3><div class="tx-list" id="pTxList"><p style="color:var(--text2);text-align:center;padding:16px;">Nenhuma operacao</p></div></div>
  </div>
</div>

<!-- CHILD ACCESS -->
<div id="childAccessScreen" class="login-screen hidden">
  <div class="login-logo">Financial Child</div>
  <div class="login-subtitle">Area do Investidor </div>
  <div class="login-box">
    <h2>Digite seu codigo</h2>
    <div class="form-group"><label>Codigo</label><input type="text" id="childCodeInput" placeholder="ABC123" maxlength="6" style="text-align:center;font-size:1.5rem;letter-spacing:6px;font-weight:900;"></div>
    <button class="btn btn-primary ripple" onclick="childLogin()">Entrar</button>
    <div id="childLoginError" class="error-msg hidden"></div>
    <button class="btn btn-outline" style="margin-top:12px;" onclick="backToLogin()">Voltar</button>
  </div>
</div>

<!-- TRADING PANEL (Child) -->
<div id="tradingPanel" class="trading-panel hidden">
  <div class="trading-header">
    <div><h1>Financial Child</h1><div class="market-status"><div class="status-dot" id="marketDot"></div><span id="marketStatusText">Ao vivo</span></div></div>
    <div class="balance-display"><div class="label">SALDO</div><div class="value" id="cBalance">R$ 0</div></div>
  </div>
  <div class="xp-header-bar" id="xpHeaderBar">
    <span class="xp-level-badge" id="xpLevelBadge"> Lv.1</span>
    <div class="xp-bar-mini"><div class="xp-bar-mini-fill" id="xpBarMiniFill" style="width:0%"></div></div>
    <span class="xp-text-mini" id="xpTextMini">0/50 XP</span>
  </div>
  <div class="welcome-banner" id="welcomeBanner">
    <div class="wb-greeting" id="wbGreeting">Ola, Investidor! </div>
    <div class="wb-sub">Bora fazer boas escolhas hoje?</div>
  </div>

  <!-- TAB: MERCADO -->
  <div id="tabMercado" class="tab-content active">
    <!-- Market Index -->
    <div class="market-index-bar" id="marketIndexBar">
      <div class="mib-left">
        <div class="mib-name"> IBKIDS Index</div>
        <div class="mib-val" id="ibkidsVal">1000</div>
        <div class="mib-chg" id="ibkidsChg"></div>
      </div>
      <canvas class="mib-spark" id="ibkidsSparkline"></canvas>
    </div>
    <!-- Event Ticker -->
    <div class="event-ticker" id="eventTickerWrap" style="display:none">
      <span id="eventTickerText" class="event-ticker-inner"></span>
    </div>
    <!-- Sentiment -->
    <div class="fear-greed-section">
      <h4> Sentimento do Mercado <span style="font-size:.65rem;color:var(--text2);cursor:pointer;" onclick="toggleFGTip()"></span></h4>
      <div class="fg-label-row"><span style="color:var(--red)">Medo</span><span>Neutro</span><span style="color:var(--green)">Ganancia</span></div>
      <canvas id="fgGauge" width="200" height="110" style="display:block;margin:0 auto 8px;"></canvas>
      <div class="fg-value-display" id="fgValue">50</div>
      <div class="fg-sentiment" id="fgSentiment">Neutro</div>
      <div class="fg-tip hidden" id="fgTip">O indice mede o sentimento dos investidores. Medo extremo pode ser oportunidade de compra; ganancia extrema pode indicar bolha. Use como referencia educacional!</div>
    </div>
    <div class="category-tabs" id="catTabs"></div>
    <div class="asset-scroll" id="assetScroll"></div>
    <div class="price-section">
      <div class="price-label"><span class="live-dot"></span> <strong id="cCoinName">EKO</strong> - <span id="cCoinType">Cripto</span></div>
      <div class="price-row"><span class="price-value price-stable" id="cPrice">R$ 10,00</span><span class="price-emoji" id="cEmoji"></span></div>
      <div class="price-change" id="cPriceChange"></div>
      <div class="price-meta">
        <span> Max: <strong id="cHigh">-</strong></span>
        <span> Min: <strong id="cLow">-</strong></span>
        <span> Base: <strong id="cBase">-</strong></span>
      </div>
    </div>
    <!-- Order Book -->
    <div class="order-book-section">
      <h4> Livro de Ordens</h4>
      <div class="ob-header"><span>Preco</span><span style="text-align:center">Qtd</span><span style="text-align:right">Total</span></div>
      <div id="obSellOrders"></div>
      <div class="ob-spread" id="obSpread">Spread: --</div>
      <div id="obBuyOrders"></div>
    </div>
    <div class="chart-section">
      <div class="chart-toolbar">
        <span class="chart-title" id="chartTitle">Grafico EKO</span>
        <div class="chart-toolbar-right">
          <button class="chart-type-btn active" id="chartTypeLine" onclick="setChartType('line')"> Linha</button>
          <button class="chart-type-btn" id="chartTypeCandle" onclick="setChartType('candle')"> Vela</button>
          <div class="time-tabs" id="timeTabs"></div>
        </div>
      </div>
      <div class="indicator-tabs">
        <button class="indicator-btn" id="indMA" onclick="toggleIndicator('MA')">MA</button>
        <button class="indicator-btn" id="indBB" onclick="toggleIndicator('BB')">BB</button>
        <button class="indicator-btn" id="indRSI" onclick="toggleIndicator('RSI')">RSI</button>
      </div>
      <div class="chart-wrap"><canvas class="chart-canvas" id="priceChart"></canvas></div>
      <div class="rsi-wrap hidden" id="rsiWrap"><canvas id="rsiCanvas" style="width:100%;height:100%"></canvas></div>
    </div>
    <div class="news-section">
      <div class="news-header"><span> Noticias do Mercado</span><span class="news-badge">AO VIVO</span></div>
      <div id="newsContainer"></div>
    </div>
    <div class="holdings-bar">
      <div class="holding-item"><div class="h-label">Quantidade</div><div class="h-value" id="cQty" style="color:var(--blue);">0</div></div>
      <div class="holding-item"><div class="h-label">Valor</div><div class="h-value" id="cVal" style="color:var(--purple);">R$ 0</div></div>
      <div class="holding-item"><div class="h-label">Patrimonio</div><div class="h-value" id="cTotal" style="color:var(--gold);">R$ 0</div></div>
    </div>
    <div class="portfolio-section"><h4> Carteira</h4><div class="portfolio-grid" id="portfolioGrid"></div></div>
    <!-- Short Positions -->
    <div id="shortPositionsWrap" class="hidden">
      <div class="short-positions">
        <h4 style="font-size:.8rem;color:var(--purple);font-weight:800;margin-bottom:8px;"> Posicoes Short</h4>
        <div id="shortPosList"></div>
      </div>
    </div>
    <div class="trade-section">
      <h4>Negociar <span id="tradeAssetName">EKO</span></h4>
      <div class="qty-selector"><label>Qtd:</label><div class="qty-controls"><button class="qty-btn ripple" onclick="changeQty(-1)">-</button><span class="qty-value" id="qtyValue">1</span><button class="qty-btn ripple" onclick="changeQty(1)">+</button></div></div>
      <div class="trade-buttons">
        <button class="trade-btn buy-btn ripple" id="buyBtn" onclick="confirmTrade('BUY')">Comprar<span class="btn-sub" id="buyCost"></span></button>
        <button class="trade-btn sell-btn ripple" id="sellBtn" onclick="confirmTrade('SELL')">Vender<span class="btn-sub" id="sellValue"></span></button>
        <button class="short-btn ripple" id="shortBtn" onclick="openShortModal()">Short<span style="font-size:.6rem;display:block;margin-top:3px;"> Venda a descoberto</span></button>
      </div>
      <div class="max-buttons">
        <button class="max-btn ripple" onclick="buyMax()"> COMPRAR MAX</button>
        <button class="max-btn ripple" onclick="sellMax()"> VENDER TUDO</button>
      </div>
      <div class="leverage-row">
        <span style="font-size:.75rem;font-weight:700;color:var(--text2);"> Alavancagem 2x <span style="font-size:.6rem;">(maior risco!)</span></span>
        <button class="leverage-toggle" id="leverageToggle" onclick="toggleLeverage()">OFF</button>
      </div>
    </div>
    <!-- Advanced Orders -->
    <div class="orders-section">
      <h4> Ordens Avancadas</h4>
      <div class="order-type-tabs">
        <button class="order-type-tab active" id="otLimitBuy" onclick="selectOrderType('LIMIT_BUY')">Limite Compra</button>
        <button class="order-type-tab" id="otLimitSell" onclick="selectOrderType('LIMIT_SELL')">Limite Venda</button>
        <button class="order-type-tab" id="otStopLoss" onclick="selectOrderType('STOP_LOSS')">Stop Loss</button>
        <button class="order-type-tab" id="otStopGain" onclick="selectOrderType('STOP_GAIN')">Stop Gain</button>
      </div>
      <div class="order-form">
        <div class="order-form-row">
          <input class="order-input" type="number" id="orderPrice" placeholder="Preco alvo (R$)" step="0.01">
          <input class="order-input" type="number" id="orderQty" placeholder="Qtd" min="1" value="1">
          <button class="order-submit-btn" onclick="placeOrder()">Criar Ordem</button>
        </div>
        <div style="font-size:.68rem;color:var(--text2)" id="orderTypeDesc">Compra automaticamente quando preco atingir o alvo</div>
      </div>
      <div id="activeOrdersList" class="active-orders-list"></div>
    </div>
    <!-- Price Alerts -->
    <div class="alerts-section">
      <h4> Alertas de Preco</h4>
      <div class="alert-form">
        <button class="alert-direction-btn active" id="alertDirAbove" onclick="setAlertDir('above')">Acima </button>
        <button class="alert-direction-btn" id="alertDirBelow" onclick="setAlertDir('below')">Abaixo </button>
        <input class="alert-input" type="number" id="alertPrice" placeholder="Preco (R$)" step="0.01">
        <button class="alert-add-btn" onclick="addAlert()">+ Alerta</button>
      </div>
      <div id="alertsList"></div>
    </div>
    <!-- DCA -->
    <div class="dca-section">
      <h4> Investimento Automatico (DCA)</h4>
      <div class="dca-desc">Invista valores fixos periodicamente. Reduz o impacto da volatilidade e constroi patrimonio gradualmente!</div>
      <div class="dca-form">
        <div class="dca-form-row">
          <input class="dca-input" type="number" id="dcaAmount" placeholder="Valor R$" min="1" step="1">
          <select class="dca-select" id="dcaFreq">
            <option value="30">A cada 30s</option>
            <option value="60">A cada 1min</option>
            <option value="300">A cada 5min</option>
          </select>
          <button class="dca-add-btn" onclick="addDCA()">+ DCA</button>
        </div>
      </div>
      <div id="dcaList"></div>
    </div>
    <!-- Savings Account -->
    <div class="savings-section">
      <h4> Conta Poupanca</h4>
      <div class="savings-stats">
        <div class="savings-stat"><div class="ss-val" id="savBalance" style="color:var(--cyan)">R$ 0,00</div><div class="ss-label">Saldo</div></div>
        <div class="savings-stat"><div class="ss-val" id="savInterest" style="color:var(--green)">R$ 0,00</div><div class="ss-label">Juros Ganhos</div></div>
        <div class="savings-stat"><div class="ss-val" id="savRate" style="color:var(--gold)">0.3%/min</div><div class="ss-label">Taxa</div></div>
        <div class="savings-stat"><div class="ss-val" id="savProjected" style="color:var(--blue)">R$ 0,00</div><div class="ss-label">Projecao/min</div></div>
      </div>
      <div class="savings-actions">
        <button class="savings-btn deposit" onclick="openSavingsModal('deposit')"> Depositar</button>
        <button class="savings-btn withdraw" onclick="openSavingsModal('withdraw')"> Sacar</button>
      </div>
    </div>
    <div class="challenges-section">
      <h4> Desafios do Investidor</h4>
      <div id="challengesList"></div>
    </div>
    <div class="yield-section">
      <div class="yield-header"><span class="yield-title"> Rendimento Passivo</span><span class="yield-rate" id="yieldRate">+0.5%/min</span></div>
      <div class="yield-info">
        <div class="yield-card"><div class="y-label">Ganho/min</div><div class="y-value" id="yieldPerMin" style="color:var(--green)">R$ 0,00</div><div class="y-sub">baseado nos seus EKOs</div></div>
        <div class="yield-card"><div class="y-label">Total ganho</div><div class="y-value" id="yieldTotal" style="color:var(--gold)">R$ 0,00</div><div class="y-sub" id="yieldTime">desde o inicio</div></div>
      </div>
    </div>
    <div class="ranking-section">
      <h4> Ranking de Investidores</h4>
      <div class="rank-list" id="rankList"></div>
    </div>
    <div class="progress-section"><div class="progress-header"><span class="progress-label"> Meta</span><span class="progress-value" id="cGoalText">R$0 / R$0</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" id="cProgressBar" style="width:0%"><span class="progress-percent" id="cProgressPct">0%</span></div></div></div>
    <div class="tx-feed"><h4>Ultimas Operacoes</h4><div id="cTxList"><p style="color:var(--text2);text-align:center;padding:10px;font-size:.85rem;">Faca sua primeira operacao!</p></div></div>
  </div>

  <!-- TAB: ANALISE -->
  <div id="tabAnalise" class="tab-content analytics-tab">
    <h3 style="text-align:center;margin-bottom:18px;font-size:1.2rem;font-weight:900;"> Analise da Carteira</h3>
    <div class="analytics-section">
      <h4> Alocacao por Categoria</h4>
      <canvas id="pieChart" width="300" height="200" style="display:block;margin:0 auto;max-width:300px;"></canvas>
      <div id="pieLegend" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:10px;"></div>
    </div>
    <div class="analytics-metrics">
      <div class="analytics-metric"><div class="am-val" id="analyticsTotalROI" style="color:var(--green)">0%</div><div class="am-label">ROI Total</div></div>
      <div class="analytics-metric"><div class="am-val" id="analyticsDivScore" style="color:var(--blue)">0/10</div><div class="am-label">Diversificacao</div></div>
      <div class="analytics-metric"><div class="am-val" id="analyticsPatrimony" style="color:var(--gold)">R$ 0</div><div class="am-label">Patrimonio</div></div>
      <div class="analytics-metric"><div class="am-val" id="analyticsRisk" style="color:var(--orange)">-</div><div class="am-label">Perfil de Risco</div></div>
    </div>
    <div class="analytics-section">
      <h4> Historico do Patrimonio</h4>
      <canvas id="portfolioHistChart" width="400" height="120" style="width:100%;height:120px;border-radius:12px;"></canvas>
    </div>
    <div class="analytics-section">
      <h4> P&L por Ativo</h4>
      <div class="pnl-grid" id="pnlGrid"></div>
    </div>
    <!-- Tax Simulation -->
    <div class="tax-section">
      <h4> Simulacao de IR</h4>
      <div class="tax-rows">
        <div class="tax-row"><span class="tr-label">Ganhos Realizados</span><span class="tr-value" id="taxGains" style="color:var(--green)">R$ 0,00</span></div>
        <div class="tax-row"><span class="tr-label">Base Tributavel</span><span class="tr-value" id="taxBase" style="color:var(--gold)">R$ 0,00</span></div>
        <div class="tax-row"><span class="tr-label">IR Estimado (15%)</span><span class="tr-value" id="taxOwed" style="color:var(--red)">R$ 0,00</span></div>
        <div class="tax-row"><span class="tr-label">Lucro Liquido</span><span class="tr-value" id="taxNet" style="color:var(--cyan)">R$ 0,00</span></div>
      </div>
      <div class="tax-tip"> No Brasil, ganhos no mercado acima de R$ 20/mes podem ser tributados em 15% (Imposto de Renda sobre ganho de capital). Aqui e uma simulacao educacional!</div>
    </div>
  </div>

  <!-- TAB: EMPRESAS -->
  <div id="tabEmpresas" class="tab-content">
    <h3 style="text-align:center;margin-bottom:18px;font-size:1.2rem;font-weight:900;"> Empresas & Investimentos</h3>
    <div class="empresas-portfolio-bar" id="empresasPortfolioBar">
      <div class="empresas-portfolio-card"><div class="ep-label">Total Investido</div><div class="ep-value" id="epTotalInvested" style="color:var(--blue)">R$ 0,00</div></div>
      <div class="empresas-portfolio-card"><div class="ep-label">Dividendos Ganhos</div><div class="ep-value" id="epDividendsEarned" style="color:var(--green)">R$ 0,00</div></div>
      <div class="empresas-portfolio-card"><div class="ep-label">Empresas Investidas</div><div class="ep-value" id="epCompaniesCount" style="color:var(--purple)">0</div></div>
      <div class="empresas-portfolio-card"><div class="ep-label">Renda Projetada/min</div><div class="ep-value" id="epProjectedIncome" style="color:var(--gold)">R$ 0,00</div></div>
    </div>
    <div class="criar-empresa-section">
      <h4> Criar Minha Empresa</h4>
      <div class="criar-empresa-form">
        <div class="form-group"><label>Nome da Empresa</label><input type="text" id="myCompanyName" placeholder="Ex: Super Lanches" maxlength="20"></div>
        <div class="form-group"><label>Setor</label><select id="myCompanySector"><option value="Comida"> Comida</option><option value="Brinquedos"> Brinquedos</option><option value="Tecnologia"> Tecnologia</option><option value="Roupas"> Roupas</option><option value="Animais"> Animais</option><option value="Educacao"> Educacao</option></select></div>
        <div class="form-group"><label>Investimento Inicial</label>
          <div class="criar-empresa-size-options" id="compSizeOptions">
            <div class="criar-empresa-size-btn" onclick="selectCompanySize('small')" id="compSizeSmall"><span class="size-price">R$ 20</span><span class="size-earn">Renda: R$ 0,05/tick</span></div>
            <div class="criar-empresa-size-btn" onclick="selectCompanySize('medium')" id="compSizeMedium"><span class="size-price">R$ 50</span><span class="size-earn">Renda: R$ 0,15/tick</span></div>
            <div class="criar-empresa-size-btn" onclick="selectCompanySize('large')" id="compSizeLarge"><span class="size-price">R$ 100</span><span class="size-earn">Renda: R$ 0,40/tick</span></div>
          </div>
        </div>
        <button class="btn btn-primary ripple" onclick="createMyCompany()">Criar Empresa </button>
      </div>
    </div>
    <div class="my-companies-section" id="myCompaniesSection">
      <h4> Minhas Empresas</h4>
      <div id="myCompaniesList"><p style="color:var(--text2);text-align:center;font-size:.82rem;padding:12px;">Voce ainda nao criou nenhuma empresa.</p></div>
    </div>
    <h4 style="font-size:.85rem;color:var(--text2);font-weight:700;margin-bottom:12px;"> Empresas Disponiveis para Investir</h4>
    <div class="company-grid" id="companyGrid"></div>
  </div>

  <!-- TAB: JOGOS -->
  <div id="tabJogos" class="tab-content">
    <h3 style="text-align:center;margin-bottom:18px;font-size:1.2rem;font-weight:900;"> Mini-Games</h3>
    <div class="game-card" onclick="startQuiz()"><span class="game-emoji"></span><div class="game-name">Quiz do Investidor</div><div class="game-desc">Teste seus conhecimentos sobre dinheiro e investimentos!</div><span class="game-xp">+15 XP</span></div>
    <div class="game-card" onclick="startLemonade()"><span class="game-emoji"></span><div class="game-name">Fabrica de Limonada</div><div class="game-desc">Monte sua barraca e aprenda sobre custos, precos e lucro!</div><span class="game-xp">+15 XP</span></div>
    <div class="game-card" onclick="startBudget()"><span class="game-emoji"></span><div class="game-name">Desafio do Orcamento</div><div class="game-desc">Receba R$100 e aprenda a gastar com sabedoria!</div><span class="game-xp">+15 XP</span></div>
  </div>

  <!-- TAB: APRENDER -->
  <div id="tabAprender" class="tab-content">
    <h3 style="text-align:center;margin-bottom:18px;font-size:1.2rem;font-weight:900;"> Aprender</h3>
    <div id="lessonsList"></div>
  </div>

  <!-- TAB: PERFIL -->
  <div id="tabPerfil" class="tab-content">
    <div class="profile-avatar">
      <div class="avatar-circle" id="profileAvatarIcon"></div>
      <div class="profile-name" id="profileName">Investidor</div>
      <div class="profile-level" id="profileLevel"> Nivel 1 - Iniciante</div>
    </div>
    <div class="xp-section">
      <div class="xp-title">Experiencia</div>
      <div class="xp-values"><span class="xp-current" id="profileXpCurrent">0 XP</span><span class="xp-next" id="profileXpNext">Proximo: 50 XP</span></div>
      <div class="xp-bar-full"><div class="xp-bar-fill" id="profileXpBar" style="width:0%"></div></div>
    </div>
    <div class="profile-stats">
      <div class="profile-stat"><div class="ps-value" id="profPatrimony" style="color:var(--gold)">R$ 0</div><div class="ps-label">Patrimonio</div></div>
      <div class="profile-stat"><div class="ps-value" id="profTrades" style="color:var(--blue)">0</div><div class="ps-label">Operacoes</div></div>
      <div class="profile-stat"><div class="ps-value" id="profDays" style="color:var(--green)">0</div><div class="ps-label">Dias Ativo</div></div>
      <div class="profile-stat"><div class="ps-value" id="profGames" style="color:var(--purple)">0</div><div class="ps-label">Jogos</div></div>
    </div>
    <div class="achievements-section">
      <h4> Conquistas</h4>
      <div class="achievement-grid" id="achievementGrid"></div>
    </div>
    <button class="btn btn-outline" style="margin-top:14px;margin-bottom:10px;" onclick="logout()" id="btn_logout_profile">Sair da Conta</button>
    <button class="lang-change-btn" style="width:100%;justify-content:center;margin-bottom:20px;" onclick="showScreen('lang')"> <span id="profileLangBtnText">Mudar Idioma</span></button>
  </div>
</div>

<!-- FIXED TRADE BAR (always visible on Mercado tab) -->
<div id="fixedTradeBar" class="fixed-trade-bar">
  <div class="ftb-row">
    <div class="ftb-asset"><span class="ftb-icon" id="ftbIcon"></span><span class="ftb-name" id="ftbName">EKO</span></div>
    <div class="ftb-price-col"><div class="ftb-price stable" id="ftbPrice">R$ 10,00</div><div class="ftb-change" id="ftbChange"></div></div>
    <div class="ftb-btns">
      <button class="ftb-buy" id="ftbBuy" onclick="confirmTrade('BUY')">COMPRAR</button>
      <button class="ftb-sell" id="ftbSell" onclick="confirmTrade('SELL')">VENDER</button>
    </div>
  </div>
</div>

<!-- BOTTOM NAV (child only) -->
<div id="bottomNav" class="bottom-nav hidden">
  <div class="nav-item active" onclick="switchChildTab('Mercado')" id="navMercado"><span class="nav-icon"></span><span class="nav-label">Mercado</span></div>
  <div class="nav-item" onclick="switchChildTab('Analise')" id="navAnalise"><span class="nav-icon"></span><span class="nav-label">Analise</span></div>
  <div class="nav-item" onclick="switchChildTab('Empresas')" id="navEmpresas"><span class="nav-icon"></span><span class="nav-label">Empresas</span></div>
  <div class="nav-item" onclick="switchChildTab('Jogos')" id="navJogos"><span class="nav-icon"></span><span class="nav-label">Jogos</span></div>
  <div class="nav-item" onclick="switchChildTab('Perfil')" id="navPerfil"><span class="nav-icon"></span><span class="nav-label">Perfil</span></div>
</div>

<!-- OVERLAYS -->
<div id="celebrationOverlay" class="celebration-overlay hidden"><div class="celebration-content"><div class="celebration-emoji"></div><div class="celebration-title">META ATINGIDA!</div><div class="celebration-text" id="celebrationText"></div><button class="btn btn-primary ripple" style="max-width:200px;margin:0 auto;" onclick="closeCelebration()">Valeu! </button></div></div>
<div id="confirmOverlay" class="confirm-overlay hidden">
  <div class="confirm-box">
    <div class="confirm-title" id="confirmTitle">Comprar EKO?</div>
    <div class="confirm-detail" id="confirmDetail">2 EKO por R$ 20,00</div>
    <div class="confirm-question"> Por que voce quer fazer isso?</div>
    <div class="reason-options" id="reasonOptions"></div>
    <div class="confirm-actions">
      <button class="btn btn-cancel ripple" onclick="cancelTrade()">Cancelar</button>
      <button class="btn btn-primary ripple" id="confirmBtn" onclick="executeTrade()" disabled>Confirmar</button>
    </div>
  </div>
</div>
<div id="pausedOverlay" class="paused-overlay hidden"><div class="paused-content"><div class="pause-icon"></div><div class="pause-text">Mercado Pausado</div></div></div>
<div id="levelUpOverlay" class="levelup-overlay hidden">
  <div class="levelup-content">
    <div class="levelup-emoji" id="levelUpEmoji"></div>
    <div class="levelup-title">LEVEL UP!</div>
    <div class="levelup-level" id="levelUpText">Nivel 2 - Aprendiz</div>
    <button class="btn btn-primary ripple" style="max-width:200px;margin:0 auto;" onclick="closeLevelUp()">Incrivel! </button>
  </div>
</div>
<div id="companyModalOverlay" class="company-modal-overlay hidden"><div class="company-modal-box" id="companyModalBox"></div></div>
<div id="gameOverlay" class="game-overlay hidden"><div class="game-container" id="gameContainer"></div></div>
<div id="lessonOverlay" class="game-overlay hidden"><div class="game-container" id="lessonContainer"></div></div>
<!-- Generic Modal for savings/short input -->
<div id="genericModalOverlay" class="confirm-overlay hidden">
  <div class="confirm-box">
    <div class="confirm-title" id="genericModalTitle">Acao</div>
    <div class="confirm-detail" style="margin-bottom:14px;" id="genericModalDetail"></div>
    <div class="form-group"><input type="number" id="genericModalInput" placeholder="R$ 0,00" min="0.01" step="0.01" style="margin-bottom:0;"></div>
    <div class="confirm-actions" style="margin-top:14px;">
      <button class="btn btn-cancel ripple" onclick="closeGenericModal()">Cancelar</button>
      <button class="btn btn-primary ripple" id="genericModalConfirm" onclick="confirmGenericModal()">Confirmar</button>
    </div>
  </div>
</div>
<script>
// ============================================================
// FINANCIAL CHILD v4 - PREMIUM EDITION (FULL FEATURES)
// ============================================================

const CATEGORIES = [
  { id: 'cripto',      name: 'Cripto',      icon: '' },
  { id: 'acoes',       name: 'Acoes',       icon: '' },
  { id: 'commodities', name: 'Commodit.',   icon: '' },
  { id: 'rendafixa',   name: 'Renda Fixa',  icon: '' },
  { id: 'fundos',      name: 'Fundos',      icon: '' },
  { id: 'forex',       name: 'Moedas',      icon: '' },
];

const ASSETS = [
  // === CRIPTO (12) ===
  { id:'EKO',   name:'EKO',       icon:'', color:'#3b82f6', basePrice:10,   cat:'cripto', vol:1.0  },
  { id:'LUNA',  name:'LUNA',      icon:'', color:'#8b5cf6', basePrice:25,   cat:'cripto', vol:1.2  },
  { id:'FIRE',  name:'FIRE',      icon:'', color:'#ef4444', basePrice:15,   cat:'cripto', vol:1.5  },
  { id:'STAR',  name:'STAR',      icon:'', color:'#f59e0b', basePrice:5,    cat:'cripto', vol:0.8  },
  { id:'AQUA',  name:'AQUA',      icon:'', color:'#06b6d4', basePrice:8,    cat:'cripto', vol:1.1  },
  { id:'BOLT',  name:'BOLT',      icon:'', color:'#eab308', basePrice:12,   cat:'cripto', vol:1.4  },
  { id:'NEON',  name:'NEON',      icon:'', color:'#a855f7', basePrice:18,   cat:'cripto', vol:1.3  },
  { id:'NOVA',  name:'NOVA',      icon:'', color:'#f472b6', basePrice:35,   cat:'cripto', vol:1.6  },
  { id:'ZERO',  name:'ZERO',      icon:'', color:'#64748b', basePrice:2,    cat:'cripto', vol:2.0  },
  { id:'MEGA',  name:'MEGA',      icon:'', color:'#7c3aed', basePrice:50,   cat:'cripto', vol:1.8  },
  { id:'ATOM',  name:'ATOM',      icon:'', color:'#22d3ee', basePrice:22,   cat:'cripto', vol:1.0  },
  { id:'WIND',  name:'WIND',      icon:'', color:'#38bdf8', basePrice:7,    cat:'cripto', vol:1.5  },
  // === ACOES (15) ===
  { id:'TOYS',  name:'TOYS',      icon:'', color:'#ec4899', basePrice:30,   cat:'acoes', vol:0.6  },
  { id:'GAME',  name:'GAME',      icon:'', color:'#06b6d4', basePrice:45,   cat:'acoes', vol:0.7  },
  { id:'FOOD',  name:'FOOD',      icon:'', color:'#f97316', basePrice:20,   cat:'acoes', vol:0.4  },
  { id:'PETS',  name:'PETS',      icon:'', color:'#a3e635', basePrice:18,   cat:'acoes', vol:0.5  },
  { id:'SHOP',  name:'SHOP',      icon:'', color:'#14b8a6', basePrice:35,   cat:'acoes', vol:0.5  },
  { id:'BANK',  name:'BANK',      icon:'', color:'#6366f1', basePrice:60,   cat:'acoes', vol:0.4  },
  { id:'MODA',  name:'MODA',      icon:'', color:'#f43f5e', basePrice:25,   cat:'acoes', vol:0.6  },
  { id:'TECH',  name:'TECH',      icon:'', color:'#0ea5e9', basePrice:80,   cat:'acoes', vol:0.8  },
  { id:'AVIA',  name:'AVIA',      icon:'', color:'#8b5cf6', basePrice:55,   cat:'acoes', vol:0.7  },
  { id:'FARM',  name:'FARM',      icon:'', color:'#10b981', basePrice:40,   cat:'acoes', vol:0.5  },
  { id:'ENER',  name:'ENER',      icon:'', color:'#f59e0b', basePrice:38,   cat:'acoes', vol:0.45 },
  { id:'TELE',  name:'TELE',      icon:'', color:'#3b82f6', basePrice:28,   cat:'acoes', vol:0.5  },
  { id:'EDUC',  name:'EDUC',      icon:'', color:'#8b5cf6', basePrice:22,   cat:'acoes', vol:0.35 },
  { id:'AUTO',  name:'AUTO',      icon:'', color:'#ef4444', basePrice:70,   cat:'acoes', vol:0.65 },
  { id:'CINE',  name:'CINE',      icon:'', color:'#a855f7', basePrice:32,   cat:'acoes', vol:0.55 },
  // === COMMODITIES (10) ===
  { id:'GOLD',  name:'GOLD',      icon:'', color:'#fbbf24', basePrice:80,   cat:'commodities', vol:0.3  },
  { id:'DIAM',  name:'DIAM',      icon:'', color:'#67e8f9', basePrice:120,  cat:'commodities', vol:0.35 },
  { id:'SILV',  name:'SILV',      icon:'', color:'#94a3b8', basePrice:40,   cat:'commodities', vol:0.25 },
  { id:'IRON',  name:'FERRO',     icon:'', color:'#78716c', basePrice:25,   cat:'commodities', vol:0.3  },
  { id:'COPR',  name:'COBRE',     icon:'', color:'#b45309', basePrice:30,   cat:'commodities', vol:0.35 },
  { id:'OIL',   name:'PETROLEO',  icon:'', color:'#1e293b', basePrice:65,   cat:'commodities', vol:0.45 },
  { id:'GAS',   name:'GAS',       icon:'', color:'#0284c7', basePrice:35,   cat:'commodities', vol:0.4  },
  { id:'CAFE',  name:'CAFE',      icon:'', color:'#78350f', basePrice:18,   cat:'commodities', vol:0.3  },
  { id:'SOJA',  name:'SOJA',      icon:'', color:'#16a34a', basePrice:22,   cat:'commodities', vol:0.28 },
  { id:'TRIGO', name:'TRIGO',     icon:'', color:'#ca8a04', basePrice:15,   cat:'commodities', vol:0.25 },
  // === RENDA FIXA (8) ===
  { id:'POUP',  name:'Poupanca',  icon:'', color:'#06b6d4', basePrice:100,  cat:'rendafixa', vol:0.02 },
  { id:'CDB',   name:'CDB',       icon:'', color:'#3b82f6', basePrice:100,  cat:'rendafixa', vol:0.05 },
  { id:'TESD',  name:'Teso.Dir.', icon:'', color:'#22c55e', basePrice:100,  cat:'rendafixa', vol:0.03 },
  { id:'LCI',   name:'LCI',       icon:'', color:'#f59e0b', basePrice:100,  cat:'rendafixa', vol:0.03 },
  { id:'LCA',   name:'LCA',       icon:'', color:'#22c55e', basePrice:100,  cat:'rendafixa', vol:0.025},
  { id:'DEBN',  name:'Debenture', icon:'', color:'#8b5cf6', basePrice:100,  cat:'rendafixa', vol:0.06 },
  { id:'CRI',   name:'CRI',       icon:'', color:'#f97316', basePrice:100,  cat:'rendafixa', vol:0.04 },
  { id:'CRA',   name:'CRA',       icon:'', color:'#16a34a', basePrice:100,  cat:'rendafixa', vol:0.035},
  // === FUNDOS (8) ===
  { id:'ETFBR', name:'ETF Brasil', icon:'', color:'#22c55e', basePrice:50,  cat:'fundos', vol:0.4  },
  { id:'ETFUS', name:'ETF EUA',    icon:'', color:'#3b82f6', basePrice:80,  cat:'fundos', vol:0.5  },
  { id:'FII',   name:'Fundo Imob', icon:'', color:'#f59e0b', basePrice:35,  cat:'fundos', vol:0.3  },
  { id:'FIAGR', name:'FI Agro',    icon:'', color:'#16a34a', basePrice:30,  cat:'fundos', vol:0.35 },
  { id:'MULT',  name:'Multimerc.', icon:'', color:'#8b5cf6', basePrice:45,  cat:'fundos', vol:0.45 },
  { id:'ACBR',  name:'Acoes BR',   icon:'', color:'#ef4444', basePrice:55,  cat:'fundos', vol:0.5  },
  { id:'RFND',  name:'Renda Fixa', icon:'', color:'#06b6d4', basePrice:100, cat:'fundos', vol:0.08 },
  { id:'INTL',  name:'Internac.',  icon:'', color:'#0ea5e9', basePrice:70,  cat:'fundos', vol:0.55 },
  // === FOREX / MOEDAS (10) ===
  { id:'USD',   name:'Dolar',     icon:'', color:'#22c55e', basePrice:5.20, cat:'forex', vol:0.15 },
  { id:'EUR',   name:'Euro',      icon:'', color:'#3b82f6', basePrice:5.80, cat:'forex', vol:0.15 },
  { id:'BTC',   name:'Bitcoin',   icon:'',  color:'#f59e0b', basePrice:300,  cat:'forex', vol:2.0  },
  { id:'ETH',   name:'Ethereum',  icon:'', color:'#6366f1', basePrice:150,  cat:'forex', vol:1.8  },
  { id:'GBP',   name:'Libra',     icon:'', color:'#dc2626', basePrice:6.50, cat:'forex', vol:0.12 },
  { id:'JPY',   name:'Iene',      icon:'', color:'#ef4444', basePrice:0.035,cat:'forex', vol:0.1  },
  { id:'CNY',   name:'Yuan',      icon:'', color:'#dc2626', basePrice:0.72,cat:'forex', vol:0.12 },
  { id:'ARS',   name:'Peso Arg.', icon:'', color:'#60a5fa', basePrice:0.006,cat:'forex',vol:0.5  },
  { id:'SOL',   name:'Solana',    icon:'', color:'#9333ea', basePrice:80,   cat:'forex', vol:1.9  },
  { id:'DOGE',  name:'Dogecoin',  icon:'', color:'#ca8a04', basePrice:1.50, cat:'forex', vol:2.5  },
];

const TIME_PERIODS = [
  { id:'1m',  label:'1m',   seconds:60 },
  { id:'5m',  label:'5m',   seconds:300 },
  { id:'15m', label:'15m',  seconds:900 },
  { id:'1h',  label:'1h',   seconds:3600 },
  { id:'all', label:'Tudo', seconds:Infinity },
];

const LEVELS = [
  { level:1, xp:0,   title:'Iniciante', emoji:'' },
  { level:2, xp:50,  title:'Aprendiz',  emoji:'' },
  { level:3, xp:150, title:'Esperto',   emoji:'' },
  { level:4, xp:300, title:'Investidor',emoji:'' },
  { level:5, xp:500, title:'Mestre',    emoji:'' },
  { level:6, xp:800, title:'Lenda',     emoji:'' },
];

function getLevel(xp) {
  let lv = LEVELS[0];
  for (let i = LEVELS.length-1; i>=0; i--) { if (xp>=LEVELS[i].xp){lv=LEVELS[i];break;} }
  return lv;
}
function getNextLevel(xp) {
  for (let i=0;i<LEVELS.length;i++) { if (xp<LEVELS[i].xp) return LEVELS[i]; }
  return null;
}
function addXP(amount, reason) {
  if (!currentChild) return;
  const ch = load('children')||{}; const child = ch[currentChild.id]; if (!child) return;
  const oldXP = child.xp||0; const oldLevel = getLevel(oldXP);
  child.xp = (child.xp||0)+amount;
  const newLevel = getLevel(child.xp);
  ch[child.id]=child; save('children',ch); currentChild=child;
  showToast(`+${amount} XP! ${reason}`,'success');
  if (newLevel.level>oldLevel.level) setTimeout(()=>showLevelUp(newLevel),500);
  updateXPUI();
}
function showLevelUp(level) {
  document.getElementById('levelUpEmoji').textContent=level.emoji;
  document.getElementById('levelUpText').textContent=`Nivel ${level.level} - ${level.title}`;
  document.getElementById('levelUpOverlay').classList.remove('hidden');
  createConfetti();
}
function closeLevelUp(){ document.getElementById('levelUpOverlay').classList.add('hidden'); }
function updateXPUI() {
  if (!currentChild) return;
  const xp=currentChild.xp||0; const lv=getLevel(xp); const next=getNextLevel(xp);
  const badge=`${lv.emoji} Lv.${lv.level}`; let pct=100,xpText=`${xp} XP (MAX)`;
  if (next){const progress=xp-lv.xp;const needed=next.xp-lv.xp;pct=Math.min(100,(progress/needed)*100);xpText=`${xp}/${next.xp} XP`;}
  const hBadge=document.getElementById('xpLevelBadge'),hFill=document.getElementById('xpBarMiniFill'),hText=document.getElementById('xpTextMini');
  if(hBadge)hBadge.textContent=badge; if(hFill)hFill.style.width=pct+'%'; if(hText)hText.textContent=xpText;
  const pName=document.getElementById('profileName'),pLevel=document.getElementById('profileLevel');
  const pXpCur=document.getElementById('profileXpCurrent'),pXpNext=document.getElementById('profileXpNext'),pXpBar=document.getElementById('profileXpBar');
  if(pName)pName.textContent=currentChild.name||'Investidor';
  if(pLevel)pLevel.textContent=`${lv.emoji} Nivel ${lv.level} - ${lv.title}`;
  if(pXpCur)pXpCur.textContent=xp+' XP';
  if(pXpNext)pXpNext.textContent=next?`Proximo: ${next.xp} XP`:'Nivel Maximo!';
  if(pXpBar)pXpBar.style.width=pct+'%';
}

// ============ STORAGE ============
function save(k,d){localStorage.setItem('fc4_'+k,JSON.stringify(d));}
function load(k){const d=localStorage.getItem('fc4_'+k);return d?JSON.parse(d):null;}
function genCode(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let r='';for(let i=0;i<6;i++)r+=c[~~(Math.random()*c.length)];return r;}

// ============ STATE ============
let currentParent=null,currentChild=null,currentView='login';
let marketInterval=null,tradeQty=1;
let selectedAsset='EKO',selectedCat='cripto',selectedTime='5m';
let priceHistories={},trendData={},celebrationShown=false;
let tickCount=0,totalYieldEarned=0,yieldInterval=null;
let currentChildTab='Mercado';
let chartType='line';
let activeIndicators={MA:false,BB:false,RSI:false};
let selectedOrderType='LIMIT_BUY';
let alertDirection='above';
let leverageActive=false;
let genericModalAction=null;
let ibkidsHistory=[];
let portfolioValueHistory=[];
let savingsInterval=null;
let dcaIntervals={};
let marketEventLog=[];
let fearGreedValue=50;

function init() {
  const savedLang=localStorage.getItem('fc4_lang');
  if(savedLang){
    currentLang=savedLang;
    applyTranslations();
    const s=load('session');
    if(s){
      if(s.type==='parent'){currentParent=s.data;showParentDashboard();}
      else if(s.type==='child'){currentChild=s.data;showTradingPanel();}
      else{showScreen('login');}
    } else {
      showScreen('login');
    }
  } else {
    showScreen('lang');
  }
}

// ============ AUTH ============
function switchTab(t){
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',(t==='login'&&i===0)||(t==='register'&&i===1)));
  document.getElementById('loginForm').classList.toggle('hidden',t!=='login');
  document.getElementById('registerForm').classList.toggle('hidden',t!=='register');
}
function handleRegister(){
  const n=document.getElementById('regName').value.trim(),e=document.getElementById('regEmail').value.trim(),p=document.getElementById('regPassword').value.trim();
  if(!n||!e||!p){showError('regError','Preencha todos os campos');return;}
  const ex=load('parents')||{}; if(ex[e]){showError('regError','Email ja cadastrado');return;}
  const par={id:Date.now().toString(),name:n,email:e,password:p};
  ex[e]=par;save('parents',ex);currentParent=par;save('session',{type:'parent',data:par});showParentDashboard();
}
function handleLogin(){
  const e=document.getElementById('loginEmail').value.trim(),p=document.getElementById('loginPassword').value.trim();
  const pars=load('parents')||{};const par=pars[e];
  if(!par||par.password!==p){showError('loginError','Email ou senha incorretos');return;}
  currentParent=par;save('session',{type:'parent',data:par});showParentDashboard();
}
function enterAsParent(){switchTab('register');}
function showChildAccess(){showScreen('childAccess');}
function backToLogin(){showScreen('login');}
function childLogin(){
  const code=document.getElementById('childCodeInput').value.trim().toUpperCase();
  const ch=load('children')||{};const child=Object.values(ch).find(c=>c.code===code);
  if(!child){showError('childLoginError','Codigo invalido');return;}
  currentChild=child;save('session',{type:'child',data:child});
  const today=new Date().toDateString();const lastLogin=child.lastLogin||'';
  if(lastLogin!==today){
    child.lastLogin=today;child.daysActive=(child.daysActive||0)+1;
    ch[child.id]=child;save('children',ch);currentChild=child;
    setTimeout(()=>addXP(10,'Login diario!'),1000);
  }
  showTradingPanel();
}
function logout(){
  stopMarket();currentParent=null;currentChild=null;
  localStorage.removeItem('fc4_session');celebrationShown=false;
  document.getElementById('bottomNav').classList.add('hidden');showScreen('login');applyTranslations();
}
function showError(id,msg){const el=document.getElementById(id);el.textContent=msg;el.classList.remove('hidden');setTimeout(()=>el.classList.add('hidden'),3000);}
function showScreen(s){
  currentView=s;
  const map={lang:'langScreen',login:'loginScreen',parent:'parentDashboard',childAccess:'childAccessScreen',trading:'tradingPanel'};
  ['langScreen','loginScreen','parentDashboard','childAccessScreen','tradingPanel'].forEach(id=>document.getElementById(id).classList.toggle('hidden',id!==map[s]));
  document.getElementById('bottomNav').classList.toggle('hidden',s!=='trading');
  if(s==='lang')renderLangScreen();
  if(s==='login')applyTranslations();
}

// ============ BOTTOM NAV / TABS ============
function switchChildTab(tab){
  currentChildTab=tab;
  ['Mercado','Analise','Empresas','Jogos','Aprender','Perfil'].forEach(t=>{
    const el=document.getElementById('tab'+t);
    const nav=document.getElementById('nav'+t);
    if(el)el.classList.toggle('active',t===tab);
    if(nav)nav.classList.toggle('active',t===tab);
  });
  if(tab==='Perfil')updateProfileTab();
  if(tab==='Aprender')renderLessons();
  if(tab==='Empresas')renderEmpresasTab();
  if(tab==='Analise')updateAnalyticsTab();
  showFixedTradeBar(tab==='Mercado');
}

// ============ PARENT DASHBOARD ============
function showParentDashboard(){showScreen('parent');refreshParent();}
function refreshParent(){
  const ch=load('children')||{};
  const list=Object.values(ch).filter(c=>c.parent_id===currentParent.id);
  if(!list.length){document.getElementById('setupChild').classList.remove('hidden');document.getElementById('childDashboard').classList.add('hidden');return;}
  document.getElementById('setupChild').classList.add('hidden');document.getElementById('childDashboard').classList.remove('hidden');
  const child=list[0];currentChild=child;
  const tv=calcTotal(child);const txs=(load('transactions')||{})[child.id]||[];
  const totalAssets=ASSETS.reduce((s,a)=>s+(child.assets?.[a.id]?.qty||0),0);
  document.getElementById('pSaldo').textContent=fmt(child.balance);
  document.getElementById('pMoedas').textContent=totalAssets;
  document.getElementById('pTotal').textContent=fmt(tv);
  document.getElementById('pOps').textContent=txs.length;
  const pct=Math.min(100,(tv/child.goal_amount)*100);
  document.getElementById('pChildName').textContent=child.name;
  document.getElementById('pGoalText').textContent=`${fmt(tv)} / ${fmt(child.goal_amount)}`;
  document.getElementById('pProgressBar').style.width=pct+'%';
  document.getElementById('pProgressPct').textContent=Math.round(pct)+'%';
  document.getElementById('editVolatility').value=child.volatility;
  document.getElementById('editGoal').value=child.goal_amount;
  document.getElementById('toggleBtn').textContent=child.is_active?' Pausar':' Retomar';
  document.getElementById('childCode').textContent=child.code;
  renderParentTx(child.id);
}
function createChildAccount(){
  const name=document.getElementById('childName').value.trim();
  if(!name){showToast('Digite o nome','error');return;}
  const age=+document.getElementById('childAge').value,bal=+document.getElementById('childBalance').value;
  const vol=document.getElementById('childVolatility').value,goal=+document.getElementById('childGoal').value;
  const code=genCode();const assets={};
  ASSETS.forEach(a=>{assets[a.id]={qty:0,price:a.basePrice,avgPrice:a.basePrice};});
  const child={id:Date.now().toString(),parent_id:currentParent.id,name,age,balance:bal,initial_balance:bal,assets,volatility:vol,goal_amount:goal,is_active:1,code,created_at:new Date().toISOString(),xp:0,daysActive:0,gamesPlayed:0,lastLogin:'',totalYield:0,savings:{balance:0,totalInterest:0,lastUpdate:Date.now()},shorts:{},realizedGains:0};
  const ch=load('children')||{};ch[child.id]=child;save('children',ch);
  const ph=load('priceH')||{};
  ASSETS.forEach(a=>{ph[child.id+'_'+a.id]=[{p:a.basePrice,t:Date.now()}];});
  save('priceH',ph);
  const tx=load('transactions')||{};tx[child.id]=[];save('transactions',tx);
  showToast(`${name} criado! Codigo: ${code}`,'success');refreshParent();
}
function updateConfig(){
  if(!currentChild)return;const ch=load('children')||{};const c=ch[currentChild.id];if(!c)return;
  c.volatility=document.getElementById('editVolatility').value;
  c.goal_amount=+document.getElementById('editGoal').value;
  ch[c.id]=c;save('children',ch);currentChild=c;refreshParent();
}
function toggleMarket(){
  if(!currentChild)return;const ch=load('children')||{};const c=ch[currentChild.id];
  c.is_active=c.is_active?0:1;ch[c.id]=c;save('children',ch);currentChild=c;refreshParent();
}
function resetChildAccount(){
  if(!currentChild||!confirm('Resetar todo o progresso?'))return;
  const bal=+(prompt('Saldo (R$):',currentChild.initial_balance)||currentChild.initial_balance);
  const goal=+(prompt('Meta (R$):',currentChild.goal_amount)||currentChild.goal_amount);
  const ch=load('children')||{};const c=ch[currentChild.id];
  c.balance=bal;c.initial_balance=bal;c.goal_amount=goal;c.xp=0;c.gamesPlayed=0;c.realizedGains=0;c.shorts={};c.savings={balance:0,totalInterest:0,lastUpdate:Date.now()};
  const assets={};ASSETS.forEach(a=>{assets[a.id]={qty:0,price:a.basePrice,avgPrice:a.basePrice};});c.assets=assets;
  ch[c.id]=c;save('children',ch);
  const ph=load('priceH')||{};
  ASSETS.forEach(a=>{ph[c.id+'_'+a.id]=[{p:a.basePrice,t:Date.now()}];});
  save('priceH',ph);
  const tx=load('transactions')||{};tx[c.id]=[];save('transactions',tx);
  save('challenges_'+c.id,{});save('lessons_'+c.id,{});
  localStorage.removeItem('fc4_orders_'+c.id);localStorage.removeItem('fc4_alerts_'+c.id);localStorage.removeItem('fc4_dca_'+c.id);
  c.companies={ownedShares:{},myCompanies:[],dividendsEarned:0};
  localStorage.removeItem('fc4_firstDividendXP_'+c.id);
  currentChild=c;showToast('Resetado!','success');refreshParent();
}
function renderParentTx(cid){
  const txs=(load('transactions')||{})[cid]||[];
  const el=document.getElementById('pTxList');
  if(!txs.length){el.innerHTML='<p style="color:var(--text2);text-align:center;padding:16px;">Nenhuma operacao</p>';return;}
  el.innerHTML=txs.slice(-20).reverse().map(tx=>{
    const a=ASSETS.find(x=>x.id===tx.asset)||ASSETS[0];
    return `<div class="tx-item"><div><span class="tx-type ${tx.type==='BUY'?'tx-buy':'tx-sell'}">${tx.type==='BUY'?' COMPROU':' VENDEU'}</span><span style="margin-left:6px;color:var(--text2);font-size:.82rem;">${tx.qty} ${a.icon}${a.name} a ${fmt(tx.price)}</span></div><div class="tx-details"><div class="tx-value">${fmt(tx.total)}</div><div class="tx-time">${new Date(tx.time).toLocaleTimeString('pt-BR')}</div></div></div>`;
  }).join('');
}

// ============ TRADING ============
function showTradingPanel(){
  showScreen('trading');applyTranslations();
  const ch=load('children')||{};currentChild=ch[currentChild.id]||currentChild;
  if(!currentChild.assets){
    const assets={};ASSETS.forEach(a=>{assets[a.id]={qty:0,price:a.basePrice,avgPrice:a.basePrice};});
    currentChild.assets=assets;ch[currentChild.id]=currentChild;save('children',ch);
  }
  // Ensure new fields
  if(!currentChild.savings)currentChild.savings={balance:0,totalInterest:0,lastUpdate:Date.now()};
  if(!currentChild.shorts)currentChild.shorts={};
  if(!currentChild.realizedGains)currentChild.realizedGains=0;
  // Ensure ALL assets exist (for users upgrading from older versions)
  const ph0=load('priceH')||{};
  ASSETS.forEach(a=>{
    if(!currentChild.assets[a.id]){
      currentChild.assets[a.id]={qty:0,price:a.basePrice,avgPrice:a.basePrice};
      if(!ph0[currentChild.id+'_'+a.id])ph0[currentChild.id+'_'+a.id]=[{p:a.basePrice,t:Date.now()}];
    }
    if(currentChild.assets[a.id]&&!currentChild.assets[a.id].avgPrice)currentChild.assets[a.id].avgPrice=a.basePrice;
  });
  save('priceH',ph0);
  ch[currentChild.id]=currentChild;save('children',ch);
  loadHistories();selectedAsset='EKO';selectedCat='cripto';selectedTime='5m';
  celebrationShown=false;tickCount=0;totalYieldEarned=currentChild.totalYield||0;
  currentChildTab='Mercado';
  ensureChildCompanyData();initCompanyData();
  const wbg=document.getElementById('wbGreeting');if(wbg)wbg.textContent=`Ola, ${currentChild.name}! `;
  renderCatTabs();renderAssets();renderTimeTabs();updateUI();startMarket();startYield();startSavingsInterval();
  updateXPUI();renderLessons();switchChildTab('Mercado');
  renderActiveOrders();renderAlerts();renderDCAList();
  setTimeout(()=>{const wb=document.getElementById('welcomeBanner');if(wb){wb.style.opacity='0';wb.style.transform='translateY(-10px)';setTimeout(()=>{wb.style.display='none';},300);}},5000);
}
function loadHistories(){
  const ph=load('priceH')||{};priceHistories={};
  ASSETS.forEach(a=>{priceHistories[a.id]=ph[currentChild.id+'_'+a.id]||[{p:a.basePrice,t:Date.now()}];});
}
function renderCatTabs(){
  document.getElementById('catTabs').innerHTML=CATEGORIES.map(c=>`<button class="cat-tab ${selectedCat===c.id?'active':''}" onclick="selectCat('${c.id}')">${c.icon} ${c.name}</button>`).join('');
}
function selectCat(catId){
  selectedCat=catId;const first=ASSETS.find(a=>a.cat===catId);
  if(first)selectedAsset=first.id;renderCatTabs();renderAssets();updateUI();
}
function renderAssets(){
  const filtered=ASSETS.filter(a=>a.cat===selectedCat);
  document.getElementById('assetScroll').innerHTML=filtered.map(a=>{
    const ad=currentChild.assets?.[a.id];const price=ad?.price||a.basePrice;
    const h=priceHistories[a.id]||[];const prev=h.length>=2?h[h.length-2].p:price;
    const chg=prev>0?((price-prev)/prev*100).toFixed(1):'0.0';const up=price>=prev;
    return `<div class="asset-chip ${selectedAsset===a.id?'active':''}" onclick="selectAsset('${a.id}')"><span class="a-icon">${a.icon}</span><span class="a-name">${a.name}</span><span class="a-price">${fmt(price)}</span><span class="a-change ${up?'up':'down'}">${up?'+':''}${chg}%</span></div>`;
  }).join('');
}
function selectAsset(id){
  selectedAsset=id;tradeQty=1;document.getElementById('qtyValue').textContent=1;
  renderAssets();updateUI();
}
function renderTimeTabs(){
  document.getElementById('timeTabs').innerHTML=TIME_PERIODS.map(t=>`<button class="time-tab ${selectedTime===t.id?'active':''}" onclick="selectTime('${t.id}')">${t.label}</button>`).join('');
}
function selectTime(id){selectedTime=id;renderTimeTabs();drawChart();}
function setChartType(t){
  chartType=t;
  document.getElementById('chartTypeLine').classList.toggle('active',t==='line');
  document.getElementById('chartTypeCandle').classList.toggle('active',t==='candle');
  drawChart();
}
function toggleIndicator(ind){
  activeIndicators[ind]=!activeIndicators[ind];
  document.getElementById('ind'+ind).classList.toggle('active',activeIndicators[ind]);
  const rsiWrap=document.getElementById('rsiWrap');
  if(rsiWrap)rsiWrap.classList.toggle('hidden',!activeIndicators.RSI);
  drawChart();
}

function startMarket(){
  stopMarket();
  ASSETS.forEach(a=>{if(!trendData[a.id])trendData[a.id]={dir:Math.random()>.4?1:-1,ticks:~~(Math.random()*20)+8};});
  initCompanyData();
  marketInterval=setInterval(tickMarket,3000);
  startDividendInterval();
  startDCAIntervals();
}
function stopMarket(){
  if(marketInterval)clearInterval(marketInterval);marketInterval=null;
  if(yieldInterval)clearInterval(yieldInterval);yieldInterval=null;
  if(savingsInterval)clearInterval(savingsInterval);savingsInterval=null;
  stopDividendInterval();
  stopDCAIntervals();
}

// ============ YIELD ============
function getYieldRate(child){
  const ekoState=child.assets?.['EKO'];if(!ekoState||ekoState.qty<=0)return{rate:0,perMin:0};
  const ekoValue=ekoState.qty*ekoState.price;const rate=0.005;const perMin=ekoValue*rate;
  return{rate,perMin,ekoValue,ekoQty:ekoState.qty};
}
function startYield(){
  if(yieldInterval)clearInterval(yieldInterval);
  yieldInterval=setInterval(()=>{
    const ch=load('children')||{};const child=ch[currentChild.id];
    if(!child||!child.is_active)return;
    const y=getYieldRate(child);if(y.perMin<=0)return;
    const earning=Math.round((y.perMin/6)*100)/100;
    child.balance=Math.round((child.balance+earning)*100)/100;
    totalYieldEarned=Math.round((totalYieldEarned+earning)*100)/100;
    child.totalYield=totalYieldEarned;
    ch[child.id]=child;save('children',ch);currentChild=child;updateYieldUI(child);
  },10000);
}
function updateYieldUI(child){
  const y=getYieldRate(child);
  const yRate=document.getElementById('yieldRate');const yPM=document.getElementById('yieldPerMin');const yTot=document.getElementById('yieldTotal');const yTime=document.getElementById('yieldTime');
  if(yRate)yRate.textContent=y.perMin>0?`+${(y.rate*100).toFixed(1)}%/min`:'Compre EKOs!';
  if(yPM)yPM.textContent=y.perMin>0?fmt(y.perMin):'R$ 0,00';
  if(yTot)yTot.textContent=fmt(totalYieldEarned);
  if(yTime)yTime.textContent=y.ekoQty?`${y.ekoQty} EKOs gerando renda`:'compre EKOs para ganhar';
}

// ============ TICK MARKET ============
function tickMarket(){
  const ch=load('children')||{};const child=ch[currentChild.id];
  if(!child||!child.is_active)return;
  const ph=load('priceH')||{};tickCount++;
  ASSETS.forEach(asset=>{
    const state=child.assets[asset.id];if(!state)return;
    const np=calcPrice(asset,state.price,child.volatility);
    state.price=np;
    const key=child.id+'_'+asset.id;
    if(!ph[key])ph[key]=[];
    ph[key].push({p:np,t:Date.now()});
    if(ph[key].length>2000)ph[key]=ph[key].slice(-2000);
  });
  ch[child.id]=child;save('children',ch);save('priceH',ph);currentChild=child;
  ASSETS.forEach(a=>{priceHistories[a.id]=ph[child.id+'_'+a.id]||[];});
  // Check advanced orders
  checkOrders(child);
  // Check price alerts
  checkAlerts(child);
  // Check short positions
  updateShortPositions(child);
  // Market events
  if(tickCount%100===0)triggerMarketEvent();
  // Update index
  updateIBKIDSIndex(child);
  // Update fear & greed
  updateFearGreed(child);
  if(tickCount%3===0)renderAssets();
  if(tickCount%10===0)checkChallenges();
  tickCompanyPrices();
  if(currentChildTab==='Empresas'&&tickCount%3===0){renderCompanyCards();renderEmpresasPortfolio();}
  if(currentChildTab==='Analise'&&tickCount%5===0)updateAnalyticsTab();
  // Portfolio value history
  portfolioValueHistory.push({v:calcTotal(child),t:Date.now()});
  if(portfolioValueHistory.length>200)portfolioValueHistory=portfolioValueHistory.slice(-200);
  updateUI();
}
function calcPrice(asset,cur,volatility){
  let base={baixa:.012,media:.025,alta:.05}[volatility]||.025;
  base*=asset.vol;
  let td=trendData[asset.id];if(!td){td={dir:1,ticks:10};trendData[asset.id]=td;}
  td.ticks--;if(td.ticks<=0){td.dir=Math.random()>.4?1:-1;td.ticks=~~(Math.random()*20)+8;}
  let v=Math.random()*(base*2)-base;
  v+=td.dir*(Math.random()*.008+.003);
  v-=((cur-asset.basePrice)/asset.basePrice)*.02;
  let np=cur*(1+v);
  np=Math.max(asset.basePrice*.08,Math.min(asset.basePrice*5,np));
  return Math.round(np*100)/100;
}
function calcTotal(child){
  let t=child.balance;
  ASSETS.forEach(a=>{const d=child.assets?.[a.id];if(d)t+=d.qty*d.price;});
  if(child.savings)t+=child.savings.balance;
  if(child.companies&&child.companies.ownedShares){
    const cp=load('companyPrices')||{};
    COMPANIES.forEach(comp=>{const qty=child.companies.ownedShares[comp.id]||0;if(qty>0){const price=cp[comp.id]||comp.basePrice;t+=qty*price;}});
  }
  return t;
}
function updateUI(){
  const child=currentChild;if(!child)return;
  const ch=load('children')||{};const fresh=ch[child.id];
  if(fresh){currentChild=fresh;document.getElementById('pausedOverlay').classList.toggle('hidden',fresh.is_active===1);document.getElementById('marketDot').classList.toggle('paused',!fresh.is_active);document.getElementById('marketStatusText').textContent=fresh.is_active?'Ao vivo':'Pausado';}
  const asset=ASSETS.find(a=>a.id===selectedAsset);const state=child.assets?.[selectedAsset];if(!asset||!state)return;
  const price=state.price;const bp=asset.basePrice;const tv=calcTotal(child);
  document.getElementById('cBalance').textContent=fmt(child.balance);
  document.getElementById('cCoinName').textContent=asset.icon+' '+asset.name;
  document.getElementById('cCoinType').textContent=CATEGORIES.find(c=>c.id===asset.cat)?.name||'';
  document.getElementById('tradeAssetName').textContent=asset.icon+' '+asset.name;
  const priceEl=document.getElementById('cPrice');priceEl.textContent=fmt(price);
  const h=priceHistories[selectedAsset]||[];let prev=bp;if(h.length>=2)prev=h[h.length-2].p;
  const diff=price-prev;const pct=prev>0?((diff/prev)*100).toFixed(1):'0.0';
  priceEl.className='price-value '+(diff>0?'price-up':diff<0?'price-down':'price-stable');
  document.getElementById('cEmoji').textContent=diff>0?'':diff<0?'':'';
  const chgEl=document.getElementById('cPriceChange');chgEl.textContent=`${diff>=0?'+':''}${fmt(diff)} (${pct}%)`;chgEl.style.color=diff>0?'var(--green)':diff<0?'var(--red)':'var(--text2)';
  const prices=h.map(x=>x.p);
  document.getElementById('cHigh').textContent=prices.length?fmt(Math.max(...prices.slice(-100))):'-';
  document.getElementById('cLow').textContent=prices.length?fmt(Math.min(...prices.slice(-100))):'-';
  document.getElementById('cBase').textContent=fmt(bp);
  document.getElementById('chartTitle').textContent=`${asset.icon} ${asset.name}`;
  document.getElementById('cQty').textContent=state.qty;
  document.getElementById('cVal').textContent=fmt(state.qty*price);
  document.getElementById('cTotal').textContent=fmt(tv);
  const cost=price*tradeQty;
  const leverMult=leverageActive?2:1;
  const effectiveCost=cost/leverMult;
  document.getElementById('buyCost').textContent=`${tradeQty} x ${fmt(price)}${leverageActive?' [2x]':''} = ${fmt(cost)}`;
  document.getElementById('sellValue').textContent=`${tradeQty} x ${fmt(price)}${leverageActive?' [2x]':''} = ${fmt(cost)}`;
  const buyBtn=document.getElementById('buyBtn'),sellBtn=document.getElementById('sellBtn');
  buyBtn.disabled=child.balance<effectiveCost;sellBtn.disabled=state.qty<tradeQty;
  buyBtn.classList.toggle('glow-green',price<bp*.85&&child.balance>=effectiveCost);
  sellBtn.classList.toggle('glow-red',price>bp*1.25&&state.qty>=tradeQty);
  renderPortfolio(child);renderShortPositions(child);
  const ppct=Math.min(100,(tv/child.goal_amount)*100);
  document.getElementById('cGoalText').textContent=`${fmt(tv)} / ${fmt(child.goal_amount)}`;
  const bar=document.getElementById('cProgressBar');bar.style.width=ppct+'%';
  document.getElementById('cProgressPct').textContent=Math.round(ppct)+'%';
  bar.classList.remove('near-goal','goal-reached');
  if(ppct>=100)bar.classList.add('goal-reached');else if(ppct>=90)bar.classList.add('near-goal');
  if(ppct>=100&&!celebrationShown){celebrationShown=true;showCelebration(tv,child.goal_amount);}
  updateYieldUI(child);renderRanking(child);renderNews();renderChallenges();drawChart();renderChildTx();updateXPUI();
  renderOrderBook(price);updateSavingsUI();
  // Update fixed trade bar
  updateFixedTradeBar(asset,state,child,diff,pct);
}

// ============ FIXED TRADE BAR ============
function updateFixedTradeBar(asset,state,child,diff,pct){
  const bar=document.getElementById('fixedTradeBar');if(!bar)return;
  if(currentChildTab!=='Mercado'){bar.style.display='none';return;}
  bar.style.display='block';
  const ftbIcon=document.getElementById('ftbIcon'),ftbName=document.getElementById('ftbName');
  const ftbPrice=document.getElementById('ftbPrice'),ftbChange=document.getElementById('ftbChange');
  const ftbBuy=document.getElementById('ftbBuy'),ftbSell=document.getElementById('ftbSell');
  if(ftbIcon)ftbIcon.textContent=asset.icon;
  if(ftbName)ftbName.textContent=asset.name;
  if(ftbPrice){ftbPrice.textContent=fmt(state.price);ftbPrice.className='ftb-price '+(diff>0?'up':diff<0?'down':'stable');}
  if(ftbChange){ftbChange.textContent=`${diff>=0?'+':''}${pct}%`;ftbChange.className='ftb-change '+(diff>=0?'up':'down');}
  const cost=state.price*tradeQty;const leverMult=leverageActive?2:1;const effectiveCost=cost/leverMult;
  if(ftbBuy)ftbBuy.disabled=child.balance<effectiveCost;
  if(ftbSell)ftbSell.disabled=state.qty<tradeQty;
}
function showFixedTradeBar(show){
  const bar=document.getElementById('fixedTradeBar');if(bar)bar.style.display=show?'block':'none';
}

// ============ RANKING ============
function renderRanking(child){
  const el=document.getElementById('rankList');
  const allChildren=Object.values(load('children')||{});
  const players=allChildren.map(c=>{const tv=calcTotal(c);const numAssets=ASSETS.filter(a=>(c.assets?.[a.id]?.qty||0)>0).length;return{name:c.name,value:tv,numAssets,me:c.id===child.id};});
  players.sort((a,b)=>b.value-a.value);
  if(!players.length){el.innerHTML='<p style="color:var(--text2);text-align:center;font-size:.8rem;">Nenhum investidor</p>';return;}
  el.innerHTML=players.map((p,i)=>{
    const posClass=i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'rank-other';const medal=i===0?'':i===1?'':i===2?'':'';
    return `<div class="rank-item ${p.me?'me':''}"><div class="rank-pos ${posClass}">${medal||i+1}</div><div class="rank-info"><div class="rank-name">${p.me?' ':''} ${p.name}${p.me?' (Voce)':''}</div><div class="rank-assets">${p.numAssets} ativo${p.numAssets!==1?'s':''}</div></div><div class="rank-value" style="color:${p.me?'var(--gold)':'var(--text)'}">${fmt(p.value)}</div></div>`;
  }).join('');
}
function renderPortfolio(child){
  const grid=document.getElementById('portfolioGrid');
  const owned=ASSETS.filter(a=>(child.assets?.[a.id]?.qty||0)>0);
  if(!owned.length){grid.innerHTML='<p style="color:var(--text2);font-size:.75rem;grid-column:1/-1;text-align:center;">Carteira vazia</p>';return;}
  grid.innerHTML=owned.map(a=>{
    const d=child.assets[a.id];const avgP=d.avgPrice||a.basePrice;const pnlPct=((d.price-avgP)/avgP*100).toFixed(1);const up=d.price>=avgP;
    return `<div class="portfolio-coin" onclick="selectAsset('${a.id}');selectCat('${a.cat}')" style="${selectedAsset===a.id?'border-color:'+a.color:''}"><span class="pc-icon">${a.icon}</span><div class="pc-info"><div class="pc-name">${a.name}</div><div class="pc-qty">${d.qty} unid.</div></div><div style="text-align:right"><div class="pc-val" style="color:${a.color}">${fmt(d.qty*d.price)}</div><div style="font-size:.6rem;color:${up?'var(--green)':'var(--red)'}; font-weight:800;">${up?'+':''}${pnlPct}%</div></div></div>`;
  }).join('');
}

// ============ TRADE CONFIRMATION ============
let pendingTrade=null,selectedReason='';
const BUY_REASONS=[
  {icon:'',text:'O preco caiu e esta barato (comprar na baixa)'},
  {icon:'',text:'Acredito que vai subir em breve'},
  {icon:'',text:'Quero ter mais dessa moeda para o rendimento'},
  {icon:'',text:'Faz parte da minha estrategia para a meta'},
];
const SELL_REASONS=[
  {icon:'',text:'O preco subiu bastante (vender na alta)'},
  {icon:'',text:'Quero garantir meu lucro agora'},
  {icon:'',text:'Quero trocar por outro ativo melhor'},
  {icon:'',text:'Preciso de saldo para outra oportunidade'},
];
function confirmTrade(type){
  const asset=ASSETS.find(a=>a.id===selectedAsset);const state=currentChild.assets?.[selectedAsset];if(!asset||!state)return;
  const total=state.price*tradeQty;
  const leverMult=leverageActive?2:1;const effectiveCost=total/leverMult;
  if(type==='BUY'&&currentChild.balance<effectiveCost){showToast('Saldo insuficiente!','error');return;}
  if(type==='SELL'&&state.qty<tradeQty){showToast('Quantidade insuficiente!','error');return;}
  pendingTrade={type,asset:selectedAsset,qty:tradeQty,price:state.price,total,leverage:leverageActive};selectedReason='';
  document.getElementById('confirmTitle').textContent=`${type==='BUY'?'Comprar':'Vender'} ${asset.icon} ${asset.name}?`;
  document.getElementById('confirmDetail').textContent=`${tradeQty} unid. por ${fmt(total)}${leverageActive?' (Alavancagem 2x!)':''}`;
  document.getElementById('confirmBtn').disabled=true;
  const reasons=type==='BUY'?BUY_REASONS:SELL_REASONS;
  document.getElementById('reasonOptions').innerHTML=reasons.map((r,i)=>`<button class="reason-btn" onclick="pickReason(${i})" id="reason${i}"><span class="reason-icon">${r.icon}</span>${r.text}</button>`).join('');
  document.getElementById('confirmOverlay').classList.remove('hidden');
}
function pickReason(i){
  selectedReason=i;
  document.querySelectorAll('.reason-btn').forEach((b,j)=>{b.style.borderColor=j===i?'var(--gold)':'var(--glass-border)';b.style.background=j===i?'rgba(245,158,11,0.08)':'rgba(0,0,0,0.2)';});
  document.getElementById('confirmBtn').disabled=false;
}
function cancelTrade(){pendingTrade=null;document.getElementById('confirmOverlay').classList.add('hidden');}
function executeTrade(){
  if(!pendingTrade)return;
  document.getElementById('confirmOverlay').classList.add('hidden');
  if(pendingTrade.type==='BUY')execBuy(pendingTrade.qty,pendingTrade.leverage);
  else execSell(pendingTrade.qty,pendingTrade.leverage);
  checkChallenges();addXP(5,'Operacao realizada!');pendingTrade=null;
}
function execBuy(qty,leverage){
  const ch=load('children')||{};const child=ch[currentChild.id];if(!child||!child.is_active)return;
  const asset=ASSETS.find(a=>a.id===selectedAsset);const state=child.assets[selectedAsset];
  const leverMult=leverage?2:1;const cost=state.price*qty/leverMult;
  if(child.balance<cost)return;
  child.balance=Math.round((child.balance-cost)*100)/100;
  // Update average price
  const prevQty=state.qty;const prevAvg=state.avgPrice||state.price;
  const newTotal=prevQty*prevAvg+qty*state.price*leverMult;
  state.qty+=qty*leverMult;
  state.avgPrice=state.qty>0?newTotal/state.qty:state.price;
  ch[child.id]=child;save('children',ch);currentChild=child;
  const tx=load('transactions')||{};if(!tx[child.id])tx[child.id]=[];
  tx[child.id].push({type:'BUY',asset:selectedAsset,qty:qty*leverMult,price:state.price,total:state.price*qty*leverMult,time:Date.now(),leverage});
  save('transactions',tx);showToast(`Comprou ${qty*leverMult} ${asset.icon}${asset.name}!`,'success');updateUI();
}
function execSell(qty,leverage){
  const ch=load('children')||{};const child=ch[currentChild.id];if(!child||!child.is_active)return;
  const asset=ASSETS.find(a=>a.id===selectedAsset);const state=child.assets[selectedAsset];
  if(state.qty<qty)return;
  const leverMult=leverage?2:1;const val=state.price*qty*leverMult;
  const avgP=state.avgPrice||asset.basePrice;const gain=(state.price-avgP)*qty;
  child.balance=Math.round((child.balance+val)*100)/100;state.qty-=qty;
  // Track realized gains for tax
  if(gain>0){child.realizedGains=(child.realizedGains||0)+gain;}
  ch[child.id]=child;save('children',ch);currentChild=child;
  const tx=load('transactions')||{};if(!tx[child.id])tx[child.id]=[];
  tx[child.id].push({type:'SELL',asset:selectedAsset,qty,price:state.price,total:val,time:Date.now(),leverage,gain});
  save('transactions',tx);showToast(`Vendeu ${qty} ${asset.icon}${asset.name}!`,'success');updateUI();
}
function buyMax(){const state=currentChild.assets?.[selectedAsset];if(!state)return;const leverMult=leverageActive?2:1;const maxQty=Math.floor(currentChild.balance*leverMult/state.price);if(maxQty<=0){showToast('Saldo insuficiente!','error');return;}tradeQty=maxQty;document.getElementById('qtyValue').textContent=tradeQty;confirmTrade('BUY');}
function sellMax(){const state=currentChild.assets?.[selectedAsset];if(!state||state.qty<=0){showToast('Voce nao tem esse ativo!','error');return;}tradeQty=state.qty;document.getElementById('qtyValue').textContent=tradeQty;confirmTrade('SELL');}
function changeQty(d){tradeQty=Math.max(1,tradeQty+d);document.getElementById('qtyValue').textContent=tradeQty;updateUI();}

// ============ LEVERAGE ============
function toggleLeverage(){
  leverageActive=!leverageActive;
  const btn=document.getElementById('leverageToggle');
  btn.textContent=leverageActive?'2x ON':'OFF';
  btn.classList.toggle('active',leverageActive);
  if(leverageActive)showToast('Alavancagem 2x ativada! Cuidado com o risco!','warn');
  updateUI();
}

// ============ SHORT SELLING ============
function openShortModal(){
  const asset=ASSETS.find(a=>a.id===selectedAsset);if(!asset)return;
  const state=currentChild.assets?.[selectedAsset];const price=state?.price||asset.basePrice;
  genericModalAction='short';
  document.getElementById('genericModalTitle').textContent=`Short ${asset.icon} ${asset.name}`;
  document.getElementById('genericModalDetail').textContent=`Vender a descoberto ao preco ${fmt(price)}. Lucro se cair, prejuizo se subir. Qtd:`;
  document.getElementById('genericModalInput').value='1';document.getElementById('genericModalInput').step='1';document.getElementById('genericModalInput').min='1';
  document.getElementById('genericModalOverlay').classList.remove('hidden');
}
function executeShort(qty){
  const ch=load('children')||{};const child=ch[currentChild.id];if(!child)return;
  const asset=ASSETS.find(a=>a.id===selectedAsset);const state=child.assets[selectedAsset];
  const price=state.price;const value=price*qty;
  if(child.balance<value*0.5){showToast('Margem insuficiente! Precisa de 50% do valor.','error');return;}
  if(!child.shorts)child.shorts={};
  const existing=child.shorts[selectedAsset];
  if(existing){existing.qty+=qty;existing.entryPrice=(existing.entryPrice*existing.qty+price*qty)/(existing.qty);}
  else{child.shorts[selectedAsset]={qty,entryPrice:price};}
  // Credit proceeds to balance (you sold borrowed shares)
  child.balance=Math.round((child.balance+value)*100)/100;
  ch[child.id]=child;save('children',ch);currentChild=child;
  showToast(`Short aberto: ${qty} ${asset.icon}${asset.name} a ${fmt(price)}`,'info');updateUI();
}
function coverShort(assetId){
  const ch=load('children')||{};const child=ch[currentChild.id];if(!child||!child.shorts)return;
  const pos=child.shorts[assetId];if(!pos)return;
  const asset=ASSETS.find(a=>a.id===assetId);const state=child.assets[assetId];
  const curPrice=state?.price||asset.basePrice;
  const costToCover=curPrice*pos.qty;
  const pnl=(pos.entryPrice-curPrice)*pos.qty;
  child.balance=Math.round((child.balance-costToCover)*100)/100;
  delete child.shorts[assetId];
  if(pnl>0)child.realizedGains=(child.realizedGains||0)+pnl;
  ch[child.id]=child;save('children',ch);currentChild=child;
  const msg=pnl>=0?`Short coberto com lucro de ${fmt(pnl)}!`:`Short coberto com prejuizo de ${fmt(-pnl)}`;
  showToast(msg,pnl>=0?'success':'error');updateUI();
}
function updateShortPositions(child){
  if(!child.shorts)return;
  Object.entries(child.shorts).forEach(([assetId,pos])=>{
    const asset=ASSETS.find(a=>a.id===assetId);if(!asset)return;
    const curPrice=child.assets[assetId]?.price||asset.basePrice;
    const loss=(curPrice-pos.entryPrice)*pos.qty;
    // Auto liquidate if loss > 80% of entry value
    if(loss>pos.entryPrice*pos.qty*0.8){
      showToast(`Margin call! Short ${asset.icon}${asset.name} liquidado automaticamente!`,'error');
      const ch=load('children')||{};const c=ch[currentChild.id];
      if(!c)return;if(!c.shorts)c.shorts={};
      const p2=c.shorts[assetId];if(!p2)return;
      c.balance=Math.round((c.balance-curPrice*p2.qty)*100)/100;
      delete c.shorts[assetId];
      ch[c.id]=c;save('children',ch);currentChild=c;
    }
  });
}
function renderShortPositions(child){
  const wrap=document.getElementById('shortPositionsWrap');const list=document.getElementById('shortPosList');
  if(!wrap||!list)return;
  const shorts=child.shorts||{};const entries=Object.entries(shorts);
  wrap.classList.toggle('hidden',entries.length===0);
  if(!entries.length)return;
  list.innerHTML=entries.map(([assetId,pos])=>{
    const asset=ASSETS.find(a=>a.id===assetId);if(!asset)return '';
    const curPrice=child.assets[assetId]?.price||asset.basePrice;
    const pnl=(pos.entryPrice-curPrice)*pos.qty;const up=pnl>=0;
    return `<div class="short-pos-item"><span>${asset.icon} ${asset.name}: ${pos.qty} unid. @ ${fmt(pos.entryPrice)}</span><span style="color:${up?'var(--green)':'var(--red)'};font-weight:800;">${up?'+':''}${fmt(pnl)}</span><button onclick="coverShort('${assetId}')" style="padding:3px 8px;border:1px solid rgba(139,92,246,0.3);border-radius:6px;background:transparent;color:var(--purple);cursor:pointer;font-size:.65rem;font-weight:800;">Cobrir</button></div>`;
  }).join('');
}

// ============ ORDER TYPES ============
function selectOrderType(type){
  selectedOrderType=type;
  ['LIMIT_BUY','LIMIT_SELL','STOP_LOSS','STOP_GAIN'].forEach(t=>{
    const el=document.getElementById('ot'+t.replace('_',''));
    if(el)el.classList.toggle('active',t===type);
  });
  const descs={LIMIT_BUY:'Compra automaticamente quando preco atingir o alvo',LIMIT_SELL:'Vende automaticamente quando preco atingir o alvo',STOP_LOSS:'Vende automaticamente se preco cair abaixo do alvo (protege de perdas)',STOP_GAIN:'Vende automaticamente se preco subir acima do alvo (garante lucro)'};
  const el=document.getElementById('orderTypeDesc');if(el)el.textContent=descs[type]||'';
}
function placeOrder(){
  const price=parseFloat(document.getElementById('orderPrice').value);const qty=parseInt(document.getElementById('orderQty').value)||1;
  if(!price||price<=0){showToast('Digite um preco valido!','error');return;}
  const asset=ASSETS.find(a=>a.id===selectedAsset);if(!asset)return;
  const orders=load('orders_'+currentChild.id)||[];
  orders.push({id:Date.now().toString(),type:selectedOrderType,asset:selectedAsset,price,qty,createdAt:Date.now()});
  save('orders_'+currentChild.id,orders);
  showToast(`Ordem ${selectedOrderType} criada: ${asset.icon} ${qty} unid. @ ${fmt(price)}`,'success');
  renderActiveOrders();document.getElementById('orderPrice').value='';
}
function cancelOrder(id){
  let orders=load('orders_'+currentChild.id)||[];orders=orders.filter(o=>o.id!==id);
  save('orders_'+currentChild.id,orders);renderActiveOrders();showToast('Ordem cancelada','info');
}
function renderActiveOrders(){
  const el=document.getElementById('activeOrdersList');if(!el)return;
  const orders=load('orders_'+(currentChild?.id||''))||[];
  if(!orders.length){el.innerHTML='<p style="color:var(--text2);font-size:.72rem;text-align:center;padding:8px;">Nenhuma ordem ativa</p>';return;}
  el.innerHTML=orders.map(o=>{
    const asset=ASSETS.find(a=>a.id===o.asset);
    const typeLabels={LIMIT_BUY:'Lim.Compra',LIMIT_SELL:'Lim.Venda',STOP_LOSS:'Stop Loss',STOP_GAIN:'Stop Gain'};
    const typeColors={LIMIT_BUY:'var(--green)',LIMIT_SELL:'var(--red)',STOP_LOSS:'var(--orange)',STOP_GAIN:'var(--cyan)'};
    return `<div class="active-order-item"><div><span style="color:${typeColors[o.type]||'var(--text)'};font-weight:800;font-size:.68rem;">${typeLabels[o.type]||o.type}</span> ${asset?.icon||''} ${asset?.name||o.asset}<br><span style="color:var(--text2);font-size:.65rem;">${o.qty} unid. @ ${fmt(o.price)}</span></div><button class="active-order-cancel" onclick="cancelOrder('${o.id}')"></button></div>`;
  }).join('');
}
function checkOrders(child){
  let orders=load('orders_'+child.id)||[];let changed=false;
  const newOrders=[];
  orders.forEach(o=>{
    const state=child.assets[o.asset];if(!state){newOrders.push(o);return;}
    const cur=state.price;let triggered=false;
    if(o.type==='LIMIT_BUY'&&cur<=o.price){
      if(child.balance>=cur*o.qty){child.balance=Math.round((child.balance-cur*o.qty)*100)/100;state.qty+=o.qty;triggered=true;showToast(`Ordem Limite: Comprou ${o.qty} ${ASSETS.find(a=>a.id===o.asset)?.icon||''} @ ${fmt(cur)}`,'success');}
    } else if(o.type==='LIMIT_SELL'&&cur>=o.price){
      if(state.qty>=o.qty){state.qty-=o.qty;child.balance=Math.round((child.balance+cur*o.qty)*100)/100;triggered=true;showToast(`Ordem Limite: Vendeu ${o.qty} ${ASSETS.find(a=>a.id===o.asset)?.icon||''} @ ${fmt(cur)}`,'success');}
    } else if(o.type==='STOP_LOSS'&&cur<=o.price){
      const qty=Math.min(o.qty,state.qty);if(qty>0){state.qty-=qty;child.balance=Math.round((child.balance+cur*qty)*100)/100;triggered=true;showToast(`Stop Loss ativado! Vendeu ${qty} ${ASSETS.find(a=>a.id===o.asset)?.icon||''} @ ${fmt(cur)}`,'warn');}
    } else if(o.type==='STOP_GAIN'&&cur>=o.price){
      const qty=Math.min(o.qty,state.qty);if(qty>0){state.qty-=qty;child.balance=Math.round((child.balance+cur*qty)*100)/100;triggered=true;showToast(`Stop Gain ativado! Vendeu ${qty} ${ASSETS.find(a=>a.id===o.asset)?.icon||''} @ ${fmt(cur)}`,'success');}
    }
    if(!triggered)newOrders.push(o);else changed=true;
  });
  if(changed){const ch=load('children')||{};ch[child.id]=child;save('children',ch);currentChild=child;save('orders_'+child.id,newOrders);setTimeout(renderActiveOrders,100);}
}

// ============ PRICE ALERTS ============
function setAlertDir(dir){
  alertDirection=dir;
  document.getElementById('alertDirAbove').classList.toggle('active',dir==='above');
  document.getElementById('alertDirBelow').classList.toggle('active',dir==='below');
}
function addAlert(){
  const price=parseFloat(document.getElementById('alertPrice').value);if(!price||price<=0){showToast('Digite um preco valido!','error');return;}
  const alerts=load('alerts_'+currentChild.id)||[];
  const asset=ASSETS.find(a=>a.id===selectedAsset);
  alerts.push({id:Date.now().toString(),asset:selectedAsset,price,direction:alertDirection,createdAt:Date.now()});
  save('alerts_'+currentChild.id,alerts);showToast(`Alerta criado: ${asset?.icon||''} ${alertDirection==='above'?'acima':'abaixo'} de ${fmt(price)}`,'info');
  renderAlerts();document.getElementById('alertPrice').value='';
}
function removeAlert(id){
  let alerts=load('alerts_'+currentChild.id)||[];alerts=alerts.filter(a=>a.id!==id);
  save('alerts_'+currentChild.id,alerts);renderAlerts();
}
function renderAlerts(){
  const el=document.getElementById('alertsList');if(!el)return;
  const alerts=load('alerts_'+(currentChild?.id||''))||[];
  if(!alerts.length){el.innerHTML='<p style="color:var(--text2);font-size:.72rem;text-align:center;padding:6px;">Nenhum alerta</p>';return;}
  el.innerHTML=alerts.map(a=>{
    const asset=ASSETS.find(x=>x.id===a.asset);
    return `<div class="alert-item"><span>${asset?.icon||''} ${asset?.name||a.asset} ${a.direction==='above'?' acima':' abaixo'} de ${fmt(a.price)}</span><button class="alert-remove" onclick="removeAlert('${a.id}')"></button></div>`;
  }).join('');
}
function checkAlerts(child){
  let alerts=load('alerts_'+child.id)||[];const remaining=[];let triggered=false;
  alerts.forEach(a=>{
    const state=child.assets[a.asset];if(!state){remaining.push(a);return;}
    const cur=state.price;let fire=false;
    if(a.direction==='above'&&cur>=a.price)fire=true;
    if(a.direction==='below'&&cur<=a.price)fire=true;
    if(fire){
      const asset=ASSETS.find(x=>x.id===a.asset);
      showToast(` ALERTA! ${asset?.icon||''} ${asset?.name||a.asset} ${a.direction==='above'?'acima':'abaixo'} de ${fmt(a.price)}! Atual: ${fmt(cur)}`,'warn');
      triggered=true;
    } else {remaining.push(a);}
  });
  if(triggered){save('alerts_'+child.id,remaining);setTimeout(renderAlerts,100);}
}

// ============ DCA ============
function addDCA(){
  const amount=parseFloat(document.getElementById('dcaAmount').value);const freq=parseInt(document.getElementById('dcaFreq').value)||30;
  if(!amount||amount<=0){showToast('Digite um valor valido!','error');return;}
  const asset=ASSETS.find(a=>a.id===selectedAsset);
  const dcas=load('dca_'+currentChild.id)||[];
  const id=Date.now().toString();
  dcas.push({id,asset:selectedAsset,amount,freq,createdAt:Date.now(),executions:0,avgPrice:0,totalSpent:0});
  save('dca_'+currentChild.id,dcas);
  showToast(`DCA criado: ${asset?.icon||''} ${fmt(amount)} a cada ${freq}s`,'success');
  renderDCAList();startDCAIntervals();document.getElementById('dcaAmount').value='';
}
function removeDCA(id){
  let dcas=load('dca_'+currentChild.id)||[];dcas=dcas.filter(d=>d.id!==id);
  save('dca_'+currentChild.id,dcas);renderDCAList();stopDCAIntervals();startDCAIntervals();
}
function renderDCAList(){
  const el=document.getElementById('dcaList');if(!el)return;
  const dcas=load('dca_'+(currentChild?.id||''))||[];
  if(!dcas.length){el.innerHTML='<p style="color:var(--text2);font-size:.72rem;text-align:center;padding:6px;">Nenhum DCA ativo</p>';return;}
  el.innerHTML=dcas.map(d=>{
    const asset=ASSETS.find(a=>a.id===d.asset);const freqLabel=d.freq>=300?`${d.freq/60}min`:d.freq>=60?'1min':'30s';
    return `<div class="dca-item"><div><span style="font-weight:800;">${asset?.icon||''} ${asset?.name||d.asset}</span><br><span style="color:var(--text2);font-size:.65rem;">${fmt(d.amount)}/cada ${freqLabel} | ${d.executions} exec. | Total: ${fmt(d.totalSpent)}</span></div><button class="dca-item-cancel" onclick="removeDCA('${d.id}')"></button></div>`;
  }).join('');
}
function startDCAIntervals(){
  stopDCAIntervals();
  const dcas=load('dca_'+(currentChild?.id||''))||[];
  dcas.forEach(d=>{
    dcaIntervals[d.id]=setInterval(()=>executeDCA(d.id),d.freq*1000);
  });
}
function stopDCAIntervals(){Object.values(dcaIntervals).forEach(clearInterval);dcaIntervals={};}
function executeDCA(dcaId){
  const ch=load('children')||{};const child=ch[currentChild?.id];if(!child||!child.is_active)return;
  let dcas=load('dca_'+child.id)||[];const dca=dcas.find(d=>d.id===dcaId);if(!dca)return;
  const state=child.assets[dca.asset];if(!state)return;
  const price=state.price;const qty=Math.floor(dca.amount/price);if(qty<=0)return;
  const cost=qty*price;if(child.balance<cost){showToast('DCA: Saldo insuficiente!','error');return;}
  child.balance=Math.round((child.balance-cost)*100)/100;
  const prevQty=state.qty;const prevAvg=state.avgPrice||price;
  const newTotal=prevQty*prevAvg+qty*price;
  state.qty+=qty;state.avgPrice=state.qty>0?newTotal/state.qty:price;
  dca.executions++;dca.totalSpent=Math.round((dca.totalSpent+cost)*100)/100;dca.avgPrice=state.avgPrice;
  ch[child.id]=child;save('children',ch);currentChild=child;save('dca_'+child.id,dcas);
  const asset=ASSETS.find(a=>a.id===dca.asset);
  showToast(`DCA: Comprou ${qty} ${asset?.icon||''}${asset?.name||dca.asset} por ${fmt(cost)}`,'info');
  renderDCAList();if(document.getElementById('cBalance'))document.getElementById('cBalance').textContent=fmt(child.balance);
}

// ============ SAVINGS ACCOUNT ============
function startSavingsInterval(){
  if(savingsInterval)clearInterval(savingsInterval);
  savingsInterval=setInterval(updateSavings,10000);
}
function updateSavings(){
  const ch=load('children')||{};const child=ch[currentChild?.id];if(!child||!child.is_active)return;
  if(!child.savings)child.savings={balance:0,totalInterest:0,lastUpdate:Date.now()};
  if(child.savings.balance<=0){ch[child.id]=child;save('children',ch);currentChild=child;updateSavingsUI();return;}
  const rate=0.003/6;// 0.3%/min, every 10s = /6
  const interest=Math.round(child.savings.balance*rate*100)/100;
  if(interest>0){
    child.savings.balance=Math.round((child.savings.balance+interest)*100)/100;
    child.savings.totalInterest=Math.round((child.savings.totalInterest+interest)*100)/100;
    child.savings.lastUpdate=Date.now();
    ch[child.id]=child;save('children',ch);currentChild=child;
  }
  updateSavingsUI();
}
function updateSavingsUI(){
  const sav=currentChild?.savings||{balance:0,totalInterest:0};
  const rate=0.003;const projPerMin=sav.balance*rate;
  const el1=document.getElementById('savBalance'),el2=document.getElementById('savInterest'),el3=document.getElementById('savProjected');
  if(el1)el1.textContent=fmt(sav.balance);if(el2)el2.textContent=fmt(sav.totalInterest);if(el3)el3.textContent=fmt(projPerMin);
}
function openSavingsModal(action){
  genericModalAction='savings_'+action;
  document.getElementById('genericModalTitle').textContent=action==='deposit'?'Depositar na Poupanca':'Sacar da Poupanca';
  document.getElementById('genericModalDetail').textContent=action==='deposit'?`Saldo atual: ${fmt(currentChild?.balance||0)}`:`Saldo da poupanca: ${fmt(currentChild?.savings?.balance||0)}`;
  document.getElementById('genericModalInput').value='';document.getElementById('genericModalInput').step='0.01';document.getElementById('genericModalInput').min='0.01';
  document.getElementById('genericModalOverlay').classList.remove('hidden');
}
function closeGenericModal(){document.getElementById('genericModalOverlay').classList.add('hidden');genericModalAction=null;}
function confirmGenericModal(){
  const val=parseFloat(document.getElementById('genericModalInput').value);
  if(!val||val<=0){showToast('Valor invalido!','error');return;}
  if(genericModalAction==='short'){executeShort(Math.max(1,Math.round(val)));closeGenericModal();return;}
  if(genericModalAction==='savings_deposit'){
    const ch=load('children')||{};const child=ch[currentChild.id];if(!child)return;
    if(child.balance<val){showToast('Saldo insuficiente!','error');return;}
    child.balance=Math.round((child.balance-val)*100)/100;
    if(!child.savings)child.savings={balance:0,totalInterest:0,lastUpdate:Date.now()};
    child.savings.balance=Math.round((child.savings.balance+val)*100)/100;
    ch[child.id]=child;save('children',ch);currentChild=child;
    showToast(`Depositado ${fmt(val)} na poupanca!`,'success');updateUI();
  } else if(genericModalAction==='savings_withdraw'){
    const ch=load('children')||{};const child=ch[currentChild.id];if(!child)return;
    if(!child.savings||child.savings.balance<val){showToast('Saldo insuficiente na poupanca!','error');return;}
    child.savings.balance=Math.round((child.savings.balance-val)*100)/100;
    child.balance=Math.round((child.balance+val)*100)/100;
    ch[child.id]=child;save('children',ch);currentChild=child;
    showToast(`Saque de ${fmt(val)} da poupanca!`,'success');updateUI();
  }
  closeGenericModal();
}

// ============ ORDER BOOK ============
function renderOrderBook(currentPrice){
  const sellEl=document.getElementById('obSellOrders'),buyEl=document.getElementById('obBuyOrders'),spreadEl=document.getElementById('obSpread');
  if(!sellEl||!buyEl)return;
  const spread=currentPrice*0.002;const asks=[],bids=[];
  for(let i=5;i>=1;i--){const p=currentPrice+spread*i*(0.5+Math.random());const q=~~(Math.random()*50+5);asks.push({p,q});}
  for(let i=1;i<=5;i++){const p=currentPrice-spread*i*(0.5+Math.random());const q=~~(Math.random()*50+5);bids.push({p,q});}
  const maxQ=Math.max(...asks.map(a=>a.q),...bids.map(b=>b.q));
  sellEl.innerHTML=asks.reverse().map(a=>`<div class="ob-row ob-sell"><span style="color:var(--red)">${fmt(a.p)}</span><span style="text-align:center">${a.q}</span><span style="text-align:right;color:var(--text2)">${fmt(a.p*a.q)}</span><div class="ob-row-bg" style="width:${(a.q/maxQ*100).toFixed(0)}%"></div></div>`).join('');
  buyEl.innerHTML=bids.map(b=>`<div class="ob-row ob-buy"><span style="color:var(--green)">${fmt(b.p)}</span><span style="text-align:center">${b.q}</span><span style="text-align:right;color:var(--text2)">${fmt(b.p*b.q)}</span><div class="ob-row-bg" style="width:${(b.q/maxQ*100).toFixed(0)}%"></div></div>`).join('');
  if(spreadEl)spreadEl.textContent=`Spread: ${fmt(spread*2)} (${((spread*2/currentPrice)*100).toFixed(2)}%)`;
}

// ============ MARKET INDEX (IBKIDS) ============
function updateIBKIDSIndex(child){
  let total=0,base=0;
  ASSETS.forEach(a=>{const state=child.assets[a.id];if(state){total+=state.price/a.basePrice;}base+=1;});
  const idx=base>0?Math.round((total/base)*1000)/10:100;
  ibkidsHistory.push({v:idx,t:Date.now()});if(ibkidsHistory.length>200)ibkidsHistory=ibkidsHistory.slice(-200);
  const prev=ibkidsHistory.length>=2?ibkidsHistory[ibkidsHistory.length-2].v:idx;
  const diff=idx-prev;const pct=prev>0?((diff/prev)*100).toFixed(2):'0.00';
  const valEl=document.getElementById('ibkidsVal'),chgEl=document.getElementById('ibkidsChg');
  if(valEl)valEl.textContent=idx.toFixed(1);
  if(chgEl){chgEl.textContent=`${diff>=0?'+':''}${pct}%`;chgEl.style.color=diff>=0?'var(--green)':'var(--red)';}
  drawIBKIDSSparkline();
}
function drawIBKIDSSparkline(){
  const canvas=document.getElementById('ibkidsSparkline');if(!canvas)return;
  const ctx=canvas.getContext('2d');const data=ibkidsHistory.slice(-30).map(x=>x.v);
  if(data.length<2)return;
  canvas.width=80;canvas.height=30;
  const w=80,h=30,min=Math.min(...data)*0.995,max=Math.max(...data)*1.005,range=max-min||1;
  const stepX=w/(data.length-1);const isUp=data[data.length-1]>=data[0];const color=isUp?'#22c55e':'#ef4444';
  ctx.clearRect(0,0,w,h);ctx.beginPath();ctx.moveTo(0,h-((data[0]-min)/range)*h);
  for(let i=1;i<data.length;i++)ctx.lineTo(i*stepX,h-((data[i]-min)/range)*h);
  ctx.strokeStyle=color;ctx.lineWidth=1.5;ctx.stroke();
}

// ============ FEAR & GREED ============
function updateFearGreed(child){
  let score=50;
  // Factor 1: recent price trend
  let upCount=0,downCount=0;
  ASSETS.forEach(a=>{const h=priceHistories[a.id]||[];if(h.length>=2){const cur=h[h.length-1].p,prev=h[h.length-2].p;if(cur>prev)upCount++;else if(cur<prev)downCount++;}});
  const total=upCount+downCount||1;const trendScore=(upCount/total)*100;
  score=(score*0.6+trendScore*0.4);
  // Factor 2: ibkids momentum
  if(ibkidsHistory.length>=10){const recent=ibkidsHistory.slice(-5).map(x=>x.v);const older=ibkidsHistory.slice(-10,-5).map(x=>x.v);const rAvg=recent.reduce((a,b)=>a+b,0)/recent.length;const oAvg=older.reduce((a,b)=>a+b,0)/older.length;const momentum=(rAvg-oAvg)/oAvg*100;score=Math.min(100,Math.max(0,score+momentum*2));}
  fearGreedValue=Math.round(score);
  drawFGGauge(fearGreedValue);
  const valEl=document.getElementById('fgValue'),sentEl=document.getElementById('fgSentiment');
  if(valEl)valEl.textContent=fearGreedValue;
  if(sentEl){let sent,color;if(fearGreedValue<25){sent='Medo Extremo';color='var(--red)';}else if(fearGreedValue<45){sent='Medo';color='var(--orange)';}else if(fearGreedValue<55){sent='Neutro';color='var(--gold)';}else if(fearGreedValue<75){sent='Ganancia';color='#84cc16';}else{sent='Ganancia Extrema';color='var(--green)';}sentEl.textContent=sent;sentEl.style.color=color;}
}
function drawFGGauge(value){
  const canvas=document.getElementById('fgGauge');if(!canvas)return;
  const ctx=canvas.getContext('2d'),w=canvas.width,h=canvas.height;
  ctx.clearRect(0,0,w,h);
  const cx=w/2,cy=h-10,r=Math.min(w,h*2)*0.42;
  // Background arc
  const zones=[{from:Math.PI,to:Math.PI*1.25,color:'#ef4444'},{from:Math.PI*1.25,to:Math.PI*1.45,color:'#f97316'},{from:Math.PI*1.45,to:Math.PI*1.55,color:'#f59e0b'},{from:Math.PI*1.55,to:Math.PI*1.75,color:'#84cc16'},{from:Math.PI*1.75,to:Math.PI*2,color:'#22c55e'}];
  zones.forEach(z=>{ctx.beginPath();ctx.arc(cx,cy,r,z.from,z.to);ctx.strokeStyle=z.color;ctx.lineWidth=14;ctx.stroke();});
  // Needle
  const angle=Math.PI+(value/100)*Math.PI;
  ctx.beginPath();ctx.moveTo(cx,cy);
  ctx.lineTo(cx+Math.cos(angle)*(r-16),cy+Math.sin(angle)*(r-16));
  ctx.strokeStyle='#fff';ctx.lineWidth=3;ctx.lineCap='round';ctx.stroke();
  ctx.beginPath();ctx.arc(cx,cy,6,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
}
function toggleFGTip(){const el=document.getElementById('fgTip');if(el)el.classList.toggle('hidden');}

// ============ MARKET EVENTS ============
function triggerMarketEvent(){
  const events=['flash_crash','bull_run','dividendos','news_shock'];
  const ev=events[~~(Math.random()*events.length)];
  const asset=ASSETS[~~(Math.random()*ASSETS.length)];
  const ch=load('children')||{};const child=ch[currentChild?.id];if(!child)return;
  const state=child.assets[asset.id];if(!state)return;
  let msg='';
  if(ev==='flash_crash'){const pct=0.15+Math.random()*0.10;state.price=Math.round(state.price*(1-pct)*100)/100;msg=` FLASH CRASH! ${asset.icon} ${asset.name} caiu ${(pct*100).toFixed(0)}%! Oportunidade?`;}
  else if(ev==='bull_run'){const pct=0.10+Math.random()*0.10;state.price=Math.round(state.price*(1+pct)*100)/100;msg=` BULL RUN! ${asset.icon} ${asset.name} subiu ${(pct*100).toFixed(0)}%! Hora de vender?`;}
  else if(ev==='dividendos'){const bonus=Math.round(child.balance*0.02*100)/100;child.balance=Math.round((child.balance+bonus)*100)/100;msg=` DIVIDENDOS ESPECIAIS! +${fmt(bonus)} adicionado ao seu saldo!`;}
  else if(ev==='news_shock'){const pct=(Math.random()>0.5?1:-1)*0.08;state.price=Math.round(state.price*(1+pct)*100)/100;msg=` NOTICIA! ${asset.icon} ${asset.name} ${pct>0?'subiu':'caiu'} com novidades!`;}
  ch[child.id]=child;save('children',ch);currentChild=child;
  if(msg){showToast(msg,'info');showEventTicker(msg);marketEventLog.push({msg,t:Date.now()});if(marketEventLog.length>20)marketEventLog=marketEventLog.slice(-20);}
}
function showEventTicker(msg){
  const wrap=document.getElementById('eventTickerWrap'),text=document.getElementById('eventTickerText');
  if(!wrap||!text)return;wrap.style.display='block';text.textContent=msg;
  setTimeout(()=>{wrap.style.display='none';},20000);
}

// ============ CHART ============
function calcMA(prices,period){
  return prices.map((_,i)=>{if(i<period-1)return null;const slice=prices.slice(i-period+1,i+1);return slice.reduce((a,b)=>a+b,0)/period;});
}
function calcBB(prices,period,mult){
  const mas=calcMA(prices,period);
  return mas.map((ma,i)=>{if(ma===null)return null;const slice=prices.slice(Math.max(0,i-period+1),i+1);const variance=slice.reduce((s,p)=>s+Math.pow(p-ma,2),0)/slice.length;const std=Math.sqrt(variance);return{upper:ma+mult*std,lower:ma-mult*std,mid:ma};});
}
function calcRSI(prices,period){
  if(prices.length<period+1)return[];
  const rsi=[];let avgGain=0,avgLoss=0;
  for(let i=1;i<=period;i++){const d=prices[i]-prices[i-1];if(d>0)avgGain+=d;else avgLoss+=-d;}
  avgGain/=period;avgLoss/=period;
  for(let i=period;i<prices.length;i++){
    if(i===period){const rs=avgGain/avgLoss||0;rsi.push(avgLoss===0?100:100-100/(1+rs));continue;}
    const d=prices[i]-prices[i-1];const gain=d>0?d:0;const loss=d<0?-d:0;
    avgGain=(avgGain*(period-1)+gain)/period;avgLoss=(avgLoss*(period-1)+loss)/period;
    const rs=avgLoss===0?Infinity:avgGain/avgLoss;rsi.push(avgLoss===0?100:100-100/(1+rs));
  }
  return rsi;
}
function drawChart(){
  const canvas=document.getElementById('priceChart');if(!canvas)return;
  const ctx=canvas.getContext('2d');const rect=canvas.parentElement.getBoundingClientRect();
  canvas.width=rect.width;canvas.height=rect.height;
  const asset=ASSETS.find(a=>a.id===selectedAsset);
  let allData=priceHistories[selectedAsset]||[];
  const period=TIME_PERIODS.find(t=>t.id===selectedTime);
  if(period&&period.seconds!==Infinity){const cutoff=Date.now()-period.seconds*1000;allData=allData.filter(d=>d.t>=cutoff);}
  if(allData.length<2){ctx.fillStyle='#7a8ba8';ctx.font='13px sans-serif';ctx.textAlign='center';ctx.fillText('Coletando dados...',canvas.width/2,canvas.height/2);return;}
  let data=allData;const maxPts=150;
  if(data.length>maxPts){const step=Math.ceil(data.length/maxPts);data=data.filter((_,i)=>i%step===0);if(data[data.length-1]!==allData[allData.length-1])data.push(allData[allData.length-1]);}
  const prices=data.map(d=>d.p);
  const min=Math.min(...prices)*.97,max=Math.max(...prices)*1.03;const range=max-min||1;
  const w=canvas.width,h=canvas.height,pad=8;
  const stepX=w/(prices.length-1||1);
  ctx.strokeStyle='#1f2d4722';ctx.lineWidth=.5;
  for(let i=0;i<=5;i++){const y=pad+((h-pad*2)/5)*i;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}
  ctx.fillStyle='#4a5568';ctx.font='9px sans-serif';ctx.textAlign='right';
  for(let i=0;i<=4;i++){const y=pad+((h-pad*2)/4)*i;const val=max-(range/4)*i;ctx.fillText(`${val.toFixed(val>=100?0:1)}`,w-4,y+3);}
  const baseY=h-pad-((asset.basePrice-min)/range)*(h-pad*2);
  ctx.strokeStyle='#f59e0b33';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(0,baseY);ctx.lineTo(w,baseY);ctx.stroke();ctx.setLineDash([]);
  if(chartType==='candle'){drawCandlestick(ctx,data,min,range,w,h,pad);}
  else{drawLineChart(ctx,prices,min,range,w,h,pad,stepX,asset);}
  // Indicators
  if(activeIndicators.MA){drawMAIndicator(ctx,prices,min,range,w,h,pad,stepX);}
  if(activeIndicators.BB){drawBBIndicator(ctx,prices,min,range,w,h,pad,stepX);}
  if(activeIndicators.RSI)drawRSIChart(prices);
}
function drawLineChart(ctx,prices,min,range,w,h,pad,stepX,asset){
  const pts=prices.map((p,i)=>({x:i*stepX,y:h-pad-((p-min)/range)*(h-pad*2)}));
  const lastP=prices[prices.length-1];const lineColor=asset.color;
  ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);
  for(let i=1;i<pts.length;i++){const prev=pts[i-1],cur=pts[i];const cpx=(prev.x+cur.x)/2;ctx.bezierCurveTo(cpx,prev.y,cpx,cur.y,cur.x,cur.y);}
  ctx.strokeStyle=lineColor;ctx.lineWidth=2.5;ctx.lineCap='round';ctx.lineJoin='round';ctx.stroke();
  ctx.shadowColor=lineColor;ctx.shadowBlur=8;ctx.stroke();ctx.shadowBlur=0;
  const lastPt=pts[pts.length-1];
  ctx.lineTo(lastPt.x,h);ctx.lineTo(pts[0].x,h);ctx.closePath();
  const grad=ctx.createLinearGradient(0,0,0,h);grad.addColorStop(0,lineColor+'30');grad.addColorStop(.6,lineColor+'08');grad.addColorStop(1,'transparent');
  ctx.fillStyle=grad;ctx.fill();
  if(prices.length>3){const barH=h*.12;for(let i=1;i<prices.length;i++){const change=Math.abs(prices[i]-prices[i-1])/prices[i-1];const bh=Math.min(barH,change*barH*40);const x=i*stepX;ctx.fillStyle=prices[i]>=prices[i-1]?'rgba(34,197,94,.15)':'rgba(239,68,68,.15)';ctx.fillRect(x-stepX/3,h-bh,stepX*.6,bh);}}
  ctx.beginPath();ctx.arc(lastPt.x,lastPt.y,7,0,Math.PI*2);ctx.fillStyle=lineColor+'33';ctx.fill();
  ctx.beginPath();ctx.arc(lastPt.x,lastPt.y,4,0,Math.PI*2);ctx.fillStyle=lineColor;ctx.fill();
  ctx.strokeStyle='#fff';ctx.lineWidth=1.5;ctx.stroke();
  ctx.fillStyle=lineColor;ctx.font='bold 10px sans-serif';ctx.textAlign='right';ctx.fillText(fmt(lastP),lastPt.x-8,lastPt.y-8);
}
function drawCandlestick(ctx,data,min,range,w,h,pad){
  // Group into candles of 4 points
  const candleSize=4;const candles=[];
  for(let i=0;i<data.length;i+=candleSize){
    const group=data.slice(i,i+candleSize);if(group.length<2)continue;
    const prices=group.map(d=>d.p);
    candles.push({open:prices[0],close:prices[prices.length-1],high:Math.max(...prices),low:Math.min(...prices)});
  }
  if(!candles.length)return;
  const cw=Math.max(2,(w/candles.length)*0.7);const cx=(w/candles.length);
  candles.forEach((c,i)=>{
    const x=i*cx+cx/2;const isGreen=c.close>=c.open;const color=isGreen?'#22c55e':'#ef4444';
    const openY=h-pad-((c.open-min)/range)*(h-pad*2);const closeY=h-pad-((c.close-min)/range)*(h-pad*2);
    const highY=h-pad-((c.high-min)/range)*(h-pad*2);const lowY=h-pad-((c.low-min)/range)*(h-pad*2);
    // Wick
    ctx.beginPath();ctx.moveTo(x,highY);ctx.lineTo(x,lowY);ctx.strokeStyle=color;ctx.lineWidth=1;ctx.stroke();
    // Body
    const bodyTop=Math.min(openY,closeY);const bodyH=Math.max(2,Math.abs(openY-closeY));
    ctx.fillStyle=color;ctx.fillRect(x-cw/2,bodyTop,cw,bodyH);
  });
}
function drawMAIndicator(ctx,prices,min,range,w,h,pad,stepX){
  const mas=calcMA(prices,10);ctx.beginPath();let first=true;
  mas.forEach((ma,i)=>{if(ma===null)return;const x=i*stepX;const y=h-pad-((ma-min)/range)*(h-pad*2);if(first){ctx.moveTo(x,y);first=false;}else ctx.lineTo(x,y);});
  ctx.strokeStyle='rgba(251,191,36,0.8)';ctx.lineWidth=1.5;ctx.setLineDash([]);ctx.stroke();
}
function drawBBIndicator(ctx,prices,min,range,w,h,pad,stepX){
  const bbs=calcBB(prices,10,2);
  ctx.beginPath();let firstU=true;
  bbs.forEach((bb,i)=>{if(!bb)return;const x=i*stepX;const y=h-pad-((bb.upper-min)/range)*(h-pad*2);if(firstU){ctx.moveTo(x,y);firstU=false;}else ctx.lineTo(x,y);});
  ctx.strokeStyle='rgba(139,92,246,0.6)';ctx.lineWidth=1;ctx.stroke();
  ctx.beginPath();let firstL=true;
  bbs.forEach((bb,i)=>{if(!bb)return;const x=i*stepX;const y=h-pad-((bb.lower-min)/range)*(h-pad*2);if(firstL){ctx.moveTo(x,y);firstL=false;}else ctx.lineTo(x,y);});
  ctx.strokeStyle='rgba(139,92,246,0.6)';ctx.lineWidth=1;ctx.stroke();
  // Fill between bands
  ctx.beginPath();let fp=true;
  bbs.forEach((bb,i)=>{if(!bb)return;const x=i*stepX;const y=h-pad-((bb.upper-min)/range)*(h-pad*2);if(fp){ctx.moveTo(x,y);fp=false;}else ctx.lineTo(x,y);});
  bbs.slice().reverse().forEach((bb,i)=>{if(!bb)return;const idx=bbs.length-1-i;const x=idx*stepX;const y=h-pad-((bb.lower-min)/range)*(h-pad*2);ctx.lineTo(x,y);});
  ctx.closePath();ctx.fillStyle='rgba(139,92,246,0.07)';ctx.fill();
}
function drawRSIChart(prices){
  const canvas=document.getElementById('rsiCanvas');if(!canvas)return;
  const wrap=document.getElementById('rsiWrap');if(!wrap||wrap.classList.contains('hidden'))return;
  const ctx=canvas.getContext('2d');canvas.width=wrap.offsetWidth;canvas.height=40;
  const w=canvas.width,h=canvas.height;
  const rsi=calcRSI(prices,14);if(!rsi.length)return;
  const stepX=w/(rsi.length-1||1);
  ctx.fillStyle='rgba(0,0,0,0.15)';ctx.fillRect(0,0,w,h);
  // Overbought/oversold lines
  ctx.strokeStyle='rgba(239,68,68,0.4)';ctx.lineWidth=1;ctx.setLineDash([3,3]);
  ctx.beginPath();ctx.moveTo(0,(1-70/100)*h);ctx.lineTo(w,(1-70/100)*h);ctx.stroke();
  ctx.strokeStyle='rgba(34,197,94,0.4)';
  ctx.beginPath();ctx.moveTo(0,(1-30/100)*h);ctx.lineTo(w,(1-30/100)*h);ctx.stroke();
  ctx.setLineDash([]);
  ctx.beginPath();rsi.forEach((v,i)=>{const x=i*stepX;const y=(1-v/100)*h;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});
  const lastRSI=rsi[rsi.length-1];ctx.strokeStyle=lastRSI>70?'#ef4444':lastRSI<30?'#22c55e':'#f59e0b';ctx.lineWidth=2;ctx.stroke();
  ctx.fillStyle='#fff';ctx.font='bold 9px sans-serif';ctx.textAlign='left';ctx.fillText(`RSI: ${lastRSI.toFixed(0)}${lastRSI>70?' Sobrecomp.':lastRSI<30?' Sobrevend.':''}`,4,10);
}

// ============ ANALYTICS TAB ============
function updateAnalyticsTab(){
  if(!currentChild)return;
  const child=currentChild;const tv=calcTotal(child);
  // ROI
  const roi=((tv-child.initial_balance)/child.initial_balance*100).toFixed(1);
  const roiEl=document.getElementById('analyticsTotalROI');if(roiEl){roiEl.textContent=`${roi>=0?'+':''}${roi}%`;roiEl.style.color=roi>=0?'var(--green)':'var(--red)';}
  const patEl=document.getElementById('analyticsPatrimony');if(patEl)patEl.textContent=fmt(tv);
  // Diversification
  const owned=ASSETS.filter(a=>(child.assets?.[a.id]?.qty||0)>0).length;
  const divScore=Math.min(10,Math.round(owned*1.5));
  const divEl=document.getElementById('analyticsDivScore');if(divEl){divEl.textContent=`${divScore}/10`;divEl.style.color=divScore>=7?'var(--green)':divScore>=4?'var(--gold)':'var(--red)';}
  // Risk
  const cats=new Set(ASSETS.filter(a=>(child.assets?.[a.id]?.qty||0)>0).map(a=>a.cat));
  const hasHighRisk=cats.has('cripto')||cats.has('forex');const hasLowRisk=cats.has('rendafixa');
  let risk='Moderado';if(hasHighRisk&&!hasLowRisk)risk='Agressivo';else if(hasLowRisk&&!hasHighRisk)risk='Conservador';
  const riskEl=document.getElementById('analyticsRisk');if(riskEl){riskEl.textContent=risk;riskEl.style.color=risk==='Agressivo'?'var(--red)':risk==='Conservador'?'var(--green)':'var(--gold)';}
  // P&L Grid
  const pnlGrid=document.getElementById('pnlGrid');
  if(pnlGrid){const ownedAssets=ASSETS.filter(a=>(child.assets?.[a.id]?.qty||0)>0);
    if(!ownedAssets.length){pnlGrid.innerHTML='<p style="color:var(--text2);text-align:center;font-size:.8rem;">Nenhum ativo na carteira</p>';}
    else{pnlGrid.innerHTML=ownedAssets.map(a=>{const d=child.assets[a.id];const avgP=d.avgPrice||a.basePrice;const pnl=(d.price-avgP)*d.qty;const pct=((d.price-avgP)/avgP*100).toFixed(1);const up=pnl>=0;return `<div class="pnl-item"><div class="pnl-left"><span class="pnl-icon">${a.icon}</span><div><div class="pnl-name">${a.name}</div><div class="pnl-qty">${d.qty} unid. | Avg: ${fmt(avgP)}</div></div></div><div class="pnl-right"><div class="pnl-value" style="color:${up?'var(--green)':'var(--red)'}">${up?'+':''}${fmt(pnl)}</div><div class="pnl-pct" style="color:${up?'var(--green)':'var(--red)'}">${up?'+':''}${pct}%</div></div></div>`;}).join('');}}
  // Tax
  const gains=child.realizedGains||0;const taxable=Math.max(0,gains-20);const taxOwed=taxable*0.15;const netProfit=gains-taxOwed;
  const tgEl=document.getElementById('taxGains'),tbEl=document.getElementById('taxBase'),toEl=document.getElementById('taxOwed'),tnEl=document.getElementById('taxNet');
  if(tgEl)tgEl.textContent=fmt(gains);if(tbEl)tbEl.textContent=fmt(taxable);if(toEl)toEl.textContent=fmt(taxOwed);if(tnEl)tnEl.textContent=fmt(netProfit);
  // Pie chart
  drawPieChart(child);
  // Portfolio history chart
  drawPortfolioHistChart();
}
function drawPieChart(child){
  const canvas=document.getElementById('pieChart');if(!canvas)return;
  const ctx=canvas.getContext('2d');canvas.width=300;canvas.height=200;
  const w=300,h=200,cx=150,cy=110,r=80;
  ctx.clearRect(0,0,w,h);
  const catValues={};
  CATEGORIES.forEach(c=>{catValues[c.id]=0;});
  ASSETS.forEach(a=>{const d=child.assets?.[a.id];if(d&&d.qty>0)catValues[a.cat]=(catValues[a.cat]||0)+d.qty*d.price;});
  const total=Object.values(catValues).reduce((a,b)=>a+b,0)||1;
  const colors={'cripto':'#3b82f6','acoes':'#22c55e','commodities':'#f59e0b','rendafixa':'#06b6d4','fundos':'#8b5cf6','forex':'#ec4899'};
  let startAngle=-Math.PI/2;const legend=[];
  CATEGORIES.forEach(c=>{
    const val=catValues[c.id];if(val<=0)return;
    const slice=(val/total)*Math.PI*2;const color=colors[c.id]||'#64748b';
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,startAngle,startAngle+slice);ctx.closePath();
    ctx.fillStyle=color;ctx.fill();ctx.strokeStyle='rgba(0,0,0,0.3)';ctx.lineWidth=2;ctx.stroke();
    legend.push({name:c.name,color,pct:((val/total)*100).toFixed(0)});startAngle+=slice;
  });
  if(total===1){ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fillStyle='#1f2d47';ctx.fill();ctx.fillStyle='#7a8ba8';ctx.font='13px sans-serif';ctx.textAlign='center';ctx.fillText('Carteira Vazia',cx,cy);}
  const legendEl=document.getElementById('pieLegend');
  if(legendEl)legendEl.innerHTML=legend.map(l=>`<span style="display:inline-flex;align-items:center;gap:4px;font-size:.68rem;font-weight:700;"><span style="width:10px;height:10px;border-radius:2px;background:${l.color};display:inline-block;"></span>${l.name} ${l.pct}%</span>`).join('');
}
function drawPortfolioHistChart(){
  const canvas=document.getElementById('portfolioHistChart');if(!canvas)return;
  const ctx=canvas.getContext('2d');canvas.width=canvas.parentElement?.offsetWidth||400;canvas.height=120;
  const w=canvas.width,h=canvas.height;ctx.clearRect(0,0,w,h);
  const data=portfolioValueHistory.slice(-60).map(x=>x.v);if(data.length<2){ctx.fillStyle='#7a8ba8';ctx.font='12px sans-serif';ctx.textAlign='center';ctx.fillText('Acumulando dados...',w/2,h/2);return;}
  const min=Math.min(...data)*0.99,max=Math.max(...data)*1.01,range=max-min||1;const stepX=w/(data.length-1);
  const pts=data.map((v,i)=>({x:i*stepX,y:h-((v-min)/range)*(h-10)-5}));
  const isUp=data[data.length-1]>=data[0];const color=isUp?'#22c55e':'#ef4444';
  ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);pts.slice(1).forEach(p=>ctx.lineTo(p.x,p.y));ctx.strokeStyle=color;ctx.lineWidth=2;ctx.stroke();
  ctx.lineTo(pts[pts.length-1].x,h);ctx.lineTo(0,h);ctx.closePath();const grad=ctx.createLinearGradient(0,0,0,h);grad.addColorStop(0,color+'40');grad.addColorStop(1,'transparent');ctx.fillStyle=grad;ctx.fill();
}

// ============ NEWS ============
const NEWS_TEMPLATES=[
  {text:' Fabrica de {asset} aumentou producao! Especialistas dizem que o preco pode {dir}.',hint:'Pense: mais oferta = preco tende a cair?',forUp:false},
  {text:' Muitas pessoas querem comprar {asset}! A demanda esta altissima.',hint:'Dica: quando todos querem, o preco geralmente sobe!',forUp:true},
  {text:' Uma nova tecnologia usa {asset}. Investidores estao animados!',hint:'Novidades boas costumam fazer o preco subir.',forUp:true},
  {text:' Especialistas dizem que {asset} esta caro demais agora.',hint:'Quando esta caro, pode ser hora de vender e esperar cair.',forUp:false},
  {text:' {asset} bateu recorde de vendas essa semana!',hint:'Recordes podem significar que o preco ainda vai subir.',forUp:true},
  {text:' Investidores estao com medo e vendendo {asset}.',hint:'Quando todos vendem, o preco cai. Pode ser hora de comprar barato!',forUp:false},
  {text:' O Banco Central disse que {asset} e um bom investimento.',hint:'Noticias positivas de autoridades fazem o preco subir.',forUp:true},
  {text:' Problemas de transporte afetaram a entrega de {asset}.',hint:'Problemas = menos oferta. O que acontece com o preco?',forUp:true},
];
let currentNews=[];
function generateNews(){
  currentNews=[];const shuffled=[...NEWS_TEMPLATES].sort(()=>Math.random()-.5);
  for(let i=0;i<2;i++){const template=shuffled[i];const asset=ASSETS[~~(Math.random()*ASSETS.length)];currentNews.push({text:template.text.replace('{asset}',asset.icon+' '+asset.name).replace('{dir}',template.forUp?'subir':'cair'),hint:template.hint,asset:asset.id,forUp:template.forUp});}
}
function renderNews(){
  const el=document.getElementById('newsContainer');if(!currentNews.length)generateNews();
  el.innerHTML=currentNews.map(n=>`<div class="news-item">${n.text}<span class="news-hint"> ${n.hint}</span></div>`).join('');
}
setInterval(()=>{generateNews();renderNews();},45000);

// ============ CHALLENGES ============
const CHALLENGE_DEFS=[
  {id:'buy_low',icon:'',name:'Comprar na Baixa',desc:'Compre qualquer ativo quando estiver abaixo do preco base',reward:'+R$ 5',check:c=>{const txs=(load('transactions')||{})[c.id]||[];return txs.some(t=>{if(t.type!=='BUY')return false;const a=ASSETS.find(x=>x.id===t.asset);return a&&t.price<a.basePrice;})}},
  {id:'sell_high',icon:'',name:'Vender na Alta',desc:'Venda qualquer ativo quando estiver acima de 120% do base',reward:'+R$ 5',check:c=>{const txs=(load('transactions')||{})[c.id]||[];return txs.some(t=>{if(t.type!=='SELL')return false;const a=ASSETS.find(x=>x.id===t.asset);return a&&t.price>a.basePrice*1.2;})}},
  {id:'diversify',icon:'',name:'Diversificar',desc:'Tenha pelo menos 3 ativos diferentes na carteira',reward:'+R$ 10',check:c=>ASSETS.filter(a=>(c.assets?.[a.id]?.qty||0)>0).length>=3},
  {id:'patience',icon:'',name:'Paciencia',desc:'Acumule mais de R$ 20 em rendimento passivo (EKOs)',reward:'+R$ 8',check:c=>(c.totalYield||0)>=20},
  {id:'profit',icon:'',name:'Lucro Real',desc:'Tenha patrimonio 30% acima do saldo inicial',reward:'+R$ 15',check:c=>calcTotal(c)>=c.initial_balance*1.3},
  {id:'trader',icon:'',name:'Trader Ativo',desc:'Faca 10 operacoes no total',reward:'+R$ 5',check:c=>{const txs=(load('transactions')||{})[c.id]||[];return txs.length>=10;}},
];
function renderChallenges(){
  const el=document.getElementById('challengesList');const child=currentChild;const completed=load('challenges_'+child.id)||{};
  el.innerHTML=CHALLENGE_DEFS.map(ch=>{const done=completed[ch.id]||false;return `<div class="challenge-item ${done?'completed':''}"><span class="challenge-icon">${ch.icon}</span><div class="challenge-info"><div class="challenge-name">${ch.name}</div><div class="challenge-desc">${ch.desc}</div></div>${done?'<span class="challenge-check"></span>':`<span class="challenge-reward">${ch.reward}</span>`}</div>`;}).join('');
}
function checkChallenges(){
  const ch=load('children')||{};const child=ch[currentChild.id];if(!child)return;
  const completed=load('challenges_'+child.id)||{};let earned=false;
  CHALLENGE_DEFS.forEach(chal=>{
    if(completed[chal.id])return;if(chal.check(child)){completed[chal.id]=true;const reward=parseFloat(chal.reward.replace(/[^0-9.]/g,''))||0;child.balance=Math.round((child.balance+reward)*100)/100;earned=true;showToast(` Desafio "${chal.name}" completo! ${chal.reward}`,'success');setTimeout(()=>addXP(20,'Desafio completo!'),500);}
  });
  if(earned){ch[child.id]=child;save('children',ch);currentChild=child;save('challenges_'+child.id,completed);}renderChallenges();
}
function renderChildTx(){
  const txs=((load('transactions')||{})[currentChild.id]||[]);const el=document.getElementById('cTxList');
  if(!txs.length){el.innerHTML='<p style="color:var(--text2);text-align:center;padding:10px;font-size:.85rem;">Faca sua primeira operacao!</p>';return;}
  el.innerHTML=txs.slice(-10).reverse().map(tx=>{const a=ASSETS.find(x=>x.id===tx.asset)||ASSETS[0];return `<div class="tx-feed-item"><span>${tx.type==='BUY'?'':''} ${tx.type==='BUY'?'Comprou':'Vendeu'} ${tx.qty} ${a.icon}${a.name} a ${fmt(tx.price)}</span><span style="font-weight:800;color:${tx.type==='BUY'?'var(--red)':'var(--green)'}">${tx.type==='BUY'?'-':'+'}${fmt(tx.total)}</span></div>`;}).join('');
}

// ============ CELEBRATION ============
function showCelebration(tv,goal){document.getElementById('celebrationText').textContent=`Patrimonio: ${fmt(tv)} - Meta: ${fmt(goal)}`;document.getElementById('celebrationOverlay').classList.remove('hidden');createConfetti();}
function closeCelebration(){document.getElementById('celebrationOverlay').classList.add('hidden');}
function createConfetti(){
  const colors=['#22c55e','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899'];
  for(let i=0;i<60;i++){const c=document.createElement('div');c.style.cssText=`position:fixed;width:${Math.random()*10+5}px;height:${Math.random()*10+5}px;background:${colors[~~(Math.random()*colors.length)]};left:${Math.random()*100}vw;top:-20px;border-radius:${Math.random()>.5?'50%':'2px'};z-index:1100;pointer-events:none;animation:cFall ${Math.random()*2+2}s ease-in forwards;`;document.body.appendChild(c);setTimeout(()=>c.remove(),4000);}
  if(!document.getElementById('cStyle')){const s=document.createElement('style');s.id='cStyle';s.textContent='@keyframes cFall{to{transform:translateY(110vh) rotate(720deg);opacity:0}}';document.head.appendChild(s);}
}

// ============ UTILS ============
function fmt(v){return'R$ '+(v||0).toFixed(2).replace('.',',');}
function showToast(m,t){
  const el=document.createElement('div');el.className=`toast toast-${t||'success'}`;el.textContent=m;
  document.body.appendChild(el);setTimeout(()=>el.remove(),3000);
}
function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=~~(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}

// ============================================================
// MINI-GAMES
// ============================================================
const QUIZ_QUESTIONS=[
  {q:'O que acontece quando muita gente quer comprar algo?',opts:['O preco sobe','O preco cai','Nada acontece','O produto some'],correct:0},
  {q:'O que significa diversificar?',opts:['Comprar so uma coisa','Investir em coisas diferentes','Vender tudo','Guardar dinheiro em casa'],correct:1},
  {q:'Se voce compra por R$5 e vende por R$8, qual o lucro?',opts:['R$8','R$5','R$3','R$13'],correct:2},
  {q:'O que e inflacao?',opts:['Quando as coisas ficam mais baratas','Quando as coisas ficam mais caras','Quando o dinheiro aumenta','Quando o banco fecha'],correct:1},
  {q:'Qual a melhor hora de comprar?',opts:['Quando o preco esta alto','Quando o preco esta baixo','Quando todo mundo compra','Nunca'],correct:1},
  {q:'O que e um investimento?',opts:['Gastar dinheiro com doces','Colocar dinheiro para ele crescer','Emprestar dinheiro','Guardar moedas'],correct:1},
  {q:'O que e lucro?',opts:['O dinheiro que voce gasta','O dinheiro que voce ganha alem do que investiu','O preco de um produto','O salario do mes'],correct:1},
  {q:'Por que poupar dinheiro e importante?',opts:['Para ter seguranca no futuro','Nao e importante','Para impressionar amigos','Para o dinheiro ficar velho'],correct:0},
  {q:'O que e uma acao?',opts:['Um pedacinho de uma empresa','Um tipo de doce','Uma conta bancaria','Um emprestimo'],correct:0},
  {q:'Se um produto custa R$10 e tem desconto de 20%, quanto voce paga?',opts:['R$8','R$2','R$10','R$12'],correct:0},
  {q:'O que e risco no investimento?',opts:['A chance de perder dinheiro','Ganhar muito dinheiro','Comprar algo caro','Vender algo barato'],correct:0},
  {q:'O que e empreendedor?',opts:['Alguem que cria um negocio','Alguem que gasta muito','Alguem que so poupa','Alguem que nao trabalha'],correct:0},
  {q:'O que significa "oferta e demanda"?',opts:['Quantos querem vender vs quantos querem comprar','Uma promocao de loja','Um tipo de investimento','O nome de um banco'],correct:0},
  {q:'Qual a melhor hora de vender um investimento?',opts:['Quando o preco esta alto','Quando o preco esta baixo','Nunca','No inicio'],correct:0},
  {q:'O que e juros?',opts:['O dinheiro extra que o banco te paga por guardar','Um imposto','O preco de algo','Um desconto'],correct:0},
  {q:'O que significa "comprar na baixa e vender na alta"?',opts:['A estrategia basica de ganhar dinheiro investindo','Comprar coisas baratas','Vender coisas caras','Nao investir'],correct:0},
];
let quizState={current:0,score:0,questions:[],answered:false};
function startQuiz(){quizState={current:0,score:0,questions:shuffle([...QUIZ_QUESTIONS]).slice(0,8),answered:false};document.getElementById('gameOverlay').classList.remove('hidden');renderQuiz();}
function renderQuiz(){
  const gc=document.getElementById('gameContainer');const q=quizState.questions[quizState.current];const total=quizState.questions.length;
  gc.innerHTML=`<button class="game-back" onclick="closeGame()"> Voltar</button><div class="game-title-bar"><h2> Quiz do Investidor</h2><p>Pergunta ${quizState.current+1} de ${total}</p></div><div class="quiz-progress">${quizState.questions.map((_,i)=>`<div class="quiz-dot ${i<quizState.current?'done':i===quizState.current?'current':''}"></div>`).join('')}</div><div class="glass-card" style="margin-bottom:16px;"><p style="font-size:1.05rem;font-weight:800;line-height:1.5;text-align:center;">${q.q}</p></div><div>${q.opts.map((o,i)=>`<button class="quiz-option" onclick="answerQuiz(${i})" id="qopt${i}">${o}</button>`).join('')}</div><div style="text-align:center;margin-top:12px;"><span style="color:var(--gold);font-weight:800;">Pontos: ${quizState.score}/${total}</span></div>`;
}
function answerQuiz(idx){
  if(quizState.answered)return;quizState.answered=true;const q=quizState.questions[quizState.current];const correct=idx===q.correct;
  if(correct)quizState.score++;document.getElementById('qopt'+idx).classList.add(correct?'correct':'wrong');
  if(!correct)document.getElementById('qopt'+q.correct).classList.add('correct');
  setTimeout(()=>{quizState.current++;quizState.answered=false;if(quizState.current>=quizState.questions.length)showQuizResult();else renderQuiz();},1200);
}
function showQuizResult(){
  const gc=document.getElementById('gameContainer');const total=quizState.questions.length;const pct=Math.round((quizState.score/total)*100);const xpEarned=Math.round((quizState.score/total)*15);
  let msg=pct>=80?'Incrivel! Voce e um genio!':pct>=50?'Muito bem! Continue aprendendo!':'Continue estudando, voce vai melhorar!';let emoji=pct>=80?'':pct>=50?'':'';
  gc.innerHTML=`<button class="game-back" onclick="closeGame()"> Voltar</button><div style="text-align:center;padding:40px 20px;"><div style="font-size:4rem;margin-bottom:16px;">${emoji}</div><h2 style="font-size:1.5rem;font-weight:900;margin-bottom:8px;">Quiz Completo!</h2><p style="font-size:1.1rem;color:var(--text2);margin-bottom:6px;">${quizState.score} de ${total} corretas (${pct}%)</p><p style="font-size:1rem;font-weight:700;margin-bottom:20px;">${msg}</p><p style="color:var(--gold);font-weight:900;font-size:1.1rem;margin-bottom:24px;">+${xpEarned} XP</p><button class="btn btn-primary ripple" style="max-width:240px;margin:0 auto 10px;" onclick="startQuiz()">Jogar Novamente </button><button class="btn btn-outline" style="max-width:240px;margin:0 auto;" onclick="closeGame()">Voltar aos Jogos</button></div>`;
  if(xpEarned>0)addXP(xpEarned,'Quiz completo!');incrementGamesPlayed();
}

// LEMONADE GAME
let lemonState={};
function startLemonade(){lemonState={round:1,totalRounds:5,money:20,totalProfit:0,history:[]};document.getElementById('gameOverlay').classList.remove('hidden');renderLemonadeRound();}
function renderLemonadeRound(){
  const gc=document.getElementById('gameContainer');
  const weathers=[{name:'Ensolarado',emoji:'',demand:1.5,desc:'Dia perfeito para limonada!'},{name:'Nublado',emoji:'',demand:1.0,desc:'Um dia normal.'},{name:'Chuvoso',emoji:'',demand:0.4,desc:'Pouca gente na rua...'},{name:'Muito Quente',emoji:'',demand:2.0,desc:'Todo mundo quer algo gelado!'}];
  const weather=weathers[~~(Math.random()*weathers.length)];lemonState.currentWeather=weather;
  gc.innerHTML=`<button class="game-back" onclick="closeGame()"> Voltar</button><div class="game-title-bar"><h2> Fabrica de Limonada</h2><p>Rodada ${lemonState.round} de ${lemonState.totalRounds}</p></div><div class="weather-display"><span class="weather-icon">${weather.emoji}</span><div class="weather-text">${weather.name}</div><div style="color:var(--text2);font-size:.85rem;margin-top:4px;">${weather.desc}</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;"><div class="lemon-stat"><div class="ls-val" style="color:var(--gold)">${fmt(lemonState.money)}</div><div class="ls-label">Seu Dinheiro</div></div><div class="lemon-stat"><div class="ls-val" style="color:var(--green)">${fmt(lemonState.totalProfit)}</div><div class="ls-label">Lucro Total</div></div></div><div class="glass-card"><p style="font-size:.85rem;color:var(--text2);margin-bottom:12px;text-align:center;">Cada copo custa R$ 1,00 para fazer.</p><div class="lemon-controls"><div class="lemon-control"><label> Copos para fazer:</label><div class="lemon-input"><input type="number" id="lemonCups" value="10" min="1" max="50"></div></div><div class="lemon-control"><label> Preco por copo:</label><div class="lemon-input">R$ <input type="number" id="lemonPrice" value="3" min="1" max="10" step="0.5"></div></div></div><p style="font-size:.78rem;color:var(--text2);text-align:center;" id="lemonCostPreview">Custo: R$ 10,00</p></div><button class="btn btn-primary ripple" style="margin-top:12px;" onclick="playLemonadeRound()">Vender! </button>`;
  document.getElementById('lemonCups').addEventListener('input',updateLemonPreview);document.getElementById('lemonPrice').addEventListener('input',updateLemonPreview);
}
function updateLemonPreview(){const cups=Math.max(1,+document.getElementById('lemonCups').value||0);document.getElementById('lemonCostPreview').textContent=`Custo: ${fmt(cups)}`;}
function playLemonadeRound(){
  const cups=Math.min(50,Math.max(1,+document.getElementById('lemonCups').value||10));const price=Math.min(10,Math.max(1,+document.getElementById('lemonPrice').value||3));const cost=cups;
  if(cost>lemonState.money){showToast('Dinheiro insuficiente!','error');return;}
  const weather=lemonState.currentWeather;const baseDemand=~~(Math.random()*8+8);const actualDemand=Math.min(cups,~~(baseDemand*weather.demand*(price<3?1.3:price>5?0.6:1)));const revenue=actualDemand*price;const profit=revenue-cost;
  lemonState.money=Math.round((lemonState.money+profit)*100)/100;lemonState.totalProfit=Math.round((lemonState.totalProfit+profit)*100)/100;
  lemonState.history.push({round:lemonState.round,cups,price,sold:actualDemand,cost,revenue,profit,weather:weather.name});
  const gc=document.getElementById('gameContainer');const profitColor=profit>=0?'var(--green)':'var(--red)';
  gc.innerHTML=`<button class="game-back" onclick="closeGame()"> Voltar</button><div class="game-title-bar"><h2> Resultado da Rodada ${lemonState.round}</h2></div><div class="glass-card" style="text-align:center;"><p style="font-size:1.1rem;margin-bottom:12px;">Voce fez <strong>${cups}</strong> copos e vendeu <strong>${actualDemand}</strong>!</p><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;"><div><div style="font-size:.7rem;color:var(--text2)">Custo</div><div style="font-size:1.1rem;font-weight:900;color:var(--red)">${fmt(cost)}</div></div><div><div style="font-size:.7rem;color:var(--text2)">Receita</div><div style="font-size:1.1rem;font-weight:900;color:var(--blue)">${fmt(revenue)}</div></div><div><div style="font-size:.7rem;color:var(--text2)">Lucro</div><div style="font-size:1.1rem;font-weight:900;color:${profitColor}">${profit>=0?'+':''}${fmt(profit)}</div></div></div>${actualDemand<cups?`<p style="font-size:.82rem;color:var(--orange);"> ${cups-actualDemand} copos sobraram!</p>`:`<p style="font-size:.82rem;color:var(--green);"> Vendeu tudo!</p>`}</div><button class="btn btn-primary ripple" style="margin-top:14px;" onclick="nextLemonadeRound()">${lemonState.round<lemonState.totalRounds?`Proxima Rodada (${lemonState.round+1}/${lemonState.totalRounds})`:'Ver Resultado Final'}</button>`;
}
function nextLemonadeRound(){lemonState.round++;if(lemonState.round>lemonState.totalRounds)showLemonadeResult();else renderLemonadeRound();}
function showLemonadeResult(){
  const gc=document.getElementById('gameContainer');const profit=lemonState.totalProfit;const xpEarned=profit>10?15:profit>0?10:5;let msg=profit>10?'Empresario de sucesso!':profit>0?'Bom trabalho!':'Prejuizo, mas voce aprendeu!';let emoji=profit>10?'':profit>0?'':'';
  gc.innerHTML=`<button class="game-back" onclick="closeGame()"> Voltar</button><div style="text-align:center;padding:30px 20px;"><div style="font-size:4rem;margin-bottom:14px;">${emoji}</div><h2 style="font-size:1.5rem;font-weight:900;margin-bottom:8px;">Jogo Completo!</h2><p style="font-size:1.1rem;font-weight:800;color:${profit>=0?'var(--green)':'var(--red)'};margin-bottom:6px;">Lucro: ${profit>=0?'+':''}${fmt(profit)}</p><p style="color:var(--gold);font-weight:900;font-size:1.1rem;margin-bottom:20px;">+${xpEarned} XP</p><button class="btn btn-primary ripple" style="max-width:240px;margin:0 auto 10px;" onclick="startLemonade()">Jogar Novamente </button><button class="btn btn-outline" style="max-width:240px;margin:0 auto;" onclick="closeGame()">Voltar aos Jogos</button></div>`;
  addXP(xpEarned,'Fabrica de Limonada!');incrementGamesPlayed();
}

// BUDGET GAME
const BUDGET_ITEMS=[
  {name:'Comida da Semana',icon:'',price:30,type:'need',tag:'Necessidade'},{name:'Brinquedo Legal',icon:'',price:50,type:'want',tag:'Desejo'},{name:'Poupanca',icon:'',price:20,type:'save',tag:'Poupanca'},{name:'Roupa Nova',icon:'',price:25,type:'need',tag:'Necessidade'},{name:'Doces',icon:'',price:10,type:'want',tag:'Desejo'},{name:'Livro Educativo',icon:'',price:15,type:'need',tag:'Necessidade'},{name:'Video Game',icon:'',price:60,type:'want',tag:'Desejo'},{name:'Investimento',icon:'',price:25,type:'save',tag:'Poupanca'},{name:'Material Escolar',icon:'',price:20,type:'need',tag:'Necessidade'},{name:'Sorvete',icon:'',price:8,type:'want',tag:'Desejo'},{name:'Presente pra Mae',icon:'',price:15,type:'need',tag:'Necessidade'},{name:'Fundo de Emergencia',icon:'',price:15,type:'save',tag:'Poupanca'},
];
let budgetState={budget:100,selected:[],items:[]};
function startBudget(){budgetState={budget:100,selected:[],items:shuffle([...BUDGET_ITEMS]).slice(0,8)};document.getElementById('gameOverlay').classList.remove('hidden');renderBudget();}
function renderBudget(){
  const gc=document.getElementById('gameContainer');const spent=budgetState.selected.reduce((s,i)=>s+budgetState.items[i].price,0);const remaining=budgetState.budget-spent;
  gc.innerHTML=`<button class="game-back" onclick="closeGame()"> Voltar</button><div class="game-title-bar"><h2> Desafio do Orcamento</h2><p>Escolha com sabedoria!</p></div><div class="budget-remaining"><div class="br-label">Orcamento Restante</div><div class="br-value" style="color:${remaining<0?'var(--red)':'var(--gold)'}">${fmt(remaining)}</div></div><div style="margin-bottom:14px;">${budgetState.items.map((item,i)=>{const sel=budgetState.selected.includes(i);const canAfford=!sel&&(remaining>=item.price);const tagClass=item.type==='need'?'need':item.type==='save'?'save':'want';return`<div class="budget-item ${sel?'selected':''}" onclick="toggleBudgetItem(${i})" style="${!canAfford&&!sel?'opacity:0.4;':''}"><div class="bi-info"><span class="bi-icon">${item.icon}</span><span class="bi-name">${item.name}</span><span class="bi-tag ${tagClass}">${item.tag}</span></div><span class="bi-price">${fmt(item.price)}</span></div>`;}).join('')}</div><button class="btn btn-primary ripple" onclick="finishBudget()" ${budgetState.selected.length===0?'disabled':''}>Confirmar Escolhas </button>`;
}
function toggleBudgetItem(i){const idx=budgetState.selected.indexOf(i);if(idx>=0){budgetState.selected.splice(idx,1);}else{const spent=budgetState.selected.reduce((s,j)=>s+budgetState.items[j].price,0);if(spent+budgetState.items[i].price<=budgetState.budget)budgetState.selected.push(i);else{showToast('Orcamento insuficiente!','error');return;}}renderBudget();}
function finishBudget(){
  const items=budgetState.selected.map(i=>budgetState.items[i]);const needScore=items.filter(i=>i.type==='need').length*15;const saveScore=items.filter(i=>i.type==='save').length*20;const wantScore=items.filter(i=>i.type==='want').length*5;const spent=items.reduce((s,i)=>s+i.price,0);const leftover=budgetState.budget-spent;const totalScore=Math.min(100,needScore+saveScore+wantScore+(leftover>=10?10:0));const xpEarned=Math.round(totalScore/100*15);
  let msg,emoji;if(totalScore>=80){msg='Excelente! Voce sabe equilibrar muito bem!';emoji='';}else if(totalScore>=50){msg='Bom trabalho! Tente priorizar mais as necessidades.';emoji='';}else{msg='Muitos desejos! Lembre: necessidades primeiro!';emoji='';}
  const gc=document.getElementById('gameContainer');
  gc.innerHTML=`<button class="game-back" onclick="closeGame()"> Voltar</button><div style="text-align:center;padding:30px 20px;"><div style="font-size:4rem;margin-bottom:14px;">${emoji}</div><h2 style="font-size:1.5rem;font-weight:900;margin-bottom:8px;">Orcamento Completo!</h2><p style="font-size:1.2rem;font-weight:800;color:var(--gold);margin-bottom:6px;">Pontuacao: ${totalScore}/100</p><p style="font-size:.95rem;color:var(--text2);margin-bottom:16px;">${msg}</p><p style="color:var(--gold);font-weight:900;font-size:1.1rem;margin-bottom:20px;">+${xpEarned} XP</p><button class="btn btn-primary ripple" style="max-width:240px;margin:0 auto 10px;" onclick="startBudget()">Jogar Novamente </button><button class="btn btn-outline" style="max-width:240px;margin:0 auto;" onclick="closeGame()">Voltar aos Jogos</button></div>`;
  addXP(xpEarned,'Desafio do Orcamento!');incrementGamesPlayed();
}
function closeGame(){document.getElementById('gameOverlay').classList.add('hidden');}
function incrementGamesPlayed(){const ch=load('children')||{};const child=ch[currentChild.id];if(!child)return;child.gamesPlayed=(child.gamesPlayed||0)+1;ch[child.id]=child;save('children',ch);currentChild=child;}

// ============================================================
// LESSONS
// ============================================================
const LESSONS_DATA=[
  {id:'money',title:'O que e dinheiro?',emoji:'',desc:'Conceitos basicos sobre dinheiro',slides:[{emoji:'',title:'O que e Dinheiro?',text:'Dinheiro e algo que usamos para trocar por coisas que queremos ou precisamos. Antigamente, as pessoas trocavam coisas diretamente!'},{emoji:'',title:'De onde vem o Dinheiro?',text:'O dinheiro e criado pelo governo do pais. No Brasil, usamos o Real (R$). Cada pais tem sua moeda: EUA tem o Dolar ($), Europa tem o Euro.'},{emoji:'',title:'Tipos de Dinheiro',text:'Dinheiro pode ser fisico (notas e moedas) ou digital (no banco, no celular). Hoje em dia, a maior parte do dinheiro e digital!'},{emoji:'',title:'O Valor do Dinheiro',text:'Dinheiro tem valor porque todos concordam que ele vale algo. Por isso e importante cuidar bem dele!'}]},
  {id:'supply',title:'Comprar e Vender',emoji:'',desc:'Oferta e demanda',slides:[{emoji:'',title:'Oferta e Demanda',text:'Quando muita gente quer comprar algo (demanda alta) e tem pouco disponivel (oferta baixa), o preco SOBE. E a lei basica do mercado!'},{emoji:'',title:'Preco Subindo',text:'Imagine que so existem 10 ingressos para um show incrivel, mas 100 pessoas querem. O preco vai la para cima!'},{emoji:'',title:'Preco Caindo',text:'Agora imagine que tem 100 sorvetes, mas so 5 pessoas querem. O vendedor vai abaixar o preco para vender.'},{emoji:'',title:'Dica de Investidor',text:'Compre quando o preco esta baixo e venda quando esta alto. Essa e a base de todo investimento!'}]},
  {id:'saving',title:'O poder da poupanca',emoji:'',desc:'Aprendendo a poupar',slides:[{emoji:'',title:'Por que Poupar?',text:'Poupar dinheiro significa guardar uma parte do que voce ganha para usar no futuro. E como plantar uma semente que vai virar uma arvore!'},{emoji:'',title:'A Regra 50-30-20',text:'Gaste 50% com o que precisa, 30% com o que quer, e guarde 20%!'},{emoji:'',title:'O Poder do Tempo',text:'Quanto mais cedo voce comecar a poupar, mais dinheiro tera no futuro.'},{emoji:'',title:'Metas de Poupanca',text:'Defina uma meta! Calcule quanto custa e quanto precisa guardar por semana.'}]},
  {id:'investing',title:'O que sao investimentos?',emoji:'',desc:'Basico de investimentos',slides:[{emoji:'',title:'O que e Investir?',text:'Investir e colocar seu dinheiro em algo que pode crescer com o tempo. Em vez de deixar parado, voce faz ele trabalhar para voce!'},{emoji:'',title:'Tipos de Investimento',text:'Existem varios tipos: acoes, renda fixa, fundos, criptomoedas, e muito mais!'},{emoji:'',title:'Juros Compostos',text:'Quando voce investe, ganha juros. E esses juros tambem ganham juros! E como uma bola de neve.'},{emoji:'',title:'Comece Cedo!',text:'Quem comeca a investir jovem tem uma vantagem enorme. O tempo e o melhor amigo do investidor!'}]},
  {id:'risk',title:'Risco e Recompensa',emoji:'',desc:'Entendendo riscos',slides:[{emoji:'',title:'Risco vs Recompensa',text:'Todo investimento tem risco. Geralmente, quanto maior o risco, maior a chance de ganhar muito (ou perder muito).'},{emoji:'',title:'Baixo Risco',text:'Investimentos seguros (como poupanca e renda fixa) ganham pouco, mas voce quase nunca perde.'},{emoji:'',title:'Alto Risco',text:'Investimentos arriscados (como criptomoedas) podem ganhar muito, mas tambem perder bastante.'},{emoji:'',title:'Diversificar',text:'A melhor estrategia? Nao coloque todos os ovos na mesma cesta! Divida seu dinheiro.'}]},
  {id:'business',title:'Seu primeiro negocio',emoji:'',desc:'Empreendedorismo basico',slides:[{emoji:'',title:'Ser Empreendedor',text:'Um empreendedor e alguem que cria um negocio para resolver um problema. Voce pode ser um!'},{emoji:'',title:'Encontre uma Ideia',text:'Olhe ao redor: o que as pessoas precisam? Pode ser vender limonada, fazer pulseiras, ensinar algo...'},{emoji:'',title:'Planeje seu Negocio',text:'Pense: quanto vai custar? Por quanto vou vender? Quem vai comprar? Um bom plano e metade do caminho!'},{emoji:'',title:'Comece Pequeno',text:'Todo grande empresario comecou pequeno. O importante e comecar e aprender com os erros!'}]},
];
let lessonState={id:'',slide:0};
function renderLessons(){
  const el=document.getElementById('lessonsList');const completedLessons=load('lessons_'+(currentChild?.id||''))||{};
  el.innerHTML=LESSONS_DATA.map(l=>{const done=completedLessons[l.id];return `<div class="lesson-card ${done?'completed-lesson':''}" onclick="openLesson('${l.id}')"><span class="lesson-emoji">${l.emoji}</span><div class="lesson-info"><div class="lesson-name">${l.title}</div><div class="lesson-desc">${l.desc}</div></div><span class="lesson-badge">${done?'':''}</span></div>`;}).join('');
}
function openLesson(id){const lesson=LESSONS_DATA.find(l=>l.id===id);if(!lesson)return;lessonState={id,slide:0};document.getElementById('lessonOverlay').classList.remove('hidden');renderLessonSlide();}
function renderLessonSlide(){
  const lesson=LESSONS_DATA.find(l=>l.id===lessonState.id);if(!lesson)return;const slide=lesson.slides[lessonState.slide];const total=lesson.slides.length;const isLast=lessonState.slide===total-1;const lc=document.getElementById('lessonContainer');
  lc.innerHTML=`<button class="game-back" onclick="closeLesson()"> Voltar</button><div class="game-title-bar"><h2>${lesson.emoji} ${lesson.title}</h2><p>Pagina ${lessonState.slide+1} de ${total}</p></div><div class="lesson-dots">${lesson.slides.map((_,i)=>`<div class="lesson-dot ${i<=lessonState.slide?'active':''}"></div>`).join('')}</div><div class="lesson-slide"><div class="slide-emoji">${slide.emoji}</div><div class="slide-title">${slide.title}</div><div class="slide-text">${slide.text}</div></div><div style="display:flex;gap:10px;">${lessonState.slide>0?'<button class="btn btn-outline" style="flex:1;" onclick="prevSlide()"> Anterior</button>':''}<button class="btn btn-primary ripple" style="flex:1;" onclick="${isLast?'completeLesson()':'nextSlide()'}"> ${isLast?'Concluir ':'Proximo '}</button></div>`;
}
function nextSlide(){lessonState.slide++;renderLessonSlide();}
function prevSlide(){if(lessonState.slide>0){lessonState.slide--;renderLessonSlide();}}
function completeLesson(){
  const completedLessons=load('lessons_'+currentChild.id)||{};
  if(!completedLessons[lessonState.id]){completedLessons[lessonState.id]=true;save('lessons_'+currentChild.id,completedLessons);addXP(15,'Licao completa!');}
  closeLesson();renderLessons();
}
function closeLesson(){document.getElementById('lessonOverlay').classList.add('hidden');}

// ============================================================
// PROFILE TAB
// ============================================================
const ACHIEVEMENTS=[
  {id:'first_trade',icon:'',name:'Primeira Operacao',check:c=>{const txs=(load('transactions')||{})[c.id]||[];return txs.length>=1;}},
  {id:'ten_trades',icon:'',name:'10 Operacoes',check:c=>{const txs=(load('transactions')||{})[c.id]||[];return txs.length>=10;}},
  {id:'diversifier',icon:'',name:'Diversificado',check:c=>ASSETS.filter(a=>(c.assets?.[a.id]?.qty||0)>0).length>=3},
  {id:'saver',icon:'',name:'Poupador',check:c=>(c.totalYield||0)>=10},
  {id:'gamer',icon:'',name:'Jogador',check:c=>(c.gamesPlayed||0)>=3},
  {id:'learner',icon:'',name:'Estudioso',check:c=>{const l=load('lessons_'+c.id)||{};return Object.keys(l).length>=3;}},
  {id:'rich',icon:'',name:'Ricao',check:c=>calcTotal(c)>=200},
  {id:'level3',icon:'',name:'Nivel 3',check:c=>(c.xp||0)>=150},
  {id:'level5',icon:'',name:'Mestre',check:c=>(c.xp||0)>=500},
];
function updateProfileTab(){
  if(!currentChild)return;const child=currentChild;const tv=calcTotal(child);const txs=(load('transactions')||{})[child.id]||[];
  document.getElementById('profileAvatarIcon').textContent=getLevel(child.xp||0).emoji;
  document.getElementById('profPatrimony').textContent=fmt(tv);document.getElementById('profTrades').textContent=txs.length;
  document.getElementById('profDays').textContent=child.daysActive||0;document.getElementById('profGames').textContent=child.gamesPlayed||0;
  updateXPUI();
  const grid=document.getElementById('achievementGrid');
  grid.innerHTML=ACHIEVEMENTS.map(a=>{const earned=a.check(child);return `<div class="achievement-badge ${earned?'earned':''}"><span class="ab-icon">${earned?a.icon:''}</span><span class="ab-name">${a.name}</span></div>`;}).join('');
}

// ============================================================
// EMPRESAS / COMPANY SYSTEM
// ============================================================
const COMPANIES=[
  {id:'toyworld',name:'ToyWorld',icon:'',sector:'Brinquedos',basePrice:12,dividendRate:0.03,desc:'A maior loja de brinquedos do mundo! Vende bonecas, carrinhos, jogos de tabuleiro e muito mais.'},
  {id:'gamezone',name:'GameZone',icon:'',sector:'Tecnologia',basePrice:25,dividendRate:0.02,desc:'Empresa de tecnologia que cria video games e aplicativos incriveis.'},
  {id:'petlove',name:'PetLove',icon:'',sector:'Animais',basePrice:8,dividendRate:0.04,desc:'Cuida dos animais de estimacao! Vende racao, brinquedos para pets e servicos veterinarios.'},
  {id:'foodking',name:'FoodKing',icon:'',sector:'Alimentacao',basePrice:15,dividendRate:0.035,desc:'Rede de restaurantes famosa por seus hamburgueres deliciosos.'},
  {id:'bookstar',name:'BookStar',icon:'',sector:'Educacao',basePrice:10,dividendRate:0.05,desc:'Editora que publica livros educativos e historias infantis.'},
  {id:'sportmax',name:'SportMax',icon:'',sector:'Esportes',basePrice:20,dividendRate:0.025,desc:'Loja de artigos esportivos - bolas, tenis, roupas e equipamentos.'},
  {id:'musicbeat',name:'MusicBeat',icon:'',sector:'Entretenimento',basePrice:18,dividendRate:0.02,desc:'Plataforma de musica e shows! Produz concertos e festivais.'},
  {id:'ecogreen',name:'EcoGreen',icon:'',sector:'Sustentabilidade',basePrice:6,dividendRate:0.06,desc:'Empresa verde que planta arvores e cria produtos sustentaveis.'},
];
const SECTOR_ICONS={Comida:'',Brinquedos:'',Tecnologia:'',Roupas:'',Animais:'',Educacao:'',Esportes:'',Entretenimento:'',Sustentabilidade:'',Alimentacao:''};
const SECTOR_CLASSES={Brinquedos:'brinquedos',Tecnologia:'tecnologia',Animais:'animais',Alimentacao:'alimentacao',Educacao:'educacao',Esportes:'esportes',Entretenimento:'entretenimento',Sustentabilidade:'sustentabilidade',Comida:'comida',Roupas:'roupas'};
let companyPrices={},companyPH={},companyTrends={},companyPerformance={},dividendInterval=null,selectedCompanySize=null,companyModalQty=1,companyTickCount=0;
function initCompanyData(){
  companyPrices=load('companyPrices')||{};companyPH=load('companyPH')||{};companyPerformance=load('companyPerf')||{};
  COMPANIES.forEach(c=>{
    if(!companyPrices[c.id])companyPrices[c.id]=c.basePrice;
    if(!companyPH[c.id])companyPH[c.id]=[{p:c.basePrice,t:Date.now()}];
    if(!companyPerformance[c.id])companyPerformance[c.id]=Math.floor(Math.random()*3)+3;
    if(!companyTrends[c.id])companyTrends[c.id]={dir:Math.random()>0.4?1:-1,ticks:Math.floor(Math.random()*25)+10};
  });
  save('companyPrices',companyPrices);save('companyPH',companyPH);save('companyPerf',companyPerformance);
}
function ensureChildCompanyData(){
  if(!currentChild)return;const ch=load('children')||{};const child=ch[currentChild.id];if(!child)return;
  if(!child.companies){child.companies={ownedShares:{},myCompanies:[],dividendsEarned:0};ch[child.id]=child;save('children',ch);currentChild=child;}
}
function tickCompanyPrices(){
  companyTickCount++;
  COMPANIES.forEach(comp=>{
    const cur=companyPrices[comp.id]||comp.basePrice;const perf=companyPerformance[comp.id]||3;
    let td=companyTrends[comp.id];if(!td){td={dir:1,ticks:15};companyTrends[comp.id]=td;}
    td.ticks--;if(td.ticks<=0){td.dir=Math.random()>0.45?1:-1;td.ticks=Math.floor(Math.random()*25)+10;}
    const base=0.012;let v=Math.random()*(base*2)-base;v+=td.dir*(Math.random()*0.005+0.002);v+=((perf-3)*0.002);v-=((cur-comp.basePrice)/comp.basePrice)*0.015;
    let np=cur*(1+v);np=Math.max(comp.basePrice*0.3,Math.min(comp.basePrice*3,np));np=Math.round(np*100)/100;
    companyPrices[comp.id]=np;
    if(!companyPH[comp.id])companyPH[comp.id]=[];companyPH[comp.id].push({p:np,t:Date.now()});if(companyPH[comp.id].length>500)companyPH[comp.id]=companyPH[comp.id].slice(-500);
  });
  if(companyTickCount%40===0){COMPANIES.forEach(comp=>{if(Math.random()<0.3){let perf=companyPerformance[comp.id]||3;perf+=Math.random()>0.5?1:-1;perf=Math.max(1,Math.min(5,perf));companyPerformance[comp.id]=perf;}});save('companyPerf',companyPerformance);}
  save('companyPrices',companyPrices);save('companyPH',companyPH);
}
function getCompanyRevenue(comp){const price=companyPrices[comp.id]||comp.basePrice;return Math.round((price/comp.basePrice)*1000*(0.8+Math.random()*0.4));}
function getCompanyEmployees(comp){return Math.round(50+(companyPerformance[comp.id]||3)*20+Math.random()*30);}
function getCompanyRisk(comp){const ph=companyPH[comp.id]||[];if(ph.length<5)return'Medio';const recent=ph.slice(-10).map(x=>x.p);const avg=recent.reduce((a,b)=>a+b,0)/recent.length;const variance=recent.reduce((s,p)=>s+Math.pow(p-avg,2),0)/recent.length;const vol=Math.sqrt(variance)/avg;if(vol<0.02)return'Baixo';if(vol>0.05)return'Alto';return'Medio';}
function getCompanyRecommendation(comp){const price=companyPrices[comp.id]||comp.basePrice;const perf=companyPerformance[comp.id]||3;const ratio=price/comp.basePrice;if(ratio<0.85&&perf>=3)return'Comprar';if(ratio>1.3&&perf<=2)return'Vender';return'Manter';}
function getCompanyRevenueTrend(comp){const ph=companyPH[comp.id]||[];if(ph.length<5)return'Estavel';const r5=ph.slice(-5).map(x=>x.p);const o5=ph.slice(-10,-5).map(x=>x.p);if(!o5.length)return'Estavel';const rA=r5.reduce((a,b)=>a+b,0)/r5.length;const oA=o5.reduce((a,b)=>a+b,0)/o5.length;if(rA>oA*1.02)return'Subindo';if(rA<oA*0.98)return'Descendo';return'Estavel';}
function renderCompanyStars(perf){let s='';for(let i=1;i<=5;i++)s+=i<=perf?'':'';return s;}
function drawSparkline(canvasId,companyId){
  const canvas=document.getElementById(canvasId);if(!canvas)return;const ctx=canvas.getContext('2d');const ph=companyPH[companyId]||[];const data=ph.slice(-10).map(x=>x.p);if(data.length<2)return;
  canvas.width=canvas.parentElement.offsetWidth;canvas.height=30;const w=canvas.width,h=canvas.height;const min=Math.min(...data)*0.98,max=Math.max(...data)*1.02,range=max-min||1;const stepX=w/(data.length-1);const isUp=data[data.length-1]>=data[0];const color=isUp?'#22c55e':'#ef4444';
  ctx.beginPath();ctx.moveTo(0,h-((data[0]-min)/range)*h);for(let i=1;i<data.length;i++)ctx.lineTo(i*stepX,h-((data[i]-min)/range)*h);ctx.strokeStyle=color;ctx.lineWidth=1.5;ctx.lineJoin='round';ctx.lineCap='round';ctx.stroke();
  ctx.lineTo((data.length-1)*stepX,h);ctx.lineTo(0,h);ctx.closePath();const grad=ctx.createLinearGradient(0,0,0,h);grad.addColorStop(0,color+'40');grad.addColorStop(1,'transparent');ctx.fillStyle=grad;ctx.fill();
}
function renderEmpresasTab(){if(!currentChild)return;ensureChildCompanyData();initCompanyData();renderEmpresasPortfolio();renderMyCompanies();renderCompanyCards();}
function renderEmpresasPortfolio(){
  if(!currentChild||!currentChild.companies)return;const shares=currentChild.companies.ownedShares||{};let totalInvested=0,companiesCount=0,projectedPerMin=0;
  COMPANIES.forEach(comp=>{const qty=shares[comp.id]||0;if(qty>0){const price=companyPrices[comp.id]||comp.basePrice;totalInvested+=qty*price;companiesCount++;projectedPerMin+=qty*price*comp.dividendRate;}});
  const myComps=currentChild.companies.myCompanies||[];myComps.forEach(mc=>{totalInvested+=mc.investment;companiesCount++;projectedPerMin+=mc.incomeRate*20;});
  const divEarned=currentChild.companies.dividendsEarned||0;
  const e1=document.getElementById('epTotalInvested'),e2=document.getElementById('epDividendsEarned'),e3=document.getElementById('epCompaniesCount'),e4=document.getElementById('epProjectedIncome');
  if(e1)e1.textContent=fmt(totalInvested);if(e2)e2.textContent=fmt(divEarned);if(e3)e3.textContent=companiesCount;if(e4)e4.textContent=fmt(projectedPerMin);
}
function renderCompanyCards(){
  const grid=document.getElementById('companyGrid');if(!grid||!currentChild)return;ensureChildCompanyData();const shares=currentChild.companies?.ownedShares||{};
  grid.innerHTML=COMPANIES.map((comp,idx)=>{
    const price=companyPrices[comp.id]||comp.basePrice;const ph=companyPH[comp.id]||[];const prev=ph.length>=2?ph[ph.length-2].p:price;const diff=price-prev;const pctChange=prev>0?((diff/prev)*100).toFixed(1):'0.0';const isUp=diff>=0;const perf=companyPerformance[comp.id]||3;const owned=shares[comp.id]||0;const sectorClass=SECTOR_CLASSES[comp.sector]||'comida';const canvasId='sparkline_'+comp.id;
    return `<div class="company-card"><div class="company-card-header"><div class="company-card-icon">${comp.icon}</div><div class="company-card-info"><div class="company-card-name">${comp.name}</div><span class="company-card-sector sector-${sectorClass}">${comp.sector}</span></div><div class="company-dividend-badge"> ${(comp.dividendRate*100).toFixed(1)}%/min</div></div><div class="company-card-price-row"><span class="company-card-price ${isUp?'up':'down'}">${fmt(price)}</span><span class="company-card-change ${isUp?'up':'down'}">${isUp?'':''} ${isUp?'+':''}${pctChange}%</span></div><div class="company-sparkline"><canvas id="${canvasId}"></canvas></div><div style="display:flex;align-items:center;justify-content:space-between;"><span class="company-stars">${renderCompanyStars(perf)}</span>${owned>0?`<span class="company-owned-badge">${owned} acao${owned!==1?'es':''}</span>`:''}</div><div class="company-card-footer"><span style="font-size:.68rem;color:var(--text2);">Receita: R$ ${getCompanyRevenue(comp).toLocaleString()}</span><button class="company-invest-btn" onclick="openCompanyModal('${comp.id}')">INVESTIR</button></div></div>`;
  }).join('');
  setTimeout(()=>{COMPANIES.forEach(comp=>drawSparkline('sparkline_'+comp.id,comp.id));},50);
}
function openCompanyModal(compId){
  const comp=COMPANIES.find(c=>c.id===compId);if(!comp||!currentChild)return;ensureChildCompanyData();companyModalQty=1;
  const price=companyPrices[comp.id]||comp.basePrice;const perf=companyPerformance[comp.id]||3;const owned=currentChild.companies?.ownedShares?.[comp.id]||0;const risk=getCompanyRisk(comp);const recommendation=getCompanyRecommendation(comp);const revTrend=getCompanyRevenueTrend(comp);const revenue=getCompanyRevenue(comp);const employees=getCompanyEmployees(comp);const sectorClass=SECTOR_CLASSES[comp.sector]||'comida';const dividendIncome=owned>0?(owned*price*comp.dividendRate).toFixed(2):'0.00';const riskColor=risk==='Baixo'?'var(--green)':risk==='Alto'?'var(--red)':'var(--gold)';const recColor=recommendation==='Comprar'?'var(--green)':recommendation==='Vender'?'var(--red)':'var(--gold)';const trendIcon=revTrend==='Subindo'?'':revTrend==='Descendo'?'':'';
  const box=document.getElementById('companyModalBox');
  box.innerHTML=`<div class="company-modal-header"><span class="cm-icon">${comp.icon}</span><div class="cm-info"><div class="cm-name">${comp.name}</div><div class="cm-sector"><span class="company-card-sector sector-${sectorClass}" style="display:inline-block;">${comp.sector}</span></div></div><button class="company-modal-close" onclick="closeCompanyModal()"></button></div><div class="company-modal-desc">${comp.desc}</div><div class="company-modal-stats"><div class="company-modal-stat"><div class="cms-val" style="color:var(--gold)">${fmt(price)}</div><div class="cms-label">Preco/Acao</div></div><div class="company-modal-stat"><div class="cms-val" style="color:var(--green)">${renderCompanyStars(perf)}</div><div class="cms-label">Performance</div></div><div class="company-modal-stat"><div class="cms-val" style="color:var(--cyan)">${owned}</div><div class="cms-label">Suas Acoes</div></div></div><div class="company-modal-stats" style="margin-bottom:14px;"><div class="company-modal-stat"><div class="cms-val" style="font-size:.82rem;">R$ ${revenue.toLocaleString()}</div><div class="cms-label">Receita</div></div><div class="company-modal-stat"><div class="cms-val" style="font-size:.82rem;">${employees}</div><div class="cms-label">Funcionarios</div></div><div class="company-modal-stat"><div class="cms-val" style="font-size:.82rem;color:var(--gold)">${(comp.dividendRate*100).toFixed(1)}%</div><div class="cms-label">Dividendo/min</div></div></div><div class="company-report"><h5> Relatorio da Empresa</h5><div class="company-report-row"><span class="company-report-label">Tendencia</span><span class="company-report-value">${trendIcon} ${revTrend}</span></div><div class="company-report-row"><span class="company-report-label">Risco</span><span class="company-report-value" style="color:${riskColor}">${risk==='Baixo'?'':risk==='Alto'?'':''} ${risk}</span></div><div class="company-report-row"><span class="company-report-label">Recomendacao</span><span class="company-report-value" style="color:${recColor}">${recommendation==='Comprar'?'':recommendation==='Vender'?'':''} ${recommendation}</span></div>${owned>0?`<div class="company-report-row"><span class="company-report-label">Renda/min</span><span class="company-report-value" style="color:var(--green)">R$ ${dividendIncome}</span></div>`:''}</div><div class="company-trade-section"><h5>Comprar Acoes</h5><div class="company-qty-row"><button class="company-qty-btn" onclick="changeCompanyQty(-1,'${comp.id}')">-</button><span class="company-qty-val" id="companyQtyVal">${companyModalQty}</span><button class="company-qty-btn" onclick="changeCompanyQty(1,'${comp.id}')">+</button></div><div class="company-total-cost" id="companyTotalCost">Total: ${fmt(price*companyModalQty)}</div><div class="company-trade-btns"><button class="btn btn-primary ripple" onclick="buyCompanyShares('${comp.id}')" id="compBuyBtn">Comprar ${companyModalQty} Acao${companyModalQty!==1?'es':''}</button>${owned>0?`<button class="btn btn-outline ripple" onclick="sellCompanyShares('${comp.id}')" style="border-color:rgba(239,68,68,0.3);color:var(--red);">Vender</button>`:''}</div></div>`;
  document.getElementById('companyModalOverlay').classList.remove('hidden');
}
function closeCompanyModal(){document.getElementById('companyModalOverlay').classList.add('hidden');}
function changeCompanyQty(delta,compId){
  companyModalQty=Math.max(1,companyModalQty+delta);const comp=COMPANIES.find(c=>c.id===compId);if(!comp)return;const price=companyPrices[comp.id]||comp.basePrice;
  const qtyEl=document.getElementById('companyQtyVal'),costEl=document.getElementById('companyTotalCost'),buyBtn=document.getElementById('compBuyBtn');
  if(qtyEl)qtyEl.textContent=companyModalQty;if(costEl)costEl.textContent='Total: '+fmt(price*companyModalQty);if(buyBtn)buyBtn.textContent=`Comprar ${companyModalQty} Acao${companyModalQty!==1?'es':''}`;
}
function buyCompanyShares(compId){
  const comp=COMPANIES.find(c=>c.id===compId);if(!comp||!currentChild)return;ensureChildCompanyData();const price=companyPrices[comp.id]||comp.basePrice;const totalCost=price*companyModalQty;
  if(currentChild.balance<totalCost){showToast('Saldo insuficiente!','error');return;}
  const ch=load('children')||{};const child=ch[currentChild.id];if(!child)return;if(!child.companies)child.companies={ownedShares:{},myCompanies:[],dividendsEarned:0};
  child.balance=Math.round((child.balance-totalCost)*100)/100;child.companies.ownedShares[comp.id]=(child.companies.ownedShares[comp.id]||0)+companyModalQty;
  ch[child.id]=child;save('children',ch);currentChild=child;showToast(`Comprou ${companyModalQty} acao${companyModalQty!==1?'es':''} de ${comp.icon} ${comp.name}!`,'success');addXP(8,'Investimento em empresa!');closeCompanyModal();renderEmpresasTab();const balEl=document.getElementById('cBalance');if(balEl)balEl.textContent=fmt(child.balance);
}
function sellCompanyShares(compId){
  const comp=COMPANIES.find(c=>c.id===compId);if(!comp||!currentChild)return;ensureChildCompanyData();const owned=currentChild.companies?.ownedShares?.[comp.id]||0;if(owned<=0){showToast('Voce nao tem acoes desta empresa!','error');return;}
  const sellQty=Math.min(companyModalQty,owned);const price=companyPrices[comp.id]||comp.basePrice;const totalValue=price*sellQty;
  const ch=load('children')||{};const child=ch[currentChild.id];if(!child||!child.companies)return;
  child.balance=Math.round((child.balance+totalValue)*100)/100;child.companies.ownedShares[comp.id]=owned-sellQty;if(child.companies.ownedShares[comp.id]<=0)delete child.companies.ownedShares[comp.id];
  ch[child.id]=child;save('children',ch);currentChild=child;showToast(`Vendeu ${sellQty} acao${sellQty!==1?'es':''} de ${comp.icon} ${comp.name} por ${fmt(totalValue)}!`,'success');closeCompanyModal();renderEmpresasTab();const balEl=document.getElementById('cBalance');if(balEl)balEl.textContent=fmt(child.balance);
}
function selectCompanySize(size){
  selectedCompanySize=size;['small','medium','large'].forEach(s=>{const el=document.getElementById('compSize'+s.charAt(0).toUpperCase()+s.slice(1));if(el)el.classList.toggle('selected',s===size);});
}
function createMyCompany(){
  if(!currentChild)return;ensureChildCompanyData();const name=document.getElementById('myCompanyName').value.trim();const sector=document.getElementById('myCompanySector').value;
  if(!name){showToast('Digite o nome da empresa!','error');return;}if(!selectedCompanySize){showToast('Escolha o tamanho!','error');return;}
  const sizeMap={small:{investment:20,incomeRate:0.05},medium:{investment:50,incomeRate:0.15},large:{investment:100,incomeRate:0.40}};const sizeData=sizeMap[selectedCompanySize];
  if(currentChild.balance<sizeData.investment){showToast('Saldo insuficiente!','error');return;}
  const ch=load('children')||{};const child=ch[currentChild.id];if(!child)return;if(!child.companies)child.companies={ownedShares:{},myCompanies:[],dividendsEarned:0};
  child.balance=Math.round((child.balance-sizeData.investment)*100)/100;const sectorIcon=SECTOR_ICONS[sector]||'';
  child.companies.myCompanies.push({id:'mc_'+Date.now(),name,sector,icon:sectorIcon,investment:sizeData.investment,incomeRate:sizeData.incomeRate,size:selectedCompanySize,totalRevenue:0,totalProfit:0,createdAt:Date.now(),level:1});
  ch[child.id]=child;save('children',ch);currentChild=child;
  document.getElementById('myCompanyName').value='';selectedCompanySize=null;['small','medium','large'].forEach(s=>{const el=document.getElementById('compSize'+s.charAt(0).toUpperCase()+s.slice(1));if(el)el.classList.remove('selected');});
  showToast(`Empresa "${name}" criada!`,'success');addXP(25,'Empresa criada!');renderEmpresasTab();const balEl=document.getElementById('cBalance');if(balEl)balEl.textContent=fmt(child.balance);
}
function renderMyCompanies(){
  if(!currentChild||!currentChild.companies)return;const list=document.getElementById('myCompaniesList');if(!list)return;const myComps=currentChild.companies.myCompanies||[];
  if(!myComps.length){list.innerHTML='<p style="color:var(--text2);text-align:center;font-size:.82rem;padding:12px;">Voce ainda nao criou nenhuma empresa.</p>';return;}
  const sizeLabels={small:'Pequena',medium:'Media',large:'Grande'};
  list.innerHTML=myComps.map(mc=>{const upgradeCost=mc.size==='small'?30:mc.size==='medium'?80:0;const canUpgrade=mc.size!=='large'&&currentChild.balance>=upgradeCost;return `<div class="my-company-card"><span class="mc-icon">${mc.icon}</span><div class="mc-info"><div class="mc-name">${mc.name}</div><div class="mc-sector">${mc.sector} | ${sizeLabels[mc.size]||mc.size} | Nv.${mc.level}</div><div class="mc-stats"><span class="mc-stat"> Receita: ${fmt(mc.totalRevenue)}</span><span class="mc-stat"> Lucro: ${fmt(mc.totalProfit)}</span></div></div>${mc.size!=='large'?`<button class="mc-upgrade" onclick="upgradeMyCompany('${mc.id}')" ${!canUpgrade?'disabled style="opacity:0.4;cursor:not-allowed;"':''}> Upgrade<br><span style="font-size:.6rem;">${fmt(upgradeCost)}</span></button>`:'<span style="font-size:.65rem;color:var(--gold);font-weight:800;">MAX</span>'}</div>`;}).join('');
}
function upgradeMyCompany(mcId){
  if(!currentChild||!currentChild.companies)return;const ch=load('children')||{};const child=ch[currentChild.id];if(!child||!child.companies)return;const mc=child.companies.myCompanies.find(c=>c.id===mcId);if(!mc)return;
  let upgradeCost,newSize,newRate;if(mc.size==='small'){upgradeCost=30;newSize='medium';newRate=0.15;}else if(mc.size==='medium'){upgradeCost=80;newSize='large';newRate=0.40;}else{showToast('Empresa ja esta no nivel maximo!','error');return;}
  if(child.balance<upgradeCost){showToast('Saldo insuficiente para upgrade!','error');return;}
  child.balance=Math.round((child.balance-upgradeCost)*100)/100;mc.size=newSize;mc.incomeRate=newRate;mc.investment+=upgradeCost;mc.level++;
  ch[child.id]=child;save('children',ch);currentChild=child;showToast(`${mc.name} atualizada!`,'success');renderEmpresasTab();const balEl=document.getElementById('cBalance');if(balEl)balEl.textContent=fmt(child.balance);
}
function startDividendInterval(){if(dividendInterval)clearInterval(dividendInterval);dividendInterval=setInterval(payDividends,30000);}
function stopDividendInterval(){if(dividendInterval)clearInterval(dividendInterval);dividendInterval=null;}
function payDividends(){
  if(!currentChild)return;const ch=load('children')||{};const child=ch[currentChild.id];if(!child||!child.is_active||!child.companies)return;
  const shares=child.companies.ownedShares||{};let totalDividend=0;let dividendSources=[];
  COMPANIES.forEach(comp=>{const qty=shares[comp.id];if(!qty||qty<=0)return;const price=companyPrices[comp.id]||comp.basePrice;const dividend=Math.round(qty*price*comp.dividendRate/2*100)/100;if(dividend>0){totalDividend+=dividend;dividendSources.push({name:comp.name,icon:comp.icon,amount:dividend});}});
  const myComps=child.companies.myCompanies||[];myComps.forEach(mc=>{const earning=Math.round(mc.incomeRate*10*100)/100;if(earning>0){mc.totalRevenue=Math.round((mc.totalRevenue+earning)*100)/100;mc.totalProfit=Math.round((mc.totalProfit+earning)*100)/100;totalDividend+=earning;}});
  if(totalDividend>0){
    child.balance=Math.round((child.balance+totalDividend)*100)/100;child.companies.dividendsEarned=Math.round(((child.companies.dividendsEarned||0)+totalDividend)*100)/100;
    ch[child.id]=child;save('children',ch);currentChild=child;
    if(dividendSources.length>0){dividendSources.sort((a,b)=>b.amount-a.amount);const top=dividendSources[0];const othersCount=dividendSources.length-1+myComps.filter(mc=>mc.incomeRate>0).length;showToast(`Dividendo: +${fmt(totalDividend)} de ${top.icon}${top.name}${othersCount>0?` e +${othersCount}`:''}`, 'success');}else if(myComps.length>0){showToast(`Renda das empresas: +${fmt(totalDividend)}`,'success');}
    if(!load('firstDividendXP_'+child.id)){save('firstDividendXP_'+child.id,true);setTimeout(()=>addXP(15,'Primeiro dividendo recebido!'),500);}
    const balEl=document.getElementById('cBalance');if(balEl)balEl.textContent=fmt(child.balance);
    if(currentChildTab==='Empresas'){renderEmpresasPortfolio();renderMyCompanies();}
  }
}

// ============================================================
// LANGUAGE SYSTEM
// ============================================================
const LANGS=[
  {code:'pt',flag:'',name:'Portugues'},
  {code:'en',flag:'',name:'English'},
  {code:'es',flag:'',name:'Espaol'},
  {code:'fr',flag:'',name:'Franais'},
  {code:'de',flag:'',name:'Deutsch'},
  {code:'it',flag:'',name:'Italiano'},
  {code:'ja',flag:'',name:''},
  {code:'ko',flag:'',name:''},
  {code:'zh',flag:'',name:''},
  {code:'ru',flag:'',name:''},
  {code:'ar',flag:'',name:''},
  {code:'hi',flag:'',name:''},
  {code:'tr',flag:'',name:'Trke'},
  {code:'nl',flag:'',name:'Nederlands'},
  {code:'pl',flag:'',name:'Polski'},
  {code:'sv',flag:'',name:'Svenska'},
  {code:'no',flag:'',name:'Norsk'},
  {code:'da',flag:'',name:'Dansk'},
  {code:'fi',flag:'',name:'Suomi'},
  {code:'el',flag:'',name:''},
  {code:'cs',flag:'',name:'etina'},
  {code:'ro',flag:'',name:'Romn'},
  {code:'hu',flag:'',name:'Magyar'},
  {code:'th',flag:'',name:''},
  {code:'vi',flag:'',name:'Ting Vit'},
  {code:'id',flag:'',name:'Bahasa Indonesia'},
  {code:'ms',flag:'',name:'Bahasa Melayu'},
  {code:'tl',flag:'',name:'Filipino'},
  {code:'uk',flag:'',name:''},
  {code:'he',flag:'',name:''},
  {code:'af',flag:'',name:'Afrikaans'},
  {code:'pt_pt',flag:'',name:'Portugus (PT)'},
  {code:'ga',flag:'',name:'Gaeilge'},
  {code:'bn',flag:'',name:''},
  {code:'ur',flag:'',name:''},
];

let currentLang='pt';

const TRANSLATIONS={
  app_subtitle:{pt:'Aprenda a investir brincando!',en:'Learn to invest while playing!',es:'Aprende a invertir jugando!',fr:'Apprends  investir en jouant!',de:'Lerne investieren beim Spielen!',it:'Impara a investire giocando!',ja:'',ko:'  !',zh:'',ru:'  !',ar:'  !',hi:'   !',tr:'Oynayarak yatrm ren!',nl:'Leer investeren door te spelen!',pl:'Ucz si inwestowa bawic si!',sv:'Lr dig investera medan du spelar!',no:'Lr  investere mens du spiller!',da:'Lr at investere mens du spiller!',fi:'Opi sijoittamaan leikkien!',el:'   !',cs:'U se investovat pi hran!',ro:'nva s investeti jucndu-te!',hu:'Tanulj befektetni jtszva!',th:'!',vi:'Hc u t khi chi!',id:'Belajar investasi sambil bermain!',ms:'Belajar melabur sambil bermain!',tl:'Matuto mag-invest habang naglalaro!',uk:'  !',he:'    !',af:'Leer belegging terwyl jy speel!',pt_pt:'Aprende a investir a brincar!',ga:'Foghlaim infheistocht ag imirt!',bn:'   !',ur:'    !'},
  change_lang:{pt:'Mudar Idioma',en:'Change Language',es:'Cambiar Idioma',fr:'Changer la Langue',de:'Sprache ndern',it:'Cambia Lingua',ja:'',ko:' ',zh:'',ru:' ',ar:' ',hi:' ',tr:'Dili Deitir',nl:'Taal wijzigen',pl:'Zmie jzyk',sv:'Byta sprk',no:'Bytt sprk',da:'Skift sprog',fi:'Vaihda kieli',el:' ',cs:'Zmnit jazyk',ro:'Schimb limba',hu:'Nyelv vltsa',th:'',vi:'i ngn ng',id:'Ganti Bahasa',ms:'Tukar Bahasa',tl:'Baguhin ang Wika',uk:' ',he:' ',af:'Verander Taal',pt_pt:'Mudar Idioma',ga:'Athraigh Teanga',bn:' ',ur:'  '},
  login_title:{pt:'Entrar',en:'Log In',es:'Entrar',fr:'Connexion',de:'Anmelden',it:'Accedi',ja:'',ko:'',zh:'',ru:'',ar:' ',hi:' ',tr:'Giri Yap',nl:'Inloggen',pl:'Zaloguj',sv:'Logga in',no:'Logg inn',da:'Log ind',fi:'Kirjaudu',el:'',cs:'Pihlsit',ro:'Conectare',hu:'Belps',th:'',vi:'ng nhp',id:'Masuk',ms:'Log Masuk',tl:'Mag-login',uk:'',he:'',af:'Teken in',pt_pt:'Entrar',ga:'Log isteach',bn:' ',ur:'  '},
  register_title:{pt:'Criar Conta',en:'Create Account',es:'Crear Cuenta',fr:'Crer un compte',de:'Konto erstellen',it:'Crea Account',ja:'',ko:' ',zh:'',ru:' ',ar:' ',hi:' ',tr:'Hesap Olutur',nl:'Account aanmaken',pl:'Utwrz konto',sv:'Skapa konto',no:'Opprett konto',da:'Opret konto',fi:'Luo tili',el:' ',cs:'Vytvoit et',ro:'Creare cont',hu:'Fik ltrehozsa',th:'',vi:'To ti khon',id:'Buat Akun',ms:'Buat Akaun',tl:'Gumawa ng Account',uk:' ',he:' ',af:'Skep rekening',pt_pt:'Criar Conta',ga:'Cruthaigh Cuntas',bn:'  ',ur:' '},
  email:{pt:'Email',en:'Email',es:'Email',fr:'Email',de:'E-Mail',it:'Email',ja:'',ko:'',zh:'',ru:'',ar:'',hi:'',tr:'E-posta',nl:'E-mail',pl:'E-mail',sv:'E-post',no:'E-post',da:'E-mail',fi:'Shkposti',el:'Email',cs:'E-mail',ro:'Email',hu:'Email',th:'',vi:'Email',id:'Email',ms:'E-mel',tl:'Email',uk:'',he:'',af:'E-pos',pt_pt:'Email',ga:'Romhphost',bn:'',ur:' '},
  password:{pt:'Senha',en:'Password',es:'Contrasea',fr:'Mot de passe',de:'Passwort',it:'Password',ja:'',ko:'',zh:'',ru:'',ar:' ',hi:'',tr:'ifre',nl:'Wachtwoord',pl:'Haso',sv:'Lsenord',no:'Passord',da:'Adgangskode',fi:'Salasana',el:'',cs:'Heslo',ro:'Parol',hu:'Jelsz',th:'',vi:'Mt khu',id:'Kata Sandi',ms:'Kata Laluan',tl:'Password',uk:'',he:'',af:'Wagwoord',pt_pt:'Senha',ga:'Pasfhocal',bn:'',ur:' '},
  your_name:{pt:'Seu Nome',en:'Your Name',es:'Tu Nombre',fr:'Ton Prnom',de:'Dein Name',it:'Il tuo Nome',ja:'',ko:'',zh:'',ru:' ',ar:'',hi:' ',tr:'Adn',nl:'Jouw naam',pl:'Twoje imi',sv:'Ditt namn',no:'Ditt navn',da:'Dit navn',fi:'Sinun nimesi',el:'  ',cs:'Tvoje jmno',ro:'Numele tu',hu:'A neved',th:'',vi:'Tn ca bn',id:'Nama Kamu',ms:'Nama Kamu',tl:'Ang iyong Pangalan',uk:' \'',he:' ',af:'Jou naam',pt_pt:'O teu Nome',ga:'D\'ainm',bn:' ',ur:' '},
  login_btn:{pt:'Entrar',en:'Log In',es:'Entrar',fr:'Entrer',de:'Einloggen',it:'Entra',ja:'',ko:'',zh:'',ru:'',ar:'',hi:'',tr:'Gir',nl:'Inloggen',pl:'Wejd',sv:'G in',no:'G inn',da:'G ind',fi:'Kirjaudu',el:'',cs:'Pihlsit',ro:'Intr',hu:'Belp',th:'',vi:'Vo',id:'Masuk',ms:'Masuk',tl:'Pumasok',uk:'',he:'',af:'Gaan in',pt_pt:'Entrar',ga:'Isteach',bn:' ',ur:' '},
  register_btn:{pt:'Criar Conta',en:'Create Account',es:'Crear Cuenta',fr:'Crer',de:'Erstellen',it:'Crea',ja:'',ko:'',zh:'',ru:'',ar:'',hi:'',tr:'Olutur',nl:'Aanmaken',pl:'Utwrz',sv:'Skapa',no:'Opprett',da:'Opret',fi:'Luo',el:'',cs:'Vytvoit',ro:'Creare',hu:'Ltrehozs',th:'',vi:'To',id:'Buat',ms:'Buat',tl:'Gumawa',uk:'',he:'',af:'Skep',pt_pt:'Criar',ga:'Cruthaigh',bn:'',ur:''},
  parent_btn:{pt:'Sou Pai/Mae',en:'I am a Parent',es:'Soy Padre/Madre',fr:'Je suis parent',de:'Ich bin Elternteil',it:'Sono Genitore',ja:'',ko:'',zh:'',ru:' ',ar:' /',hi:' - ',tr:'Ebeveynm',nl:'Ik ben een Ouder',pl:'Jestem Rodzicem',sv:'Jag r Frlder',no:'Jeg er Forelder',da:'Jeg er Forlder',fi:'Olen Vanhempi',el:' ',cs:'Jsem Rodi',ro:'Sunt Printe',hu:'Szl vagyok',th:'',vi:'Ti l Ph huynh',id:'Saya Orang Tua',ms:'Saya Ibu Bapa',tl:'Magulang ako',uk:' /',he:' ',af:'Ek is \'n Ouer',pt_pt:'Sou Pai/Me',ga:'Is Tuismitheoir m',bn:' ',ur:'  '},
  child_btn:{pt:'Sou Crianca',en:'I am a Kid',es:'Soy Nio/a',fr:'Je suis Enfant',de:'Ich bin ein Kind',it:'Sono un Bambino',ja:'',ko:' ',zh:'',ru:' ',ar:' ',hi:'  ',tr:'Ben ocuum',nl:'Ik ben een Kind',pl:'Jestem Dzieckiem',sv:'Jag r ett Barn',no:'Jeg er et Barn',da:'Jeg er et Barn',fi:'Olen Lapsi',el:' ',cs:'Jsem Dt',ro:'Sunt Copil',hu:'Gyerek vagyok',th:'',vi:'Ti l Tr em',id:'Saya Anak-anak',ms:'Saya Kanak-kanak',tl:'Bata ako',uk:' ',he:' ',af:'Ek is \'n Kind',pt_pt:'Sou Criana',ga:'Is Leanbh m',bn:' ',ur:'  '},
  market:{pt:'Mercado',en:'Market',es:'Mercado',fr:'March',de:'Markt',it:'Mercato',ja:'',ko:'',zh:'',ru:'',ar:'',hi:'',tr:'Pazar',nl:'Markt',pl:'Rynek',sv:'Marknad',no:'Marked',da:'Marked',fi:'Markkinat',el:'',cs:'Trh',ro:'Pia',hu:'Piac',th:'',vi:'Th trng',id:'Pasar',ms:'Pasaran',tl:'Merkado',uk:'',he:'',af:'Mark',pt_pt:'Mercado',ga:'Margadh',bn:'',ur:''},
  analysis:{pt:'Analise',en:'Analysis',es:'Anlisis',fr:'Analyse',de:'Analyse',it:'Analisi',ja:'',ko:'',zh:'',ru:'',ar:'',hi:'',tr:'Analiz',nl:'Analyse',pl:'Analiza',sv:'Analys',no:'Analyse',da:'Analyse',fi:'Analyysi',el:'',cs:'Analza',ro:'Analiz',hu:'Elemzs',th:'',vi:'Phn tch',id:'Analisis',ms:'Analisis',tl:'Pagsusuri',uk:'',he:'',af:'Analise',pt_pt:'Anlise',ga:'Anails',bn:'',ur:''},
  companies:{pt:'Empresas',en:'Companies',es:'Empresas',fr:'Entreprises',de:'Firmen',it:'Aziende',ja:'',ko:'',zh:'',ru:'',ar:'',hi:'',tr:'irketler',nl:'Bedrijven',pl:'Firmy',sv:'Fretag',no:'Selskaper',da:'Virksomheder',fi:'Yritykset',el:'',cs:'Firmy',ro:'Companii',hu:'Cgek',th:'',vi:'Cng ty',id:'Perusahaan',ms:'Syarikat',tl:'Mga Kumpanya',uk:'',he:'',af:'Maatskappye',pt_pt:'Empresas',ga:'Cuideachta',bn:'',ur:''},
  games:{pt:'Jogos',en:'Games',es:'Juegos',fr:'Jeux',de:'Spiele',it:'Giochi',ja:'',ko:'',zh:'',ru:'',ar:'',hi:'',tr:'Oyunlar',nl:'Spellen',pl:'Gry',sv:'Spel',no:'Spill',da:'Spil',fi:'Pelit',el:'',cs:'Hry',ro:'Jocuri',hu:'Jtkok',th:'',vi:'Tr chi',id:'Permainan',ms:'Permainan',tl:'Mga Laro',uk:'',he:'',af:'Speletjies',pt_pt:'Jogos',ga:'Cluich',bn:'',ur:''},
  profile:{pt:'Perfil',en:'Profile',es:'Perfil',fr:'Profil',de:'Profil',it:'Profilo',ja:'',ko:'',zh:'',ru:'',ar:'',hi:'',tr:'Profil',nl:'Profiel',pl:'Profil',sv:'Profil',no:'Profil',da:'Profil',fi:'Profiili',el:'',cs:'Profil',ro:'Profil',hu:'Profil',th:'',vi:'H s',id:'Profil',ms:'Profil',tl:'Profil',uk:'',he:'',af:'Profiel',pt_pt:'Perfil',ga:'Prifl',bn:'',ur:''},
  logout:{pt:'Sair',en:'Log Out',es:'Salir',fr:'Dconnexion',de:'Abmelden',it:'Esci',ja:'',ko:'',zh:'',ru:'',ar:' ',hi:' ',tr:'k',nl:'Uitloggen',pl:'Wyloguj',sv:'Logga ut',no:'Logg ut',da:'Log ud',fi:'Kirjaudu ulos',el:'',cs:'Odhlsit',ro:'Deconectare',hu:'Kijelentkezs',th:'',vi:'ng xut',id:'Keluar',ms:'Log Keluar',tl:'Mag-logout',uk:'',he:'',af:'Teken uit',pt_pt:'Sair',ga:'Logil amach',bn:' ',ur:' '},
  back:{pt:'Voltar',en:'Back',es:'Volver',fr:'Retour',de:'Zurck',it:'Indietro',ja:'',ko:'',zh:'',ru:'',ar:'',hi:'',tr:'Geri',nl:'Terug',pl:'Wr',sv:'Tillbaka',no:'Tilbake',da:'Tilbage',fi:'Takaisin',el:'',cs:'Zpt',ro:'napoi',hu:'Vissza',th:'',vi:'Quay li',id:'Kembali',ms:'Kembali',tl:'Bumalik',uk:'',he:'',af:'Terug',pt_pt:'Voltar',ga:'Ar ais',bn:' ',ur:''},
  buy:{pt:'Comprar',en:'Buy',es:'Comprar',fr:'Acheter',de:'Kaufen',it:'Comprare',ja:'',ko:'',zh:'',ru:'',ar:'',hi:'',tr:'Satn Al',nl:'Kopen',pl:'Kup',sv:'Kp',no:'Kjp',da:'Kb',fi:'Osta',el:'',cs:'Koupit',ro:'Cumpr',hu:'Vsrls',th:'',vi:'Mua',id:'Beli',ms:'Beli',tl:'Bilhin',uk:'',he:'',af:'Koop',pt_pt:'Comprar',ga:'Ceannaigh',bn:'',ur:''},
  sell:{pt:'Vender',en:'Sell',es:'Vender',fr:'Vendre',de:'Verkaufen',it:'Vendere',ja:'',ko:'',zh:'',ru:'',ar:'',hi:'',tr:'Sat',nl:'Verkopen',pl:'Sprzedaj',sv:'Slj',no:'Selg',da:'Slg',fi:'Myy',el:'',cs:'Prodat',ro:'Vinde',hu:'Elads',th:'',vi:'Bn',id:'Jual',ms:'Jual',tl:'Ibenta',uk:'',he:'',af:'Verkoop',pt_pt:'Vender',ga:'Dol',bn:'',ur:''},
  cancel:{pt:'Cancelar',en:'Cancel',es:'Cancelar',fr:'Annuler',de:'Abbrechen',it:'Annulla',ja:'',ko:'',zh:'',ru:'',ar:'',hi:' ',tr:'ptal',nl:'Annuleren',pl:'Anuluj',sv:'Avbryt',no:'Avbryt',da:'Annuller',fi:'Peruuta',el:'',cs:'Zruit',ro:'Anuleaz',hu:'Mgse',th:'',vi:'Hy',id:'Batal',ms:'Batal',tl:'Kanselahin',uk:'',he:'',af:'Kanselleer',pt_pt:'Cancelar',ga:'Cealaigh',bn:'',ur:' '},
  confirm:{pt:'Confirmar',en:'Confirm',es:'Confirmar',fr:'Confirmer',de:'Besttigen',it:'Conferma',ja:'',ko:'',zh:'',ru:'',ar:'',hi:' ',tr:'Onayla',nl:'Bevestigen',pl:'Potwierd',sv:'Bekrfta',no:'Bekreft',da:'Bekrft',fi:'Vahvista',el:'',cs:'Potvrdit',ro:'Confirm',hu:'Megersts',th:'',vi:'Xc nhn',id:'Konfirmasi',ms:'Sahkan',tl:'Kumpirmahin',uk:'',he:'',af:'Bevestig',pt_pt:'Confirmar',ga:'Deimhnigh',bn:' ',ur:' '},
};

function t(key){
  const tr=TRANSLATIONS[key];
  if(!tr) return key;
  return tr[currentLang]||tr['en']||tr['pt']||key;
}

function selectLang(code){
  currentLang=code;
  localStorage.setItem('fc4_lang',code);
  applyTranslations();
  showScreen('login');
}

function renderLangScreen(){
  const grid=document.getElementById('langGrid');
  if(!grid) return;
  grid.innerHTML=LANGS.map(l=>`<button class="lang-btn" onclick="selectLang('${l.code}')"><span class="lang-flag">${l.flag}</span>${l.name}</button>`).join('');
}

function applyTranslations(){
  // Tab switch buttons
  const tabBtns=document.querySelectorAll('.tab-btn');
  if(tabBtns[0]) tabBtns[0].textContent=t('login_title');
  if(tabBtns[1]) tabBtns[1].textContent=t('register_title');
  // Login form labels
  const lbl_email=document.getElementById('lbl_email');
  const lbl_password=document.getElementById('lbl_password');
  const lbl_yourname=document.getElementById('lbl_yourname');
  const lbl_email2=document.getElementById('lbl_email2');
  const lbl_password2=document.getElementById('lbl_password2');
  if(lbl_email) lbl_email.textContent=t('email');
  if(lbl_password) lbl_password.textContent=t('password');
  if(lbl_yourname) lbl_yourname.textContent=t('your_name');
  if(lbl_email2) lbl_email2.textContent=t('email');
  if(lbl_password2) lbl_password2.textContent=t('password');
  const btn_login=document.getElementById('btn_login');
  const btn_register=document.getElementById('btn_register');
  const btn_parent=document.getElementById('btn_parent');
  const btn_child=document.getElementById('btn_child');
  if(btn_login) btn_login.textContent=t('login_btn');
  if(btn_register) btn_register.textContent=t('register_btn');
  if(btn_parent) btn_parent.textContent=t('parent_btn');
  if(btn_child) btn_child.textContent=t('child_btn');
  // Login subtitle
  const sub=document.querySelector('#loginScreen .login-subtitle');
  if(sub) sub.textContent=t('app_subtitle');
  // Lang change buttons text
  const loginLangBtn=document.getElementById('loginLangBtnText');
  const profileLangBtn=document.getElementById('profileLangBtnText');
  if(loginLangBtn) loginLangBtn.textContent=t('change_lang');
  if(profileLangBtn) profileLangBtn.textContent=t('change_lang');
  // Bottom nav
  const navLabels=[
    {id:'navMercado', key:'market'},
    {id:'navAnalise', key:'analysis'},
    {id:'navEmpresas', key:'companies'},
    {id:'navJogos', key:'games'},
    {id:'navPerfil', key:'profile'},
  ];
  navLabels.forEach(n=>{
    const el=document.getElementById(n.id);
    if(el){const lbl=el.querySelector('.nav-label');if(lbl)lbl.textContent=t(n.key);}
  });
}

// ============ DATA MIGRATION ============
function migrateData(){
  const v3Parents=localStorage.getItem('fc3_parents'),v4Parents=localStorage.getItem('fc4_parents');
  if(v3Parents&&!v4Parents){for(let i=0;i<localStorage.length;i++){const key=localStorage.key(i);if(key&&key.startsWith('fc3_')){const newKey='fc4_'+key.substring(4);if(!localStorage.getItem(newKey))localStorage.setItem(newKey,localStorage.getItem(key));}}
  const ch=load('children')||{};Object.values(ch).forEach(c=>{if(c.xp===undefined)c.xp=0;if(c.daysActive===undefined)c.daysActive=0;if(c.gamesPlayed===undefined)c.gamesPlayed=0;if(c.lastLogin===undefined)c.lastLogin='';if(!c.savings)c.savings={balance:0,totalInterest:0,lastUpdate:Date.now()};if(!c.shorts)c.shorts={};if(c.realizedGains===undefined)c.realizedGains=0;ch[c.id]=c;});save('children',ch);}
}

migrateData();
init();
</script>
</body>
</html>
