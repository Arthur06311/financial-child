<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Child - Aprenda a Investir Brincando!</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--green:#22c55e;--green-glow:#4ade80;--red:#ef4444;--red-glow:#f87171;--blue:#3b82f6;--purple:#8b5cf6;--gold:#f59e0b;--orange:#f97316;--cyan:#06b6d4;--pink:#ec4899;--dark:#0a0e1a;--dark2:#131a2e;--dark3:#1c2540;--dark4:#263354;--text:#f1f5f9;--text2:#7a8ba8;--card:#131a2e;--card-border:#1f2d47}
    body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--dark);color:var(--text);min-height:100vh;overflow-x:hidden}

    /* LOGIN */
    .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#0a0e1a 0%,#111827 50%,#0f172a 100%)}
    .login-logo{font-size:2.8rem;font-weight:800;margin-bottom:6px;background:linear-gradient(135deg,var(--green),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .login-subtitle{color:var(--text2);margin-bottom:40px;font-size:1.05rem}
    .login-box{background:var(--card);border:1px solid var(--card-border);border-radius:20px;padding:36px;width:100%;max-width:400px}
    .login-box h2{text-align:center;margin-bottom:20px;font-size:1.3rem}
    .tab-switch{display:flex;margin-bottom:20px;border-radius:10px;overflow:hidden;border:1px solid var(--card-border)}
    .tab-btn{flex:1;padding:10px;border:none;background:var(--dark);color:var(--text2);cursor:pointer;font-size:.9rem;font-weight:600;transition:all .3s}
    .tab-btn.active{background:var(--blue);color:#fff}
    .form-group{margin-bottom:14px}
    .form-group label{display:block;margin-bottom:5px;color:var(--text2);font-size:.8rem;font-weight:600}
    .form-group input,.form-group select{width:100%;padding:11px 14px;border:1px solid var(--card-border);border-radius:10px;background:var(--dark);color:var(--text);font-size:.95rem;outline:none;transition:border .3s}
    .form-group input:focus,.form-group select:focus{border-color:var(--blue)}
    .btn{width:100%;padding:13px;border:none;border-radius:12px;font-size:1rem;font-weight:700;cursor:pointer;transition:all .3s;margin-top:6px}
    .btn-primary{background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(59,130,246,.3)}
    .error-msg{color:var(--red);font-size:.82rem;text-align:center;margin-top:8px}
    .access-options{display:flex;gap:10px;margin-top:14px}
    .access-btn{flex:1;padding:14px;border:2px solid var(--card-border);border-radius:14px;background:var(--dark);color:var(--text);cursor:pointer;text-align:center;transition:all .3s}
    .access-btn:hover{border-color:var(--blue);transform:translateY(-2px)}
    .access-btn .icon{font-size:1.8rem;display:block;margin-bottom:6px}
    .access-btn .label{font-weight:700;font-size:.9rem}

    /* PARENT */
    .dashboard{min-height:100vh;padding:20px;max-width:900px;margin:0 auto}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid var(--card-border)}
    .header-left h1{font-size:1.4rem;background:linear-gradient(135deg,var(--green),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .header-left small{color:var(--text2)}
    .logout-btn{padding:8px 14px;border:1px solid var(--card-border);border-radius:8px;background:transparent;color:var(--text2);cursor:pointer;font-size:.82rem;transition:all .3s}
    .logout-btn:hover{border-color:var(--red);color:var(--red)}
    .card{background:var(--card);border:1px solid var(--card-border);border-radius:16px;padding:22px;margin-bottom:16px}
    .card h3{font-size:1.05rem;margin-bottom:14px;display:flex;align-items:center;gap:8px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-bottom:16px}
    .stat-card{background:var(--dark2);border:1px solid var(--card-border);border-radius:12px;padding:14px;text-align:center}
    .stat-card .stat-value{font-size:1.4rem;font-weight:800;margin-bottom:3px}
    .stat-card .stat-label{color:var(--text2);font-size:.75rem;font-weight:600;text-transform:uppercase}
    .stat-green .stat-value{color:var(--green)}.stat-blue .stat-value{color:var(--blue)}.stat-gold .stat-value{color:var(--gold)}.stat-purple .stat-value{color:var(--purple)}
    .config-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn-row{display:flex;gap:10px;margin-top:14px}
    .btn-row .btn{flex:1}
    .btn-sm{padding:10px 14px;font-size:.85rem}
    .btn-outline{background:transparent;border:1px solid var(--card-border);color:var(--text)}
    .btn-outline:hover{border-color:var(--blue)}
    .tx-list{max-height:280px;overflow-y:auto}
    .tx-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--card-border)}
    .tx-item:last-child{border-bottom:none}
    .tx-type{font-weight:700;font-size:.8rem;padding:3px 8px;border-radius:6px}
    .tx-buy{background:rgba(34,197,94,.12);color:var(--green)}.tx-sell{background:rgba(239,68,68,.12);color:var(--red)}
    .tx-details{text-align:right}.tx-details .tx-value{font-weight:700;font-size:.9rem}.tx-details .tx-time{color:var(--text2);font-size:.75rem}

    /* TRADING */
    .trading-panel{min-height:100vh;padding:14px;max-width:520px;margin:0 auto;display:flex;flex-direction:column}
    .trading-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .trading-header h1{font-size:1.15rem;background:linear-gradient(135deg,var(--green),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .balance-display{text-align:right}
    .balance-display .label{font-size:.7rem;color:var(--text2);font-weight:600}
    .balance-display .value{font-size:1.2rem;font-weight:800;color:var(--gold)}
    .market-status{display:flex;align-items:center;gap:5px;font-size:.75rem;color:var(--text2)}
    .live-dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
    .status-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
    .status-dot.paused{background:var(--red);animation:none}

    /* Category Tabs */
    .category-tabs{display:flex;gap:4px;margin-bottom:10px;background:var(--dark2);border-radius:10px;padding:3px}
    .cat-tab{flex:1;padding:8px 6px;border:none;border-radius:8px;background:transparent;color:var(--text2);cursor:pointer;font-size:.75rem;font-weight:700;transition:all .2s;text-align:center}
    .cat-tab.active{background:var(--dark4);color:var(--text)}
    .cat-tab:hover{color:var(--text)}

    /* Asset List */
    .asset-scroll{display:flex;gap:6px;margin-bottom:12px;overflow-x:auto;padding-bottom:4px;-webkit-overflow-scrolling:touch}
    .asset-scroll::-webkit-scrollbar{height:3px}
    .asset-scroll::-webkit-scrollbar-thumb{background:var(--dark4);border-radius:3px}
    .asset-chip{flex-shrink:0;padding:8px 12px;border-radius:10px;border:1.5px solid var(--card-border);background:var(--dark2);cursor:pointer;text-align:center;transition:all .25s;min-width:85px;position:relative}
    .asset-chip:hover{border-color:var(--blue);transform:translateY(-1px)}
    .asset-chip.active{border-color:var(--blue);background:rgba(59,130,246,.1)}
    .asset-chip .a-icon{font-size:1.2rem;display:block}
    .asset-chip .a-name{font-size:.68rem;font-weight:800;margin-top:1px;letter-spacing:.5px}
    .asset-chip .a-price{font-size:.65rem;font-weight:600;color:var(--text2);margin-top:1px}
    .asset-chip .a-change{font-size:.6rem;font-weight:700}
    .a-change.up{color:var(--green)}.a-change.down{color:var(--red)}
    .asset-chip .a-type{position:absolute;top:3px;right:5px;font-size:.5rem;font-weight:700;color:var(--text2);opacity:.6}

    /* Price Display */
    .price-section{background:var(--dark2);border:1px solid var(--card-border);border-radius:18px;padding:16px;text-align:center;margin-bottom:12px;position:relative;overflow:hidden}
    .price-section::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--blue),transparent);animation:scanline 3s linear infinite}
    @keyframes scanline{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
    .price-label{color:var(--text2);font-size:.78rem;font-weight:600;margin-bottom:6px}
    .price-row{display:flex;align-items:center;justify-content:center;gap:8px}
    .price-value{font-size:2.6rem;font-weight:900;transition:color .3s;font-variant-numeric:tabular-nums}
    .price-up{color:var(--green)}.price-down{color:var(--red)}.price-stable{color:var(--text)}
    .price-emoji{font-size:1.8rem;display:inline-block;animation:bounce 1s infinite}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .price-change{font-size:.88rem;font-weight:700;margin-top:3px}
    .price-meta{display:flex;justify-content:center;gap:16px;margin-top:8px;font-size:.72rem;color:var(--text2)}
    .price-meta span{display:flex;align-items:center;gap:4px}

    /* Chart */
    .chart-section{background:var(--dark2);border:1px solid var(--card-border);border-radius:14px;margin-bottom:12px;overflow:hidden}
    .chart-toolbar{display:flex;justify-content:space-between;align-items:center;padding:10px 14px 6px}
    .chart-toolbar .chart-title{font-size:.78rem;font-weight:700;color:var(--text2)}
    .time-tabs{display:flex;gap:2px;background:var(--dark);border-radius:8px;padding:2px}
    .time-tab{padding:5px 10px;border:none;border-radius:6px;background:transparent;color:var(--text2);cursor:pointer;font-size:.68rem;font-weight:700;transition:all .2s}
    .time-tab.active{background:var(--dark4);color:var(--text)}
    .time-tab:hover{color:var(--text)}
    .chart-wrap{padding:6px 14px 14px;height:200px;position:relative}
    .chart-canvas{width:100%;height:100%}

    /* Holdings */
    .holdings-bar{display:flex;gap:6px;margin-bottom:12px}
    .holding-item{flex:1;background:var(--dark2);border:1px solid var(--card-border);border-radius:10px;padding:10px;text-align:center}
    .holding-item .h-label{font-size:.65rem;color:var(--text2);font-weight:600;text-transform:uppercase;letter-spacing:.5px}
    .holding-item .h-value{font-size:1.05rem;font-weight:800;margin-top:2px}

    /* Portfolio */
    .portfolio-section{margin-bottom:12px}
    .portfolio-section h4{font-size:.8rem;color:var(--text2);margin-bottom:8px;font-weight:600}
    .portfolio-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .portfolio-coin{background:var(--dark2);border:1px solid var(--card-border);border-radius:10px;padding:9px;display:flex;align-items:center;gap:7px;cursor:pointer;transition:all .2s}
    .portfolio-coin:hover{border-color:var(--blue)}
    .portfolio-coin .pc-icon{font-size:1.2rem}
    .portfolio-coin .pc-info{flex:1}
    .portfolio-coin .pc-name{font-size:.72rem;font-weight:700}
    .portfolio-coin .pc-qty{font-size:.65rem;color:var(--text2)}
    .portfolio-coin .pc-val{font-size:.82rem;font-weight:800;text-align:right}

    /* Trade */
    .trade-section{background:var(--dark2);border:1px solid var(--card-border);border-radius:14px;padding:14px;margin-bottom:12px}
    .trade-section h4{font-size:.8rem;color:var(--text2);margin-bottom:10px;font-weight:600;text-align:center}
    .qty-selector{display:flex;align-items:center;justify-content:center;gap:14px;margin-bottom:12px}
    .qty-selector label{color:var(--text2);font-size:.8rem;font-weight:600}
    .qty-controls{display:flex;align-items:center;gap:10px}
    .qty-btn{width:34px;height:34px;border-radius:50%;border:1px solid var(--card-border);background:var(--dark);color:var(--text);font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
    .qty-btn:hover{border-color:var(--blue);background:var(--dark3)}
    .qty-value{font-size:1.3rem;font-weight:800;min-width:28px;text-align:center}
    .trade-buttons{display:flex;gap:10px}
    .trade-btn{flex:1;padding:16px 12px;border:none;border-radius:14px;font-size:1.1rem;font-weight:900;cursor:pointer;transition:all .3s;text-transform:uppercase;letter-spacing:.5px}
    .buy-btn{background:linear-gradient(135deg,#14532d,var(--green));color:#fff;box-shadow:0 4px 15px rgba(34,197,94,.15)}
    .sell-btn{background:linear-gradient(135deg,#7f1d1d,var(--red));color:#fff;box-shadow:0 4px 15px rgba(239,68,68,.15)}
    .trade-btn:hover{transform:translateY(-2px)}
    .trade-btn:active{transform:translateY(0)}
    .trade-btn.glow-green{animation:glowG 1.5s ease-in-out infinite}
    .trade-btn.glow-red{animation:glowR 1.5s ease-in-out infinite}
    .trade-btn:disabled{opacity:.35;cursor:not-allowed;transform:none!important;animation:none!important;box-shadow:none!important}
    @keyframes glowG{0%,100%{box-shadow:0 0 20px rgba(34,197,94,.3)}50%{box-shadow:0 0 35px rgba(34,197,94,.6)}}
    @keyframes glowR{0%,100%{box-shadow:0 0 20px rgba(239,68,68,.3)}50%{box-shadow:0 0 35px rgba(239,68,68,.6)}}
    .trade-btn .btn-sub{font-size:.65rem;font-weight:600;opacity:.8;display:block;margin-top:3px;letter-spacing:0;text-transform:none}

    /* Progress */
    .progress-section{background:var(--dark2);border:1px solid var(--card-border);border-radius:14px;padding:12px;margin-bottom:12px}
    .progress-header{display:flex;justify-content:space-between;margin-bottom:7px}
    .progress-label{font-size:.8rem;color:var(--text2);font-weight:600}
    .progress-value{font-size:.8rem;font-weight:700;color:var(--gold)}
    .progress-bar-bg{width:100%;height:18px;background:var(--dark);border-radius:9px;overflow:hidden;position:relative}
    .progress-bar-fill{height:100%;border-radius:9px;transition:width .8s ease,background .5s;background:linear-gradient(90deg,var(--blue),var(--purple));position:relative}
    .progress-bar-fill.near-goal{background:linear-gradient(90deg,var(--gold),#fbbf24);animation:pulseG 1s ease-in-out infinite}
    .progress-bar-fill.goal-reached{background:linear-gradient(90deg,var(--green),var(--green-glow))}
    @keyframes pulseG{0%,100%{opacity:1}50%{opacity:.7}}
    .progress-percent{position:absolute;right:7px;top:50%;transform:translateY(-50%);font-size:.65rem;font-weight:800;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.3)}

    /* TX */
    .tx-feed{background:var(--dark2);border:1px solid var(--card-border);border-radius:14px;padding:12px}
    .tx-feed h4{font-size:.82rem;color:var(--text2);margin-bottom:8px}
    .tx-feed-item{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--card-border);font-size:.78rem}
    .tx-feed-item:last-child{border-bottom:none}

    /* Overlays */
    .celebration-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.88);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;animation:fadeIn .5s}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .celebration-content{text-align:center;animation:scaleIn .5s}
    @keyframes scaleIn{from{transform:scale(.5);opacity:0}to{transform:scale(1);opacity:1}}
    .celebration-emoji{font-size:4.5rem;margin-bottom:14px}
    .celebration-title{font-size:1.8rem;font-weight:900;background:linear-gradient(135deg,var(--gold),#fbbf24);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px}
    .celebration-text{color:var(--text2);font-size:1rem;margin-bottom:20px}
    .toast{position:fixed;top:16px;right:16px;padding:10px 18px;border-radius:10px;font-weight:700;font-size:.85rem;z-index:999;animation:slideIn .3s,slideOut .3s 2.7s;pointer-events:none}
    .toast-success{background:var(--green);color:#fff}.toast-error{background:var(--red);color:#fff}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}
    .paused-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:900}
    .paused-content{text-align:center;color:var(--text2)}
    .paused-content .pause-icon{font-size:3.5rem;margin-bottom:10px}
    .paused-content .pause-text{font-size:1.2rem;font-weight:700}
    /* Yield Section */
    .yield-section{background:linear-gradient(135deg,#131a2e,#1a2744);border:1px solid var(--card-border);border-radius:14px;padding:14px;margin-bottom:12px;position:relative;overflow:hidden}
    .yield-section::after{content:'';position:absolute;top:-50%;right:-50%;width:100%;height:100%;background:radial-gradient(circle,rgba(34,197,94,.05),transparent);pointer-events:none}
    .yield-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .yield-title{font-size:.82rem;font-weight:700;color:var(--green)}
    .yield-rate{font-size:.75rem;font-weight:700;color:var(--gold);background:rgba(245,158,11,.1);padding:3px 8px;border-radius:6px}
    .yield-info{display:flex;gap:8px}
    .yield-card{flex:1;background:var(--dark);border-radius:10px;padding:10px;text-align:center}
    .yield-card .y-label{font-size:.65rem;color:var(--text2);font-weight:600;text-transform:uppercase}
    .yield-card .y-value{font-size:1rem;font-weight:800;margin-top:2px}
    .yield-card .y-sub{font-size:.6rem;color:var(--green);font-weight:600;margin-top:1px}

    /* Ranking */
    .ranking-section{background:var(--dark2);border:1px solid var(--card-border);border-radius:14px;padding:14px;margin-bottom:12px}
    .ranking-section h4{font-size:.82rem;color:var(--text2);margin-bottom:10px;font-weight:600}
    .rank-list{display:flex;flex-direction:column;gap:6px}
    .rank-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;background:var(--dark);transition:all .2s}
    .rank-item.me{background:rgba(59,130,246,.1);border:1px solid var(--blue)}
    .rank-pos{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:900;flex-shrink:0}
    .rank-1{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#000}
    .rank-2{background:linear-gradient(135deg,#94a3b8,#64748b);color:#000}
    .rank-3{background:linear-gradient(135deg,#cd7f32,#a0522d);color:#fff}
    .rank-other{background:var(--dark3);color:var(--text2)}
    .rank-info{flex:1}
    .rank-name{font-size:.78rem;font-weight:700}
    .rank-assets{font-size:.65rem;color:var(--text2)}
    .rank-value{font-size:.85rem;font-weight:800;text-align:right}

    .hidden{display:none!important}

    @media(max-width:500px){.config-grid{grid-template-columns:1fr}.stats-grid{grid-template-columns:1fr 1fr}.price-value{font-size:2rem}.trade-btn{padding:14px 8px;font-size:.95rem}.asset-chip{min-width:72px;padding:6px 8px}.portfolio-grid{grid-template-columns:1fr}.chart-wrap{height:170px}}
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="login-screen">
  <div class="login-logo">Financial Child</div>
  <div class="login-subtitle">Aprenda a investir brincando!</div>
  <div class="login-box">
    <div class="tab-switch"><button class="tab-btn active" onclick="switchTab('login')">Entrar</button><button class="tab-btn" onclick="switchTab('register')">Criar Conta</button></div>
    <div id="loginForm">
      <div class="form-group"><label>Email</label><input type="email" id="loginEmail" placeholder="seu@email.com"></div>
      <div class="form-group"><label>Senha</label><input type="password" id="loginPassword" placeholder="Sua senha"></div>
      <button class="btn btn-primary" onclick="handleLogin()">Entrar</button>
      <div id="loginError" class="error-msg hidden"></div>
      <div class="access-options"><button class="access-btn" onclick="enterAsParent()"><span class="icon">üë®‚Äçüë©‚Äçüëß</span><span class="label">Sou Pai/Mae</span></button><button class="access-btn" onclick="showChildAccess()"><span class="icon">üßí</span><span class="label">Sou Crianca</span></button></div>
    </div>
    <div id="registerForm" class="hidden">
      <div class="form-group"><label>Seu Nome</label><input type="text" id="regName" placeholder="Ex: Maria"></div>
      <div class="form-group"><label>Email</label><input type="email" id="regEmail" placeholder="seu@email.com"></div>
      <div class="form-group"><label>Senha</label><input type="password" id="regPassword" placeholder="Crie uma senha"></div>
      <button class="btn btn-primary" onclick="handleRegister()">Criar Conta</button>
      <div id="regError" class="error-msg hidden"></div>
    </div>
  </div>
</div>

<!-- PARENT -->
<div id="parentDashboard" class="dashboard hidden">
  <div class="header"><div class="header-left"><h1>Financial Child</h1><small>Painel dos Pais</small></div><button class="logout-btn" onclick="logout()">Sair</button></div>
  <div id="setupChild" class="card">
    <h3>üë∂ Configurar Conta do Filho</h3>
    <div class="config-grid">
      <div class="form-group"><label>Nome</label><input type="text" id="childName" placeholder="Ex: Joao"></div>
      <div class="form-group"><label>Idade</label><input type="number" id="childAge" value="10" min="5" max="17"></div>
      <div class="form-group"><label>Saldo Inicial (R$)</label><input type="number" id="childBalance" value="100" min="10" step="10"></div>
      <div class="form-group"><label>Volatilidade</label><select id="childVolatility"><option value="baixa">Baixa</option><option value="media" selected>Media</option><option value="alta">Alta</option></select></div>
      <div class="form-group"><label>Meta (R$)</label><input type="number" id="childGoal" value="200" min="20" step="10"></div>
    </div>
    <button class="btn btn-primary" onclick="createChildAccount()">Criar Conta</button>
  </div>
  <div id="childDashboard" class="hidden">
    <div class="stats-grid">
      <div class="stat-card stat-blue"><div class="stat-value" id="pSaldo">R$ 0</div><div class="stat-label">Saldo</div></div>
      <div class="stat-card stat-green"><div class="stat-value" id="pMoedas">0</div><div class="stat-label">Ativos</div></div>
      <div class="stat-card stat-gold"><div class="stat-value" id="pTotal">R$ 0</div><div class="stat-label">Patrimonio</div></div>
      <div class="stat-card stat-purple"><div class="stat-value" id="pOps">0</div><div class="stat-label">Operacoes</div></div>
    </div>
    <div class="card"><h3>üéØ Meta</h3><div class="progress-header"><span class="progress-label" id="pChildName">Filho</span><span class="progress-value" id="pGoalText">R$0 / R$0</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" id="pProgressBar" style="width:0%"><span class="progress-percent" id="pProgressPct">0%</span></div></div></div>
    <div class="card"><h3>‚öôÔ∏è Config</h3><div class="config-grid"><div class="form-group"><label>Volatilidade</label><select id="editVolatility" onchange="updateConfig()"><option value="baixa">Baixa</option><option value="media">Media</option><option value="alta">Alta</option></select></div><div class="form-group"><label>Meta (R$)</label><input type="number" id="editGoal" min="20" step="10" onchange="updateConfig()"></div></div><div class="btn-row"><button class="btn btn-sm btn-outline" onclick="toggleMarket()" id="toggleBtn">‚è∏ Pausar</button><button class="btn btn-sm btn-outline" onclick="resetChildAccount()" style="border-color:var(--red);color:var(--red);">üîÑ Resetar</button></div></div>
    <div class="card"><h3>üîë Codigo da Crianca</h3><div style="background:var(--dark);padding:14px;border-radius:12px;text-align:center;"><span id="childCode" style="font-size:1.6rem;font-weight:900;letter-spacing:4px;color:var(--gold);"></span></div></div>
    <div class="card"><h3>üìä Historico</h3><div class="tx-list" id="pTxList"><p style="color:var(--text2);text-align:center;padding:16px;">Nenhuma operacao</p></div></div>
  </div>
</div>

<!-- CHILD ACCESS -->
<div id="childAccessScreen" class="login-screen hidden">
  <div class="login-logo">Financial Child</div>
  <div class="login-subtitle">Area do Investidor üöÄ</div>
  <div class="login-box"><h2>Digite seu codigo</h2><div class="form-group"><label>Codigo</label><input type="text" id="childCodeInput" placeholder="ABC123" maxlength="6" style="text-align:center;font-size:1.4rem;letter-spacing:4px;font-weight:800;"></div><button class="btn btn-primary" onclick="childLogin()">Entrar</button><div id="childLoginError" class="error-msg hidden"></div><button class="btn btn-outline" style="margin-top:10px;" onclick="backToLogin()">Voltar</button></div>
</div>

<!-- TRADING -->
<div id="tradingPanel" class="trading-panel hidden">
  <div class="trading-header">
    <div><h1>Financial Child</h1><div class="market-status"><div class="status-dot" id="marketDot"></div><span id="marketStatusText">Ao vivo</span></div></div>
    <div class="balance-display"><div class="label">SALDO</div><div class="value" id="cBalance">R$ 0</div></div>
  </div>

  <!-- Categories -->
  <div class="category-tabs" id="catTabs"></div>
  <!-- Assets -->
  <div class="asset-scroll" id="assetScroll"></div>

  <!-- Price -->
  <div class="price-section">
    <div class="price-label"><span class="live-dot"></span> <strong id="cCoinName">EKO</strong> - <span id="cCoinType">Cripto</span></div>
    <div class="price-row"><span class="price-value price-stable" id="cPrice">R$ 10,00</span><span class="price-emoji" id="cEmoji">üìä</span></div>
    <div class="price-change" id="cPriceChange"></div>
    <div class="price-meta">
      <span>üìà Max: <strong id="cHigh">-</strong></span>
      <span>üìâ Min: <strong id="cLow">-</strong></span>
      <span>üìä Base: <strong id="cBase">-</strong></span>
    </div>
  </div>

  <!-- Chart -->
  <div class="chart-section">
    <div class="chart-toolbar">
      <span class="chart-title" id="chartTitle">Grafico EKO</span>
      <div class="time-tabs" id="timeTabs"></div>
    </div>
    <div class="chart-wrap"><canvas class="chart-canvas" id="priceChart"></canvas></div>
  </div>

  <!-- Holdings -->
  <div class="holdings-bar">
    <div class="holding-item"><div class="h-label">Quantidade</div><div class="h-value" id="cQty" style="color:var(--blue);">0</div></div>
    <div class="holding-item"><div class="h-label">Valor</div><div class="h-value" id="cVal" style="color:var(--purple);">R$ 0</div></div>
    <div class="holding-item"><div class="h-label">Patrimonio</div><div class="h-value" id="cTotal" style="color:var(--gold);">R$ 0</div></div>
  </div>

  <!-- Portfolio -->
  <div class="portfolio-section"><h4>üì¶ Carteira</h4><div class="portfolio-grid" id="portfolioGrid"></div></div>

  <!-- Trade -->
  <div class="trade-section">
    <h4>Negociar <span id="tradeAssetName">EKO</span></h4>
    <div class="qty-selector"><label>Qtd:</label><div class="qty-controls"><button class="qty-btn" onclick="changeQty(-1)">-</button><span class="qty-value" id="qtyValue">1</span><button class="qty-btn" onclick="changeQty(1)">+</button></div></div>
    <div class="trade-buttons">
      <button class="trade-btn buy-btn" id="buyBtn" onclick="handleBuy()">Comprar<span class="btn-sub" id="buyCost"></span></button>
      <button class="trade-btn sell-btn" id="sellBtn" onclick="handleSell()">Vender<span class="btn-sub" id="sellValue"></span></button>
    </div>
  </div>

  <!-- Yield -->
  <div class="yield-section">
    <div class="yield-header"><span class="yield-title">üí∞ Rendimento Passivo</span><span class="yield-rate" id="yieldRate">+0.5%/min</span></div>
    <div class="yield-info">
      <div class="yield-card"><div class="y-label">Ganho/min</div><div class="y-value" id="yieldPerMin" style="color:var(--green)">R$ 0,00</div><div class="y-sub">baseado nos seus EKOs</div></div>
      <div class="yield-card"><div class="y-label">Total ganho</div><div class="y-value" id="yieldTotal" style="color:var(--gold)">R$ 0,00</div><div class="y-sub" id="yieldTime">desde o inicio</div></div>
    </div>
  </div>

  <!-- Ranking -->
  <div class="ranking-section">
    <h4>üèÜ Ranking de Investidores</h4>
    <div class="rank-list" id="rankList"></div>
  </div>

  <!-- Progress -->
  <div class="progress-section"><div class="progress-header"><span class="progress-label">üéØ Meta</span><span class="progress-value" id="cGoalText">R$0 / R$0</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" id="cProgressBar" style="width:0%"><span class="progress-percent" id="cProgressPct">0%</span></div></div></div>
  <div class="tx-feed"><h4>Ultimas Operacoes</h4><div id="cTxList"><p style="color:var(--text2);text-align:center;padding:10px;font-size:.85rem;">Faca sua primeira operacao!</p></div></div>
  <button class="logout-btn" style="margin-top:14px;width:100%;" onclick="logout()">Sair</button>
</div>

<!-- Overlays -->
<div id="celebrationOverlay" class="celebration-overlay hidden"><div class="celebration-content"><div class="celebration-emoji">üèÜüéâüöÄ</div><div class="celebration-title">META ATINGIDA!</div><div class="celebration-text" id="celebrationText"></div><button class="btn btn-primary" style="max-width:180px;margin:0 auto;" onclick="closeCelebration()">Valeu! üéä</button></div></div>
<div id="pausedOverlay" class="paused-overlay hidden"><div class="paused-content"><div class="pause-icon">‚è∏Ô∏è</div><div class="pause-text">Mercado Pausado</div></div></div>

<script>
// ============================================================
// FINANCIAL CHILD v3 - SMOOTH LIVE + MULTI-ASSET + PRO CHARTS
// ============================================================

const CATEGORIES = [
  { id: 'cripto', name: 'Cripto', icon: 'ü™ô' },
  { id: 'acoes',  name: 'Acoes',  icon: 'üìä' },
  { id: 'commodities', name: 'Commodities', icon: 'üí∞' },
];

const ASSETS = [
  // Cripto
  { id:'EKO',  name:'EKO',  icon:'üíé', color:'#3b82f6', basePrice:10,  cat:'cripto', vol:1.0 },
  { id:'LUNA', name:'LUNA', icon:'üåô', color:'#8b5cf6', basePrice:25,  cat:'cripto', vol:1.2 },
  { id:'FIRE', name:'FIRE', icon:'üî•', color:'#ef4444', basePrice:15,  cat:'cripto', vol:1.5 },
  { id:'STAR', name:'STAR', icon:'‚≠ê', color:'#f59e0b', basePrice:5,   cat:'cripto', vol:0.8 },
  // Acoes
  { id:'TOYS', name:'TOYS', icon:'üß∏', color:'#ec4899', basePrice:30,  cat:'acoes', vol:0.6 },
  { id:'GAME', name:'GAME', icon:'üéÆ', color:'#06b6d4', basePrice:45,  cat:'acoes', vol:0.7 },
  { id:'FOOD', name:'FOOD', icon:'üçî', color:'#f97316', basePrice:20,  cat:'acoes', vol:0.4 },
  { id:'PETS', name:'PETS', icon:'üê∂', color:'#a3e635', basePrice:18,  cat:'acoes', vol:0.5 },
  // Commodities
  { id:'GOLD', name:'GOLD', icon:'ü•á', color:'#fbbf24', basePrice:80,  cat:'commodities', vol:0.3 },
  { id:'DIAM', name:'DIAM', icon:'üí†', color:'#67e8f9', basePrice:120, cat:'commodities', vol:0.35 },
  { id:'SILV', name:'SILV', icon:'ü•à', color:'#94a3b8', basePrice:40,  cat:'commodities', vol:0.25 },
];

const TIME_PERIODS = [
  { id:'1m', label:'1m', seconds:60 },
  { id:'5m', label:'5m', seconds:300 },
  { id:'15m',label:'15m',seconds:900 },
  { id:'1h', label:'1h', seconds:3600 },
  { id:'all',label:'Tudo',seconds:Infinity },
];

// Storage
function save(k,d){localStorage.setItem('fc3_'+k,JSON.stringify(d))}
function load(k){const d=localStorage.getItem('fc3_'+k);return d?JSON.parse(d):null}
function genCode(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let r='';for(let i=0;i<6;i++)r+=c[~~(Math.random()*c.length)];return r}

// State
let currentParent=null,currentChild=null,currentView='login';
let marketInterval=null,tradeQty=1;
let selectedAsset='EKO',selectedCat='cripto',selectedTime='5m';
let priceHistories={},trendData={},celebrationShown=false;
let tickCount=0,totalYieldEarned=0,yieldInterval=null;

function init(){
  const s=load('session');
  if(s){if(s.type==='parent'){currentParent=s.data;showParentDashboard()}else if(s.type==='child'){currentChild=s.data;showTradingPanel()}}
}

// ============ AUTH ============
function switchTab(t){document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',(t==='login'&&i===0)||(t==='register'&&i===1)));document.getElementById('loginForm').classList.toggle('hidden',t!=='login');document.getElementById('registerForm').classList.toggle('hidden',t!=='register')}
function handleRegister(){
  const n=document.getElementById('regName').value.trim(),e=document.getElementById('regEmail').value.trim(),p=document.getElementById('regPassword').value.trim();
  if(!n||!e||!p){showError('regError','Preencha todos os campos');return}
  const ex=load('parents')||{};if(ex[e]){showError('regError','Email ja cadastrado');return}
  const par={id:Date.now().toString(),name:n,email:e,password:p};ex[e]=par;save('parents',ex);
  currentParent=par;save('session',{type:'parent',data:par});showParentDashboard();
}
function handleLogin(){
  const e=document.getElementById('loginEmail').value.trim(),p=document.getElementById('loginPassword').value.trim();
  const pars=load('parents')||{};const par=pars[e];
  if(!par||par.password!==p){showError('loginError','Email ou senha incorretos');return}
  currentParent=par;save('session',{type:'parent',data:par});showParentDashboard();
}
function enterAsParent(){switchTab('register')}
function showChildAccess(){showScreen('childAccess')}
function backToLogin(){showScreen('login')}
function childLogin(){
  const code=document.getElementById('childCodeInput').value.trim().toUpperCase();
  const ch=load('children')||{};const child=Object.values(ch).find(c=>c.code===code);
  if(!child){showError('childLoginError','Codigo invalido');return}
  currentChild=child;save('session',{type:'child',data:child});showTradingPanel();
}
function logout(){stopMarket();currentParent=null;currentChild=null;localStorage.removeItem('fc3_session');celebrationShown=false;showScreen('login')}
function showError(id,msg){const el=document.getElementById(id);el.textContent=msg;el.classList.remove('hidden');setTimeout(()=>el.classList.add('hidden'),3000)}
function showScreen(s){currentView=s;['loginScreen','parentDashboard','childAccessScreen','tradingPanel'].forEach(id=>{document.getElementById(id).classList.toggle('hidden',id!=={login:'loginScreen',parent:'parentDashboard',childAccess:'childAccessScreen',trading:'tradingPanel'}[s])})}

// ============ PARENT ============
function showParentDashboard(){showScreen('parent');refreshParent()}
function refreshParent(){
  const ch=load('children')||{};const list=Object.values(ch).filter(c=>c.parent_id===currentParent.id);
  if(!list.length){document.getElementById('setupChild').classList.remove('hidden');document.getElementById('childDashboard').classList.add('hidden');return}
  document.getElementById('setupChild').classList.add('hidden');document.getElementById('childDashboard').classList.remove('hidden');
  const child=list[0];currentChild=child;
  const tv=calcTotal(child);const txs=(load('transactions')||{})[child.id]||[];
  const totalAssets=ASSETS.reduce((s,a)=>s+(child.assets?.[a.id]?.qty||0),0);
  document.getElementById('pSaldo').textContent=fmt(child.balance);
  document.getElementById('pMoedas').textContent=totalAssets;
  document.getElementById('pTotal').textContent=fmt(tv);
  document.getElementById('pOps').textContent=txs.length;
  const pct=Math.min(100,(tv/child.goal_amount)*100);
  document.getElementById('pChildName').textContent=child.name;
  document.getElementById('pGoalText').textContent=`${fmt(tv)} / ${fmt(child.goal_amount)}`;
  document.getElementById('pProgressBar').style.width=pct+'%';
  document.getElementById('pProgressPct').textContent=Math.round(pct)+'%';
  document.getElementById('editVolatility').value=child.volatility;
  document.getElementById('editGoal').value=child.goal_amount;
  document.getElementById('toggleBtn').textContent=child.is_active?'‚è∏ Pausar':'‚ñ∂Ô∏è Retomar';
  document.getElementById('childCode').textContent=child.code;
  renderParentTx(child.id);
}
function createChildAccount(){
  const name=document.getElementById('childName').value.trim();if(!name){showToast('Digite o nome','error');return}
  const age=+document.getElementById('childAge').value,bal=+document.getElementById('childBalance').value;
  const vol=document.getElementById('childVolatility').value,goal=+document.getElementById('childGoal').value;
  const code=genCode();const assets={};
  ASSETS.forEach(a=>{assets[a.id]={qty:0,price:a.basePrice}});
  const child={id:Date.now().toString(),parent_id:currentParent.id,name,age,balance:bal,initial_balance:bal,assets,volatility:vol,goal_amount:goal,is_active:1,code,created_at:new Date().toISOString()};
  const ch=load('children')||{};ch[child.id]=child;save('children',ch);
  const ph=load('priceH')||{};ASSETS.forEach(a=>{ph[child.id+'_'+a.id]=[{p:a.basePrice,t:Date.now()}]});save('priceH',ph);
  const tx=load('transactions')||{};tx[child.id]=[];save('transactions',tx);
  showToast(`${name} criado! Codigo: ${code}`,'success');refreshParent();
}
function updateConfig(){if(!currentChild)return;const ch=load('children')||{};const c=ch[currentChild.id];if(!c)return;c.volatility=document.getElementById('editVolatility').value;c.goal_amount=+document.getElementById('editGoal').value;ch[c.id]=c;save('children',ch);currentChild=c;refreshParent()}
function toggleMarket(){if(!currentChild)return;const ch=load('children')||{};const c=ch[currentChild.id];c.is_active=c.is_active?0:1;ch[c.id]=c;save('children',ch);currentChild=c;refreshParent()}
function resetChildAccount(){if(!currentChild||!confirm('Resetar todo o progresso?'))return;const bal=+(prompt('Saldo (R$):',currentChild.initial_balance)||currentChild.initial_balance);const goal=+(prompt('Meta (R$):',currentChild.goal_amount)||currentChild.goal_amount);const ch=load('children')||{};const c=ch[currentChild.id];c.balance=bal;c.initial_balance=bal;c.goal_amount=goal;const assets={};ASSETS.forEach(a=>{assets[a.id]={qty:0,price:a.basePrice}});c.assets=assets;ch[c.id]=c;save('children',ch);const ph=load('priceH')||{};ASSETS.forEach(a=>{ph[c.id+'_'+a.id]=[{p:a.basePrice,t:Date.now()}]});save('priceH',ph);const tx=load('transactions')||{};tx[c.id]=[];save('transactions',tx);currentChild=c;showToast('Resetado!','success');refreshParent()}
function renderParentTx(cid){const txs=(load('transactions')||{})[cid]||[];const el=document.getElementById('pTxList');if(!txs.length){el.innerHTML='<p style="color:var(--text2);text-align:center;padding:16px;">Nenhuma operacao</p>';return}el.innerHTML=txs.slice(-20).reverse().map(tx=>{const a=ASSETS.find(x=>x.id===tx.asset)||ASSETS[0];return`<div class="tx-item"><div><span class="tx-type ${tx.type==='BUY'?'tx-buy':'tx-sell'}">${tx.type==='BUY'?'üü¢ COMPROU':'üî¥ VENDEU'}</span><span style="margin-left:6px;color:var(--text2);font-size:.82rem;">${tx.qty} ${a.icon}${a.name} a ${fmt(tx.price)}</span></div><div class="tx-details"><div class="tx-value">${fmt(tx.total)}</div><div class="tx-time">${new Date(tx.time).toLocaleTimeString('pt-BR')}</div></div></div>`}).join('')}

// ============ TRADING ============
function showTradingPanel(){
  showScreen('trading');
  const ch=load('children')||{};currentChild=ch[currentChild.id]||currentChild;
  if(!currentChild.assets){const assets={};ASSETS.forEach(a=>{assets[a.id]={qty:0,price:a.basePrice}});currentChild.assets=assets;ch[currentChild.id]=currentChild;save('children',ch)}
  loadHistories();selectedAsset='EKO';selectedCat='cripto';selectedTime='5m';celebrationShown=false;tickCount=0;totalYieldEarned=currentChild.totalYield||0;
  renderCatTabs();renderAssets();renderTimeTabs();updateUI();startMarket();startYield();
}
function loadHistories(){const ph=load('priceH')||{};priceHistories={};ASSETS.forEach(a=>{priceHistories[a.id]=ph[currentChild.id+'_'+a.id]||[{p:a.basePrice,t:Date.now()}]})}

function renderCatTabs(){
  document.getElementById('catTabs').innerHTML=CATEGORIES.map(c=>`<button class="cat-tab ${selectedCat===c.id?'active':''}" onclick="selectCat('${c.id}')">${c.icon} ${c.name}</button>`).join('');
}
function selectCat(catId){selectedCat=catId;const first=ASSETS.find(a=>a.cat===catId);if(first)selectedAsset=first.id;renderCatTabs();renderAssets();updateUI()}

function renderAssets(){
  const filtered=ASSETS.filter(a=>a.cat===selectedCat);
  document.getElementById('assetScroll').innerHTML=filtered.map(a=>{
    const ad=currentChild.assets?.[a.id];const price=ad?.price||a.basePrice;
    const h=priceHistories[a.id]||[];const prev=h.length>=2?h[h.length-2].p:price;
    const chg=prev>0?((price-prev)/prev*100).toFixed(1):'0.0';const up=price>=prev;
    return`<div class="asset-chip ${selectedAsset===a.id?'active':''}" onclick="selectAsset('${a.id}')"><span class="a-icon">${a.icon}</span><span class="a-name">${a.name}</span><span class="a-price">${fmt(price)}</span><span class="a-change ${up?'up':'down'}">${up?'+':''}${chg}%</span></div>`;
  }).join('');
}
function selectAsset(id){selectedAsset=id;tradeQty=1;document.getElementById('qtyValue').textContent=1;renderAssets();updateUI()}

function renderTimeTabs(){
  document.getElementById('timeTabs').innerHTML=TIME_PERIODS.map(t=>`<button class="time-tab ${selectedTime===t.id?'active':''}" onclick="selectTime('${t.id}')">${t.label}</button>`).join('');
}
function selectTime(id){selectedTime=id;renderTimeTabs();drawChart()}

function startMarket(){stopMarket();ASSETS.forEach(a=>{if(!trendData[a.id])trendData[a.id]={dir:Math.random()>.4?1:-1,ticks:~~(Math.random()*20)+8}});marketInterval=setInterval(tickMarket,2500)}
function stopMarket(){if(marketInterval)clearInterval(marketInterval);marketInterval=null;if(yieldInterval)clearInterval(yieldInterval);yieldInterval=null}

// ============ YIELD (Passive Income) ============
function getYieldRate(child){
  // Yield based on EKO holdings: 0.5% per minute of EKO value
  // More EKOs = more passive income
  const ekoState=child.assets?.['EKO'];
  if(!ekoState||ekoState.qty<=0)return{rate:0,perMin:0};
  const ekoValue=ekoState.qty*ekoState.price;
  const rate=0.005;// 0.5% per minute
  const perMin=ekoValue*rate;
  return{rate,perMin,ekoValue,ekoQty:ekoState.qty};
}
function startYield(){
  if(yieldInterval)clearInterval(yieldInterval);
  // Apply yield every 10 seconds (1/6 of per-minute rate)
  yieldInterval=setInterval(()=>{
    const ch=load('children')||{};const child=ch[currentChild.id];
    if(!child||!child.is_active)return;
    const y=getYieldRate(child);if(y.perMin<=0)return;
    const earning=Math.round((y.perMin/6)*100)/100;// 10s = 1/6 min
    child.balance=Math.round((child.balance+earning)*100)/100;
    totalYieldEarned=Math.round((totalYieldEarned+earning)*100)/100;
    child.totalYield=totalYieldEarned;
    ch[child.id]=child;save('children',ch);currentChild=child;
    updateYieldUI(child);
  },10000);
}
function updateYieldUI(child){
  const y=getYieldRate(child);
  document.getElementById('yieldRate').textContent=y.perMin>0?`+${(y.rate*100).toFixed(1)}%/min`:'Compre EKOs!';
  document.getElementById('yieldPerMin').textContent=y.perMin>0?fmt(y.perMin):'R$ 0,00';
  document.getElementById('yieldTotal').textContent=fmt(totalYieldEarned);
  document.getElementById('yieldTime').textContent=y.ekoQty?`${y.ekoQty} EKOs gerando renda`:'compre EKOs para ganhar';
}

function tickMarket(){
  const ch=load('children')||{};const child=ch[currentChild.id];if(!child||!child.is_active)return;
  const ph=load('priceH')||{};tickCount++;
  ASSETS.forEach(asset=>{
    const state=child.assets[asset.id];if(!state)return;
    const np=calcPrice(asset,state.price,child.volatility);
    state.price=np;
    const key=child.id+'_'+asset.id;if(!ph[key])ph[key]=[];
    ph[key].push({p:np,t:Date.now()});
    if(ph[key].length>2000)ph[key]=ph[key].slice(-2000);
  });
  ch[child.id]=child;save('children',ch);save('priceH',ph);currentChild=child;
  ASSETS.forEach(a=>{priceHistories[a.id]=ph[child.id+'_'+a.id]||[]});
  // Only update chips every 3rd tick to reduce DOM thrash
  if(tickCount%3===0)renderAssets();
  updateUI();
}

function calcPrice(asset,cur,volatility){
  let base={baixa:.012,media:.025,alta:.05}[volatility]||.025;
  base*=asset.vol;// asset-specific multiplier
  const range={min:-base,max:base};
  let td=trendData[asset.id];if(!td){td={dir:1,ticks:10};trendData[asset.id]=td}
  td.ticks--;if(td.ticks<=0){td.dir=Math.random()>.4?1:-1;td.ticks=~~(Math.random()*20)+8}
  let v=Math.random()*(range.max-range.min)+range.min;
  v+=td.dir*(Math.random()*.008+.003);
  v-=((cur-asset.basePrice)/asset.basePrice)*.02;// mean reversion
  let np=cur*(1+v);
  np=Math.max(asset.basePrice*.08,Math.min(asset.basePrice*5,np));
  return Math.round(np*100)/100;
}

function calcTotal(child){let t=child.balance;ASSETS.forEach(a=>{const d=child.assets?.[a.id];if(d)t+=d.qty*d.price});return t}

function updateUI(){
  const child=currentChild;if(!child)return;
  const ch=load('children')||{};const fresh=ch[child.id];
  if(fresh){currentChild=fresh;document.getElementById('pausedOverlay').classList.toggle('hidden',fresh.is_active===1);document.getElementById('marketDot').classList.toggle('paused',!fresh.is_active);document.getElementById('marketStatusText').textContent=fresh.is_active?'Ao vivo':'Pausado'}
  const asset=ASSETS.find(a=>a.id===selectedAsset);const state=child.assets?.[selectedAsset];if(!asset||!state)return;
  const price=state.price;const bp=asset.basePrice;const tv=calcTotal(child);

  document.getElementById('cBalance').textContent=fmt(child.balance);
  document.getElementById('cCoinName').textContent=asset.icon+' '+asset.name;
  document.getElementById('cCoinType').textContent=CATEGORIES.find(c=>c.id===asset.cat)?.name||'';
  document.getElementById('tradeAssetName').textContent=asset.icon+' '+asset.name;

  const priceEl=document.getElementById('cPrice');priceEl.textContent=fmt(price);
  const h=priceHistories[selectedAsset]||[];let prev=bp;if(h.length>=2)prev=h[h.length-2].p;
  const diff=price-prev;const pct=prev>0?((diff/prev)*100).toFixed(1):'0.0';
  priceEl.className='price-value '+(diff>0?'price-up':diff<0?'price-down':'price-stable');
  document.getElementById('cEmoji').textContent=diff>0?'üöÄ':diff<0?'ü™Ç':'üìä';
  const chgEl=document.getElementById('cPriceChange');
  chgEl.textContent=`${diff>=0?'+':''}${fmt(diff)} (${pct}%)`;
  chgEl.style.color=diff>0?'var(--green)':diff<0?'var(--red)':'var(--text2)';

  // High/Low/Base
  const prices=h.map(x=>x.p);
  document.getElementById('cHigh').textContent=prices.length?fmt(Math.max(...prices.slice(-100))):'-';
  document.getElementById('cLow').textContent=prices.length?fmt(Math.min(...prices.slice(-100))):'-';
  document.getElementById('cBase').textContent=fmt(bp);

  document.getElementById('chartTitle').textContent=`${asset.icon} ${asset.name}`;

  // Holdings
  document.getElementById('cQty').textContent=state.qty;
  document.getElementById('cVal').textContent=fmt(state.qty*price);
  document.getElementById('cTotal').textContent=fmt(tv);

  // Trade
  const cost=price*tradeQty;
  document.getElementById('buyCost').textContent=`${tradeQty} x ${fmt(price)} = ${fmt(cost)}`;
  document.getElementById('sellValue').textContent=`${tradeQty} x ${fmt(price)} = ${fmt(cost)}`;
  const buyBtn=document.getElementById('buyBtn'),sellBtn=document.getElementById('sellBtn');
  buyBtn.disabled=child.balance<cost;sellBtn.disabled=state.qty<tradeQty;
  buyBtn.classList.toggle('glow-green',price<bp*.85&&child.balance>=cost);
  sellBtn.classList.toggle('glow-red',price>bp*1.25&&state.qty>=tradeQty);

  renderPortfolio(child);

  // Progress
  const ppct=Math.min(100,(tv/child.goal_amount)*100);
  document.getElementById('cGoalText').textContent=`${fmt(tv)} / ${fmt(child.goal_amount)}`;
  const bar=document.getElementById('cProgressBar');bar.style.width=ppct+'%';
  document.getElementById('cProgressPct').textContent=Math.round(ppct)+'%';
  bar.classList.remove('near-goal','goal-reached');
  if(ppct>=100)bar.classList.add('goal-reached');else if(ppct>=90)bar.classList.add('near-goal');
  if(ppct>=100&&!celebrationShown){celebrationShown=true;showCelebration(tv,child.goal_amount)}

  updateYieldUI(child);renderRanking(child);drawChart();renderChildTx();
}

// ============ RANKING ============
function renderRanking(child){
  const el=document.getElementById('rankList');
  // Generate simulated competitors + real player
  const competitors=[
    {name:'ü§ñ RoboTrader',value:getSimValue(180,50)},
    {name:'ü¶ä RaposaEsper',value:getSimValue(150,40)},
    {name:'üê¢ TartaLenta',value:getSimValue(90,20)},
    {name:'ü¶Å LeaoFeroz',value:getSimValue(200,60)},
    {name:'üê∞ CoelhoVeloz',value:getSimValue(130,30)},
  ];
  const myValue=calcTotal(child);
  const all=[...competitors,{name:`‚≠ê ${child.name} (Voce)`,value:myValue,me:true}];
  all.sort((a,b)=>b.value-a.value);

  el.innerHTML=all.map((p,i)=>{
    const posClass=i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'rank-other';
    const medal=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'';
    return`<div class="rank-item ${p.me?'me':''}">
      <div class="rank-pos ${posClass}">${medal||i+1}</div>
      <div class="rank-info"><div class="rank-name">${p.name}</div><div class="rank-assets">${p.me?ASSETS.filter(a=>(child.assets?.[a.id]?.qty||0)>0).length+' ativos':'investidor virtual'}</div></div>
      <div class="rank-value" style="color:${p.me?'var(--gold)':'var(--text)'}">${fmt(p.value)}</div>
    </div>`;
  }).join('');
}
function getSimValue(base,variance){
  // Simulated competitors with slow drift
  const time=Date.now()/60000;// minutes
  const drift=Math.sin(time*.1+base)*variance+Math.cos(time*.07+base*.5)*variance*.5;
  return Math.max(50,base+drift);
}

function renderPortfolio(child){
  const grid=document.getElementById('portfolioGrid');
  const owned=ASSETS.filter(a=>(child.assets?.[a.id]?.qty||0)>0);
  if(!owned.length){grid.innerHTML='<p style="color:var(--text2);font-size:.75rem;grid-column:1/-1;text-align:center;">Carteira vazia</p>';return}
  grid.innerHTML=owned.map(a=>{const d=child.assets[a.id];return`<div class="portfolio-coin" onclick="selectAsset('${a.id}');selectCat('${a.cat}')" style="${selectedAsset===a.id?'border-color:'+a.color:''}"><span class="pc-icon">${a.icon}</span><div class="pc-info"><div class="pc-name">${a.name}</div><div class="pc-qty">${d.qty} unid.</div></div><div class="pc-val" style="color:${a.color}">${fmt(d.qty*d.price)}</div></div>`}).join('');
}

function handleBuy(){
  const ch=load('children')||{};const child=ch[currentChild.id];if(!child||!child.is_active)return;
  const asset=ASSETS.find(a=>a.id===selectedAsset);const state=child.assets[selectedAsset];
  const cost=state.price*tradeQty;if(child.balance<cost){showToast('Saldo insuficiente!','error');return}
  child.balance=Math.round((child.balance-cost)*100)/100;state.qty+=tradeQty;
  ch[child.id]=child;save('children',ch);currentChild=child;
  const tx=load('transactions')||{};if(!tx[child.id])tx[child.id]=[];
  tx[child.id].push({type:'BUY',asset:selectedAsset,qty:tradeQty,price:state.price,total:cost,time:Date.now()});
  save('transactions',tx);showToast(`Comprou ${tradeQty} ${asset.icon}${asset.name}!`,'success');updateUI();
}
function handleSell(){
  const ch=load('children')||{};const child=ch[currentChild.id];if(!child||!child.is_active)return;
  const asset=ASSETS.find(a=>a.id===selectedAsset);const state=child.assets[selectedAsset];
  if(state.qty<tradeQty){showToast('Quantidade insuficiente!','error');return}
  const val=state.price*tradeQty;child.balance=Math.round((child.balance+val)*100)/100;state.qty-=tradeQty;
  ch[child.id]=child;save('children',ch);currentChild=child;
  const tx=load('transactions')||{};if(!tx[child.id])tx[child.id]=[];
  tx[child.id].push({type:'SELL',asset:selectedAsset,qty:tradeQty,price:state.price,total:val,time:Date.now()});
  save('transactions',tx);showToast(`Vendeu ${tradeQty} ${asset.icon}${asset.name}!`,'success');updateUI();
}
function changeQty(d){tradeQty=Math.max(1,tradeQty+d);document.getElementById('qtyValue').textContent=tradeQty;updateUI()}

function renderChildTx(){
  const txs=((load('transactions')||{})[currentChild.id]||[]);const el=document.getElementById('cTxList');
  if(!txs.length){el.innerHTML='<p style="color:var(--text2);text-align:center;padding:10px;font-size:.85rem;">Faca sua primeira operacao!</p>';return}
  el.innerHTML=txs.slice(-10).reverse().map(tx=>{const a=ASSETS.find(x=>x.id===tx.asset)||ASSETS[0];return`<div class="tx-feed-item"><span>${tx.type==='BUY'?'üü¢':'üî¥'} ${tx.type==='BUY'?'Comprou':'Vendeu'} ${tx.qty} ${a.icon}${a.name} a ${fmt(tx.price)}</span><span style="font-weight:700;color:${tx.type==='BUY'?'var(--red)':'var(--green)'}">${tx.type==='BUY'?'-':'+'}${fmt(tx.total)}</span></div>`}).join('');
}

// ============ PRO CHART ============
function drawChart(){
  const canvas=document.getElementById('priceChart');if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const rect=canvas.parentElement.getBoundingClientRect();
  canvas.width=rect.width;canvas.height=rect.height;

  const asset=ASSETS.find(a=>a.id===selectedAsset);
  let allData=priceHistories[selectedAsset]||[];

  // Filter by time period
  const period=TIME_PERIODS.find(t=>t.id===selectedTime);
  if(period&&period.seconds!==Infinity){
    const cutoff=Date.now()-period.seconds*1000;
    allData=allData.filter(d=>d.t>=cutoff);
  }
  if(allData.length<2){ctx.fillStyle='#7a8ba8';ctx.font='13px sans-serif';ctx.textAlign='center';ctx.fillText('Coletando dados...',canvas.width/2,canvas.height/2);return}

  // Downsample if too many points
  let data=allData;
  const maxPts=150;
  if(data.length>maxPts){const step=Math.ceil(data.length/maxPts);data=data.filter((_,i)=>i%step===0);if(data[data.length-1]!==allData[allData.length-1])data.push(allData[allData.length-1])}

  const prices=data.map(d=>d.p);
  const min=Math.min(...prices)*.97;const max=Math.max(...prices)*1.03;
  const range=max-min||1;
  const w=canvas.width,h=canvas.height,pad=8;
  const stepX=w/(prices.length-1);

  // Background grid
  ctx.strokeStyle='#1f2d4722';ctx.lineWidth=.5;
  for(let i=0;i<=5;i++){const y=pad+((h-pad*2)/5)*i;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke()}

  // Price labels
  ctx.fillStyle='#4a5568';ctx.font='9px sans-serif';ctx.textAlign='right';
  for(let i=0;i<=4;i++){const y=pad+((h-pad*2)/4)*i;const val=max-(range/4)*i;ctx.fillText(`${val.toFixed(val>=100?0:1)}`,w-4,y+3)}

  // Base price line
  const baseY=h-pad-((asset.basePrice-min)/range)*(h-pad*2);
  ctx.strokeStyle='#f59e0b33';ctx.lineWidth=1;ctx.setLineDash([4,4]);
  ctx.beginPath();ctx.moveTo(0,baseY);ctx.lineTo(w,baseY);ctx.stroke();ctx.setLineDash([]);

  // Smooth line (bezier)
  const pts=prices.map((p,i)=>({x:i*stepX,y:h-pad-((p-min)/range)*(h-pad*2)}));
  const lastP=prices[prices.length-1],firstP=prices[0],isUp=lastP>=firstP;
  const lineColor=asset.color;

  ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);
  for(let i=1;i<pts.length;i++){
    const prev=pts[i-1],cur=pts[i];
    const cpx=(prev.x+cur.x)/2;
    ctx.bezierCurveTo(cpx,prev.y,cpx,cur.y,cur.x,cur.y);
  }
  ctx.strokeStyle=lineColor;ctx.lineWidth=2.5;ctx.lineCap='round';ctx.lineJoin='round';ctx.stroke();

  // Glow effect
  ctx.shadowColor=lineColor;ctx.shadowBlur=8;ctx.stroke();ctx.shadowBlur=0;

  // Gradient fill
  const lastPt=pts[pts.length-1];
  ctx.lineTo(lastPt.x,h);ctx.lineTo(pts[0].x,h);ctx.closePath();
  const grad=ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,lineColor+'30');grad.addColorStop(.6,lineColor+'08');grad.addColorStop(1,'transparent');
  ctx.fillStyle=grad;ctx.fill();

  // Volume bars at bottom (simulated from price changes)
  if(prices.length>3){
    const barH=h*.12;
    for(let i=1;i<prices.length;i++){
      const change=Math.abs(prices[i]-prices[i-1])/prices[i-1];
      const bh=Math.min(barH,change*barH*40);
      const x=i*stepX;
      ctx.fillStyle=prices[i]>=prices[i-1]?'rgba(34,197,94,.15)':'rgba(239,68,68,.15)';
      ctx.fillRect(x-stepX/3,h-bh,stepX*.6,bh);
    }
  }

  // Current price dot with pulse ring
  ctx.beginPath();ctx.arc(lastPt.x,lastPt.y,7,0,Math.PI*2);ctx.fillStyle=lineColor+'33';ctx.fill();
  ctx.beginPath();ctx.arc(lastPt.x,lastPt.y,4,0,Math.PI*2);ctx.fillStyle=lineColor;ctx.fill();
  ctx.strokeStyle='#fff';ctx.lineWidth=1.5;ctx.stroke();

  // Current price label
  ctx.fillStyle=lineColor;ctx.font='bold 10px sans-serif';ctx.textAlign='right';
  ctx.fillText(fmt(lastP),lastPt.x-8,lastPt.y-8);
}

// ============ CELEBRATION ============
function showCelebration(tv,goal){document.getElementById('celebrationText').textContent=`Patrimonio: ${fmt(tv)} - Meta: ${fmt(goal)}`;document.getElementById('celebrationOverlay').classList.remove('hidden');createConfetti()}
function closeCelebration(){document.getElementById('celebrationOverlay').classList.add('hidden')}
function createConfetti(){const colors=['#22c55e','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899'];for(let i=0;i<60;i++){const c=document.createElement('div');c.style.cssText=`position:fixed;width:${Math.random()*10+5}px;height:${Math.random()*10+5}px;background:${colors[~~(Math.random()*colors.length)]};left:${Math.random()*100}vw;top:-20px;border-radius:${Math.random()>.5?'50%':'2px'};z-index:1001;pointer-events:none;animation:cFall ${Math.random()*2+2}s ease-in forwards;`;document.body.appendChild(c);setTimeout(()=>c.remove(),4000)}if(!document.getElementById('cStyle')){const s=document.createElement('style');s.id='cStyle';s.textContent='@keyframes cFall{to{transform:translateY(110vh) rotate(720deg);opacity:0}}';document.head.appendChild(s)}}

// ============ UTILS ============
function fmt(v){return'R$ '+(v||0).toFixed(2).replace('.',',')}
function showToast(m,t){const el=document.createElement('div');el.className=`toast toast-${t}`;el.textContent=m;document.body.appendChild(el);setTimeout(()=>el.remove(),3000)}

init();
</script>
</body>
</html>
